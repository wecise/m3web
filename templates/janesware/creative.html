<!--

    [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]
    [::::::::::::::      ::::::::::::::]
    [::::::::::::::      ::::::::::::::]
    [::::::[[[[[[[:      :]]]]]]]::::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[    CODE BY WANGZD    ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [::::::[[[[[[[:      :]]]]]]]::::::]
    [::::::::::::::      ::::::::::::::]
    [::::::::::::::      ::::::::::::::]
    [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]

-->
{{template "base/head" .}}
<!-- zTree Core CSS -->
<link href="{{AppSubUrl}}/web/vendor/zTree/css/entityStyle/zTreeStyle.css" type="text/css" rel="stylesheet">

<style>


    #content .bg-info.dir {
        background: rgb(255, 255, 255);
        background: -moz-linear-gradient(top, #b2e1ff 0%, #66b6fc 100%);
        background: -webkit-linear-gradient(top, rgb(255, 255, 255) 0%,rgb(235, 235, 235) 100%);
        background: linear-gradient(to bottom, rgb(255, 255, 255) 0%,rgb(235, 235, 235) 100%);
    }

    #content .bg-info {
        background: rgb(255, 255, 255);
        background: -moz-linear-gradient(top, #b2e1ff 0%, #66b6fc 100%);
        background: -webkit-linear-gradient(top, rgb(178, 225, 255) 0%,rgb(102, 182, 252) 100%);
        background: linear-gradient(to bottom, rgb(255, 255, 255) 0%,rgb(201, 233, 249) 100%);
    }

    #content .col-md-3 {
        width: 25%;
        max-width: 350px;
        min-width: 310px;
        padding-left: 5px;
        padding-right: 5px;
    }

    #content .fa-wrench{
        color: #999999;
    }

    .widget-stats .stats-desc, .widget-stats .stats-title {
        color: rgb(0, 0, 0);
    }

    @media screen and (max-width: 2560px) {

        #content .stats-title {
            font-family: 'microsoft yahei';
            font-size: 22px;
            color: rgb(0, 0, 0);
            line-height: 25px;
            overflow-x: auto;
            overflow-y: hidden;
            max-height: 36px;
            cursor: pointer;

            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            width: 13.5em;
        }
    }

    @media screen and (max-width: 1960px) {

        #content .stats-title {
            font-family: 'microsoft yahei';
            font-size: 22px;
            color: rgb(0, 0, 0);
            line-height: 25px;
            overflow-x: auto;
            overflow-y: hidden;
            max-height: 36px;
            cursor: pointer;

            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            width: 13.5em;
        }
    }

    @media screen and (max-width: 1280px) {

        #content .stats-title {
            font-family: 'microsoft yahei';
            font-size: 22px;
            color: rgb(0, 0, 0);
            line-height: 25px;
            overflow-x: auto;
            overflow-y: hidden;
            max-height: 36px;
            cursor: pointer;

            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            width: 12em;
        }
    }

    #content .stats-subtitle{
        font-size:12px;
        color: #999999;
        line-height: 25px;
        overflow: hidden;
        max-height: 46px;
        min-height: 46px;
        cursor: pointer;

        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2
    }

    #content .media {
        cursor: pointer;
        margin-bottom: 0px;
    }

    #content .media-body{
        color: #999999;
    }

    #content .media-body p{
        margin: 0px 0px 3px 20px;
    }

    #content .media-object{
        max-width:75px;
        min-width:60px;
    }

    #content .stats-desc {
        display: -webkit-box;
        margin: 0px -15px -15px -15px;
        background-color: rgb(247, 247, 247);
        padding: 5px 10px;
        border-top: 0.5px solid rgb(240, 243, 244);
        color: rgb(124, 124, 124)!important;
    }

    #content .stats-desc .fa-wrench {
        color: rgb(144, 144, 144);
    }

    #content .stats-desc .status {
        right: -73%;
        position: relative;
        color: rgb(124, 124, 124)!important;
    }

    #icon-list ul{
        padding-left: 0;
        list-style: none;
    }

    #icon-list ul > li{
        float: left;
        width: 25%;
        height: 115px;
        padding: 10px;
        font-size: 10px;
        line-height: 1.4;
        text-align: center;
        background-color: rgb(249, 249, 249);
        border: 1px solid rgb(255, 255, 255);
    }

    .col-lg-12 .widget-stats{
        border: 1px solid rgb(229, 229, 229);
        border-radius: 10px;
        max-height: 210px;
        min-height: 205px;
    }

    .col-lg-10 .widget-stats{
        border: 1px solid rgb(240, 240, 240);
        border-radius: 10px;
        max-height: 210px;
        min-height: 200px;
    }

    .rating {
        unicode-bidi: bidi-override;
        direction: rtl;
        text-align: center;
    }

    .rating > span {
        display: inline-block;
        position: relative;
        width: 1.1em;
    }

    .rating > span:hover,
    .rating > span:hover ~ span {
        color: transparent;
    }

    .rating > span:hover:before,
    .rating > span:hover ~ span:before {
        content: "\2605";
        position: absolute;
        left: 0;
        color: gold;
    }

    .bootstrap-tagsinput {
        background-color: transparent;
        border-style: none;
        box-shadow: none;
    }

    .label {
        font-size: 12px;
    }

    .input {
        width: auto;
    }

    .modal-dialog {
        position: relative;
        display: table;
        overflow-y: auto;
        overflow-x: auto;
        width: auto;
        min-width: 85%;
    }

    .btn.dropdown-toggle {
        padding: 7px 12px;
        border-radius: 0px;
    }

    .widget-stats.bg-info:hover,.widget-stats.bg-info.active {
        box-shadow: 2px 2px 20px 2px #999999;
        background-color: rgb(255, 255, 255)!important;
        /*background-image: linear-gradient(to bottom, rgb(255, 255, 255) 0%, rgb(239, 239, 239) 100%)!important;*/
    }

    .widget-stats.bg-grey:hover,.widget-stats.bg-grey.active {
        box-shadow: 2px 2px 2px 2px #999;
        background-color: rgb(183, 190, 208)!important;
        background-image: linear-gradient(to bottom, rgb(182, 194, 202) 0%, rgb(244, 244, 244) 100%)!important;
    }

    .bootstrap-tagsinput>input {
        border: none!important;
    }

    .context-menu-list {
        box-shadow: 0 2px 8px 0 rgba(0,0,0,0.15);
        padding:5px;
        border: none;
    }
        
    .context-menu-list>li>a{
        padding: 5px 5px;
        color:rgb(102, 102, 102)!important;
    }

    .img-thumbnail {
        background-color: transparent;
        border: none;
        max-width: 60%;
    }


    .breadcrumb > li {
        text-overflow: ellipsis;
        width: 10em;
        overflow: hidden;
        white-space: nowrap;
    }


</style>
<div id="app"></div>

<!-- Bootstrap x-editable JS -->
<script src="{{AppSubUrl}}/web/vendor/bootstrap3-editable/js/bootstrap-editable.min.js"></script>

<!--Clipboard JS-->
<script src="{{AppSubUrl}}/web/vendor/clipboard/dist/clipboard.min.js"></script>

<link rel="vc" href="{{AppSubUrl}}/web/component/vue-fs-tree-component.html"></link>

<script type="text/javascript">
    
    VueLoader.onloaded(["vue-fs-tree-component"
                        ],function() {

        moment.locale({{.Lang}});

        $(".current-active-item").html('<a class="active item" href="{{AppSubUrl}}/janesware/creative"><i class="fa fa-sitemap"></i>&nbsp;{{.i18n.Tr .ActiveView }}</a>');

        $(function() {
            
            let _appVue = new Vue({
                delimiters: ['${', '}'],
                el: '#app',
                template: '#app-template',
                data: {
                    model: {
                        list:[],
                        root: "/home/creative",
                        action: {
                            from: null,
                            to: null
                        },
                        project: {
                                    title: "",
                                    current:"",
                                    stime: "",
                                    etime: "",
                                    status: "start",
                                    diaglog: {
                                        title: "",
                                        prompt: [],
                                        select: ""
                                    },
                                    action: {
                                        node: "",
                                        status: ""
                                    }

                                }
                    },
                    crontab: {
                        project:{
                            sched: Object,
                            timer: Object
                        }
                    },
                    toggle: {
                        left: false
                    }

                },
                mounted: function() {
                    let self = this;

                    self.$nextTick(function() {
                        self.load();
                        self.init();

                        _.delay(function(){
                            self.initPlugin();
                        },500);
                    })
                },
                watch: {
                    model: {
                        handler:function(newValue, oldValue) {
                            let self = this;

                            if (!_.isEqual(newValue, oldValue)) {
                                self.refresh();
                            }
                        },
                        deep:true
                    }
                },
                created: function() {
                    let self = this;

                    self.initProject();

                    eventHub.$on("FS-FORWARD-EVENT", self.forwardDir);
                },
                computed: {
                    filePath: function(){
                        let self = this;
                        let _tmp = self.model.root.split("/");

                        return _tmp;
                    }
                },
                filters: {
                    pickName: function (item) {
                        let self = this;

                        if (_.isEmpty(item)) return '';

                        let _name = _.head(item.name.split("."));

                        /*if(!_.isEmpty(_name) && _.size(_name) > 9){
                            _name = _.split(_name,"",9).join("") + "...";
                        }*/

                        return _name;
                    },
                    pickRemark: function (item) {
                        let self = this;

                        if (_.isEmpty(item.attr)) return '';

                        let _remark = '';

                        if(_.attempt(JSON.parse.bind(null, item.attr)).remark){

                            _remark = _.attempt(JSON.parse.bind(null, item.attr)).remark;

                            /*if(_.isEmpty(_remark)) return '';


                            if($(window).width()>1280){
                                if(_.size(_remark) > 50){
                                    _remark = _.split(_remark,"",49).join("") + "..."
                                }
                            } else {

                                if(_.size(_remark) > 44){
                                    _remark = _.split(_remark,"",43).join("") + "..."
                                }
                            }*/

                        }

                        return _remark;
                    },
                    pickIcon: function(item){
                        let self = this;

                        if (_.isEmpty(item.attr)) return `/fs/home/assets/${item.ftype}.png?type=download`;

                        return JSON.parse(item.attr).icon;
                    },
                    readMore: function (text, length, suffix) {
                        return text.substring(0, length) + suffix;
                    },
                    toLocalTime: function (value) {
                        return moment(value).format("LLL");
                    }
                },
                methods: {
                    init: function() {
                        let self = this;

                    },
                    initPlugin: function(){
                        let self = this;

                        self.crontab.project.sched = later.parse.text('every 15 sec');
                        self.crontab.project.timer = later.setInterval(self.initProject, self.crontab.project.sched);
                        self.initProject();

                        self.initContextMenu();

                    },
                    initContextMenu: function(){
                        let self = this;

                        $.contextMenu({
                            selector: '.list-context-menu',
                            trigger: 'left',
                            build: function($trigger, e) {
                                // this callback is executed every time the menu is to be shown
                                // its results are destroyed every time the menu is hidden
                                // e is the original contextmenu event, containing e.pageX and e.pageY (amongst other data)
                                let _item = _.attempt(JSON.parse.bind(null, e.target.attributes.getNamedItem('data-item').value));

                                return {

                                    items: {
                                        "edit": {name: "编辑", icon: "fa-edit", callback: function(key, opt) {
                                                self.forwardCreative('edit', _item);
                                            }
                                        },
                                        "sep2": "---------",

                                        "delete": {name: "删除", icon: "fa-trash", callback: function(key, opt) {
                                                self.remove(_item);
                                            }
                                        },
                                        "sep3": "---------",
                                        "copy": {name: "复制", icon: "fa-copy", callback: function(key, opt) {
                                                self.copyIt(_item);
                                            }
                                        },
                                        "paste": {name: "粘贴", icon: "fa-paste", callback: function(key, opt) {
                                                self.pasteIt();

                                            }
                                        },
                                        "sep4": "---------",

                                        "info": {name: "属性", icon: "fa-info", callback: function(key, opt, rootMenu, originalEvent) {
                                                self.info(_item);
                                            }
                                        }
                                    }
                                };
                            }
                        });

                    },
                    initProject: function(){
                        let self = this;


                        let _rtn = jobContextGet("BOB", "");

                        if (!_.isEmpty(_rtn) && !_.isEmpty(_rtn.message)) {
                            if (!_.isEmpty(_rtn.message["BOB"])){
                                self.model.project = _rtn.message["BOB"];
                            }
                        }
                    },
                    forwardDir: function(path){
                        let self = this;

                        self.model.root = path;

                        self.load();
                    },
                    load: function() {
                        let self = this;

                        let _rtn = fsList(self.model.root);

                        console.log(JSON.stringify(_rtn))

                        self.model.list = _.orderBy(_.map(_rtn,function(v,k){

                                            return _.merge(v, {"username": {{.SignedUser.Name}}, "project": self.model.project });

                                        }),['fullname'],['asc']);


                        _.delay(function(){

                            self.refresh();

                            /*$(".fs-name").editable({
                                type: "text",
                                container: 'body',
                                validate: function (value) {
                                    if (!$.trim(value)) {
                                        return '不能为空';
                                    }
                                },
                                display: function(value, sourceData) {
                                    if(value.length > 10) {
                                        $(this).html(_.split(value,"",9).join("")+"...");
                                    }
                                },
                                success: function (response,newValue) {

                                    let _item = $(this).data("info");

                                    let _extName = _item.ftype=='dir'?'':'.'+_item.ftype;
                                    let _old = _item.parent + "/" + $(this).editable('getValue', true) + _extName;
                                    let _new = _item.parent + "/" + newValue + _extName;


                                    let _check = fsCheck( _item.parent, newValue);
                                    if(_check) {
                                        alertify.error("文件已存在，请确认！")
                                        return false;
                                    }

                                    let _rtn = fsRename(_old, _new);

                                    if(_rtn == 1){
                                        self.load();
                                    } else {
                                        $(this).innerHTML($(this).editable('getValue', true));
                                    }
                                }
                            });*/

                        },200);

                    },
                    newDir: function() {
                        let self = this;

                        let win = newWindow('small','{{.i18n.Tr "creative-new-project"}}',`<div id="creative-starting"></div>`, null);

                        let _vue  = new Vue({
                            delimiters: ['#{', '}#'],
                            el: "#creative-starting",
                            template: "#creative-project-template",
                            data: {
                                model: {
                                    project: {
                                        value: "流程设计",
                                        extName: {
                                            "流程设计": "iflow",
                                            "仪表盘": "ishow",
                                            "IT地图": "imap"
                                        }
                                    },
                                    name: "",
                                    type: "dir",
                                    tags: [],
                                    info: {
                                        remark: ""
                                    },
                                    ifshare: 0
                                }
                            },
                            mounted:function(){
                                let me = this;

                                me.$nextTick(function() {
                                    me.init();
                                })
                            },
                            watch: {

                            },
                            computed: {
                                type: function(){
                                    let me = this;

                                    return me.model.type + "t";
                                }
                            },
                            methods: {
                                init: function(){
                                    let me = this;

                                    $("#tags").tagsinput({
                                        tagClass: function(item) {
                                            return _.sample(['label label-default', 'label label-success', 'label label-primary', 'label label-warning', 'label label-danger label-important']);
                                        }
                                    });

                                },
                                save: function(){
                                    let me = this;
                                    let _root = _.cloneDeep(self.model.root);

                                    if (_.isEmpty(me.model.name)) {
                                        swal("名称不能为空！", "", "warning");
                                        return false;
                                    }

                                    let _name = me.model.name;
                                    let _type = me.model.type;
                                    let _info = {remark: me.model.info.remark, ctime: _.now(), author: `{{.SignedUser.Name}}`, type: _type, icon: "/fs/home/assets/dir.png?type=download"};

                                    let _check = fsCheck(_root, _name);
                                    if(_check) {
                                        alertify.error("文件已存在，请确认！")
                                        return false;
                                    }

                                    let _rtn = fsNew(_type, _root, _name, null, _info);

                                    if(_rtn == 1){

                                        alertify.success("",me.model.name,"success");

                                        self.load();

                                        /*let _parent = _root + "/" + me.model.name;

                                        me.newFile(_parent);*/

                                        win.close();
                                    }
                                },
                                newFile: function(parent){

                                    let me = this;

                                    _.delay(function(){

                                        let _name = "PAGE_" + _.now();
                                        let _type = me.model.project.extName[me.model.project.value];
                                        let _info = {remark: me.model.info.remark, ctime: _.now(), author: `{{.SignedUser.Name}}`, type: _type, icon: "/fs/home/assets/dir.png?type=download"};
                                        let _rtn = fsNew(_type, parent, _name+"."+_type, "", _info);

                                        if(_rtn == 1){

                                            alertify.success("",_name,"success");

                                            self.load();
                                        }
                                    },500)

                                }
                            }
                        })
                    },
                    newFile: function() {
                        let self = this;

                        let win = newWindow('large','{{.i18n.Tr "creative-new-file"}}',`<div id="creative-starting"></div>`, null);

                        let _vue  = new Vue({
                            delimiters: ['#{', '}#'],
                            el: "#creative-starting",
                            template: "#creative-list-template",
                            data: {
                                model: {
                                    name: "",
                                    type: "iflow",
                                    tags: [],
                                    info: {
                                        remark: ""
                                    },
                                    ifshare: 0,
                                    astemplate: 0,
                                    templates: []
                                }
                            },
                            mounted:function(){
                                let me = this;

                                me.$nextTick(function() {
                                    me.init();
                                })
                            },
                            watch: {
                                'model.type': function(val,oldVal){
                                    let me = this;
                                    
                                    me.initTemplates();

                                },
                                deep:true
                            },
                            computed: {
                                type: function(){
                                    let me = this;

                                    return me.model.type + "t";
                                }
                            },
                            methods: {
                                init: function(){
                                    let me = this;

                                    $("#tags").tagsinput({
                                        tagClass: function(item) {
                                            return _.sample(['label label-default', 'label label-success', 'label label-primary', 'label label-warning', 'label label-danger label-important']);
                                        }
                                    });

                                    // 只导入template    
                                    me.initTemplates();

                                },
                                initTemplates: function(){
                                    let me = this;


                                    let _list = fetchData("#/matrix/filesystem/: | ftype=" + me.type + "| top 200");
                                    
                                    me.model.templates = _.map(_list.message,function(v,k){
                                                        v.parent = v.parent.replace(/\/home\/admin/,"");
                                                        return _.merge(v, {"username": `{{.SignedUser.Name}}`, "star": ""});
                                                    });

                                    _.delay(self.refresh,100);
                                },
                                save: function(){
                                    let me = this;
                                    let _xml = null;
                                    
                                    if (_.isEmpty(me.model.name)) {
                                        swal("名称不能为空！", "", "warning");
                                        return false;
                                    }
                                    
                                    let _name = me.model.name;
                                    let _type = me.model.type;

                                    let _info = {remark: me.model.info.remark, ctime: _.now(), author: `{{.SignedUser.Name}}`, type: _type, icon: "/fs/home/assets/iflow.png?type=download"};

                                    if(me.model.astemplate){
                                        _name = me.model.name;
                                        _type = me.type;                                      
                                    }

                                    let _check = fsCheck(self.model.root, _name+"."+_type);
                                    if(_check) {
                                        alertify.error("文件已存在，请确认！")
                                        return false;
                                    }

                                    let _rtn = fsNew(_type, self.model.root, _name+"."+_type, _xml, _info);

                                    if(_rtn == 1){
                                        swal("",_name,"success");

                                        _.delay(function(){
                                            self.load();
                                            win.close();
                                        },500);
                                    }

                                },
                                click: function(item){
                                    let me = self;

                                    _vue.model.item = item;

                                    $(".widget-stats.active").removeClass("active");
                                    $("#"+item.id).addClass("active");
                                }
                            }
                        })
                    },
                    refresh: function() {
                        let self = this;

                        $(".tagsLabel").tagsinput({
                            tagClass: function(item) {
                                return _.sample(['label label-success']);//, 'label label-default', 'label label-primary', 'label label-warning', 'label label-danger label-important']);
                            }
                        });

                        $(".tagsLabel").on('itemAdded', function(event) {

                            let _id = $(this).data("index");
                            let _item = _.find(self.model.list,{id:_id});
                            
                            fetchData(_item.id + ' | tags +' + event.item);

                        });

                        $(".tagsLabel").on('itemRemoved', function(event) {

                            let _id = $(this).data("index");
                            let _item = _.find(self.model.list,{id:_id});

                            fetchData(_item.id + ' | tags -' + event.item);

                        });
                    },
                    forwardCreative: function(action,item){
                        let self = this;
                        let _lang = `{{.Lang}}`;
                        let lang = _lang.replace(/"/g,"").split("-")[0].replace(/en/g,"eg");

                        let obj = {};
                        obj.lang = lang;
                        obj.action = action;
                        obj.type = item.ftype;
                        obj.name = item.name;
                        obj.parent = item.parent;
                        obj.fsExtension = item.name.split(".")[1] || "ishow";
                        obj.attr = item.attr;

                        localStorage.setItem("graph-object",JSON.stringify(obj));

                        if(item.ftype === 'ishow'){
                            let _obj = {};

                            _obj.name = item.name;
                            _obj.parent = "/home/dashboard";

                            localStorage.setItem("dashboard-object", JSON.stringify(_obj));

                            window.open(
                                "/janesware/" + obj.fsExtension,
                                "_blank"
                            );
                        } else if(item.ftype === 'dir'){
                            self.model.root = item.parent+"/"+item.name.replace(/\/home\/admin/g,"");
                            self.load();
                        } else {
                            if (action == 'edit'){
                                window.open(
                                    "/web/vendor/mxgraph/graph/index.html",
                                    "_blank"
                                );
                            } else {
                                window.open(
                                    "/janesware/" + obj.fsExtension,
                                    "_blank"
                                );
                            }
                        }
                    },
                    remove: function(event) {
                        let self = this;

                        swal({
                            title: event.name,
                            text: "确定要删除?",
                            type: "warning",
                            showCancelButton: true,
                            closeOnConfirm: false,
                            cancelButtonText: "取消",
                            confirmButtonText: "删除",
                            confirmButtonColor: "#ff0000"
                        }).then((result) => {
                            if (result.value) {
                                let _rtn = fsDelete(event.parent,event.name);

                                if (_rtn == 1){
                                    self.load();
                                }
                            }
                        })
                    },
                    info: function(node){
                        let self = this;

                        let _win = newWindow("fsinfo","属性",'<div id="fs-info"></div>',null);

                        let _infoVue = new Vue({
                            delimiters: ['#{', '}#'],
                            el: "#fs-info",
                            template: `<div class="tab-content">
                                            <div role="tabpanel" class="tab-pane active" id="home">
                                                    <form>
                                                        <div class="form-group">
                                                            <label for="name">项目名称</label>
                                                            <input type="text" class="form-control" id="name" placeholder="" v-model="model.newName">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="remark">项目备注</label>
                                                            <textarea type="text" class="form-control" rows="2" id="remark" placeholder="" v-model="model.attr.remark"></textarea>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="ctime">更新时间</label>
                                                            <input type="text" class="form-control" id="ctime" placeholder="" :value="model.attr.ctime | toLocalTime" disabled>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="parent">目录</label>
                                                            <input type="text" class="form-control" id="parent" placeholder="" v-model="model.parent" disabled>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="type">类型</label>
                                                            <input type="text" class="form-control" id="type" placeholder="" v-model="model.type" disabled>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="author">作者</label>
                                                            <input type="text" class="form-control" id="author" placeholder="" v-model="model.attr.author" disabled>
                                                        </div>
                                                        <div class="form-group">
                                                            <a href="#icon-list" aria-controls="icon-list" role="tab" data-toggle="tab">
                                                                <label for="icon">图标</label> <small style="color: rgb(153, 153, 153);">点击更换图标</small>
                                                                <img class="media-object" :src="model.icon.value" style="width:15%;">
                                                            </a>
                                                        </div>

                                                        <div class="form-group" style="text-align: center;">
                                                            <a href="javascript:void(0)" class="btn btn-sm btn-warning" @click="apply">应用</a>
                                                            <a href="javascript:void(0)" class="btn btn-sm btn-success" @click="save">确定</a>
                                                            <a href="javascript:void(0)" class="btn btn-sm btn-default" @click="close">取消</a>
                                                        </div>

                                                </form>
                                            </div>
                                            <div role="tabpanel" class="tab-pane" id="icon-list">
                                                <div class="row">
                                                  <div class="col-md-12" style="display: list-item;height: 44em;overflow: auto;">
                                                    <ul>
                                                        <li v-for="icon in model.icon.list">
                                                            <a href="#" class="thumbnail" style="border:none;" @click="triggerInput(icon.id)">
                                                              <img class="media-object" :src="icon | pickIcon" style="max-width: 55px;min-width: 55px;;">
                                                              <input type="radio" :ref="icon.id" :id="icon.id"  :value="'/fs'+icon.parent+'/'+icon.name+'?type=download'" v-model="model.icon.value" >
                                                            </a>
                                                        </li>
                                                    </ul>
                                                  </div>
                                                </div>
                                                <div class="row" style="margin-top:15px;">
                                                    <div class="col-md-12" style="text-align:center;">
                                                        <a class="btn btn-sm btn-default" href="#home" aria-controls="home" role="tab" data-toggle="tab">返回</a></li>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>`,
                            data: {
                                model: {
                                    parent: node.parent,
                                    oldName: node.name,
                                    newName: _.head(_.split(node.name,'.')),
                                    extName: node.ftype=='dir'?'':'.'+node.ftype,
                                    type: node.ftype,
                                    attr: null,
                                    icon: {
                                        value: '',
                                        list: []
                                    }
                                }
                            },
                            mounted: function() {
                                let me = this;

                                me.$nextTick(function() {
                                    me.model.attr = _.attempt(JSON.parse.bind(null, node.attr));
                                    me.model.icon.value = me.model.attr.icon;
                                    me.init();
                                })
                            },
                            filters: {
                                pickName: function (value) {
                                    let me = this;

                                    if (!value) return '';

                                    let _attr = _.attempt(JSON.parse.bind(null, value));

                                    return _attr.name;
                                },
                                pickIcon: function(item) {
                                    return "/fs" + item.parent + "/" + item.name + "?type=download";
                                },
                                readMore: function (text, length, suffix) {
                                    return text.substring(0, length) + suffix;
                                },
                                toLocalTime: function (value) {
                                    return moment(value).format("LLL");
                                }
                            },
                            destroyed: function(){
                                let me = this;

                                me.model = null;
                            },
                            methods: {
                                init: function(){
                                    let me = this;

                                    me.model.icon.list = fsList('/home/assets');
                                },
                                triggerInput: function(id){
                                    let self = this;

                                    $(self.$refs[id]).click()
                                },
                                apply: function(){
                                    let me = this;

                                    me.saveAttr();

                                },
                                save: function(){
                                    let me = this;

                                    me.saveAttr();
                                    _win.close();
                                },
                                close: function(){
                                    let me = this;

                                    _win.close();
                                },
                                saveName: function(){
                                    let me = this;

                                    let _old = node.parent + "/" + node.name;// + _extName;
                                    let _new = node.parent + "/" + me.model.newName + me.model.extName;


                                    let _check = fsCheck( node.parent, me.model.newName + me.model.extName);
                                    if(_check) {
                                        alertify.error("文件已存在，请确认！")
                                        return false;
                                    }

                                    let _rtn = fsRename(_old, _new);

                                    if(_rtn == 1){

                                        self.load();
                                    }
                                },
                                saveAttr: function(){
                                    let me = this;

                                    me.model.attr.icon = me.model.icon.value;

                                    let _rtn = fsUpdateAttr(node.parent, node.name, me.model.attr);

                                    if(_rtn == 1){
                                        self.load();

                                        if(me.model.oldName != me.model.newName + me.model.extName){

                                            me.saveName();
                                        }
                                    }
                                }
                            }
                        })

                    },
                    copyIt: function(item){
                        let self = this;

                        self.model.action.from = item.parent + "/" + item.name;
                        alertify.log("已复制 " + self.model.action.from);
                    },
                    pasteIt: function(){
                        let self = this;

                        if(_.isEmpty(self.model.action.from)){
                            alertify.log("请选择复制内容")
                            return false;
                        }

                        self.model.action.to = self.model.root;
                        let _rtn = fsCopy(self.model.action.from, self.model.action.to);
                        if(_rtn == 1){

                            alertify.log("已粘贴 " + self.model.action.to);
                            self.load();

                            //
                            self.model.action.from = null;
                            self.model.action.to = null;
                        }
                    },
                    toggleLeft: function() {
                        let self = this;

                        if(self.toggle.left) {

                            $("#nav").hide();

                            $("#content").removeClass("col-lg-10");
                            $("#content").addClass("col-lg-12");

                            $(".navtoggle").removeClass("fa fa-caret-left");
                            $(".navtoggle").addClass("fa fa-caret-right");

                            self.toggle.left = false;
                        } else {
                            $("#nav").slideDown(500);
                            $("#nav").show();

                            $("#content").removeClass("col-lg-12");
                            $("#content").addClass("col-lg-10");
                            //$("#content").find(".panel-default").css("border-left","2px #ddd dotted");

                            $(".navtoggle").removeClass("fa fa-caret-right");
                            $(".navtoggle").addClass("fa fa-caret-left");

                            self.toggle.left = true;
                        }
                    }

                }
            })
        })
    })
</script>

<script type="text/x-template" id="app-template">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-grey">
                    <div class="panel-body" style="padding: 5px 0px;">
                        <div class="col-lg-2" id="nav" style="display:none;">
                            <vue-fs-tree-component id="creative-fs-tree" :root="model.root" :checkEnable="false" :contextMenu="null"></vue-fs-tree-component>
                        </div>
                        <div class="col-lg-12" id="content">
                            <div class="row" style="margin: 0px -15px;">
                                <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8">
                                    <ul style="font-size:16px; list-style: none;display:  flex;margin-left: -40px;">
                                        <li style="padding:5px 0px;">
                                            <a href="javascript:void(0);" @click="forwardDir('/home/creative')" style="text-decoration:none;color:#333333;">
                                                <i class="fa fa-folder-o"></i> 所有
                                            </a>
                                        </li>
                                        <li style="padding-top: 2px;">
                                            <ol class="breadcrumb">
                                                <li v-for="(item,index) in filePath" :style="index<3 ? 'display:none;':'display:;'">
                                                    <a href="javascript:void(0);" @click="forwardDir(_.slice(filePath,0,index+1).join('/'))" :title="item">${item}</a>
                                                </li>
                                            </ol>
                                        </li>
                                    </ul>

                                </div>
                                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                                    <div class="btn-group-action pull-right">
                                        <!--a href="#" class="btn btn-sm btn-default" @click="toggleLeft"><i class="fa fa-caret-right navtoggle"></i> </a-->
                                        <a href="#" class="btn btn-sm btn-primary" @click="pasteIt"><i class="fa fa-paste"></i> 粘贴</a>
                                        <a href="#" class="btn btn-sm btn-primary" @click="newDir"><i class="fa fa-plus"></i> {{.i18n.Tr "creative-new-project"}}</a>
                                        <a href="#" class="btn btn-sm btn-primary" @click="newFile"><i class="fa fa-plus"></i> {{.i18n.Tr "creative-new-file"}}</a>
                                    </div>
                                </div>
                            </div>

                            <div class="row">

                                <div class="col-md-3 col-sm-6" v-for="(item,index) in model.list" >
                                        <div :class="'widget widget-stats animated flipInX bg-info ' + item.ftype">
                                            <div class="list-context-menu" :data-item="JSON.stringify(item)" style="position: absolute;right: 10px;top: 5px;cursor:pointer;">
                                                <i class="fa fa-wrench"></i>
                                            </div>
                                            <div @click="forwardCreative('show',item)">
                                                <div class="stats-title">
                                                    <i class="fa fa-braille fa-fw"></i>
                                                    <span class="fs-name" :data-info="JSON.stringify(item)">${ item | pickName}</span>
                                                </div>

                                                <div class="stats-subtitle">
                                                    ${item | pickRemark}
                                                </div>

                                                <div class="media">
                                                    <div class="media-left">
                                                        <img class="media-object" :src="item | pickIcon">
                                                    </div>
                                                    <div class="media-body">
                                                        <p>项目作者： ${item.username}</p>
                                                        <p>更新日期： ${ moment(item.vtime).format("L") }</p>
                                                        <p>更新时间： ${ moment(item.vtime).format("LTS") }</p>
                                                        <p class="status" v-if="item.project.status==='1'">
                                                            项目状态： 运行中 <i class='fa fa-spinner fa-spin'></i>
                                                        </p>
                                                        <p class="status" v-else>
                                                            项目状态： 就绪
                                                        </p>
                                                    </div>
                                                </div>

                                            </div>
                                            {{if not .SignedUser.Company.OSpace}}
                                            <div class="stats-desc">
                                                <input class="tagsLabel" :id="'tagsLabel'+index" :value="item.tags" :data-index="item.id" placeholder='{{.i18n.Tr "mxdashboard_tag_add"}}'>
                                            </div>
                                            {{end}}
                                        </div>

                                </div>

                            </div>
                        </div>
                    </div>
                </div>  
            </div>
        </div>
    </div>
</script>

<script type="text/x-template" id="creative-saveas-template">
    <div>
        <div class="row">
            <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8 col-lg-offset-2">
                <form class="form-horizontal" style="padding:15px;">
                
                    <div class="form-group">
                        <input type="text" name="name" class="form-control" placeholder="{{.i18n.Tr "mxdashboard_modal_title"}}" autofocus="true" v-model="model.name" style="border:1px solid #dddddd;">
                    </div>
                    
                    <div class="form-group">
                        <input type="checkbox" v-model="model.astemplate" value="0">&nbsp;{{.i18n.Tr "mxdashboard_modal_astemplate"}}
                    </div>

                    <div class="form-group pull-right">
                        <a href="javascript:void" class="btn btn-xs btn-info" @click="save">{{.i18n.Tr "creative-save"}}</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</script>

<script type="text/x-template" id="creative-project-template">
    <div class="panel">
        <div class="panel-body">
            <form>

                <div class="form-group">
                    <label for="title">{{.i18n.Tr "mxdashboard_modal_project&name"}}</label>
                    <div class="input-group">
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">#{model.project.value}# <span class="caret"></span></button>
                            <ul class="dropdown-menu">
                                <li>
                                    <label style="padding:5px;">
                                        <input type="radio" v-model="model.project.value" value="流程设计" checked> 流程设计
                                    </label>
                                <li>
                                    <label style="padding:5px;">
                                        <input type="radio" v-model="model.project.value" value="仪表盘"> 仪表盘
                                    </label>
                                <li>
                                    <label style="padding:5px;">
                                        <input type="radio" v-model="model.project.value" value="IT地图"> IT地图
                                    </label>
                            </ul>
                        </div>
                        <input type="text" class="form-control" id="title" placeholder="{{.i18n.Tr "mxdashboard_modal_title"}}" autofocus="true" v-model="model.name" style="height:33px;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="remark">{{.i18n.Tr "mxdashboard_modal_remark"}}</label>
                    <textarea class="form-control" id="remark" rows="6" placeholder="{{.i18n.Tr "mxdashboard_modal_remark"}}" v-model="model.info.remark"></textarea>
                </div>

                {{if ne .SignedUser.Company.OSpace "oneswitch"}}
                <div class="form-group" style="max-height: 5vh;overflow:auto;">
                    <input id="tags" name="tags" placeholder="{{.i18n.Tr "mxdashboard_modal_tag"}}" v-model="model.tags">
                </div>

                <div class="form-group">
                    <div style="padding:5px;">
                        <input type="radio" v-model="model.ifshare" value="1" checked>&nbsp;{{.i18n.Tr "mxdashboard_modal_public"}}
                        <input type="radio" v-model="model.ifshare" value="0">&nbsp;{{.i18n.Tr "mxdashboard_modal_private"}}
                    </div>
                </div>
                {{end}}
                <div class="form-group">
                    <div class="pull-right" style="background-color:transparent;position: relative;">
                        <a href="javascript:void(0)" type="button" class="btn btn-sm btn-primary" @click="save">{{.i18n.Tr "mxdashboard_modal_submit"}}</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</script>

<script type="text/x-template" id="creative-list-template">
    <div style="padding:10px 0px;">
        <div class="row" style="border-bottom:1px solid #ddd;">
            <div class="col-xs-11 col-sm-11 col-md-11 col-lg-11">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label for="name" class="col-sm-2 control-label">{{.i18n.Tr "mxdashboard_modal_title"}}</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="name" placeholder="{{.i18n.Tr "mxdashboard_modal_title"}}" autofocus="true" v-model="model.name" style="border:1px solid #ddd;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="remark"  class="col-sm-2 control-label">{{.i18n.Tr "mxdashboard_modal_remark"}}</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="remark" placeholder="{{.i18n.Tr "mxdashboard_modal_remark"}}" v-model="model.info.remark" style="border:1px solid #ddd;">
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="row" style="background-color:#f7f7f7;">
            <div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
                <form class="form-vertical" role="form">

                    <div class="form-group">
                        <div class="col-lg-12">

                            <label class="radio-inline">
                                <input type="radio" v-model="model.type" value="iflow" checked>&nbsp;流程设计
                                <p><img src="{{AppSubUrl}}/web/assets/images/iflow.png" class="img-fluid img-thumbnail"></p>
                            </label>
                            {{if ne .SignedUser.Company.OSpace "oneswitch"}}
                            <label class="radio-inline">
                                <input type="radio" v-model="model.type" value="ishow">&nbsp;DashBoard
                                <p><img src="{{AppSubUrl}}/web/assets/images/ishow.png" class="img-fluid img-thumbnail"></p>
                            </label>
                            <label class="radio-inline">
                                <input type="radio" v-model="model.type" value="imap">&nbsp;IT地图
                                <p><img src="{{AppSubUrl}}/web/assets/images/imap.png" class="img-fluid img-thumbnail"></p>
                            </label>
                            {{end}}
                        </div>
                    </div>

                </form>
            </div>
            <div class="col-xs-9 col-sm-9 col-md-9 col-lg-9"  style="border-left:1px solid #dddddd;">
                <div class="panel panel-grey" style="background-color:transparent;margin-bottom: 0px;">
                    <div class="panel-body">
                        
                        <div class="row" style="min-height:42vh;max-height:42vh;overflow: auto;border-bottom:1px solid #ddd;">
                            <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                                <div class="widget widget-stats bg-grey" id="blank" @click="click({'id':'blank'})">
                                    <div>
                                        <div class="stats-number" style="font-size:14px;"><i class='fa fa-braille'></i> Blank</div>
                                        <span>
                                            <img src="/web/assets/images/logo_trans.png" style="width:75%;height:80px; margin: 0px 20px;opacity: 50;">
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3" v-for="item in model.templates">
                                <div class="widget widget-stats bg-grey" :id="item.id" @click="click(item)">
                                    <div>
                                        <div class="stats-number" style="font-size:14px;"><i class='fa fa-braille'></i> #{item.name}#</div>
                                        <span>
                                            <img :src="'/web/assets/images/'+item.ftype+'.png'" style="width:75%;height:80px; margin: 0px 20px;">
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {{if ne .SignedUser.Company.OSpace "oneswitch"}}
                        <div class="row" style="padding-top:10px;">
                            <div class="col-lg-12" style="max-height: 5vh;overflow:auto;">
                                <input id="tags" name="tags" placeholder="{{.i18n.Tr "mxdashboard_modal_tag"}}" v-model="model.tags">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <input type="radio" v-model="model.ifshare" value="1" checked>&nbsp;{{.i18n.Tr "mxdashboard_modal_public"}}
                                <input type="radio" v-model="model.ifshare" value="0">&nbsp;{{.i18n.Tr "mxdashboard_modal_private"}}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-2">
                                <input type="checkbox" v-model="model.astemplate" value="0">&nbsp;{{.i18n.Tr "mxdashboard_modal_astemplate"}}
                            </div>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="pull-right" style="background-color:transparent;position: relative; padding:10px 15px;">
                    <a href="javascript:void(0)" type="button" class="btn btn-sm btn-primary" @click="save">{{.i18n.Tr "mxdashboard_modal_submit"}}</a>
                </div>
            </div>
        </div>
    </div>
</script>
{{template "base/footer" .}}
