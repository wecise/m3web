<!--

    [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]
    [::::::::::::::      ::::::::::::::]
    [::::::::::::::      ::::::::::::::]
    [::::::[[[[[[[:      :]]]]]]]::::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[    CODE BY WANGZD    ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [::::::[[[[[[[:      :]]]]]]]::::::]
    [::::::::::::::      ::::::::::::::]
    [::::::::::::::      ::::::::::::::]
    [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]

-->
{{template "base/head" .}}

<!-- zTree Core CSS -->
<link href="{{AppSubUrl}}/web/lib/tree/zTree/css/entitieszTreeStyle/zTreeStyle.css" type="text/css" rel="stylesheet">
<!--link href="{{AppSubUrl}}/web/lib/tree/zTree/css/font-awesome/font-awesome-zTree.css" type="text/css" rel="stylesheet">
<link href="{{AppSubUrl}}/web/lib/tree/zTree/css/font-awesome/zTreeStyle.css" type="text/css" rel="stylesheet"-->

<link href="{{AppSubUrl}}/web/lib/jquery-file-upload/css/jquery.fileupload.css" rel="stylesheet" >

<style>
    body {
        background-color: #d9e0e7;
    }

    /* For zTree */
    .ztree{
        overflow: auto;
    }

    .item-selected {
        -webkit-box-shadow: 2px 2px 5px 0px rgba(0,0,0,0.75);
        -moz-box-shadow: 2px 2px 5px 0px rgba(0,0,0,0.75);
        box-shadow: 2px 2px 5px 0px rgba(0,0,0,0.75);
    }


    /* File List Table */
    .fixed-table-container{
        border: none;
        border-radius: 0px;
    }
    .fixed-table-toolbar {
        padding: 0px 10px;
    }


    .btn-group-action > .btn.btn-default {
        color: rgb(130, 130, 130);
        background: rgb(255, 255, 255);
        border-color: rgb(255, 255, 255);
    }

    .btn-group-action .btn.btn-default:not(.active)+.btn.btn-default, .input-group-btn .btn.btn-default:not(.active)+.btn.btn-default {
        border-left-color: rgb(249, 249, 249);
    }

    .bootstrap-tagsinput {
        background-color: transparent;
        border-style: none;
        box-shadow: none;
    }

    .btn.dropdown-toggle {
        padding: 7px 12px;
        border-radius: 0px;
    }
</style>

<div id="app"></div>

<!--zTree Core JS-->
<script src="{{AppSubUrl}}/web/lib/tree/zTree/js/jquery.ztree.all-3.5.min.js"></script>

<!--File Parse JS-->
<script src="{{AppSubUrl}}/web/lib/papaparse/papaparse.min.js"></script>
<!--Jquery File Upload JS-->
<script src="{{AppSubUrl}}/web/lib/jquery-file-upload/js/load-image.all.min.js"></script>
<script src="{{AppSubUrl}}/web/lib/jquery-file-upload/js/canvas-to-blob.min.js"></script>
<script src="{{AppSubUrl}}/web/lib/jquery-file-upload/js/vendor/jquery.ui.widget.js"></script>
<script src="{{AppSubUrl}}/web/lib/jquery-file-upload/js/jquery.iframe-transport.js"></script>
<script src="{{AppSubUrl}}/web/lib/jquery-file-upload/js/jquery.fileupload.js"></script>
<script src="{{AppSubUrl}}/web/lib/jquery-file-upload/js/jquery.fileupload-process.js"></script>
<script src="{{AppSubUrl}}/web/lib/jquery-file-upload/js/jquery.fileupload-image.js"></script>

<script src="{{AppSubUrl}}/web/lib/layer/layer.js" ></script>

<script src="{{AppSubUrl}}/web/js/{{.Lang}}/app.js" type="text/javascript"></script>

<script src="{{AppSubUrl}}/web/lib/jquery/jquery-migrate-1.1.0.min.js"></script>
<script src="{{AppSubUrl}}/web/css/color/apps.min.js"></script>

<link rel="vc" href="{{AppSubUrl}}/web/component/vue-entity-graph-component.html"></link>
<link rel="vc" href="{{AppSubUrl}}/web/component/vue-search-preset-component_{{.Lang}}.html"></link>
<link rel="vc" href="{{AppSubUrl}}/web/component/vue-search-input-component.html"></link>

<script type="text/javascript">

    var eventHub = new Vue();

    VueLoader.onloaded(["vue-entity-graph-component",
                        "vue-search-preset-component",
                        "vue-search-input-component"
                        ],function() {

        $(function(){

            var timeoutId = 0;

            $(".current-active-item").html(`<a class="active item" href="/janesware/ciview" ><i class="fa fa-th-list"></i> &nbsp;{{.i18n.Tr .ActiveView }}</a>`);

            const ENTITIES_OBJECT = {
                '/matrix/entities/biz': {name: '业务'},
                '/matrix/entities/app': {name: '应用'},
                '/matrix/entities/host': {name: '服务器'},
                '/matrix/entities/network': {name: '网络'},
                '/matrix/entities/cluster': {name: '集群'},
                '/matrix/entities/storage': {name: '存储'}
            };

            Vue.component('tree-component', {
                template: '<ul class="ztree"></ul>',
                data: function () {
                    return {
                        zTree: Object,
                        setting: Object,
                        nodes: Array,
                    }
                },
                created: function () {
                    let self = this;

                    eventHub.$on('tree-init-event', self.init);
                    eventHub.$on('tree-refresh-event', self.refresh);

                    self.init();
                },
                mounted: function () {
                    let self = this;

                    self.$nextTick(function () {

                        self.setting = {
                            view: {
                                showLine: true,
                                selectedMulti: false,
                                dblClickExpand: false
                            },
                            edit: {
                                enable: false,
                            },
                            data: {
                                simpleData: {
                                    enable: true
                                },
                                key: {
                                    name: 'title',
                                    title: "title"
                                }
                            },
                            callback: {
                                onClick: self.onClick,
                            }
                        };

                    })
                },
                watch: {
                    setting: {
                        handler: function (val, oldVal) {
                            let self = this;

                            self.zTree = $.fn.zTree.init($(self.$el), val, self.nodes);
                        },
                        deep: true
                    },
                    nodes: {
                        handler: function (val, oldVal) {
                            let self = this;

                            self.zTree = $.fn.zTree.init($(self.$el), self.setting, val);

                            eventHub.$emit('file-view-event', _.filter(val, function (v) {
                                if (v.id > 1) return v;
                            }));
                        },
                        deep: true
                    }
                },
                methods: {
                    init: function () {
                        let self = this;

                        if (!_.isEmpty(self.zTree)) {
                            self.zTree.destroy();
                        }

                        jQuery.ajax({
                            url: '/fs/home',
                            type: 'GET',
                            data: {
                                type: 'dir'
                            },
                            dataType: 'text json',
                            contentType: "application/text; charset=utf-8",
                            beforeSend: function (xhr) {
                            },
                            complete: function (xhr, textStatus) {
                            },
                            success: function (data, textStatus, xhr) {

                                if (_.isEmpty(data.message)) {
                                    self.nodes = [];
                                } else {
                                    self.nodes = _.map(data.message, function (v, k) {
                                        var type = "dir";

                                        if (!_.isEmpty(v.type)) {
                                            type = v.type;
                                        }

                                        return _.merge(v, {pId: 1, isParent: v.isdir, title: v.name, type: type});
                                    });
                                }
                                let _root = {
                                    id: 1,
                                    pId: -1,
                                    isParent: true,
                                    name: 'home',
                                    title: '我的所有配置',
                                    type: 'dir',
                                    open: true
                                };

                                self.nodes.push(_root);

                                self.zTree = $.fn.zTree.init($(self.$el), self.setting, self.nodes);
                            },
                            error: function (xhr, textStatus, errorThrown) {
                                console.log(errorThrown);
                            }
                        });
                    },
                    refresh: function (event) {
                        let self = this;
                        var url = "/fs/home";

                        if (!_.isEmpty(event)) {
                            url = url + '/' + event.name
                        }
                        console.log(111, url)
                        jQuery.ajax({
                            url: url,
                            type: 'GET',
                            data: {
                                type: 'dir'
                            },
                            dataType: 'text json',
                            contentType: "application/text; charset=utf-8",
                            beforeSend: function (xhr) {
                            },
                            complete: function (xhr, textStatus) {
                            },
                            success: function (data, textStatus, xhr) {

                                if (_.isEmpty(data.message)) {
                                    self.nodes = [];
                                } else {
                                    self.nodes = _.map(data.message, function (v, k) {
                                        var type = "dir";

                                        if (!_.isEmpty(v.type)) {
                                            type = v.type;
                                        }
                                        return _.merge(v, {pId: 1, isParent: v.isdir, title: v.name, type: type});
                                    });
                                }

                                self.nodes.push({
                                    id: 1,
                                    pId: -1,
                                    isParent: true,
                                    name: 'home',
                                    title: '我的所有配置',
                                    type: 'dir',
                                    open: true
                                });
                            },
                            error: function (xhr, textStatus, errorThrown) {
                                console.log(errorThrown);
                            }
                        });
                    },
                    onClick: function (event, treeId, treeNode) {
                        let self = this;

                        if (!treeNode.isParent) return false;

                        if (treeNode.type === 'dir' && treeNode.id === 1) {
                            self.refresh(null);
                            return false;
                        } else if (treeNode.type === 'dir') {
                            jQuery.ajax({
                                url: url = '/fs/home/' + treeNode.name,
                                type: 'GET',
                                dataType: 'text json',
                                data: {
                                    type: 'dir'
                                },
                                beforeSend: function (xhr) {
                                },
                                complete: function (xhr, textStatus) {
                                },
                                success: function (data, textStatus, xhr) {

                                    if (!_.isEmpty(data.message)) {

                                        var tree = $.fn.zTree.getZTreeObj(self.zTree.setting.treeId);
                                        var nodes = tree.getSelectedNodes();
                                        if (nodes && nodes.length > 0) {
                                            tree.removeChildNodes(nodes[0]);
                                        }

                                        // append sub nodes
                                        var subNodes = _.map(data.message, function (v, k) {
                                            var type = "dir";

                                            if (!_.isEmpty(v.type)) {
                                                type = v.type;
                                            }
                                            return _.merge(v, {
                                                pId: treeNode.id,
                                                isParent: v.isdir,
                                                title: v.name,
                                                type: type
                                            })
                                        });

                                        tree.addNodes(treeNode, subNodes);

                                        var parentObj = [{
                                            id: treeNode.id,
                                            name: treeNode.parent,
                                            title: "..",
                                            parent: treeNode.name,
                                            type: 'parent'
                                        }];
                                        subNodes.unshift(parentObj[0]);
                                        eventHub.$emit('file-view-event', _.filter(subNodes, function (v) {
                                            if (v.id > 1) return v;
                                        }));
                                    }

                                    //if(!treeNode.isParent) {
                                    //console.log(222,treeNode.name)
                                    //eventHub.$emit('node-selected-event', treeNode.name);
                                    //}

                                },
                                error: function (xhr, textStatus, errorThrown) {
                                    console.log(errorThrown);
                                }
                            });
                        }
                    }
                }
            })

            Vue.component('bootstrap-table', {
                template: `<table :id="id" :class="classes"></table>`,
                props: {
                    columns: Array,
                    dataset: Array,
                    options: Object,
                    classes: String,
                    id: String
                },
                data: function () {
                    return {
                        defaultOptions: {
                            classes: "table table-no-bordered",
                            //resizable: true,
                            //showToggle: false,
                            //showColumns: true,
                            //pagination: true,
                            //toolbar: "#custom-toolbar1",
                            //showExport: true,
                            //exportTypes: "['json', 'csv', 'excel']",
                        }
                    }
                },
                watch: {
                    dataset: function (val, oldVal) {
                        let self = this;

                        var cols = $(self.$el).bootstrapTable('getVisibleColumns');

                        if (_.isEmpty(cols)) { // table null
                            $(self.$el).bootstrapTable('destroy').bootstrapTable(_.extend({
                                data: val,
                                columns: self.columns
                            }, self.options));
                        } else {
                            /*$(self.$el).bootstrapTable('load',val);
                        $(self.$el).bootstrapTable('refreshOptions', val);*/
                            $(self.$el).bootstrapTable('destroy').bootstrapTable(_.extend({
                                data: val,
                                columns: self.columns
                            }, self.options));
                        }
                    }
                },
                mounted: function () {
                    let self = this;

                    self.$nextTick(function () {

                        $(self.$el).bootstrapTable(_.extend({
                            data: self.dataset,
                            columns: self.columns
                        }, self.options));


                    })
                }
            });

            Vue.component('bootstraptag-component', {
                delimiters: ['${', '}'],
                template: `<input class="tagsLabel" :value="item.tag._all" placeholder='{{.i18n.Tr "mxdashboard_tag_add"}}'>`,
                mounted: function () {
                    let self = this;

                    self.$nextTick(function () {
                        self.init();
                    })
                },
                methods: {
                    init: function () {
                        let self = this;

                        $(self.$el).tagsinput({
                            tagClass: function (item) {

                                if (item.indexOf("事件") > -1 || item.indexOf("event") > -1) {
                                    return 'label label-danger label-important';
                                } else if (item.indexOf("性能") > -1 || item.indexOf("performance") > -1) {
                                    return 'label label-warning';
                                } else if (item.indexOf("日志") > -1 || item.indexOf("log") > -1 || item.indexOf("蓝色") > -1) {
                                    return 'label label-primary';
                                } else if (item.indexOf("作业") > -1 || item.indexOf("job") > -1 || item.indexOf("绿色") > -1) {
                                    return 'label label-success';
                                } else if (item.indexOf("黑色") > -1) {
                                    return 'label label-default';
                                } else {
                                    return 'label label-default';
                                }
                            },
                        })

                        $(self.$el).on('itemAdded', function (event) {

                            var index = $(this).data("index");

                            self.search.result.data[index].tag._all.push(event.item);

                            jQuery.ajax({
                                url: '/mxobject/actiontoclass',
                                type: 'POST',
                                dataType: 'json',
                                data: {
                                    data: JSON.stringify(self.search.result.data[index]),
                                    ctype: "insert"
                                },
                                beforeSend: function (xhr) {
                                },
                                complete: function (xhr, textStatus) {
                                },
                                success: function (data, textStatus, xhr) {
                                },
                                error: function (xhr, textStatus, errorThrown) {
                                }
                            });
                        })

                        $(self.$el).on('itemRemoved', function (event) {

                            var index = $(this).data("index");

                            self.search.result.data[index].tag._all = _.pull(self.search.result.data[index].tag._all, event.item);

                            jQuery.ajax({
                                url: '/mxobject/actiontoclass',
                                type: 'POST',
                                dataType: 'json',
                                data: {
                                    data: JSON.stringify(self.search.result.data[index]),
                                    ctype: "insert"
                                },
                                beforeSend: function (xhr) {
                                },
                                complete: function (xhr, textStatus) {
                                },
                                success: function (data, textStatus, xhr) {

                                },
                                error: function (xhr, textStatus, errorThrown) {
                                }
                            });
                        })
                    }
                }
            })

            Vue.component('file-view-component', {
                delimiters: ['${', '}'],
                template: `#file-view-component-template`,
                data: function () {
                    return {
                        model: {
                            list: [],
                            theme: "",
                            parse: {
                                list: []
                            }
                        },
                        contextmenu: {
                            container: {},
                            dir: {},
                            file: {},
                            selected: {
                                "attr": "",
                                "class": "/matrix/filesystem",
                                "connect": null,
                                "contain": null,
                                "day": "2018-01-05T00:00:00Z",
                                "depend": null,
                                "fullname": "/home/admin/home/",
                                "id": "8361732965156122567",
                                "isParent": true,
                                "isdir": true,
                                "md5": "d41d8cd98f00b204e9800998ecf8427e",
                                "mshare": null,
                                "name": "",
                                "owner": null,
                                "pId": 1,
                                "parent": "/home",
                                "refer": null,
                                "runon": null,
                                "status": 0,
                                "tag": null,
                                "title": "",
                                "type": "dir",
                                "vshare": null,
                                "vtime": "2018-01-04T17:18:48.287Z"
                            }
                        },
                        upload: {
                            option: {
                                url: '/fs/home',
                                dataType: 'json',
                                autoUpload: false,
                                acceptFileTypes: /(\.|\/)(gif|jpe?g|png|csv|log|pdf|html|txt)$/i,
                                maxFileSize: 999000,
                                disableImageResize: /Android(?!.*Chrome)|Opera/.test(window.navigator.userAgent),
                                previewMaxWidth: 100,
                                previewMaxHeight: 100,
                                previewCrop: true
                            },
                            swal: {}
                        },
                        currentView: 'file-view-table-component',
                    }
                },
                mounted: function () {
                    let self = this;

                    self.$nextTick(function () {
                        self.init();

                        $(self.$el).dblclick(function () {
                            $(self.$el).find('.item-selected').removeClass('item-selected');
                        })
                    })
                },
                watch: {

                },
                created: function () {
                    let self = this;

                    eventHub.$on('file-view-event', self.setData);

                    eventHub.$on("file-mouseover-event", self.mouseOver);
                    eventHub.$on("file-mouseout-event", self.mouseOut);
                    eventHub.$on("file-click-event", self.click);
                    eventHub.$on("file-dblclick-event", self.dblClick);
                    eventHub.$on("file-rightclick-event", self.rightClick);

                    eventHub.$on("view-toggle-event", self.view);

                },
                methods: {
                    init: function () {
                        let self = this;

                        self.initContentMenu();
                        self.initFileUpload();

                    },
                    initFileUpload: function () {
                        let self = this;
                        var uploadButton = $('<button/>')
                            .addClass('btn btn-primary')
                            .prop('disabled', true)
                            .text('Processing...')
                            .on('click', function () {
                                var $this = $(this),
                                    data = $this.data();
                                $this
                                    .off('click')
                                    .text('中止')
                                    .on('click', function () {
                                        $this.remove();
                                        data.abort();
                                    });
                                data.submit().always(function () {
                                    $this.remove();
                                });
                            });

                        $('#fileupload').fileupload(self.upload.option)
                            .on('fileuploadadd', function (e, data) {
                                self.swal = swal({
                                    title: '',
                                    type: 'info',
                                    html: `  <div id="progress" class="progress">
                                                    <div class="progress-bar progress-bar-success"></div>
                                                </div>
                                                <div id="files" class="files"></div>`,
                                    showConfirmButton: false,
                                });
                                data.context = $('<div/>').appendTo('#files');
                                $.each(data.files, function (index, file) {
                                    var node = $('<p/>')
                                        .append($('<span/>').text(file.name));
                                    if (!index) {
                                        node
                                            .append('<br>')
                                            .append(uploadButton.clone(true).data(data));
                                    }
                                    node.appendTo(data.context);
                                });
                            })
                            .on('fileuploadprocessalways', function (e, data) {
                                var index = data.index,
                                    file = data.files[index],
                                    node = $(data.context.children()[index]);
                                if (file.preview) {
                                    node
                                        .prepend('<hr>')
                                        .prepend(file.preview);
                                }
                                if (file.error) {
                                    node
                                        .append('<hr>')
                                        .append($('<span class="text-danger"/>').text(file.error));
                                }
                                if (index + 1 === data.files.length) {
                                    data.context.find('button')
                                        .text('上传')
                                        .prop('disabled', !!data.files.error);
                                }
                            })
                            .on('fileuploadprogressall', function (e, data) {
                                var progress = parseInt(data.loaded / data.total * 100, 10);
                                $('#progress .progress-bar').css(
                                    'width',
                                    progress + '%'
                                );
                            })
                            .on('fileuploaddone', function (e, data) {
                                $.each(data.result.files, function (index, file) {
                                    if (file.url) {
                                        var link = $('<a>')
                                            .attr('target', '_blank')
                                            .prop('href', file.url);
                                        $(data.context.children()[index])
                                            .wrap(link);
                                    } else if (file.error) {
                                        var error = $('<span class="text-danger"/>').text(file.error);
                                        $(data.context.children()[index])
                                            .append('<br>')
                                            .append(error);
                                    }
                                });

                                eventHub.$emit('tree-refresh-event', null);

                                swal.close();

                            })
                            .on('fileuploadfail', function (e, data) {
                                $.each(data.files, function (index) {
                                    var error = $('<span class="text-danger"/>').text('上传失败。');
                                    $(data.context.children()[index])
                                        .append('<br>')
                                        .append(error);
                                });
                                swal.close();
                            })
                            .prop('disabled', !$.support.fileInput)
                            .parent().addClass($.support.fileInput ? undefined : 'disabled');
                    },
                    initContentMenu: function () {
                        let self = this;
                        let _menu = {
                            "open": {
                                name: "打开", icon: "fa-folder-o",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    let _item = $(this).data("item");
                                    self.open(_item);
                                }
                            },
                            "download": {
                                name: "下载", icon: "fa-cloud-download",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    let _item = $(this).data("item");
                                    self.download(_item);
                                }
                            },
                            "-": "-",
                            "new-folder": {
                                name: "新建配置组", icon: "fa-copy",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    let _item = $(this).data("item");
                                    console.log($(this).data("item"))
                                    self.mkdir(_item);
                                }
                            },
                            "new-ci": {
                                name: "新建配置项", icon: "fa-paste",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    let _item = $(this).data("item");
                                    //self.mkfile(_item);
                                }
                            },
                            "delete": {
                                name: "删除", icon: "fa-trash",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    let _item = $(this).data("item");
                                    self.delete(_item);
                                }
                            },
                            "--": "--",
                            "history": {
                                name: "配置历史", icon: "fa-clock-o",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    let _item = $(this).data("item");
                                    self.open(_item);
                                }
                            },
                            "detail": {
                                name: "配置卡片", icon: "fa-tasks",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    self.look('config', '');
                                }
                            },
                            "compare": {
                                name: "配置比对", icon: "fa-list-alt",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    self.look('config', '');
                                }
                            },
                            "connect": {
                                name: "配置关联", icon: "fa-sitemap",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    let _item = $(this).data("item");
                                    self.open(_item);
                                }
                            },
                            "---": "---",
                            "event": {
                                name: "事件", icon: "fa-warning",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    self.look('itsm', '/janesware/event');
                                }
                            },
                            "performance": {
                                name: "性能", icon: "fa-line-chart",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    self.look('itsm', '/janesware/performance');
                                }
                            },
                            "log": {
                                name: "日志", icon: "fa-file-code-o",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    self.look('itsm', '/janesware/log');
                                }
                            },
                            "----": "----",
                            "new-content": {
                                name: "新增", icon: "fa-plus",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    swal("新增", "新增配置相关内容", "info");
                                }
                            }
                        };

                        $.contextMenu({
                            selector: '.context-menu-file',
                            callback: function (key, options) {
                                var m = "clicked: " + key;
                                console.log(m);
                            },
                            items: _menu
                        });

                        $.contextMenu({
                            selector: '.context-menu-content',
                            callback: function (key, options) {
                                var m = "clicked: " + key;
                                console.log(m);
                            },
                            items: {
                                "new-folder": {
                                    name: "新建配置组", icon: "copy",
                                    callback: function (itemKey, opt, rootMenu, originalEvent) {
                                        let _item = $(this).data("item") || self.contextmenu.selected;
                                        self.mkdir(_item);
                                    }
                                },
                                "new-ci": {
                                    name: "新建配置项", icon: "paste",
                                    callback: function (itemKey, opt, rootMenu, originalEvent) {
                                        let _item = $(this).data("item") || self.contextmenu.selected;
                                        //self.mkfile(_item);
                                    }
                                },
                                "----": "----",
                                "new-content": {
                                    name: "新增", icon: "fa fa-exit",
                                    callback: function (itemKey, opt, rootMenu, originalEvent) {
                                        swal("新增", "新增配置相关内容", "info");
                                    }
                                }
                            }
                        });
                    },
                    mouseOver: function (event) {
                        let self = this;

                        $('#file_' + event.id).find('.widget').addClass('item-selected');
                    },
                    mouseOut: function (event) {
                        let self = this;

                        $('#file_' + event.id).find('.item-selected').removeClass('item-selected');
                    },
                    click: function (event) {
                        let self = this;

                        $(self.$el).find('.item-selected').removeClass('item-selected');
                        $('#file_' + event.id).find('.widget').addClass('item-selected');

                        self.contextmenu.selected = event;
                    },
                    dblClick: function (item) {
                        let self = this;
                        var parentObj = [{
                            id: _.random(item.id),
                            name: item.parent,
                            title: "..",
                            parent: item.name,
                            type: 'parent'
                        }];

                        if (item.type === 'dir') {
                            jQuery.ajax({
                                url: '/fs/home/' + item.name,
                                type: 'GET',
                                dataType: 'text json',
                                contentType: "application/text; charset=utf-8",
                                data: {
                                    type: 'dir'
                                },
                                beforeSend: function (xhr) {
                                },
                                complete: function (xhr, textStatus) {
                                },
                                success: function (data, textStatus, xhr) {

                                    var rtn = data.message;

                                    if (!_.isEmpty(rtn)) {
                                        rtn = _.map(rtn, function (v, k) {
                                            return _.merge(v, {title: v.name});
                                        });
                                        rtn.unshift(parentObj[0]);
                                        eventHub.$emit('file-view-event', rtn);
                                    } else {
                                        eventHub.$emit('file-view-event', parentObj);
                                    }
                                },
                                error: function (xhr, textStatus, errorThrown) {
                                    console.log(errorThrown);
                                }
                            });
                        } else if (item.type === 'parent') {

                            jQuery.ajax({
                                url: '/fs/home/' + item.parent,
                                type: 'GET',
                                dataType: 'text json',
                                contentType: "application/text; charset=utf-8",
                                data: {
                                    type: 'dir'
                                },
                                beforeSend: function (xhr) {
                                },
                                complete: function (xhr, textStatus) {
                                },
                                success: function (data, textStatus, xhr) {

                                    var rtn = data.message;

                                    if (!_.isEmpty(rtn)) {
                                        rtn = _.map(rtn, function (v, k) {
                                            return _.merge(v, {title: v.name});
                                        });
                                        rtn.unshift(parentObj[0]);
                                        eventHub.$emit('file-view-event', rtn);
                                    } else {
                                        eventHub.$emit('file-view-event', parentObj);
                                    }
                                },
                                error: function (xhr, textStatus, errorThrown) {
                                    console.log(errorThrown);
                                }
                            });
                        } else {
                            self.open();
                        }
                    },
                    rightClick: function (item) {
                        let self = this;

                        alert(item.name)
                    },
                    setData: function (event) {
                        let self = this;

                        self.model.list = event;
                    },
                    mkdir: function (item) {
                        let self = this;

                        swal({
                            title: '输入名称',
                            input: 'text',
                            showCancelButton: true,
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            inputValidator: function (value) {
                                return new Promise(function (resolve, reject) {
                                    if (value) {
                                        var url = "";

                                        if (_.isEmpty(item.name)) {
                                            url = '/fs/home/' + value;
                                        } else {
                                            url = '/fs' + item.parent + '/' + item.name + '/' + value;
                                        }
                                        console.log(url)
                                        jQuery.ajax({
                                            url: url,
                                            type: 'PUT',
                                            dataType: 'text',
                                            contentType: "application/x-www-form-urlencoded",
                                            data: {
                                                type: 'dir'
                                            },
                                            beforeSend: function (xhr) {
                                            },
                                            complete: function (xhr, textStatus) {
                                            },
                                            success: function (data, textStatus, xhr) {
                                                eventHub.$emit('tree-refresh-event', null);
                                                resolve();
                                            },
                                            error: function (xhr, textStatus, errorThrown) {
                                                console.log(errorThrown);
                                            }
                                        });
                                    } else {
                                        reject('输入名称!')
                                    }
                                })
                            }
                        }).then(
                            function () {

                            }
                        )
                    },
                    open: function (item) {
                        let self = this;

                        if (_.isEmpty(item.name)) return false;

                        if (item.type === 'dir') {
                            self.dblClick(item);
                        } else {
                            var contents = '/fs' + item.parent + '/' + item.name + '?type=download';

                            if (item.type === 'png') {
                                contents = `<img src="/fs` + item.parent + `/` + item.name + `?type=download" class="img-responsive" alt="Image">`;
                            }

                            layer.open({
                                type: 2,
                                title: item.name,
                                shadeClose: true,
                                shade: false,
                                maxmin: true,
                                area: ['1024px', '600px'],
                                content: contents
                            });
                        }
                    },
                    download: function (item) {
                        let self = this;

                        if (_.isEmpty(item.name)) return false;

                        window.location = '/fs' + item.parent + '/' + item.name + '?type=download';
                    },
                    delete: function (item) {
                        let self = this;

                        if (_.isEmpty(item.name)) return false;

                        console.log('/fs' + item.parent + '/' + item.name);

                        jQuery.ajax({
                            url: '/fs' + item.parent + '/' + item.name,
                            type: 'DELETE',
                            dataType: 'text json',
                            contentType: "application/text; charset=utf-8",
                            beforeSend: function (xhr) {
                            },
                            complete: function (xhr, textStatus) {
                            },
                            success: function (data, textStatus, xhr) {
                                eventHub.$emit('tree-refresh-event', null);
                            },
                            error: function (xhr, textStatus, errorThrown) {
                                console.log(xhr, textStatus, errorThrown);
                                eventHub.$emit('tree-refresh-event', null);
                            }
                        });
                    },
                    parse: function (event) {
                        let self = this;
                        console.log("/web/data/" + event)
                        Papa.parse("/web/data/" + event, {
                            download: true,
                            complete: function (results, file) {
                                //self.model.list = results.data;
                                //console.log("Parsing complete:", JSON.stringify(results), file);
                            },
                            step: function (results, parser) {
                                //console.log("Row data:", JSON.stringify(results.data));
                                self.model.parse.list.push(results.data[0].join(" "));
                            }
                        })

                        if ($(".parse-container").hasClass('parse-container-active')) {
                            console.log(1)
                            $(".parse-container").removeClass('parse-container-active');
                            $(".parse-container").css("display", "none");
                        } else {
                            console.log(2)
                            $(".parse-container").addClass('parse-container-active');
                            $(".parse-container").css("display", "");
                        }
                    },
                    look: function (type, view) {
                        if (type == 'config') {
                            var win;
                            var w = $(window).width();//document.body.clientWidth;
                            var h = $(window).height();//(document.body.clientHeight || document.documentElement.clientHeight);
                            var wW = $(window).width() * 2 / 5;
                            var hH = $(window).height() * 2.2 / 3;
                            var lrwh = [(w - wW) / 2, (h - hH) / 2, wW, hH];
                            var tb = document.createElement('div');

                            $(tb).append(`<div id="panel-config"></div>`);
                            win = new mxWindow('配置卡片', tb, lrwh[0], lrwh[1], lrwh[2], lrwh[3], true, true);
                            win.setMaximizable(true);
                            win.setResizable(true);
                            win.setClosable(true);
                            win.setVisible(true);

                            _.delay(function () {
                                var detailVue = new Vue({
                                    delimiters: ['$', '$'],
                                    el: '#panel-config',
                                    template: ` <div class="panel">
                                                <div class="panel-body panel-form">
                                                    <form class="form-horizontal form-bordered" data-parsley-validate="true" name="demo-form" novalidate="">
                                                        <div class="form-group" v-for="(item,index) in _.sortBy(model,'name')">
                                                            <label class="control-label col-md-3 col-sm-3" for="fullname" :id="item.name">$item.title$</label>
                                                            <div class="col-md-9 col-sm-9" style="width:75%;">
                                                                <textarea class="form-control" :id="'textarea_'+item.name" :placeholder="item.title" style="border:none;">$item.value$</textarea>
                                                            </div>
                                                        </div>

                                                    </form>
                                                </div>
                                                <div class="panel-footer">
                                                </div>
                                            </div>`,
                                    data: {
                                        model: [],
                                        attribute: [
                                            {name: 'model', title: '型号'},
                                            {name: 'type', title: '类型'},
                                            {name: 'company', title: '厂商'},
                                            {name: 'ctel', title: '厂商联系电话'},
                                            {name: 'sn', title: '序列号'},
                                            {name: 'host', title: 'Host'},
                                            {name: 'ip', title: 'IP'},
                                            {name: 'dc', title: '数据中心'},
                                            {name: 'room', title: '房间'},
                                            {name: 'rack', title: '机柜'},
                                            {name: 'unit', title: '机架'},
                                            {name: 'location', title: '地点'},
                                            {name: 'region', title: '所属地点'},
                                            {name: 'biz ', title: '所属业务'},
                                            {name: 'department', title: '负责部门'},
                                            {name: 'contact', title: '联系人'},
                                            {name: 'tel', title: '联系人电话'},
                                            {name: 'assetid', title: '资产编号'},
                                            {name: 'period', title: '保修期'},
                                            {name: 'config', title: '详细配置'},
                                            {name: 'files', title: '配置文件列表'},
                                            {name: 'element', title: '组成实体的元素'}
                                        ]
                                    },
                                    mounted: function () {
                                        let self = this;

                                        self.$nextTick(function () {

                                            self.init();

                                            $(self.$el).on('click keyup keydown', 'textarea', function () {
                                                $(this).height(0).height(this.scrollHeight);
                                            }).find('textarea').change();

                                        })

                                    },
                                    methods: {
                                        autosize: function () {
                                            $("textarea").each(function (textarea) {
                                                $this.height($this[0].scrollHeight);
                                            });
                                        },
                                        init: function () {
                                            let self = this;
                                            let _param = `#/matrix/entity/vm/vmware/linux`;

                                            jQuery.ajax({
                                                url: '/mxobject/search',
                                                type: 'POST',
                                                dataType: 'json',
                                                data: {
                                                    cond: _param,
                                                    flag: false
                                                },
                                                beforeSend: function (xhr) {
                                                },
                                                complete: function (xhr, textStatus) {
                                                },
                                                success: function (data, textStatus, xhr) {

                                                    _.forEach(_.sample(data.message), function (v, k) {
                                                        let _attribute = _.filter(self.attribute, {name: k})[0];

                                                        if (!_.isEmpty(_attribute)) {
                                                            if (_.isObject(v) && v != null) {
                                                                self.model = _.map(v, function (val, key) {
                                                                    return {
                                                                        name: key,
                                                                        title: _.upperFirst(key),
                                                                        value: val
                                                                    };
                                                                })
                                                            } else {
                                                                self.model.push({
                                                                    name: k,
                                                                    title: _attribute.title,
                                                                    value: v
                                                                });
                                                            }
                                                        }
                                                    })
                                                },
                                                error: function (xhr, textStatus, errorThrown) {
                                                    console.warn("[" + moment().format("LLL") + "] [" + xhr.status + "] " + xhr.responseText);
                                                }
                                            });
                                        }
                                    }
                                });
                            }, 500)

                        } else {
                            window.open(
                                view,
                                "_blank"
                            );
                        }
                    },
                    view: function (event) {
                        let self = this;

                        self.currentView = event;

                        $("a.btn-xs").removeClass('active');
                        $("." + event).addClass('active');
                    }
                }
            })

            Vue.component('file-view-icon-component', {
                delimiters: ['${', '}'],
                props: {
                    model: Array
                },
                template: `#file-view-icon-component-template`,
                mounted: function () {
                    let self = this;

                    self.$nextTick(function () {

                    })
                },
                methods: {
                    mouseOver: function (item) {
                        eventHub.$emit("file-mouseover-event", item);
                    },
                    mouseOut: function (item) {
                        eventHub.$emit("file-mouseout-event", item);
                    },
                    click: function (item) {
                        eventHub.$emit("file-click-event", item);
                    },
                    dblClick: function (item) {
                        eventHub.$emit("file-dblclick-event", item);
                    },
                    rightClick: function (item) {
                        eventHub.$emit("file-rightclick-event", item);
                    }
                }
            })

            Vue.component('file-view-table-component', {
                delimiters: ['${', '}'],
                props: {
                    model: Array
                },
                template: `#file-view-table-component-template`,
                data: function () {
                    return {
                        columns: [
                            {field: "state", title: "", checkbox: true},
                            {field: "title", title: "Name"},
                            {field: "type", title: "Type"},
                            {
                                field: "modtime", title: "Create Time", formatter: function (value, row, index) {
                                    return moment(value).format("LLL");
                                }
                            },
                        ],
                        data: [],
                        options: {
                            class: "table table-no-bordered",
                            showColumns: false,
                            search: false,
                            clickToSelect: true,
                            pageList: [15, 30, 60, 80, 100],
                            pageSize: 15,
                            rowStyle: "tableRowStyle",
                            height: 400,
                        },
                    }
                },
                watch: {
                    model: {
                        handler: function (val, oldValue) {
                            let self = this;

                            self.data = val;
                        },
                        deep: true
                    }
                },
                mounted: function () {
                    let self = this;

                    self.$nextTick(function () {
                        _.delay(function () {
                            self.initContentMenu();
                        }, 1000)
                    })
                },
                methods: {
                    init: function () {
                        let self = this;
                    },
                    initContentMenu: function () {
                        let self = this;

                        let _menu = {
                            "open": {
                                name: "打开", icon: "fa-folder-o",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    let _item = $(this).data("item");
                                    self.open(_item);
                                }
                            },
                            "download": {
                                name: "下载", icon: "fa-cloud-download",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    let _item = $(this).data("item");
                                    self.download(_item);
                                }
                            },
                            "-": "-",
                            "new-folder": {
                                name: "新建配置组", icon: "fa-copy",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    let _item = $(this).data("item");
                                    console.log($(this).data("item"))
                                    self.mkdir(_item);
                                }
                            },
                            "new-ci": {
                                name: "新建配置项", icon: "fa-paste",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    let _item = $(this).data("item");
                                    //self.mkfile(_item);
                                }
                            },
                            "delete": {
                                name: "删除", icon: "fa-trash",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    let _item = $(this).data("item");
                                    self.delete(_item);
                                }
                            },
                            "--": "--",
                            "history": {
                                name: "历史", icon: "fa-clock-o",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    let _item = $(this).data("item");
                                    self.open(_item);
                                }
                            },
                            "detail": {
                                name: "配置卡片", icon: "fa-tasks",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    self.look('config', '');
                                }
                            },
                            "compare": {
                                name: "配置比对", icon: "fa-list-alt",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    self.look('config', '');
                                }
                            },
                            "---": "---",
                            "event": {
                                name: "事件", icon: "fa-warning",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    self.look('itsm', '/janesware/event');
                                }
                            },
                            "performance": {
                                name: "性能", icon: "fa-line-chart",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    self.look('itsm', '/janesware/performance');
                                }
                            },
                            "log": {
                                name: "日志", icon: "fa-file-code-o",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    self.look('itsm', '/janesware/log');
                                }
                            },
                            "----": "----",
                            "new-content": {
                                name: "新增", icon: "fa-plus",
                                callback: function (itemKey, opt, rootMenu, originalEvent) {
                                    swal("新增", "新增配置相关内容", "info");
                                }
                            }
                        };

                        $.contextMenu({
                            selector: '#file-list-table td',
                            callback: function (key, options) {
                                var m = "clicked: " + key;
                                console.log(m);
                            },
                            items: _menu
                        });
                    }
                }
            })

            Vue.component('graph-list-component', {
                delimiters: ['${', '}'],
                template: '#graph-list-template',
                data: function(){
                    return {
                        model: [],
                        search: {
                            class: "/matrix/filesystem",
                            params: ['#', '/matrix/filesystem/: | type=imap', '| top 200'],
                            term: "",
                            default: {},
                            fortime: " for vtime ",
                            inputModel: {type: "graph", quick: ""},
                            filter: [],
                        }
                    }

                },
                mounted: function() {
                    let self = this;

                    self.$nextTick(function() {
                        self.init();
                        self.load();
                    })
                },
                watch: {
                    model: function(newValue, oldValue) {
                        let self = this;

                        if (!_.isEqual(newValue, oldValue)) {
                            self.refresh();
                        }
                    }
                },
                created: function() {
                    let self = this;

                    eventHub.$on("input-term-event", self.setSearchTerm);
                    eventHub.$on("input-reset-event", self.setSearchReset);
                    eventHub.$on('preset-others-event',self.setPresetOthers);
                    eventHub.$on('preset-selected-event', self.setPresetDefault);
                },
                methods: {
                    init: function() {
                        let self = this;

                    },
                    setPresetDefault: function(event){
                        let self = this;

                        self.search.default = event;
                    },
                    setPresetOthers: function(event){
                        let self = this;

                        self.search.fortime = event.forTime;
                    },
                    setSearchReset: function(){
                        let self = this;
                        var param = self.search.params.join("");

                        param = param + self.search.default.value + self.search.fortime;

                        self.setSearchTerm("");
                        self.searchHandler(param, null);
                    },
                    setSearchTerm: function (event){
                        let self = this;

                        self.search.term = event;
                    },
                    onSearch: function() {
                        let self = this;

                        var param = "";

                        if(!_.isUndefined(self.search.term) && !_.isNull(self.search.term)  && self.search.term.length > 0){
                            param = self.search.params[0] + self.search.params[1] + self.search.params[2]  + self.search.params[3] + self.search.params[4] + self.search.term;
                        } else {
                            param = self.search.params.join("");
                        }

                        if(!_.isEmpty(self.search.default.value)) {
                            param = param + self.search.default.value + self.search.fortime;
                        } else {
                            param = param + self.search.default.value ;
                        }

                        param = param.replace(/undefined/g,"");

                        self.searchHandler(param,null);
                    },
                    searchHandler: function(param,func) {
                        let self = this;

                        console.log(param)
                        jQuery.ajax({
                            url: '/mxobject/search',
                            type: 'POST',
                            dataType: 'json',
                            data: {
                                cond: param,
                                flag: false
                            },
                            beforeSend: function(xhr) {
                            },
                            complete: function(xhr, textStatus) {
                            },
                            success: function(data, textStatus, xhr) {

                                var data = data.message;

                                self.model = _.map(data,function(v,k){
                                    return _.merge(v, {"username": '{{.SignedUser.Name}}', "star": "", "tag": {"_all": ""}});
                                });
                                _.delay(self.refresh,100);
                            },
                            error: function(xhr, textStatus, errorThrown) {
                                console.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                            }
                        })
                    },
                    load: function() {
                        let self = this;

                        jQuery.ajax({
                            url: '/fs/home/itmap',
                            type: 'GET',
                            dataType: 'text json',
                            contentType: "application/text; charset=utf-8",
                            data: {
                                type: 'dir'
                            },
                            beforeSend: function(xhr) {
                            },
                            complete: function(xhr, textStatus) {
                            },
                            success: function(data, textStatus, xhr) {
console.log(22,data)
                                var data = data.message;

                                self.model = _.map(data,function(v,k){
                                    return _.merge(v, {"username": '{{.SignedUser.Name}}', "star": "", "tag": {"_all": ""}});
                                });

                                _.delay(self.refresh, 500);
                            },
                            error: function(xhr, textStatus, errorThrown) {
                                console.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                            }
                        });
                    },
                    newModal: function() {
                        let self = this;
                        selectedTemplate = $(this).data("id");

                        var modal = $("#addDashBoardModal");
                        modal.modal("show");
                        //modal.find('#name').val(selectedTemplate + "_" + Math.floor(_.now()/1000));
                        modal.find('#title').val('');
                        modal.find('#tags').selectpicker('val', selectedTemplate);

                        $("#tags").tagsinput({
                            tagClass: function(item) {

                                if (item.indexOf("事件") > -1 || item.indexOf("event") > -1) {
                                    return 'label label-danger label-important';
                                } else if (item.indexOf("性能") > -1 || item.indexOf("performance") > -1) {
                                    return 'label label-warning';
                                } else if (item.indexOf("日志") > -1 || item.indexOf("log") > -1 || item.indexOf("蓝色") > -1) {
                                    return 'label label-primary';
                                } else if (item.indexOf("作业") > -1 || item.indexOf("job") > -1 || item.indexOf("绿色") > -1) {
                                    return 'label label-success';
                                } else if (item.indexOf("黑色") > -1) {
                                    return 'label label-default';
                                } else {
                                    return 'label label-default';
                                }
                            },
                        })
                    },
                    add: function() {
                        let self = this;
                        var modal = $("#addDashBoardModal");
                        var name = modal.find('#title').val() + ".imap";//"itmap_" + _.now(); //modal.find('#name').val();
                        if (_.isEmpty(name)) {
                            swal("地图标题不能空！", "", "warning");
                            modal.find('#title').setFocus();
                            return false;
                        }

                        jQuery.ajax({
                            url: '/fs/home/itmap/'+ name,
                            type: 'PUT',
                            contentType: "application/text; charset=utf-8",
                            data: {
                                type: 'file'
                            },
                            beforeSend: function(xhr) {
                            },
                            complete: function(xhr, textStatus) {
                            },
                            success: function(data, textStatus, xhr) {
                                modal.modal("hide");
                                _.delay(function() {
                                    self.load();
                                }, 200);
                            },
                            error: function(xhr, textStatus, errorThrown) {
                                console.log(xhr,textStatus,errorThrown);
                            }
                        })
                    },
                    remove: function(event) {
                        let self = this;

                        swal({
                            title: event.name,
                            text: "Confirm Delete it?",
                            type: "warning",
                            showCancelButton: true,
                            closeOnConfirm: false,
                            cancelButtonText: "Cancel",
                            confirmButtonText: "Delete",
                            confirmButtonColor: "#ff0000"
                        }).then(function () {

                            jQuery.ajax({
                                url: '/fs' + event.parent + '/' + event.name,
                                type: 'DELETE',
                                dataType: 'text json',
                                contentType: "application/text; charset=utf-8",
                                beforeSend: function(xhr) {
                                },
                                complete: function(xhr, textStatus) {
                                },
                                success: function(data, textStatus, xhr) {

                                    if (data.status == "ok") {
                                        _.delay(function() {
                                            swal("Success deleted！", "", "success");
                                            self.load();
                                        }, 300);
                                    } else {
                                        swal("Delete failed", data.message, "warning");
                                    }
                                },
                                error: function(xhr, textStatus, errorThrown) {
                                    console.log(errorThrown)
                                    self.load();
                                }
                            });

                        })
                    },
                    refresh: function() {
                        let self = this;

                        $(".tagsLabel").tagsinput({
                            tagClass: function(item) {

                                if (item.indexOf("事件") > -1 || item.indexOf("event") > -1) {
                                    return 'label label-danger label-important';
                                } else if (item.indexOf("性能") > -1 || item.indexOf("performance") > -1) {
                                    return 'label label-warning';
                                } else if (item.indexOf("日志") > -1 || item.indexOf("log") > -1 || item.indexOf("蓝色") > -1) {
                                    return 'label label-primary';
                                } else if (item.indexOf("作业") > -1 || item.indexOf("job") > -1 || item.indexOf("绿色") > -1) {
                                    return 'label label-success';
                                } else if (item.indexOf("黑色") > -1) {
                                    return 'label label-default';
                                } else {
                                    return 'label label-default';
                                }
                            },

                        });
                        $(".tagsLabel").on('itemAdded', function(event) {

                            var index = $(this).data("index");
                            var arr = [];
                            arr.push(event.item);

                            self.model[index].tag._all = arr;

                            jQuery.ajax({
                                url: '/mxobject/actiontoclass',
                                type: 'POST',
                                dataType: 'json',
                                data: {
                                    data: JSON.stringify(self.model[index]),
                                    ctype: "insert"
                                },
                                beforeSend: function(xhr) {
                                },
                                complete: function(xhr, textStatus) {
                                },
                                success: function(data, textStatus, xhr) {
                                    console.log(JSON.stringify(data))
                                },
                                error: function(xhr, textStatus, errorThrown) {
                                }
                            });
                        });

                        $(".tagsLabel").on('itemRemoved', function(event) {

                            var index = $(this).data("index");

                            self.model[index].tag._all = _.pull(self.model[index].tag._all, event.item);

                            jQuery.ajax({
                                url: '/mxobject/actiontoclass',
                                type: 'POST',
                                dataType: 'json',
                                data: {
                                    data: JSON.stringify(self.search.result.data[index]),
                                    ctype: "insert"
                                },
                                beforeSend: function(xhr) {
                                },
                                complete: function(xhr, textStatus) {
                                },
                                success: function(data, textStatus, xhr) {
                                },
                                error: function(xhr, textStatus, errorThrown) {
                                }
                            });

                        });
                    },
                    validate: function(event) {
                        let self = this;
                        var name = event.val();
                        var retValue = {};

                        if (name == "") {
                            retValue.status = false;
                            retValue.msg = "";
                        } else {
                            retValue.status = true;
                        }

                        return retValue;
                    },
                    searchByInput: function (event){
                        let self = this;

                        self.search(event);
                    },
                    openGraphPanel: function(type,name,parent){
                        let self = this;
                        let _lang = `{{.Lang}}`;
                        let lang = _lang.replace(/"/g,"").split("-")[0].replace(/en/g,"eg");
                        let obj = {};
                        obj.lang = lang;
                        obj.type = type;
                        obj.name = name;
                        obj.parent = parent;

                        localStorage.setItem("graph-object",JSON.stringify(obj));

                        window.open(
                            "/web/lib/mxgraph/graph/index.html",
                            "_blank"
                        );
                    }
                }
            })

            var appVue = new Vue({
                delimiters: ['${', '}'],
                el: '#app',
                template: '#app-template',
                data: {
                    ifShowNav: true,
                    search:{
                        params: {
                            at: '#',
                            class: `/matrix/filesystem/: | username={{.SignedUser.Name}}; ispublic=1`,
                            subclass: '',
                            top: ' top 200 ',
                            lua: ''
                        },
                        filter:[],
                        input: {
                            type: {type:"ciview",quick: ""},
                            term: ""
                        },
                        preset: {},
                        regexp: {
                            top: /top (\d+(\.\d)*)/gmi,
                            undefined:  /undefined/g,
                            doubleGrep: /\|(\s+(\|))/g,

                        },
                        result:{
                            data: [],
                            columns: [],
                            options: {
                                classes: "table table-no-bordered",
                                search: true,
                                locale: '{{.Lang}}',
                                rowStyle: 	function rowStyle(row, index) {
                                    return {
                                        classes: 'text-nowrap'
                                    };
                                }
                            }
                        }
                    }
                },
                created: function () {
                    let self = this;

                    eventHub.$on('preset-selected-event', self.setPresetDefault);
                    eventHub.$on("input-term-event", self.setSearchTerm);
                    eventHub.$on("input-reset-event", self.setSearchReset);
                },
                mounted: function () {
                    let self = this;

                    self.$nextTick(function () {
                        self.onSearch();
                        self.initPlugin();
                    })
                },
                watch: {
                    'search.result.data': {
                        handler: function (newValue, oldValue) {
                            let self = this;

                            if (!_.isEqual(newValue, oldValue)) {
                                self.refresh();
                            }
                        },
                        deep: true
                    }
                },
                methods: {
                    initPlugin: function () {
                        let self = this;

                        App.init();

                    },
                    setPresetDefault: function(event){
                        let self = this;

                        self.search.preset = event;
                    },
                    setSearchReset: function(){
                        let self = this;
                        let _param = self.search.params.at + self.search.params.class + self.search.params.subclass;
                        let _preset = self.search.preset.default;

                        _param = _param + _preset.value + self.search.preset.others.forTime + " | " + self.search.params.top;

                        self.setSearchTerm("");
                        self.searchHandler(_param, null);
                    },
                    setSearchTerm: function (term){
                        let self = this;

                        self.search.input.term = term;
                    },
                    onSearch: function (term) {
                        let self = this;
                        let _param = "";
                        let _preset = self.search.preset.default;
                        let _ifDebug = "";

                        _ifDebug = self.search.preset.others.ifDebug?"debug> ":"";
                        self.search.params.at = self.search.preset.others.ifHistory?"":"#";

                        if(!_.isEmpty(self.search.input.term)){

                            let _top = self.search.input.term.match(self.search.regexp.top);

                            if(!_.isEmpty(_top)){
                                self.search.params.top = _.last(_top);
                            }

                            _param = self.search.params.at + self.search.params.class + self.search.params.subclass + " | " + self.search.input.term;
                        } else {
                            _param = self.search.params.at + self.search.params.class + self.search.params.subclass;
                        }

                        if(!_.isEmpty(_preset)) {
                            _param = _param + _preset.value + self.search.fortime;
                        } else {
                            _param = _param + _preset.value;
                        }
                        _param = _param + " | " + self.search.params.top;

                        _param = _ifDebug + _param.replace(self.search.regexp.undefined,"").replace(self.search.regexp.doubleGrep," | ");

                        self.searchHandler(_param, null);
                    },
                    searchHandler: function(param,func){
                        let self = this;

                        console.log(param);

                        jQuery.ajax({
                            url: '/mxobject/search',
                            type: 'POST',
                            dataType: 'json',
                            data: {
                                cond: param,
                                flag: false
                            },
                            beforeSend:function(xhr){
                            },
                            complete: function(xhr, textStatus) {
                            },
                            success: function(data, textStatus, xhr) {
                                console.log(JSON.stringify(data, null, 2))

                                let _list = data;

                                if(_.isEmpty(_list.message)){
                                    self.search.result.data = [];
                                    return false;
                                }

                                self.search.result = _.sortBy(_list, "vtime").reverse();
                                self.refresh();

                            },
                            error: function(xhr, textStatus, errorThrown) {
                                console.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                            }
                        });
                    },
                    newModal: function () {
                        let self = this;
                        selectedTemplate = $(this).data("id");

                        var modal = $("#addDashBoardModal");
                        modal.modal("show");
                        //modal.find('#name').val(selectedTemplate + "_" + Math.floor(_.now()/1000));
                        modal.find('#title').val('');
                        modal.find('#tags').selectpicker('val', selectedTemplate);

                        $("#tags").tagsinput({
                            tagClass: function (item) {

                                if (item.indexOf("事件") > -1 || item.indexOf("event") > -1) {
                                    return 'label label-danger label-important';
                                } else if (item.indexOf("性能") > -1 || item.indexOf("performance") > -1) {
                                    return 'label label-warning';
                                } else if (item.indexOf("日志") > -1 || item.indexOf("log") > -1 || item.indexOf("蓝色") > -1) {
                                    return 'label label-primary';
                                } else if (item.indexOf("作业") > -1 || item.indexOf("job") > -1 || item.indexOf("绿色") > -1) {
                                    return 'label label-success';
                                } else if (item.indexOf("黑色") > -1) {
                                    return 'label label-default';
                                } else {
                                    return 'label label-default';
                                }
                            },
                        })
                    },
                    add: function () {
                        let self = this;
                        var modal = $("#addDashBoardModal");
                        var name = "dashboard_" + _.now(); //modal.find('#name').val();
                        var title = modal.find('#title').val();
                        if (_.isEmpty(title)) {
                            swal("地图标题不能空！", "", "warning");
                            modal.find('#title').setFocus();
                            return false;
                        }
                        var tags = modal.find("#tags").tagsinput('items');
                        var ispublic = $("#ispublic input:radio:checked").val();
                        var skin = $('input[name=radiooptions]:checked').val();
                        var data = new Object();

                        data.class = '/matrix/itmap';
                        data.name = name;
                        data.title = title;
                        data.tag = {
                            "_all": JSON.stringify(tags)
                        };
                        data.star = 0;
                        data.username = '{{.SignedUser.Name}}';
                        data.ispublic = ispublic;
                        data.portlet = null;
                        data.theme = new Array(JSON.stringify(theme[skin]));

                        jQuery.ajax({
                            url: '/mxobject/actiontoclass',
                            type: 'POST',
                            dataType: 'json',
                            data: {
                                data: JSON.stringify(data),
                                ctype: "insert"
                            },
                            beforeSend: function (xhr) {
                            },
                            complete: function (xhr, textStatus) {
                            },
                            success: function (data, textStatus, xhr) {
                                modal.modal("hide");
                                _.delay(function () {
                                    self.load();
                                }, 200);
                            },
                            error: function (xhr, textStatus, errorThrown) {
                            }
                        })
                    },
                    remove: function (name) {
                        let self = this;
                        var param = `#/matrix/filesystem: | name=` + name + ` | delete`;

                        swal({
                            title: name,
                            text: "确定要删除该地图吗?",
                            type: "warning",
                            showCancelButton: true,
                            closeOnConfirm: false,
                            cancelButtonText: "取消",
                            confirmButtonText: "删除",
                            confirmButtonColor: "#ff0000"
                        }, function () {

                            jQuery.ajax({
                                url: '/mxobject/search',
                                type: 'POST',
                                dataType: 'json',
                                data: {
                                    cond: param
                                },
                                beforeSend: function (xhr) {
                                },
                                complete: function (xhr, textStatus) {
                                },
                                success: function (data, textStatus, xhr) {

                                    if (data.status == "ok") {
                                        _.delay(function () {
                                            self.load();
                                        }, 200);
                                        swal("删除成功！", "", "success");
                                    } else {
                                        swal("删除失败！", data.message, "warning");
                                    }
                                },
                                error: function (xhr, textStatus, errorThrown) {
                                }
                            });

                        })
                    },
                    refresh: function () {
                        let self = this;

                        $(".tagsLabel").tagsinput({
                            tagClass: function (item) {

                                if (item.indexOf("事件") > -1 || item.indexOf("event") > -1) {
                                    return 'label label-danger label-important';
                                } else if (item.indexOf("性能") > -1 || item.indexOf("performance") > -1) {
                                    return 'label label-warning';
                                } else if (item.indexOf("日志") > -1 || item.indexOf("log") > -1 || item.indexOf("蓝色") > -1) {
                                    return 'label label-primary';
                                } else if (item.indexOf("作业") > -1 || item.indexOf("job") > -1 || item.indexOf("绿色") > -1) {
                                    return 'label label-success';
                                } else if (item.indexOf("黑色") > -1) {
                                    return 'label label-default';
                                } else {
                                    return 'label label-default';
                                }
                            },

                        });
                        $(".tagsLabel").on('itemAdded', function (event) {

                            var index = $(this).data("index");

                            self.search.result.data[index].tag._all.push(event.item);

                            jQuery.ajax({
                                url: '/mxobject/actiontoclass',
                                type: 'POST',
                                dataType: 'json',
                                data: {
                                    data: JSON.stringify(self.search.result.data[index]),
                                    ctype: "insert"
                                },
                                beforeSend: function (xhr) {
                                },
                                complete: function (xhr, textStatus) {
                                },
                                success: function (data, textStatus, xhr) {

                                },
                                error: function (xhr, textStatus, errorThrown) {
                                }
                            });
                        });

                        $(".tagsLabel").on('itemRemoved', function (event) {

                            var index = $(this).data("index");

                            self.search.result.data[index].tag._all = _.pull(self.search.result.data[index].tag._all, event.item);

                            jQuery.ajax({
                                url: '/mxobject/actiontoclass',
                                type: 'POST',
                                dataType: 'json',
                                data: {
                                    data: JSON.stringify(self.search.result.data[index]),
                                    ctype: "insert"
                                },
                                beforeSend: function (xhr) {
                                },
                                complete: function (xhr, textStatus) {
                                },
                                success: function (data, textStatus, xhr) {

                                },
                                error: function (xhr, textStatus, errorThrown) {
                                }
                            });

                        });
                    },
                    validate: function (event) {
                        let self = this;
                        var name = event.val();
                        var retValue = {};

                        if (name == "") {
                            retValue.status = false;
                            retValue.msg = "";
                        } else {
                            retValue.status = true;
                        }

                        return retValue;
                    },
                    toogleView: function () {
                        let self = this;

                        if (self.ifShowNav) {

                            $("#nav").hide();

                            $("#content").removeClass("col-lg-10");
                            $("#content").addClass("col-lg-12").css("padding-left", "11px");

                            $(".navtoggle").removeClass("fa fa-caret-left");
                            $(".navtoggle").addClass("fa fa-caret-right");

                            self.ifShowNav = false;
                        } else {
                            $("#nav").slideDown(500);
                            $("#nav").show();

                            $("#content").removeClass("col-lg-12");
                            $("#content").addClass("col-lg-10").css("padding-left", "0px");

                            $(".navtoggle").removeClass("fa fa-caret-right");
                            $(".navtoggle").addClass("fa fa-caret-left");

                            self.ifShowNav = true;
                        }
                    },
                    view: function (event) {
                        eventHub.$emit("view-toggle-event", event);
                    },
                    home: function () {
                        eventHub.$emit('tree-init-event', null);
                    }
                }
            })

            function tableRowStyle(row, index) {

                return {
                    classes: "btn-info"
                }
            }
        })
    })

</script>

<script type="text/x-template" id="app-template">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12" style="padding-left:10px;padding-bottom: 10px;">
                <div class="input-group searchinput">
                    <vue-search-input-component :model="search.input"></vue-search-input-component>
                    <div class="input-group-btn">
                        <vue-search-preset-component :preset="search.preset"></vue-search-preset-component>
                    </div>
                    <div class="input-group-btn">
                        <button type="button" class="btn btn-success" @click="onSearch"><i class="fa fa-search" style="font-size:18px;"></i></button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">

                <div role="tabpanel">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs nav-main" role="tablist">
                        <li role="presentation" class="dropdown active">
                            <a href="#cmdb" aria-controls="cmdb" role="tab" data-toggle="tab" title="CMDB Support">CMDB</a>
                        </li>
                        <li role="presentation">
                            <a href="#topology" aria-controls="topology" role="tab" data-toggle="tab" title="Business Gauge">Topology</a>
                        </li>
                        <!--<li role="presentation" class="pull-right" style="display: -webkit-box;">
                            <div class="btn-group">
                                <a href="javascript:;" data-click="panel-expand" style="color:#000;"><i class="fa fa-square-o"></i></a>
                                <a href="javascript:;" data-click="panel-collapse" style="color:#000;"><i class="fa fa-minus"></i></a>
                            </div>
                        </li>-->
                    </ul>
                    <!-- Tab panes -->
                    <div class="tab-content tab-main" style="padding:0px;">
                        <div role="tabpanel" class="tab-pane active" id="cmdb">
                            <div class="row">
                                <div class="col-lg-2" id="nav">
                                    <div class="panel" style="border-radius: 0px;min-height:60vh;">
                                        <div class="panel-body">
                                            <tree-component></tree-component>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-10" id="content">
                                    <div class="panel-body context-menu-content">

                                        <div>
                                            <div class="btn-group btn-group-action">
                                                <a href="javascript:void(0)" class="btn btn-xs btn-default" @click="toogleView"><i class="fa fa-caret-right navtoggle"></i></a>

                                                <a href="#" class="btn btn-xs btn-default"><i class="fa fa-cloud-download m-r-5"></i>导入</a>
                                                <a href="#" class="btn btn-xs btn-default"><i class="fa fa-cloud-upload m-r-5"></i>导出</a>
                                                <a href="#" class="btn btn-xs btn-default"><i class="fa fa-refresh m-r-5"></i>刷新</a>
                                                <a href="#" class="btn btn-xs btn-default fileinput-button">
                                                    <i class="fa fa-upload m-r-5"></i>Upload
                                                    <input id="fileupload" type="file" name="uploadfile" multiple>
                                                </a>
                                                <a href="#" class="btn btn-xs btn-default"><i class="fa fa-plus m-r-5"></i>New Folder</a>

                                            </div>
                                            <div class="btn-group-action btn-group-action pull-right">
                                                <a href="#" class="btn btn-xs btn-default"><i class="fa fa-reply m-r-5"></i> Up</a>
                                                <a href="javascript:void(0)" class="btn btn-xs btn-default" @click="home"><i class="fa fa-home m-r-5"></i>Root</a>
                                                <a href="javascript:void(0)" class="btn btn-xs btn-default" @click="view('file-view-icon-component')"><i class="fa fa-table m-r-5"></i>Grid</a>
                                                <a href="javascript:void(0)" class="btn btn-xs btn-default" @click="view('file-view-table-component')"><i class="fa fa-list m-r-5"></i>List</a>
                                            </div>
                                        </div>
                                        <div>
                                            <file-view-component></file-view-component>
                                        </div>
                                    </div>
                                    <div class="panel-footer">
                                        <small>Count: ${search.result.data.length}  | ${moment().format("LLL")}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="topology">
                            <graph-list-component></graph-list-component>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>    
</script>

<script type="text/x-template" id="file-view-component-template">
    <div>
        <p style="margin:10px -10px;">
            <component v-bind:is="currentView" :model="model.list"></component>
        </p>
    </div>
</script>

<script type="text/x-template" id="file-view-icon-component-template">
    <div>
        <div :class="item.type=='dir'?'dir col-md-2 col-sm-4 context-menu-file':'file col-md-2 col-sm-4 context-menu-file'" 
             :id="'file_'+item.id" 
             v-for="item in model"
             :data-item="JSON.stringify(item)"
             @mouseover="mouseOver(item)"  
             @mouseout="mouseOut(item)" 
             @click="click(item)" 
             @dblclick="dblClick(item)" 
             @oncontextmenu="rightClick(item)"
             style="cursor: pointer;">
            <div class="widget widget-stats bg-silver">
                <div class="stats-icon"></div>
                <div class="stats-info">
                    <p><img :src="'/web/assets/images/files/'+item.type+'.svg'" 
                            class="img-responsive" 
                            alt="Image" 
                            style="width:48px;height:48px;"></p>    
                </div>
                <div class="stats-link">
                    <a href="javascript:;" style="text-align: left;margin:15px -15px -15px -15px;padding: 5px;">${item.title.substring(0,12)} 
                    </a>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/x-template" id="file-view-table-component-template">
    <div class="file-view-table table-responsive">
        <bootstrap-table id="file-list-table" :columns="columns" :options="options" :dataset="model" classes="files-list-table"></bootstrap-table>
    </div>
</script>

<script type="text/x-template" id="graph-list-template">

    <div class="panel">
        <div class="panel-body">
            <div class="row">
                <div class="col-lg-3" v-for="(item,index) in model">
                    <div class="widget widget-stats bg-info">
                        <div>
                            <a href="javascript:void(0)"
                               @click=openGraphPanel(1,item.name,item.parent)>
                                <div class="stats-number" style="font-size:14px;"><i class='fa fa-braille'></i> ${item.name.split(".")[0]}</div>
                            </a>
                            <span>
                                <a href="javascript:void(0)"
                                   @click=openGraphPanel(1,item.name,item.parent)>
                                    <img :src="_.attempt(JSON.parse.bind(null, item.attr)).pic" style="width:75%;height:140px; margin: 0px 35px;">
                                </a>
                            </span>
                            <i class='fa fa-tags' style='color:#337ab7;'></i> <input class="tagsLabel" :id="'tagsLabel'+index" :value="item.tag._all" :data-index="index" placeholder='{{.i18n.Tr "mxdashboard_tag_add"}}'>
                        </div>
                        <div class="stats-desc">
                            <i class='fa fa-user' style='color:#337ab7;'></i> ${item.username} &nbsp;&nbsp;&nbsp;&nbsp;<i class='fa fa-clock-o' style='color:#337ab7;'></i> ${ new Date(item.vtime).toLocaleString() } &nbsp;&nbsp;&nbsp;&nbsp;
                            <span class="rating" v-for="data in item.star">
                                <span style="color:gold;">☆</span>
                            </span>
                            &nbsp;&nbsp;&nbsp;&nbsp;
                            <a href="javascript:void(0)"
                               @click=openGraphPanel(2,item.name,item.parent)>
                                <i class="fa fa-television" style='color:rgba(0,0,0,.5);position: absolute;right: 30px;top: 5px;z-index: 100;'></i>&nbsp;&nbsp;&nbsp;&nbsp;
                            </a>
                            <i class='fa fa-remove' style='color:rgba(0,0,0,.5);cursor:pointer;position: absolute;right: 10px;top: 5px;z-index: 100;' v-on:click="remove(item)"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-footer">
            <small>Count: ${model.length}  | ${moment().format("LLL")}</small>
        </div>
    </div>

</script>

{{template "base/footer" .}}
