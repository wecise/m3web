<!--

    [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]
    [::::::::::::::      ::::::::::::::]
    [::::::::::::::      ::::::::::::::]
    [::::::[[[[[[[:      :]]]]]]]::::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[    CODE BY WANGZD    ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [::::::[[[[[[[:      :]]]]]]]::::::]
    [::::::::::::::      ::::::::::::::]
    [::::::::::::::      ::::::::::::::]
    [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]

-->
{{template "base/head" .}}

<!-- zTree Core CSS -->
<link href="{{AppSubUrl}}/web/vendor/zTree/css/omdbStyle/zTreeStyle.css" type="text/css" rel="stylesheet">

<style type="text/css">


	body {
		overflow: hidden;
	}

	.lm_goldenlayout {
		background: none;
		background-color: rgb(249, 249, 249);
	}

	.lm_content {
		background: rgb(255, 255, 255);
		border: none;
		overflow: hidden;
	}

	.lm_header{
		height: 25px!important;
	}

	.lm_item .lm_column > .lm_stack:nth-child(1) > .lm_header{
		display: none!important;
	}

	.lm_header .lm_tab.lm_active {
		border-bottom: none;
		box-shadow: none;
		padding-bottom: 5px;
		border-bottom: 1px solid rgb(255, 0, 0);
	}

	.lm_tab:hover, .lm_tab.lm_active {
		background: rgb(255, 255, 255);
		color: rgb(119, 119, 119);
	}

	.lm_header .lm_tab {
		border: none;
		height: 15px;
		padding: 4px 25px 0px 15px;
	}

	.lm_selected .lm_header {
		background-color: rgb(230, 230, 230);
	}

	.lm_header .lm_tab .lm_close_tab {
		top: 7px!important;
	}

	.lm_tabs > li[title=查询] .lm_close_tab,
	.lm_tabs > li[title=日志] .lm_close_tab{
		display:none;
	}

	[id="app"] {
		width: 100vw;
		height: 100vh;
	}

	.logToolBar {
		height: 30px;
		width: 100%;
		background-color: rgb(33, 149, 243);
	}

	.log-console {
		height: 100%;
	}

	.log-console-content {
		padding: 5px 0px 150px 0px;
		width: 100%;
		height: 100%;
		border:none;
		outline:none;
		white-space: pre-wrap;
		overflow:auto;
		position: relative;
	}

	.log-console-content p {
		white-space: nowrap;
	}

	.log-console-content p span{
		white-space: pre-wrap;
	}

	.log-console.light {
		background-color: #ffffff;
	}

	.log-console-content.light,
	.log-console-content.light a{
		color: #333333;
		background-color: #ffffff;
		cursor: pointer;
	}

	.log-console.dark {
		background-color: #000000;
	}

	.log-console-content.dark,
	.log-console-content.dark a{
		color: #38FF41;
		background-color: #000000;
		cursor: pointer;
	}

	.log-severity.PANIC {
		color: #B12727;
	}

	.log-severity.ERROR {
		color: #FF0000;
	}

	.log-severity.INFO {
		color: #38B741;
	}

	.log-severity.WARNING {
		color: #CEC335;
	}

	.logToolBar{
		height: 30px;
		background-color: rgb(246, 246, 246);
		width: 100%;
	}

	.logToolBar .btn-primary,
	.logToolBar .btn-primary:hover{
		background-color: rgb(246, 246, 246);
		border:none;
		color: #333333;
	}

	.logToolBar .btn-group{
		top: 1px;
	}

	.logToolBar .btn-group > a > i{
		color: #666666;
	}

	.sidebar {
		display:none;
	}


</style>


<link rel="vc" href="{{AppSubUrl}}/web/component/omdb/omdb-output-datatables-component.html"></link>
<link rel="vc" href="{{AppSubUrl}}/web/component/omdb/omdb-class-datatables-component.html"></link>
<link rel="vc" href="{{AppSubUrl}}/web/component/omdb/omdb-class-tree-component.html"></link>
<link rel="vc" href="{{AppSubUrl}}/web/component/omdb/omdb-editor-component.html"></link>

<link rel="vc" href="{{AppSubUrl}}/web/component/vue-trigger-editor-component.html"></link>
<link rel="vc" href="{{AppSubUrl}}/web/component/vue-graph-component.html"></link>
<link rel="vc" href="{{AppSubUrl}}/web/component/vue-ai-robot-component.html"></link>

<!-- Golden Layout container -->
<div id="app"></div>

<script>

	'use static';

    $(".current-active-item").html(`<a class="active item" href="/janesware/omdb">
										<i class="fa fa-cube"></i>  {{.i18n.Tr .ActiveView }}
									</a>`);

    VueLoader.onloaded(["omdb-output-datatables-component",
				        "omdb-class-datatables-component",
				        "omdb-class-tree-component",
				        "omdb-editor-component",
	                    "vue-trigger-editor-component",
	                    "vue-graph-component",
                        "vue-ai-robot-component"], function() {

        let classTree = function(id, bid, template, event){

            return {
	            delimiters: ['${', '}'],
	            el: '#' + id,
                template: `#${template}-template`,
	            data: {
					id: id,
	            },
	            mounted: function() {
	                let self = this;

	                self.$nextTick(function() {
	                    $(self.$el).click(function(){
	                        self.click();
	                    })
	                })
	            },
	            methods: {
	                click: function(){

	                }
	            }
            };
        };

        let classEdit = function(id, bid, template, event){

            let _dataset = [];
            let _columns = [];

            _columns = [
                {"field": "id", render: function (data, type, row, meta) {
                        return meta.row + meta.settings._iDisplayStart + 1;
                    }
                },
                {"field": "icon", "title": "Inherit", render: function (data, type, row) {
                        return `<img src="/web/assets/images/${data}.svg" style="width:22px;height:22px;">`;
                    }
                },
                {"field": "name", "title": "Name"},
                {"field": "title", "title": "Title"},
                {"field": "colname", "title": "ColName"},
                {"field": "ftype", "title": "Ftype"},
                {"field": "loption", "title": "Loption"},
                {"field": "fparam", "title": "Fparam"},
                {"field": "isindex", "title": "Index",render: function (data, type, row) {
                        return data===1?'是':'否';
                    }
                },
                {"field": "iskey", "title": "Primary Key",render: function (data, type, row) {
                        return data===1?'是':'否';
                    }
                },
                {"field": "note", "title": "Note"},
                {"field": "mtime", "title": "Mtime",render: function (data, type, row) {
                        return moment(data).format("LLL");
                    }
                },
                {"field": "class", "title": "Class", "visible": false},
                {"field": "dispname", "title": "Dispname", "visible": false},
                {"field": "tags", "title": "Tags", "visible": false},
                {"field": "isrel", "title": "Rel", "visible": false},
                {"field": "btype", "title": "Btype", "visible": false}
            ];

            if(!_.isEmpty(event.model.node.fieldsObj) && !_.isEmpty(event.model.pnode.fieldsObj)) {
                let _diff = _.map(_.differenceBy(event.model.node.fieldsObj, event.model.pnode.fieldsObj, 'name'), function (v) {
                    return _.merge(v, {icon: 'child'});
                });
                let _pnode = _.map(event.model.pnode.fieldsObj, function (v) {
                    return _.merge(v, {icon: 'parent'});
                });
                _dataset = _.merge(_diff, _pnode);
            } else {
                _dataset = _.map(event.model.node.fieldsObj, function (v) {
                    return _.merge(v, {icon: 'parent'});
                });
            }

            _dataset = _.uniqBy(_dataset,'name');

            _columns = _.uniqBy(_columns, 'field');

            return {

                delimiters: ['${', '}'],
                el: '#' + id,
                template: `#${template}-template`,
                data: {
                    id: id,
	                bid: bid,
                    model: {
                        dataset: _dataset,
                        columns: _columns,
                        options: {
                            info:true,
                            scrollY: '40vh',
                            searching: false,
                            rowCallback: function( row, data ) {
                                if( data.icon === "parent" ) {
                                    $('td', row).css('background-color', '#f9f9f9');
                                }
                            }
                        }
                    },
                    result: event.model.node
                },
                created: function(){
                    let self = this;

                },
                mounted: function() {
                    let self = this;

                    self.$nextTick(function() {
                        self.init();
                    })
                },
                methods: {
                    init: function(){
                        let self = this;


                    }
                }
            };
        };

        let queryConsole = function(id, bid, template, event){

            let _readOnly = false;
            let _diff = null;

            if(!_.isEmpty(event.model.pnode)){
                if(event.model.node.fieldsObj && event.model.pnode.fieldsObj) {
                    _diff = _.differenceBy(event.model.node.fieldsObj, event.model.pnode.fieldsObj, 'name');
                    event.model.node["fieldsObj"] = _.uniqBy(_diff,'name');
                }
	        }

            if(event.model.pattern === 'ddl') {
                _readOnly = true;
            }

            return {

                delimiters: ['${', '}'],
                el: '#' + id,
                template: `#query-console-template`,
                data: {
                    id: id,
                    bid: bid,
                    model: {
                        oldInput: "",
                        newInput: "",
                        mode: "mql",
                        theme: "tomorrow",
                        printMargin: false,
                        readOnly: _readOnly,
                    },
	                keys: []
                },
                created: function(){
                    let self = this;

                    self.initKeys();
                },
	            mounted: function () {
                    let self = this;

                    self.$nextTick(function () {
						self.init();
                    })
                },
                methods: {
                    init: function(){
                        let self = this;

                        if(_.isEmpty(event.model.node)) return false;

                        let colms = _.without(event.model.node.fields,"_tokens") || event.model.node.fields;

                        let cls = "";
                        if(_.isEmpty(colms)){
                            cls = "*";
                        } else {
                            cls = colms.join(",");
                        }
                        let mql = "";

                        if(event.model.pattern === 'data') {
                            mql = `SELECT\n\t ${cls} \nFROM\n\t ${event.model.node.name} limit 50`;
                        } else if(event.model.pattern === 'select') {
                            mql = "SELECT\n\t " + cls + "\nFROM\n\t " + event.model.node.name;
                        } else if(event.model.pattern === 'insert') {
                            mql = "INSERT INTO " + event.model.node.name + "\n" + _.map(event.model.node.fields, function(v){return `${v}=''`;}).join(", ") + ";";
                        } else if(event.model.pattern === 'update') {
                            mql = "UPDATE " + event.model.node.name + "\nSET " + _.map(event.model.node.fields,function(v){return v+"=''";}).join(",") + "\nWHERE ";
                        } else if(event.model.pattern === 'delete') {
                            mql = "DELETE\n\t " + cls + "\nFROM\n\t " + event.model.node.name;
                        } else if(event.model.pattern === 'ddl') {

	                        mql = "#DDL\nCREATE CLASS IF NOT EXISTS " + event.model.node.name + " (\n\t" + _.map(event.model.node.fieldsObj, function(v){ return `${v.name}  ${v.ftype}  '${v.title}'`;}).join(",\n\t") + "\n\tindexes(" + _.map(_.filter(event.model.node.fieldsObj,function(v){return v.isindex == 1;}),'name').join(",") + ")\n\tkeys(" + event.model.node.keys.join(",") + ")\n);";

                            _.forEach(self.keys,function(v){

								if(_.includes(v,'time')) {
                                    mql += `\n\n#${_.startCase(v)}\n${v}=${moment(event.model.node[v]).format("LLL")}`;
                                    return;
								}

                                let _value = event.model.node[v];

                                if(_value === 1){
                                    _value = true;
                                } else if(_value === 0){
                                    _value = false;
                                }

                                if(v === 'keymethod'){
                                    if(_value === 1){
                                        _value = 'uuid';
                                    } else {
                                        _value = 'md5';
                                    }
                                }

                                mql += `\n\n#${_.startCase(v)}\n${v}=${_value}`.replace(/keymode/gi,"largepartition").replace(/keymethod/gi,"key");
                            })

			            } else if(event.model.pattern === 'create-class') {
			                let _rand = _.now();
                            mql = `CREATE CLASS IF NOT EXISTS  ${event.model.node.name}/new_${_rand}();`;
                            mql = _.replace(mql, "//", "/");
			            } else if(event.model.pattern === 'drop-class') {
                            mql = "DROP CLASS " + event.model.node.name + ";";
                        } else if(event.model.pattern === 'alter') {
                            mql = `#设置类属性`;

                            let _keys = _.remove(self.keys, function(v){
			                                return !_.includes(['cid','pid','fields','keys','mtime','fieldsObj','child', 'loption', 'subclass','vtimebase','tags', 'name'],v)
			                            })

                            _.forEach(_keys,function(v){
                                let _value = event.model.node[v];

                                if(_value === 1){
                                    _value = true;
                                } else if(_value === 0){
                                    _value = false;
                                }

                                if(v === 'keymethod'){
                                    if(_value === 1){
                                        _value = 'uuid';
                                    } else {
                                        _value = 'md5';
                                    }
                                }

                                if(_.includes(['alias','keymethod','remedy'],v)){
                                    mql += `\n\n#${_.startCase(v)}\nALTER CLASS ${event.model.node.name} SET ${v}='${_value}';`.replace(/keymode/gi,"largepartition").replace(/keymethod/gi,"key");
                                } else {
                                    mql += `\n\n#${_.startCase(v)}\nALTER CLASS ${event.model.node.name} SET ${v}=${_value};`.replace(/keymode/gi,"largepartition").replace(/keymethod/gi,"key");
                                }
                            })
                        } else if(event.model.pattern === 'alter-add-column') {
	                        mql = "ALTER CLASS " + event.model.node.name + " ADD COLUMN column_name type;\n\n";
                        } else if(event.model.pattern === 'alter-drop-column') {
                            mql = "ALTER CLASS " + event.model.node.name + " DROP COLUMN column_name;\n\n";
                        } else if(event.model.pattern === 'alter-add-index') {
                            mql = "ALTER CLASS " + event.model.node.name + " ADD INDEX index_name type;\n\n";
                        } else if(event.model.pattern === 'alter-drop-index') {
                            mql = "ALTER CLASS " + event.model.node.name + " DROP INDEX index_name type;\n\n";
                        } else if(event.model.pattern === 'alter-add-key') {
	                        mql = "ALTER CLASS " + event.model.node.name + " ADD KEY key_name;\n\n";
                        } else if(event.model.pattern === 'alter-drop-key') {
                            mql = "ALTER CLASS " + event.model.node.name + " DROP KEY key_name;\n\n";
                        } else if(event.model.pattern === 'g') {  // edge  query
	                        mql = `g.V(" ").In("${event.model.node.title}").All();`;
                        } else if(event.model.pattern === 'create-edge-type') {  // edge  new edge type
                            mql = `CREATE EDGE TYPE  type_name type_remedy;`;
                        } else if(event.model.pattern === 'drop-edge-type') {  // edge drop edge type
                            mql = `DROP EDGE TYPE ${event.model.node.title};`;
                        } else if(event.model.pattern === 'edge-insert') {  // edge  create
                            mql = `INSERT INTO class_name id="",${event.model.node.title}=[""];`;
                        } else if(event.model.pattern === 'edge-update') {  // edge  update
                            mql = `UPDATE class_name SET ${event.model.node.title}='' WHERE ID='';`;
                        } else if(event.model.pattern === 'edge-g') {  // edge query all
                            mql = GLOBAL_CONFIG.global.gremlin;
                        }

                        self.model.newInput = mql;
                    },
	                initKeys: function(){
                        let self = this;

                        let _rtn = classList(-1);
                        self.keys = _.sortBy(_.keys(_.attempt(JSON.parse.bind(null, _rtn))[0]));
	                },
	                dropClass: function(){
                        let self = this;


	                }
                }
            };
        };

        let outPut = function(id, bid, node){

            let _dataset = [];
            let _columns = [];
            let _node = {};

            if(!_.isEmpty(node)) {
                _dataset = node.data[_.keys(node.columns)[0]];
                _columns = node.columns[_.keys(node.columns)[0]];
                _node = node;
            }

            _columns.unshift({"field": "num", "title": "", render: function (data, type, row, meta) {
                    return meta.row + meta.settings._iDisplayStart + 1;
                }
            });

            return {

                delimiters: ['${', '}'],
                el: '#' + id,
                template: `#output-console-template`,
                data: {
					id: id,
                    bid: bid,
	                model: {
                        dataset: _dataset,
                        columns: _columns,
                        options: {
                            info:true,
                            scrollY: '40vh',
                            searching: false,
                        }
	                },
	                result: _node
                },
	            created: function(){
                    let self = this;

                    eventHub.$on("LAYOUT-RESIZE-TRIGGER-EVENT", self.setScrollY);

                    eventHub.$on(`QUERY-RESULT-TRIGGER-EVENT-${bid}`,self.setData);
                    eventHub.$on(`NEW-QUERY-RESULT-TRIGGER-EVENT-${bid}`,self.setData);
	            },
                mounted: function() {
                    let self = this;

                    self.$nextTick(function() {
                        self.init();
                    })
                },
                methods: {
					init: function(){
					    let self = this;

                        if(!_.isEmpty(node)) {
                            self.model.dataset = self.result.data[_.keys(self.result.columns)[0]];
                            self.model.columns = self.result.columns[_.keys(self.result.columns)[0]];
                        }

					},
                    setData: function(event){
                        let self = this;

	                    self.model.dataset = event.data[_.keys(event.columns)[0]];
                        self.model.columns = event.columns[_.keys(event.columns)[0]];
                        self.result = event;

                    },
                    setScrollY: function(event){
					    let self = this;

					    self.model.options.scrollY = event.scrollY;
                    }
                }
            };
        };

        let graph = function(id, bid, type, pattern, node){

	        let _data = {nodes:[], edges:[]};

            if(!_.isEmpty(node.data)){
                _data.nodes = node.data;
            };

            if(!_.isEmpty(node.edges)){
                _data.edges = node.edges;
            };

            return {

                delimiters: ['${', '}'],
                el: '#' + id,
                template: '#graph-template',
                data: {
                    id: id + '-' + type,
                    bid: bid,
                    model: _data,
                },
                mounted: function () {
                    let self = this;

                    self.$nextTick(function () {
                        self.init();
                    })
                },
                methods: {
                    init: function(){
                        let self = this;


                    }
                }
            };
        };

        let logConsole = function(id, bid, template, model){

            return {

                delimiters: ['${', '}'],
                el: '#' + id,
                template: `#${template}-template`,
                data: {
                    id: id,
                    bid: bid,
                    model: [],
	                theme: 'light',
	                debug: {
                        mql: [],
		                flag: [],
		                crontab: {
                            sched: '30 second',
                            timer: null
		                }
	                }
                },
	            watch: {
                    'debug.mql': {
                        handler: function(val,oldVal){
                            let self = this;

                            if(val !== oldVal){
                                self.debugIt(val);
                            }

                            if(_.isEmpty(val)){
                                self.debug.crontab.sched = null;
                                self.debug.crontab.timer = null;
                            } else {
                                self.debug.crontab.sched = later.parse.text(`every ${self.debug.crontab.sched}`);
                                self.debug.crontab.timer = later.setInterval(self.refresh, self.debug.crontab.sched);
                            }
                        },
	                    deep:true
                    }
	            },
	            created: function(){
                    let self = this;

                    eventHub.$on("LOG-CONSOLE-APPEND-EVENT", self.append);
	            },
                mounted: function () {
                    let self = this;

                    self.$nextTick(function () {
                        self.init();
                        self.initPlugin();
                    })
                },
                filters: {
					format: function(value){
					    return value.join('\n\n');
					}
	            },
                methods: {
                    init: function(){
                        let self = this;

						self.model.push(self.log('info','加载完成'));

                        self.theme = localStorage.getItem("LOG-CONSOLE-THEME");

                    },
                    initPlugin: function(){
                        let self = this;

                        $(self.$el).contextMenu({
                            selector: 'a.debug',
                            trigger: 'left',
                            build: function($trigger, e) {

                                $(".context-menu-input-refresh").eq(3).prop('selected', true);

                                let _items = {
                                        "trigger": {
                                            name: "调式触发器", type: "checkbox", selected: false
                                        },
                                        "scriptjs": {
                                            name: "调式脚本", type: "checkbox", selected: false
                                        },
                                        "itil": {
                                            name: "调式流程", type: "checkbox", selected: false
                                        },
                                        "rule": {
                                            name: "调式规则", type: "checkbox", selected: false
                                        },
                                        "webcontext": {
                                            name: "调式缓存", type: "checkbox", selected: false
                                        },
                                        "scriptlua": {
                                            name: "调式脚本Lua", type: "checkbox", selected: false
                                        },
	                                    "refresh": {
	                                        name: "刷新时间",
	                                        type: 'select',
	                                        options: {1: '5 second', 2: '15 second', 3: '30 second', 4: '1 mins'},
	                                        selected: 3,
                                            events: {
                                                change: function (e) {
                                                    self.debug.crontab.sched = e.target.options[e.target.selectedIndex].label;
                                                }
                                            }
	                                    }
                                    };

                                if(!_.isEmpty(self.debug.flag)){
									_.forEach(self.debug.flag,function(v,k){
									    _items[v].selected = true;
									})
                                }

                                return {
                                    items: _items
                                }
                            },
                            events: {
	                            show: function(opt) {
	                                let $this = this;

	                                $.contextMenu.setInputValues(opt, $this.data());

	                            },
	                            hide: function(opt) {
                                    let $this = this;

	                                $.contextMenu.getInputValues(opt, $this.data());

                                    self.debugs($this.data());


	                            }
	                        }
                        });
                    },
	                refresh: function(){
                       let self = this;

                       self.debugIt(self.debug.mql);
	                },
                    debugs: function(key){
                        let self = this;

                        self.debug.mql = [];
                        self.debug.flag = [];

                        _.forEach(key, function(v,k){
                            if(k !== 'contextMenu' && v != false){
                                self.debug.mql.push(`#/matrix/consolelog/${k}: | nearest 1 day | sort ctime desc`);
                                self.debug.flag.push(k);
                            }
                        });

	                },
	                append: function(level, event){
                        let self = this;
                        let _log = null;

                        _log = self.log(level, event);

                        self.model.unshift(_log);

                        // $(".log-console-content").scrollTop(function() { return this.scrollHeight; });

	                },
                    log: function(level, event){
	                    let self = this;
	                    let _content = event;

	                    if(typeof(event) === 'object'){
	                        _content = JSON.stringify(event);
	                    }

	                    let _short = _.truncate(_content, {
			                            'length': 130,
			                            'separator': ' ',
                                        'omission': ''
			                        });

	                    let _id = objectHash.sha1(level + _content + _.now());

	                    return [moment().format("YYYY-MM-DD HH:mm:ss:SSS"), _.upperCase(level), {id:_id, short: _short, content: _content.replace(_short,'')}];
	                },
	                copyIt: function(event){
                        let self = this;

                        new Clipboard(".copy", {
                            text: function(trigger) {
                                alertify.log("已复制");
                                let _rtn = _.map(self.model,function(v){
                                    return [v[0],v[1],v[2].short + v[2].content];
                                });
                                return _rtn.join("\n");
                            }
                        });

	                },
                    clearIt: function(){
						let self = this;

                        self.model = [];

                    },
                    debugIt: function(event){
						let self = this;

						_.forEach(event,function(v){
                            let _list = fetchData(v);

                            _.forEach(_list.message,function(v){

                                let _content = `[${v.name}] [${v.class}] ${v.msg}`;

                                let _short = _.truncate(_content, {
                                    'length': 130,
                                    'separator': ' ',
                                    'omission': ''
                                });

                                let _id = objectHash.sha1(v.level + _content + _.now());

                                let _log = [moment(v.ctime).format("YYYY-MM-DD HH:mm:ss:SSS"), _.upperCase(v.level), {id:_id, short: _short, content: _content.replace(_short,'')}];

                                self.model.unshift(_log);
                            })
						})

                    },
                    toggleTheme: function(){
                        let self = this;

						if(self.theme === 'light') {

                            $(self.$el).removeClass("light");
						    $(self.$el).addClass("dark");

                            $(self.$el).find(".light").addClass("dark");
                            $(self.$el).find(".light").removeClass("light");

                            self.theme = 'dark';

                        } else {

                            $(self.$el).removeClass("dark");
                            $(self.$el).addClass("light");

						    $(self.$el).find(".dark").addClass("light");
                            $(self.$el).find(".dark").removeClass("dark");

                            self.theme = 'light';
						}

                        localStorage.setItem("LOG-CONSOLE-THEME", self.theme);

                    }
                }
            };
        };

        let trigger = function(id, bid, type, pattern, node){

            let _readOnly = false;
            let _node = null;

            if(!_.isEmpty(node.result) && !_.isEmpty(node.result.message)){
                _node = node.result.message;
            }

            return {
                delimiters: ['${', '}'],
                el: '#' + id,
                template: "#trigger-template",
                data: {
                    id: id + '-' + type,
                    bid: bid,
                    list: [],
                    selected: []
                },
	            created: function(){
                    let self = this;

                    self.init();
	            },
                mounted: function() {
                    let self = this;

                    self.$nextTick(function () {

                    })
                },
                methods: {
                    init: function(){
                        let self = this;


                        if( _.isEmpty(_node) ) {
                            self.list = [{  name: "",
                                time: moment().format("LLL"),
                                class: node.name,
                                model: {
                                    oldInput: "",
                                    newInput: "",
                                    mode: "lua",
                                    theme: "tomorrow",
                                    printMargin: false,
                                    readOnly: _readOnly,
                                }
                            }];
                        } else {
                            self.list = _.values(_.map(_node,function(v){
                                return _.map(v.script,function(val,key){
                                    return   {  name: key,
                                        time: v.vtime,
                                        class: v.class,
                                        model: {
                                            oldInput: val,
                                            newInput: val,
                                            mode: "lua",
                                            theme: "tomorrow",
                                            printMargin: false,
                                            readOnly: _readOnly,
                                        }
                                    }
                                })
                            }))[0];
                        }

                        self.selected = _.head(self.list);
                    },
                    toggle: function(item) {
                        let self = this;

                        self.selected = item;
                    },
                    add: function() {
                        let self = this;
                        let _name = $("#trigger_name").val();

                        let _rtn = triggerNew({class:node.name, name:_name, script:''});

                        if(_rtn === 1) {
                            self.refresh();
                        }
                    },
                    save: function() {
                        let self = this;
                        let _name = self.selected.name;
                        let _class = self.selected.class;
                        let _editor = ace.edit(self.id);
                        let _script = _editor.getValue();

                        let _rtn = triggerNew({class: _class, name:_name, script: _script});

                        if(_rtn === 1) {
                            self.refresh();
                        }
                    },
                    refresh: function() {
                        let self = this;

                        let _list = triggerList(node.name);

                        if( _.isEmpty(_list.message)) {
                            self.list = [{  name: "",
                                time: moment().format("LLL"),
                                class: node.name,
                                model:{
                                    oldInput: "",
                                    newInput: "",
                                    mode: "lua"
                                }
                            }];
                        } else {
                            self.list = _.values(_.map(_list.message,function(v){
                                return _.map(v.script,function(val,key){
                                    return   {    name: key,
                                        time: v.vtime,
                                        class: v.class,
                                        model:{
                                            oldInput: val,
                                            newInput: val,
                                            mode: "lua"
                                        }
                                    }
                                })
                            }))[0];
                        }
                        self.selected = _.head(self.list);
                    },
                    remove: function(name) {
                        let self = this;
                        let _class = node.name;
                        let _name = name;

                        let _rtn = triggerDelete(_class, _name);

                        if(_rtn === 1){
                            self.refresh();
                        }
                    }
                }
            };
        };

        let appVue = new Vue({
            delimiters: ['${', '}'],
            el: '#app',
            data: {
                layout: null,
	            id: null,
                config: {
                    settings:{
                        showPopoutIcon: false,
                        showCloseIcon: false,
                        selectionEnabled: false,
                        constrainDragToContainer: false
                    },
                    dimensions:{
                        borderWidth:3
                    },
                    content: [{
                        type: 'row',
                        content:[
                            {
                                type: 'stack',
                                width: 18,
                                content:[{
                                    id: 'class-tree',
                                    type: 'component',
                                    componentName: 'omdbComponent',
                                    title:'对象管理',
                                    isClosable: false,
                                    componentState: {
                                        id: 'class-tree',
                                        type: 'class-tree',
                                        pattern: null,
                                        model: { pattern: '', node: null, pnode: null }
                                    }
                                }]
                            },
	                        {
	                            type: 'stack',
	                            content: [
                                    {
                                        type: 'column',
                                        title: '查询',
                                        content:[{
                                            type: 'component',
                                            title: '',
                                            componentName: 'omdbComponent',
                                            componentState: {
                                                id: `div_query_000000`,
                                                bid: `batch_000000`,
	                                            type: 'query-console',
                                                model: { pattern: '', node: null, pnode: null }
                                            }
                                        },
										{
                                            type: 'stack',
                                            activeItemIndex: 1,
                                            content: [
											{
                                                type: 'component',
                                                title: '日志',
                                                componentName: 'omdbComponent',
                                                componentState: {
                                                    id: `div_log_000000`,
                                                    bid: `batch_000000`,
                                                    type: 'log-console',
                                                    model: null
                                                }
                                            },
											{
                                                type: 'component',
                                                title: '结果',
                                                componentName: 'omdbComponent',
                                                componentState: {
                                                    id: `div_output_000000`,
                                                    bid: `batch_000000`,
                                                    type: 'output-console',
                                                    model: null
                                                }
                                            }]
                                        }]
                                    }]
	                        }
                        ]
                    }]
                }

            },
            created: function(){
                let self = this;

                eventHub.$on("OMDB-CLASS-TRIGGER-EVENT",self.addStackFromTree);
                eventHub.$on("QUERY-RESULT-TRIGGER-EVENT", self.addStackFromQuery);
            },
            mounted: function() {
                let self = this;

                self.$nextTick(function() {
                    setTimeout(function () {
                        self.init();
                    });
                })
            },
            methods: {
                init: function(){
                    let self = this;

                    //var savedState = localStorage.getItem('savedState');
                    //self.config = savedState !== null ? JSON.parse(savedState) : self.config;

                    self.layout = new GoldenLayout(self.config, self.$el);

                    self.layout.registerComponent('omdbComponent', function (container, state) {

                    });

                    /*self.layout.on( 'initialised', function(){
                        var noDropStack = myLayout.root.getItemsById( 'no-drop-target' )[ 0 ];
                        var originalGetArea = noDropStack._$getArea;
                        noDropStack._$getArea = function() {
                            var area = originalGetArea.call( noDropStack );
                            delete noDropStack._contentAreaDimensions.header;
                            return area;
                        };
                    });
*/
                    self.layout.on( 'stackCreated', function( stack ){
                        //console.log('stack',stack)

                    });

                    self.layout.on( 'itemCreated', function( item ){
                        //console.log('item',item.config)

                    });

                    self.layout.on( 'columnCreated', function( column ){
                        //console.log('column',column)

                    });

                    self.layout.on( 'componentCreated', function( component ){

                        let _state = component.config;
                        let _id = _state.componentState.id;
                        let _bid = _state.componentState.bid;

                        let html = `<div id="${_id}"></div>`;
                        let _comp = null;

                        component.container.getElement().html(html);

                        if(_state.componentState.type === 'class-tree'){

                            _comp = classTree(_id, _bid, _state.componentState.type, _state.componentState);

                        } else if(_state.componentState.type === 'class-edit'){

                            _comp = classEdit(_id, _bid, _state.componentState.type, _state.componentState);

                        } else if(_state.componentState.type === 'query-console'){

                            _comp = queryConsole(_id, _bid, _state.componentState.type, _state.componentState);

                        } else if(_state.componentState.type === 'output-console'){

                            _comp = outPut(_id, _bid, _state.componentState.model);


                        } else if(_state.componentState.type === 'graph'){

                            _comp = graph(_id, _bid, _state.componentState.type, _state.componentState);


                        } else if(_state.componentState.type === 'log-console'){

                            _comp = logConsole(_id, _bid, _state.componentState.type, _state.componentState);


                        } else if(_state.componentState.type === 'trigger'){

                            _comp = trigger(_id, _bid, _state.componentState.type, _state.componentState);

                        }

                        setTimeout(function(){
                            new Vue(_comp);
                        });


                        /*component.container.on('resize',function() {

                            let _scrollBody = component.container.height;//_.ceil(pxTOvh(component.container.height)*0.52);
                            let _scrollY = _scrollBody;

                            eventHub.$emit("LAYOUT-RESIZE-TRIGGER-EVENT", {scrollY:_scrollY, scrollBody: _scrollBody});
                        });*/


                    });

                    //
                    //	Save state in local storage
                    //
                    /*self.layout.on('stateChanged', function () {
                        var state = JSON.stringify(self.layout.toConfig());
                        localStorage.setItem('savedState', state);
                    });*/

                    //  Initialize GL
                    self.layout.init();

                    //  Update GL on window resize
                    window.addEventListener('resize', function () { self.layout.updateSize(); });

                },
                resetLayout: function () {
                    localStorage.removeItem('savedState');
                    window.location.reload(true);
                },
                addStackFromTree: function( event ) {
                    let self = this;

                    let _bid = `batch_${_.now()}`;

                    let newItemConfig = {
                        type: 'column',
                        title: event.title,
                        content:[{
                            type: 'component',
                            title: event.title,
                            componentName: 'omdbComponent',
                            componentState: {
                                id: `div_query_${_.now()}`,
	                            bid: _bid,
	                            type: event.type,
	                            model: event.model
                            }
                        },{
                            type: 'stack',
                            activeItemIndex: 1,
                            content: [{
                                type: 'component',
                                title: '日志',
                                componentName: 'omdbComponent',
                                componentState: {
                                    id: `div_log_${_.now()}`,
                                    bid: _bid,
                                    type: 'log-console',
                                    model: null
                                }
                            },{
                                type: 'component',
                                title: '结果',
                                componentName: 'omdbComponent',
                                componentState: {
                                    id: `div_output_${_.now()}`,
                                    bid: _bid,
                                    type: 'output-console',
                                    model: null
                                }
                            }]
                        }]
                    };

                    /*if(_.size($(`#id_${v.name}_${v.type}`)) > 0 ){
                        return false;
                    }*/

                    self.layout.root.contentItems[0].contentItems[1].addChild(newItemConfig);

                },
                addStackFromQuery: function( event ) {
                    let self = this;

                    let _bid = `batch_${_.now()}`;

                    if(event.type == "table-new"){
                        let newItemConfig =  {
                            type: 'component',
                            title: `结果_${moment().format("LT")}`,
                            componentName: 'omdbComponent',
                            componentState: {
                                id: `div_output_${_.now()}`,
                                bid: event.bid,
                                type: 'output-console',
                                model: null
                            }
                        };
                        self.layout.root.contentItems[0].contentItems[1].getActiveContentItem().contentItems[1].addChild(newItemConfig);
                    }

                    _.delay(function(){
                        eventHub.$emit(`NEW-QUERY-RESULT-TRIGGER-EVENT-${event.bid}`, event);
                    },500)

                },
                setQueryResult: function(event){
                    let self = this;


                    if(event.type === 'table-update'){
                        let _comp = outPut(event.id, event.bid,event);

                        setTimeout(function(){
                            new Vue(_comp);
                        });
                    } else if(event.type === 'table-new'){
                        appVue.addOutput({
                            type: 'output',
                            node: event
                        });
                    } else if(event.type === 'graph-update'){
			            appVue.updateOutput({
			                type: 'graph',
			                node: event
			            });
			        } else if(event.type === 'graph-new'){
                        appVue.addOutput({
                            type: 'graph',
                            node: event
                        });
                    } else if(event.type === 'trigger'){
                        appVue.addStackFromTree({
                            type: 'trigger',
                            node: event
                        });
                    }
                }
            }
        });

    })
</script>




<script type="text/x-template"  id="class-tree-template">
	<omdb-class-tree-component :id="id"></omdb-class-tree-component>
</script>

<script type="text/x-template"  id="query-console-template">
	<omdb-editor-component :id="id" :bid="bid"
	                      :model="model"
	                      showToolsBar="true"
	                      showStatusBar="true"></omdb-editor-component>
</script>

<script type="text/x-template"  id="class-edit-template">
	<omdb-class-datatables-component :id="id" :bid="bid"
	                               :dataset="model.dataset"
	                               :columns="model.columns"
	                               :options="model.options"
	                               contextmenu="null"
	                               :result="result"></omdb-class-datatables-component>
</script>

<script type="text/x-template"  id="output-console-template">
	<omdb-output-datatables-component :id="id" :bid="bid"
	                               :dataset="model.dataset"
	                               :columns="model.columns"
	                               :options="model.options"
	                               contextmenu="null"
	                               :result="result"></omdb-output-datatables-component>
</script>

<script type="text/x-template"  id="graph-template">
	<vue-graph-component :id="id" :bid="bid"
	                     :graphData="model"></vue-graph-component>
</script>

<script type="text/x-template" id="log-console-template">
	<div :class="'log-console '+ theme">
		<div class="logToolBar">
			<div class="btn-group" role="group" aria-label="...">
				<a href="javascript:void(0);" class="btn btn-sm btn-primary toggle" @click="toggleTheme" title="切换主题"><i class="fas fa-sun"></i></a>
				<a href="javascript:void(0);" class="btn btn-sm btn-primary copy" @click="copyIt" title="复制"><i class="fa fa-copy"></i></a>
				<a href="javascript:void(0);" class="btn btn-sm btn-primary clear" @click="clearIt" title="清空"><i class="fa fa-trash"></i></a>
				<a href="javascript:void(0);" class="btn btn-sm btn-primary debug" @click="debugIt" title="调试"><i class="fa fa-desktop"></i></a>
			</div>
		</div>
		<div contenteditable="true" :class="'log-console-content '+ theme">
			<p v-for="item in model"> [${item[0]}] [<span :class="'log-severity '+item[1]">${item[1]}</span>] <span v-if="_.isEmpty(item[2].content)">${item[2].short}</span><span v-else><a data-toggle="collapse" :href="'#'+item[2].id" aria-expanded="false" :aria-controls="item[2].id">${item[2].short}</a><span class="collapse animated fadeInUp" :id="item[2].id">${item[2].content}</span></span>
			</p>
		</div>
	</div>
</script>

<script type="text/x-template" id="trigger-template">
	<div>

		<div style="background-color:#F7F7F7;margin-bottom:0px;border-radius:0px;border:none;font-size:12px;padding: 5px 0px 5px 10px;;">

			<div class="btn-group">
				<a style="cursor:pointer;" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					选择触发器：${selected.name} <i class="fa fa-angle-down"></i>
				</a>
				<ul class="dropdown-menu">
					<li v-for="item in list" style="display: flex;">
						<a href="javascript:void(0)" style="cursor:pointer;width:90%;"
						   @click="toggle(item)">
							<i class="fa fa-tasks"></i> ${item.name}
						</a>
						<a  href="javascript:void(0)" style="float:right;color:#ddd;float:right;"
						    @click="remove(item.name)"><i class="fa fa-remove"></i></a>
					</li>
				</ul>
			</div>

			<div class="btn-group pull-right" style="margin:-7px 0px;">
				<a  href="#modal-trigger-add"
				    class="btn btn-sm btn-default"
				    title="新建触发器"
				    data-toggle="modal">
					<i class="fa fa-plus"></i>
				</a>
				<a  href="javascript:void(0)"
				    class="btn btn-sm btn-success"
				    title="提交"
				    @click="save">
					<i class="fa fa-save"></i>
				</a>
			</div>

			<span class="pull-right">
            <a id="btn_agent_filter_fullscreen" style="cursor:pointer;">
                <i class="fa fa-fullscreen"></i>
            </a>
          </span>
		</div>

		<div class="vertical-box">
			<div v-if="list[0].name.length > 0">
				<vue-trigger-editor-component :id="id"
				                      :model="selected.model"
				                      showToolsBar="true"
				                      showStatusBar="true"></vue-trigger-editor-component>
			</div>
			<div v-else>

			</div>
		</div>


		<div class="modal fade" id="modal-trigger-add" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel">新增触发器</h4>
					</div>
					<div class="modal-body">

						<label for="">名称</label>
						<input type="text" class="form-control" id="trigger_name" >

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						<button type="button" class="btn btn-primary" data-dismiss="modal" @click="add()">确定</button>
					</div>
				</div>
			</div>
		</div>

	</div>
</script>


{{template "base/footer" .}}

