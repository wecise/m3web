<!--

    [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]
    [::::::::::::::      ::::::::::::::]
    [::::::::::::::      ::::::::::::::]
    [::::::[[[[[[[:      :]]]]]]]::::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[    CODE BY WANGZD    ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [::::::[[[[[[[:      :]]]]]]]::::::]
    [::::::::::::::      ::::::::::::::]
    [::::::::::::::      ::::::::::::::]
    [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]

-->
{{template "base/head" .}}

<!-- zTree Core CSS -->
<link href="{{AppSubUrl}}/web/vendor/zTree/css/omdbStyle/zTreeStyle.css" type="text/css" rel="stylesheet">

<style type="text/css">

    body {
        overflow: hidden;
        background-color: #ffffff;
    }

    .lm_content{
        background-color: #ffffff!important;
    }

    div.mxWindowPane > table > tbody > tr > td > textarea {
        background-color: #333;
        color: #4caf50;
    }

    #view_config_textarea {
        position: relative;
        border: 1px solid #f7f7f7;
        margin: 0px;
        height: 450px;
        width: 100%;
    }

    .btn-xs{
        border-radius: 0px;
    }

    .item {
        cursor: pointer;
    }
    .bold {
        font-weight: bold;
    }

    ul {
        padding-left: 1em;
        line-height: 1.5em;
        list-style-type: dot;
    }

    .item li {
        padding: 0;
        margin: 0;
        list-style: none;/*square inside url('{{AppSubUrl}}/web/vendor/zTree/css/metroStyle/img/line_conn.png');*/
        line-height: 24px;
        text-align: left;
        white-space: nowrap;
        outline: 0;
    }

    .item li :hover{
        background-color: #efefef;
    }
    .item li ::selection{padding-top:0px; background-color:#e5e5e5; color:black; height:24px; opacity:0.8;}


    .node {
        fill: #000;
        cursor: crosshair;
    }

    .node_selected {
        fill: #ff7f0e;
        stroke: #ff7f0e;
    }

    .drag_line {
        stroke: #999;
        stroke-width: 5;
        pointer-events: none;
    }

    .drag_line_hidden {
        stroke: #999;
        stroke-width: 0;
        pointer-events: none;
    }

    .link {
        stroke: #999;
        stroke-width: 5;
        cursor: crosshair;
    }

    .link_selected {
        stroke: #ff7f0e;
    }

    /* For Table Start*/

    table > tbody > tr:not(.detail-view):hover> td {
        background-color: #c3e4f5;
    }

    table > tbody > tr:not(.detail-view).selected> td {
        background-color: #c3e4f5;
    }

    th{
        background-color: #eeeeee;
        text-align: center;
        font-size: 12px;
    }

    .fixed-table-container tbody .selected td {
        background-color: rgba(210,210,210,0.6);/*rgba(3,169,244,0.6);*/
    }


    .fixed-table-toolbar{
        padding-left: 15px;
        padding-right: 15px;
    }

    .fixed-table-container{
        border-radius: 0px;
        border: none;
        border-left-style: none;
        border-right-style: none;
    }

    .fixed-table-pagination{
        padding-left:15px;
    }

    .bootstrap-table .table:not(.table-condensed), .bootstrap-table .table:not(.table-condensed) > tbody > tr > th, .bootstrap-table .table:not(.table-condensed) > tfoot > tr > th, .bootstrap-table .table:not(.table-condensed) > thead > tr > td, .bootstrap-table .table:not(.table-condensed) > tbody > tr > td, .bootstrap-table .table:not(.table-condensed) > tfoot > tr > td {
        padding: 5px;
        white-space: nowrap;
    }

    .pull-right.search > input {
        height: 30px;
    }

    /* For Table End*/

    .editable-click, a.editable-click, a.editable-click:hover {
        border-bottom: none 1px #000000;
    }

    #objectDataTable {
        white-space: nowrap;
    }

    .fixed-table-container tbody td .th-inner, .fixed-table-container thead th .th-inner {
        line-height: 16px;
    }

    .bootstrap-table tbody > tr > td:first-child {
        background-color: rgb(226, 231, 237)!important;
        text-align: center;
        min-width:20px;
        max-width:30px;
        width: 30px;

    }
    .bootstrap-table thead > tr > th:first-child{
        min-width:20px;
        max-width:30px;
    }

    .table>tbody>tr.grey>td, .table>tbody>tr.grey>th, .table>tbody>tr>td.grey, .table>tbody>tr>th.grey, .table>tfoot>tr.grey>td, .table>tfoot>tr.grey>th, .table>tfoot>tr>td.grey, .table>tfoot>tr>th.grey, .table>thead>tr.grey>td, .table>thead>tr.grey>th, .table>thead>tr>td.grey, .table>thead>tr>th.grey {
        background: rgb(240, 243, 244);
        border-color: rgb(226, 231, 236);
    }


    /********************/
    svg {
        overflow: auto;
        padding-left: 35px;
    }

    .node {
        cursor: pointer;
    }
    .node circle {
        fill: #fff;
        stroke: steelblue;
        stroke-width: 5.5px;
    }
    .node text {
        font: 10px sans-serif;
    }
    .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 1.5px;
    }

    .fixed-table-container {
        border-bottom: 0px;
        border-top: 1px solid #e2e7ec;
    }

    /*----------  Class Table Start  ----------*/
    .panel-class {
        padding: 0px;
    }


    /*----------  Data Table Start  ----------*/
    .panel-data {
        padding: 0px;
    }

    /*----------  Query Input Start  ----------*/
    #query_input{
        /*
        min-height: 10vh;
        max-height: 65vh;
        */
        border: 1px solid #f7f7f7;
        border-left: none;
        border-right: none;
        margin: auto;
        width: 100%!important;
    }

    #db_trigger_input{
        min-height: calc(100vh - 220px);
        max-height: calc(100vh - 220px);
        border: 1px solid #f7f7f7;
        border-left: none;
        border-right: none;
        margin: auto;
        height: 400px;
        width: 100%;
    }
    .script-editor-component {
        min-height: calc(100vh - 180px);
        max-height: calc(100vh - 180px);
        border: 1px solid #f7f7f7;
        border-left: none;
        border-right: none;
        margin: auto;
        height: 400px;
        width: 100%;
    }

    /*----------  Query Table Start  ----------*/

    .tab-query > .tab-pane > .bootstrap-table > .fixed-table-container thead th .th-inner {
        line-height: 6px;
    }

    .tab-query > .tab-pane > .bootstrap-table > .fixed-table-container > .fixed-table-body {
        /*
        min-height: 29vh;
        max-height: 35vh;
        */
    }

    .query-table-text{
        width: 100px;
        height: 30px;
    }

    /*----------  Query UL Start  ----------*/
    .ul-query > li.active{
        background-color: #ffffff;
    }


    /*----------  Tabs  ----------*/
    .tab-content {
        margin-bottom:  0px;
        padding: 0px;
    }

    /*----------  Split  ----------*/
    .split, .split-flex {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;

        overflow-y: hidden;
        overflow-x: hidden;
    }

    .gutter {
        background-color: #f7f7f7;

        background-repeat: no-repeat;
        background-position: 50%;
    }

    .gutter.gutter-horizontal {
        background-image: url('{{AppSubUrl}}/web/vendor/split/grips/vertical.png');
        cursor: ew-resize;
    }

    .gutter.gutter-vertical {
        background-image: url('{{AppSubUrl}}/web/vendor/split/grips/horizontal.png');
        cursor: ns-resize;
    }

    .split.split-horizontal, .gutter.gutter-horizontal {
        height: 100%;
        float: left;
    }

    /*----------  jumbotron  ----------*/
    .jumbotron {
        background-color:#ffffff;
        border:none;
        color:#b6c2ca;
    }
    .jumbotron > h2 {
        color:#b6c2ca;
    }

    .panel-jumbotron {
        background-color: transparent;
        -moz-box-shadow: none;
        -ms-box-shadow: none;
        -webkit-box-shadow: none;
        height:90vh;
    }

    .trigger-jumbotron {
        height:  82vh;
    }


    .object-footer{
        position:fixed;
        bottom:30px;
    }

</style>

<!--<div id="app"></div>-->


<!-- Jquery Format JS/JSON/SQL JS -->
<script src="{{AppSubUrl}}/web/vendor/jquery-format/jquery.format.js"></script>

<!--Layer Core JS-->
<script src="{{AppSubUrl}}/web/vendor/layer/layer.js"></script>

<!-- D3 JS -->
<script src="{{AppSubUrl}}/web/vendor/d3/d3.v3.min.js"></script>

<link href="{{AppSubUrl}}/web/vendor/highlight/src/styles/default.css" rel="stylesheet" >
<script src="{{AppSubUrl}}/web/vendor/highlight/src/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<link rel="vc" href="{{AppSubUrl}}/web/component/vue-base-datatables-component.html"></link>


<SCRIPT type="text/javascript">

    var eventHub = new Vue();

    VueLoader.onloaded(["vue-base-datatables-component"
    ],function() {

    <!--
        var loading,
            curTreeNodeField,
            objRelationContent = "",
            triggerContent = "",
            queryContent = "",
            dataContent = "",
            tableContent = "";

        var jumbotronStr = `<div id="panel_jumbotron" class="panel panel-jumbotron">
                               <div class="panel-body">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="jumbotron">
                                                <h2>{{.i18n.Tr "mxobject_info_title" }}</h2>
                                                <p>{{.i18n.Tr "mxobject_info_desc" }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <!-- begin col-3 -->
                                        <div class="col-md-3 col-sm-6">
                                          <div class="widget widget-stats bg-grey">
                                            <div class="stats-icon"><i class="fa fa-cubes"></i></div>
                                            <div class="stats-info">
                                              <p>CLASS</p>
                                              <h4>Creation, maintenance</h4>
                                            </div>
                                            <div class="stats-link">
                                              <a href="javascript:;">View Describe <i class="fa fa-arrow-circle-o-right"></i></a>
                                            </div>
                                          </div>
                                        </div>
                                        <!-- end col-3 -->
                                        <!-- begin col-3 -->
                                        <div class="col-md-3 col-sm-6">
                                          <div class="widget widget-stats bg-grey">
                                            <div class="stats-icon"><i class="fa fa-tasks"></i></div>
                                            <div class="stats-info">
                                              <p>DATA</p>
                                              <h4>data maintenance</h4>
                                            </div>
                                            <div class="stats-link">
                                              <a href="javascript:;">View Describe <i class="fa fa-arrow-circle-o-right"></i></a>
                                            </div>
                                          </div>
                                        </div>
                                        <!-- end col-3 -->
                                        <!-- begin col-3 -->
                                        <div class="col-md-3 col-sm-6">
                                          <div class="widget widget-stats bg-grey">
                                            <div class="stats-icon"><i class="fa fa-code"></i></div>
                                            <div class="stats-info">
                                              <p>CQL</p>
                                              <h4>CQL execution window</h4>
                                            </div>
                                            <div class="stats-link">
                                              <a href="javascript:;">View Describe <i class="fa fa-arrow-circle-o-right"></i></a>
                                            </div>
                                          </div>
                                        </div>
                                        <!-- end col-3 -->
                                        <!-- begin col-3 -->
                                        <div class="col-md-3 col-sm-6">
                                          <div class="widget widget-stats bg-grey">
                                            <div class="stats-icon"><i class="fa fa-clock-o"></i></div>
                                            <div class="stats-info">
                                              <p>Trigger</p>
                                              <h4>Trigger management</h4>
                                            </div>
                                            <div class="stats-link">
                                              <a href="javascript:;">View Describe <i class="fa fa-arrow-circle-o-right"></i></a>
                                            </div>
                                          </div>
                                        </div>
                                        <!-- end col-3 -->
                                    </div>
                               </div>
                            </div>`;

        var apVue;


        $(function(){

            $(".current-active-item").html(`<a class="active item" href="/janesware/object"><i class="fa fa-cube"></i> &nbsp;{{.i18n.Tr .ActiveView }}</a>`);

            Vue.component('bootstrap-table', {
                template: `<table :class="classes"></table>`,
                props: {
                    columns: Array,
                    dataset: Array,
                    options: Object,
                    classes: String
                },
                data: function(){
                    return {
                        defaultOptions: {
                            //resizable: true,
                            //showToggle: false,
                            //showColumns: true,
                            //pagination: true,
                            //toolbar: "#custom-toolbar1",
                            //showExport: true,
                            //exportTypes: "['json', 'csv', 'excel']",
                        }
                    }
                },
                watch: {
                    dataset: function(val,oldVal) {
                        let self = this;

                        var cols= $(self.$el).bootstrapTable('getVisibleColumns');

                        if(_.isEmpty(cols)){ // table null
                            $(self.$el).bootstrapTable('destroy').bootstrapTable(_.extend({
                                data: val,
                                columns: self.columns
                            }, self.defaultOptions, self.options));
                        } else {
                            $(self.$el).bootstrapTable('load',val);
                            $(self.$el).bootstrapTable('refreshOptions', _.extend(self.defaultOptions, val));
                        }
                    }
                },
                mounted: function () {
                    var self =  this;

                    self.$nextTick(function () {

                        $(self.$el).bootstrapTable(_.extend({
                            data: self.dataset,
                            columns: self.columns
                        }, self.defaultOptions, self.options));


                    })
                }
            });

            Vue.component('query-table-component', {
                template: `<table :class="classes" data-height="300"></table>`,
                props: {
                    columns: Array,
                    dataset: Array,
                    options: Object,
                    classes: String
                },
                data: function(){
                    return {
                        defaultOptions: {
                            //resizable: true,
                            //showToggle: false,
                            //showColumns: true,
                            //pagination: true,
                            //toolbar: "#custom-toolbar1",
                            //showExport: true,
                            //exportTypes: "['json', 'csv', 'excel']",
                        }
                    }
                },
                watch: {
                    dataset: function(val,oldVal) {
                        let self = this;

                        var cols= $(self.$el).bootstrapTable('getVisibleColumns');

                        if(_.isEmpty(cols)){ // table null
                            $(self.$el).bootstrapTable('destroy').bootstrapTable(_.extend({
                                data: val,
                                columns: self.columns
                            }, self.defaultOptions, self.options));
                        } else {
                            $(self.$el).bootstrapTable('destroy').bootstrapTable(_.extend({
                                data: val,
                                columns: self.columns
                            }, self.defaultOptions, self.options));
                        }
                    }
                },
                mounted: function () {
                    var self =  this;

                    self.$nextTick(function () {

                        $(self.$el).bootstrapTable(_.extend({
                            data: self.dataset,
                            columns: self.columns
                        }, self.defaultOptions, self.options));


                    })
                }
            });

            Vue.component('class-tree-component', {
                template: `<div id="tree" class="ztree"></div>`,
                props: {
                    model:Array
                },
                data: function(){
                    return {
                        zTree: Object,
                        setting: {
                            view: {
                                //addHoverDom: this.addHoverDom,
                                //removeHoverDom: this.removeHoverDom,
                                dblClickExpand: this.onDblClickExpand,
                                addDiyDom: this.addDiyDom
                            },
                            edit: {
                                enable: false
                            },
                            callback: {
                                onClick: this.onClick
                            },
                            data: {
                                simpleData: {
                                    enable: true
                                },
                                key: {
                                    name: 'name',
                                    title: 'name'
                                }
                            },
                            check: {
                                enable: false
                            }
                        },
                        nodes: [],
                        tree: {},
                        selectedNodeName: ""
                    }
                },
                created: function(){
                    let self = this;

                    eventHub.$on("class-tree-refresh-event", self.refresh);
                },
                mounted: function () {
                    var self =  this;

                    self.$nextTick(function () {

                        _.delay(function () {
                            self.init();
                        },500)

                        $("#acc_btn_class_remove").on("click",function() {
                            if( appVue.class.tree.cid == null || appVue.class.tree.cid.length < 1){
                                swal("Please select class!","","info");
                                return false;
                            }

                            swal({
                                title: appVue.class.tree.name,
                                text: "Are you sure,delete it?",
                                type: "warning",
                                showCancelButton: true,

                                cancelButtonText: "Cancel",
                                confirmButtonText: "Delete",
                                confirmButtonColor: "#ff0000"
                            }).then((result) => {
                                if (result.value) {

                                    let _rtn = classDelete(appVue.class.tree.cid);

                                    if(_rtn == 1){
                                        eventHub.$emit("class-tree-refresh-event",null);
                                    }


                                } else if (result.dismiss === 'cancel') {
                                    alertify.log('已取消 ' + appVue.class.tree.curTreeNodeCid);
                                }
                            })
                        });

                        $("#btn_class_new").on("click",function() {

                            let _treeNode = appVue.class.tree.selected;

                            if(_.isEmpty(_treeNode)){
                                swal("Please select the parent class", "", "info");
                                return false;
                            }

                            let _class = appVue.class.tree.name + "/" + $("#class_name").val();
                            _class = _class.replace(/\/\//g,"/")
                            let alias = $("#class_alias").val();
                            let remedy = $("#class_remedy").val();

                            if(_class == self.getSubNodeName(_treeNode)) {
                                swal("Please Confirm!", _class, "info");
                                return false;
                            } else {
                                let jsonObj = new Object();

                                jsonObj.pid = _treeNode.cid;
                                jsonObj.name = _class;
                                jsonObj.alias = alias;
                                jsonObj.remedy = remedy;
                                jsonObj.keymethod = _treeNode.keymethod;
                                jsonObj.ttl = _treeNode.ttl;
                                jsonObj.loption = _treeNode.loption;
                                jsonObj.Fields = _treeNode.Fields;
                                jsonObj.keys = _treeNode.keys;
                                jsonObj.readonly = _treeNode.readonly;
                                jsonObj.mtime = _treeNode.mtime;
                                jsonObj.fieldsObj = _treeNode.fieldsObj;


                                let _rtn = classNew(jsonObj);

                                if(_rtn == 1) {
                                    eventHub.$emit("class-tree-refresh-event",null);
                                }

                            }
                        })

                        $("#acc_btn_class_toggle").on("click",function(){
                            var zTree = $.fn.zTree.getZTreeObj("tree");
                            if(self.setting.data.key.name == "name"){
                                self.setting.data.key.name = "alias";
                                self.init();
                            } else {
                                self.setting.data.key.name = "name";
                                self.init();
                            }
                        })

                    })
                },
                methods:{
                    init: function () {
                        let self = this;

                        if(!_.isEmpty(self.zTree)){
                            self.zTree.destroy();
                        }

                        let _rtn = classList(-1);

                        if (!_.isEmpty(_rtn)){

                            self.zTree = $.fn.zTree.init($("#tree"), self.setting, JSON.parse(_rtn));

                            let _rtnTwice = classList(1);

                            if (!_.isEmpty(_rtnTwice)) {
                                let zTree = $.fn.zTree.getZTreeObj("tree");
                                let nodes = zTree.getNodes();

                                if (nodes.length > 0) {
                                    var tId = nodes[0].tId;
                                    var node = zTree.getNodeByTId(tId);

                                    // append sub nodes
                                    zTree.addNodes(node, JSON.parse(_rtnTwice));
                                }
                            }
                        }


                    },
                    onClick: function (event, treeId, treeNode, clickFlisParentag) {
                        let self = this;

                        appVue.class.tree.pid = treeNode.pid;
                        appVue.class.tree.cid = treeNode.cid;
                        appVue.class.tree.name = treeNode.name;

                        if(!_.isEmpty(self.selectedNodeName)){
                            $("[title='" + self.selectedNodeName + "']").removeClass('curSelectedNode');
                        }

                        self.selectedNodeName = treeNode.name;

                        var loading = null;

                        // append sub nodes
                        jQuery.ajax({
                            url: "/mxobject/schema/class/list",
                            dataType: 'json',
                            type: 'GET',
                            data: {id: appVue.class.tree.cid},
                            beforeSend:function(xhr){
                                loading = layer.load(2, {
                                    shade: [0.1,'#ccc'],
                                    time: 30*1000
                                });
                            },
                            complete: function(xhr, textStatus) {
                                layer.close(loading);

                                $("#panel_jumbotron").remove();
                            },
                            success: function(data, textStatus, xhr) {

                                mxLog.debug("[" + moment().format("LLL") + "] [200] " + appVue.class.tree.cid + " " + JSON.stringify(data,null,2));

                                // append sub tree content
                                eventHub.$emit("tree-selected-event",{id: treeNode.cid, title: treeNode.name, obj: treeNode});

                                if(_.isEmpty(data.message) || data.message == "[]"){
                                    return false;
                                } else {

                                    var zTree = $.fn.zTree.getZTreeObj("tree");

                                    var nodes = zTree.getSelectedNodes();
                                    if (nodes && nodes.length>0) {
                                        zTree.removeChildNodes(nodes[0]);
                                    }

                                    // append sub nodes
                                    zTree.addNodes(treeNode, JSON.parse(data.message));

                                }
                            },
                            error: function(xhr, textStatus, errorThrown) {
                                mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseJSON.error);
                                layer.close(loading);
                            }
                        });
                    },
                    onDblClickExpand: function (treeId, treeNode) {
                        return treeNode.cid > 1;
                    },
                    removeHoverDom: function (treeId, treeNode) {
                        $("#addBtn_"+treeNode.tId).unbind().remove();
                    },
                    addHoverDom: function (treeId, treeNode) {

                        $("#class_name").val();
                        $("#class_name").val(getSubNodeName(treeNode));

                        $("input#class_color").ColorPickerSliders({
                            placement: 'top',
                            color: 'red',
                            swatches: ['red', 'blue', '#green'],
                            customswatches: false,
                            order: {}
                        });

                        $("#class_tags").val($("#class_name").val());
                        $('#class_tags').select2({
                            tags: true,
                            placeholder: "标签",
                            language: "zh-CN",
                        });
                    },
                    getSubNodeName: function (treeNode) {

                        if(treeNode.cid == 1) {
                            return "/";
                        } else {
                            return treeNode.name + "/";
                        }
                    },
                    addDiyDom: function (treeId, treeNode) {
                        let self = this;
                        let aObj = $("#" + treeNode.tId + "_a");

                        if(!_.isEmpty(treeNode.child)){
                            if (treeNode.child.length > 0){
                                let str = "<small style='color:rgb(160,160,160);'>("+treeNode.child.length+")</small>";
                                aObj.append(str);
                            }
                        }
                    },
                    refresh: function () {
                        let self = this;

                        let treeObj = $.fn.zTree.getZTreeObj("tree");
                        let sNodes = treeObj.getSelectedNodes();

                        if (sNodes.length > 0) {
                            var pNode = sNodes[0].getParentNode() || sNodes[0];

                            jQuery.ajax({
                                url: "/mxobject/schema/class/list",
                                dataType: 'json',
                                type: 'GET',
                                data: {
                                    id: pNode.cid
                                },
                                beforeSend: function(xhr) {
                                },
                                complete: function(xhr, textStatus) {
                                },
                                success: function(data, textStatus, xhr) {
                                    self.zTree.removeChildNodes(pNode);
                                    self.zTree.addNodes(pNode, JSON.parse(data.message));

                                    $("[title='" + self.selectedNodeName + "']").addClass('curSelectedNode');
                                },
                                error: function(xhr, textStatus, errorThrown) {
                                }
                            })
                        }
                    }
                }
            });

            Vue.component('script-editor-component',{
                delimiters: ['${', '}'],
                template: `<div :id="id" style="height:45vh;"></div>`,
                props: {
                    id: String,
                    model: Object
                },
                data: function(){
                    return {
                        editor: Object,
                        inputText: String,
                    }
                },
                mounted: function(){
                    let self = this;

                    self.$nextTick(function(){
                        self.init();
                    })
                },
                watch: {
                    'model.oldInput': {
                        handler:function(val,oldVal){
                            let self = this;

                            self.editor.setValue(val);
                        },
                        deep:true
                    }
                },
                created: function () {
                    let self = this;

                },
                methods: {
                    init: function() {
                        let self = this;

                        self.editor = ace.edit(self.id);

                        self.editor.setOptions({
                            minLines: 15,
                        });
                        self.editor.$blockScrolling = Infinity;

                        if(_.isEmpty(self.model.mode)) {
                            self.model.mode = "sql";
                        }

                        self.setTheme();
                        self.setMode();
                        self.setValue();

                    },
                    setTheme: function(){
                        let self = this;

                        self.editor.setTheme("ace/theme/tomorrow");
                    },
                    setMode: function(){
                        let self = this;

                        self.editor.getSession().setMode("ace/mode/"+ self.model.mode);
                    },
                    setValue: function(){
                        let self = this;

                        self.editor.setValue(self.model.oldInput);
                    },
                    getSelected: function(){
                        let self = this;
                        var temp = self.editor.getSelectedText();

                        if(_.isEmpty(temp)){
                            self.inputText = self.editor.getValue();
                        } else {
                            self.inputText = temp;
                        }
                    }
                }
            });

            var config = {
                content: [{
                    type: 'row',
                    content:[
                        {
                            type: 'component',
                            id: 'app',
                            name: 'app',
                            componentName: 'example',
                            componentState: { id: 'app', label: 'A' },
                            isClosable: false
                        }
                    ]
                }],
                settings:{
                    hasHeaders: false
                }
            };

            var myLayout = new GoldenLayout( config);

            myLayout.registerComponent( 'example', function( container, componentState ){
                container.getElement().html(`<div id="` + componentState.id + `"></div>`);
            });

            myLayout.init();

            appVue = new Vue({
                delimiters: ['${', '}'],
                el: '#app',
                template: '#app-template',
                data: {
                    class:{
                        tree: {
                            pid: "",
                            cid: "",
                            name: "",
                            selected: {},
                            selectedParent: {},
                            difference: [],
                            iskey:[],
                            autosearch: 0,
                        },
                        table: {
                            columns:[
                                {'name':'name','title':'Name'},
                                {'name':'title','title':'Title'},
                                {'name':'ftype','title':'Ftype'},
                                {'name':'loption','title':'Loption', visible:false},
                                {'name':'fparam','title':'Fparam', visible:false},
                                {'name':'isindex','title':'Index'},
                                {'name':'iskey','title':'Primary Key'},
                                {'name':'note','title':'Note'},
                                {'name':'mtime','title':'Mtime'},
                                {'name':'class','title':'Class'},
                                {'name':'dispname','title':'Dispname'},
                                {'name':'remedy','title':'Remedy'}
                            ],
                            dataset:[],
                            options: {
                                rowStyle: classTableRowStyle
                            }
                        },
                        ftypeData: [],
                        nameData: [],
                        nameObjData: [],
                        summary: {
                            count: 0
                        }
                    },
                    query: {},
                    tab: {
                        selectedTabId: null,
                    }
                },
                created: function() {
                    let self = this;

                    eventHub.$on("tree-selected-event", self.addTabs);
                },
                mounted:function() {
                    let self = this;

                    self.$nextTick(function(){
                        self.init();
                        self.initPlugin();
                        self.initFtype();
                        self.initColumnByName();
                        self.initColumnByAll();
                        self.initTabsHandle();
                    })
                },
                methods:{
                    init: function() {
                        let self = this;

                        $("#myTabContent").append(jumbotronStr);


                    },
                    initPlugin: function(){
                        let self = this;

                        /* toggle tab trigger DATATABLES resize */
                        $("a[data-toggle='tab']").on("shown.bs.tab",function(){
                            eventHub.$emit("datatable-resize-event", null);
                        })
                    },
                    onHelp: function() {
                        mxLog.consoleName = 'M³ Debug Console';
                        mxLog.show();
                    },
                    initTabsHandle: function() {
                        let self = this;

                        /**
                         * @author  cnwangzd
                         * @todo Tab关闭按钮操作定义
                         */
                        $(".nav-tabs.object").on("click", "[tabclose]", function (e) {
                            self.closeTab();
                        });

                        /**
                         * @author  cnwangzd
                         * @todo Tab双击关闭操作定义
                         */
                        $(".nav-tabs.object").on("dblclick", "[tabcloser]", function (e) {
                            self.closeTab();
                        });

                        /**
                         * @author  cnwangzd
                         * @todo Tab双击关闭操作定义
                         */
                        $(".nav-tabs.object").on("click", "a", function (e) {
                            let _tab = $(this).attr("tabcloser").split("_")[2];

                            self.tab.selectedTabId = _tab;
                            console.log(_tab)
                            switch (_tab) {
                                case "class":
                                    self.initClass();
                                    break;
                                case "data":
                                    self.initData();
                                    break;
                                case "query":
                                    //self.initQuery();
                                    break;
                                case "trigger":
                                    //self.initTrigger();
                                    break;
                                case "relation":
                                    //self.initRelation();
                                    break;
                            }
                        });

                    },
                    initFtype: function () {
                        let self = this;

                        jQuery.ajax({
                            url: '/mxobject/system/schema/ftype',
                            dataType: 'json',
                            type: 'GET',
                            success: function (data, status) {

                                jQuery.each(JSON.parse(data.message),function(key,value){
                                    var o = new Object();
                                    o.value = value.name;
                                    o.text = value.name;
                                    self.class.ftypeData.push(o);
                                });


                            },
                            error: function(xhr, textStatus, errorThrown) {
                                mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                            }
                        });
                    },
                    initColumnByName: function () {
                        let self = this;

                        jQuery.ajax({
                            url: '/mxobject/system/schema/field',
                            dataType: 'json',
                            type: 'GET',
                            success: function (data, status) {

                                obj = JSON.parse(data.message);
                                jQuery.each(obj,function(key,value){
                                    var o = new Object();
                                    o.value = value.name;
                                    o.text = value.name;
                                    self.class.nameData.push(o);
                                })
                            },
                            error: function(xhr, textStatus, errorThrown) {
                                mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                            }
                        });
                    },
                    initColumnByAll: function () {
                        let self = this;

                        jQuery.ajax({
                            url: '/mxobject/system/schema/field',
                            dataType: 'json',
                            type: 'GET',
                            success: function (data, status) {
                                self.class.nameObjData = JSON.parse(data.message);
                            },
                            error: function(xhr, textStatus, errorThrown) {
                                mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                            }
                        });
                    },
                    getSelectedParentByName: function (name) {
                        let self = this;
                        let rtn = null;
                        let _name = name.split("/").slice(0,-1);

                        jQuery.ajax({
                            url: "/mxobject/schema/class/list",
                            dataType: 'json',
                            type: 'GET',
                            async: false,
                            data: {
                                id: _name.join("/") || "/"
                            },
                            success: function (data, status) {

                                if(_.isEmpty(data.message)) return false;

                                rtn = _.attempt(JSON.parse.bind(null, data.message))[0];

                            },
                            error: function(xhr, textStatus, errorThrown){
                                mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                            }
                        });
                        return rtn;
                    },
                    addTabs: function(event) {
                        let self = this;

                        self.class.tree.selected = event.obj;

                        self.class.tree.selectedParent = self.getSelectedParentByName(self.class.tree.selected.name);

                        id1 = "class";
                        id2 = "data";
                        id3 = "query";
                        id4 = "trigger";
                        id6 = "relation";


                        //创建新TAB的title
                        title1 = '<li role="presentation" id="tab_li_' + id1 + '"> <a href="#tab_div_' + id1 + '" role="tab" data-toggle="tab" tabcloser="tab_li_' +id1 + '"> <i class="icon-edit"></i> {{.i18n.Tr "mxobject_class_define_title"}} &nbsp;<i class="icon-remove btn btn-xs" tabclose="tab_li_' + id1 + '"></i> </a></span> </li> ';
                        title2 = '<li role="presentation" id="tab_li_' + id2 + '"> <a href="#tab_div_' + id2 + '" role="tab" data-toggle="tab" tabcloser="tab_li_' +id2 + '"> <i class="icon-table"></i>  {{.i18n.Tr "mxobject_class_data_title"}}</a></span></li> ';
                        title3 = '<li role="presentation" id="tab_li_' + id3 + '"> <a href="#tab_div_' + id3 + '" role="tab" data-toggle="tab" tabcloser="tab_li_' +id3 + '"> <i class="icon-search"></i>  {{.i18n.Tr "mxobject_class_query_title"}}</a></span></li> ';
                        title4 = '<li role="presentation" id="tab_li_' + id4 + '"> <a href="#tab_div_' + id4 + '" role="tab" data-toggle="tab" tabcloser="tab_li_' +id4 + '"> <i class="icon-exchange"></i>  {{.i18n.Tr "mxobject_class_trigger_title"}}</a></span></li> ';
                        title6 = '<li role="presentation" id="tab_li_' + id6 + '"> <a href="#tab_div_' + id6 + '" role="tab" data-toggle="tab" tabcloser="tab_li_' +id6 + '"> <i class="icon-sitemap"></i>  {{.i18n.Tr "mxobject_class_relation_title"}}</a></span></li> ';

                        //是否指定TAB内容
                        content1 = '<div role="tabpanel" class="tab-pane fade in" id="tab_div_' + id1 + '"><div id="panel-class"></div></div>';
                        content2 = '<div role="tabpanel" class="tab-pane fade in" id="tab_div_' + id2 + '"><div id="panel-data"></div></div>';
                        content3 = '<div role="tabpanel" class="tab-pane fade in" id="tab_div_' + id3 + '"><div id="panel-query"></div></div>';
                        content4 = '<div role="tabpanel" class="tab-pane fade in" id="tab_div_' + id4 + '"><div id="panel-trigger"></div></div>';
                        content6 = '<div role="tabpanel" class="tab-pane fade in" id="tab_div_' + id6 + '"><div id="panel-relation"></div></div>';

                        $("#myTabMenu").empty();
                        $("#myTabContent").empty();

                        //加入TABS
                        $(".nav-tabs.object").append(title1);
                        $(".nav-tabs.object").append(title2);
                        $(".nav-tabs.object").append(title3);
                        $(".nav-tabs.object").append(title4);
                        $(".nav-tabs.object").append(title6);

                        $("#myTabContent").append(content1).ready(function(){
                            self.initClass();
                        });

                        $("#myTabContent").append(content2).ready(function() {
                            self.initData();
                        });
                        $("#myTabContent").append(content3).ready(function(){
                            self.initQuery();
                        });
                        $("#myTabContent").append(content4).ready(function(){
                            self.initTrigger();
                        });
                        $("#myTabContent").append(content6).ready(function(){
                            self.initRelation();
                        });

                        //激活TAB
                        if(_.isNull(appVue.tab.selectedTabId)){
                            $("#tab_li_" + id1).addClass("active");
                            $("#tab_div_" + id1).addClass('active');
                        } else {
                            $("#tab_div_" + appVue.tab.selectedTabId).addClass('active');
                            $("#tab_li_" + appVue.tab.selectedTabId).addClass("active");
                        }



                    },
                    closeTab: function () {
                        let self = this;

                        $("#myTabMenu").empty();
                        $('#myTabContent').empty();

                        if($("#myTabContent").children().length == 0){
                            $("#myTabContent").append(jumbotronStr);
                        }
                    },
                    initClass: function () {

                        var classVue = new Vue({
                            delimiters: ['${', '}'],
                            el: '#panel-class',
                            template: `#class-template`,
                            data:{
                                model:[]
                            },
                            mounted: function(){
                                let self = this;

                                self.$nextTick(function(){

                                    let cols = [];
                                    let _data = appVue.class.tree.selected;

                                    appVue.class.tree.iskey =  _.map(_.filter(_data.fieldsObj,function(v){
                                        return v.iskey == "1";
                                    }),'name');

                                    $("#class-table-toolbar").html(`<i class="fa fa-home fa-fw"></i>`+appVue.class.tree.name);
                                    $(".class-panel-footer").html(`<b>Count:</b> ` + _data.fields.length + ` | <b>Primary Keys: </b>` + appVue.class.tree.iskey.join(","));
                                    $("#objectDataTable").bootstrapTable('destroy');

                                    cols.push({
                                        field: "num",
                                        formatter: asNumFormatter,
                                    });

                                    cols.push({
                                        field: "state",
                                        radio: true
                                    });

                                    _.forEach(appVue.class.table.columns, function(v,k) {
                                        if( v.name == "name" ){

                                            cols.push({
                                                field: v.name,
                                                title: v.title,
                                                sortable: true,
                                                editable: {
                                                    title: "选择属性",
                                                    type: "select",
                                                    source: _.sortBy(appVue.class.nameData,"text"),
                                                    emptytext: "---",
                                                    success: function(response,newValue){
                                                        var index = $('.selected').attr('data-index');
                                                        console.log(222,JSON.stringify(appVue.class.nameObjData))
                                                        $.map(appVue.class.nameObjData,function(e) {
                                                            if(newValue == e['name']) {
                                                                $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                                        name: e["name"],
                                                                        title: e['title'],
                                                                        ftype: e['ftype'],
                                                                        loption: e['loption'],
                                                                        fparam:  e['fparam'],
                                                                        isindex: e['isindex'],
                                                                        iskey:   e['iskey'],
                                                                        note: e['note'],
                                                                        mtime: e['mtime'],
                                                                        class: e['class'],
                                                                        dispname: e['dispname'],
                                                                        remedy: e['remedy']
                                                                    }});
                                                            }
                                                        });
                                                    }
                                                }
                                            })
                                        } else if( v.name=="title" ){
                                            cols.push({
                                                field: v.name,
                                                title: v.title,
                                                sortable: true,
                                                editable: {
                                                    title: "输入显示名称",
                                                    emptytext: "---"
                                                }
                                            })
                                        } else if( v.name=="note" ){
                                            cols.push({
                                                field: v.name,
                                                title: v.title,
                                                sortable: true,
                                                editable: {
                                                    title: "输入备注",
                                                    emptytext: "---"
                                                }
                                            })
                                        } else if( v.name=="ftype" ){
                                            cols.push({
                                                field: v.name,
                                                title: v.title,
                                                sortable: true,
                                                /*
                                                editable: {
                                                    title: "选择数据类型",
                                                    type: "select",
                                                    emptytext: "---",
                                                    source: _.sortBy(appVue.class.ftypeData,"text"),
                                                    success: function(response, newValue) {
                                                      var index = $('.selected').attr('data-index');
                                                      switch (newValue) {
                                                        case 'text':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: newValue,
                                                              loption: '{"type":"text"}',
                                                              fparam: "[]"
                                                          }});
                                                          break;
                                                        case 'varchar':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: newValue,
                                                              loption: '{"type":"string"}',
                                                              fparam: "[]"
                                                          }});
                                                          break;
                                                        case 'int':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: newValue,
                                                              loption: '{"type":"integer"}',
                                                              fparam: "[]"
                                                          }});
                                                          break;
                                                        case 'bigint':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: newValue,
                                                              loption: '{"type":"long"}',
                                                              fparam: "[]"
                                                          }});
                                                          break;
                                                        case 'double':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: newValue,
                                                              loption: '{"type":"double"}',
                                                              fparam: "[]"
                                                          }});
                                                          break;
                                                        case 'float':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: newValue,
                                                              loption: '{"type":"float"}',
                                                              fparam: "[]"
                                                          }});
                                                          break;
                                                        case 'blob':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: newValue,
                                                              loption: '{"type":"bytes"}',
                                                              fparam: "[]"
                                                          }});
                                                          break;
                                                        case 'timestamp':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: newValue,
                                                              loption: '{"type":"date", "pattern":"timestamp"}',
                                                              fparam: "[]"
                                                          }});
                                                          break;
                                                        case 'uuid':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: newValue,
                                                              loption: '{"type":"uuid"}',
                                                              fparam: "[]"
                                                          }});
                                                          break;
                                                        case 'inet':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: newValue,
                                                              loption: '{"type":"uuid"}',
                                                              fparam: "[]"
                                                          }});
                                                          break;
                                                        case 'boolean':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: newValue,
                                                              loption: '{"type":"boolean"}',
                                                              fparam: "[]"
                                                          }});
                                                          break;
                                                        case 'varint':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: newValue,
                                                              loption: '{"type":"bigint"}',
                                                              fparam: "[]"
                                                          }});
                                                          break;
                                                        case 'map':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: 'map<bigint,varchar>',
                                                              loption: '{"type":"string"}',
                                                              fparam: "[\'varchar\']"
                                                          }});
                                                          break;
                                                        case 'set':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: 'set',
                                                              loption: '{"type":"string"}',
                                                              fparam: "[\'varchar\']"
                                                          }});
                                                          break;
                                                        case 'list':
                                                          $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                                              ftype: 'list<varchar>',
                                                              loption: '{"type":"string"}',
                                                              fparam: "[\'varchar\']"
                                                          }});
                                                          break;
                                                        return false;
                                                      }
                                                    }
                                                }
                                                */
                                            })
                                        } else if( v.name=="loption" ){
                                            cols.push({
                                                field: v.name,
                                                title: v.title,
                                                sortable: true,
                                                visible: v.visible
                                            })
                                        } else if( v.name=="fparam" ){
                                            cols.push({
                                                field: v.name,
                                                title: v.title,
                                                sortable: true,
                                                visible: v.visible,
                                                editable: {
                                                    emptytext: ""
                                                }
                                            })
                                        } else if( v.name == "isindex" ) {
                                            cols.push({
                                                field: v.name,
                                                title: v.title,
                                                sortable: true,
                                                editable: {
                                                    title: "是否作为索引",
                                                    type: 'select',
                                                    source: [
                                                        {value: 1, text: '是'},
                                                        {value: 0, text: '否'}
                                                    ]
                                                }
                                            })
                                        } else if( v.name=="iskey" ){
                                            cols.push({
                                                field: v.name,
                                                title: v.title,
                                                sortable: true,
                                                editable: {
                                                    title: "是否作为主键",
                                                    type: 'select',
                                                    source: [
                                                        {value: 1, text: '是'},
                                                        {value: 0, text: '否'}
                                                    ]
                                                }
                                            })
                                        } else if( v.name=="class" || v.name=="dispname" || v.name=="remedy" ){
                                            cols.push({
                                                field: v.name,
                                                title: v.title,
                                                sortable: true,
                                                visible: false
                                            })
                                        } else if( v.name == "mtime" ){
                                            cols.push({
                                                field: v.name,
                                                title: v.title,
                                                sortable: true,
                                                formatter: function(val){
                                                    return moment(val).format("LLL");
                                                }
                                            });
                                        } else {
                                            cols.push({
                                                field: v.name,
                                                title: v.title,
                                                sortable: true
                                            })
                                        }
                                    });

                                    console.log(20)

                                    appVue.class.table.dataset = _data;
                                    appVue.class.tree.difference = _.map(_.intersection(appVue.class.tree.selected.Fields, appVue.class.tree.selectedParent.Fields));

                                    console.log(30,appVue.class.table.dataset,cols)
                                    $("#class_define_alias").val(_data.alias);
                                    $("#class_define_remedy").val(_data.remedy);
                                    $("#class_define_ttl").val(_data.ttl);

                                    // sort
                                    let _tmp = [];
                                    let _pull = _.cloneDeep(appVue.class.table.dataset.fieldsObj);
                                    let _contact = [];

                                    _.forEach(appVue.class.tree.difference.sort(),function(v){
                                        let _filter = _.filter(_pull, {name: v})[0];
                                        _.remove(_pull,{name:v});
                                        _tmp.push(_filter);
                                    })

                                    _concat = _.concat(_tmp,_.orderBy(_pull,["iskey"],["desc"]));

                                    $("#objectDataTable").bootstrapTable({columns: cols});
                                    $("#objectDataTable").bootstrapTable('load', _concat);
                                    _.delay(function(){
                                        $("#objectDataTable").bootstrapTable('resetView');
                                    },1000)

                                    _.delay(function(){
                                        $(".panel-class").find(".keep-open.btn-group").before(`<div class="btn-group"><button id="obj_add_button" class="btn btn-sm btn-default" type="button"><i class="icon-plus"></i>{{.i18n.Tr "mxobject_class_define_tool_new"}}</button></div>
                                                          <div class="btn-group"><button id="obj_del_button" class="btn btn-sm btn-danger" type="button"><i class="icon-remove"></i>{{.i18n.Tr "mxobject_class_define_tool_delete"}}</button></div>`);
                                        $(".panel-class").find(".export.btn-group").after(`<div class="btn-group"><button id="obj_advance_button" class="btn btn-sm btn-default" type="button" data-toggle="collapse" data-target="#collapseAdvConfigInfo"><i class="icon-wrench"></i>{{.i18n.Tr "mxobject_class_define_tool_advanced"}}</button></div>
                                                          <div class="btn-group"><button id="obj_submit_button" class="btn btn-sm btn-success" type="button"><i class="icon-save"></i>{{.i18n.Tr "mxobject_class_define_tool_submit"}}</button></div>`);
                                        $(".panel-class").find(".keep-open").find(".btn.btn-default.dropdown-toggle").addClass('btn-sm');
                                        $(".panel-class").find(".export.btn-group").find(".btn.btn-default.dropdown-toggle").addClass('btn-sm');
                                        $(".panel-class").find(".pull-right.search").find("input").css("height","30px");

                                        $("#obj_add_button").click(function () {
                                            $("#objectDataTable").bootstrapTable("insertRow",{index: 0, row: {
                                                        name: '',
                                                        title: '',
                                                        ftype: '',
                                                        loption: '',
                                                        fparam: '',
                                                        isindex: 1,
                                                        iskey: 0,
                                                        note: '',
                                                        class: [],
                                                        dispname: {},
                                                        remedy: {}
                                                    }
                                                }
                                            );
                                        });

                                        $("#obj_del_button").click(function () {
                                            var ids = $.map($("#objectDataTable").bootstrapTable('getSelections'), function (row) {
                                                return row.name;
                                            });
                                            $("#objectDataTable").bootstrapTable('remove', {
                                                field: 'name',
                                                values: ids
                                            });
                                        });

                                        $("#obj_submit_button").on("click",function() {

                                            appVue.class.table.dataset.alias = $("#class_define_alias").val();
                                            appVue.class.table.dataset.remedy = $("#class_define_remedy").val();
                                            appVue.class.table.dataset.ttl = parseFloat($("#class_define_ttl").val());


                                            var obj = $("#objectDataTable").bootstrapTable('getData');

                                            jQuery.each(obj, function(index, val) {
                                                if(val.name == null || val.name == '---') {
                                                    obj.splice(index, 1);
                                                }
                                            });

                                            jQuery.each(obj, function(index, val) {

                                                val['fparam'] = eval(val['fparam']);

                                                val['isindex'] = eval(val['isindex']);

                                                val['iskey'] = eval(val['iskey']);

                                            });

                                            appVue.class.table.dataset.fieldsObj = obj;

                                            let _rtn = classNew(appVue.class.table.dataset);

                                            if(_rtn == 1){
                                                eventHub.$emit("class-tree-refresh-event",null);
                                            }
                                        });
                                    },500)
                                })
                            }
                        });
                    },
                    initData: function () {

                        var onContextMenu = function(row, $el){
                            let self = this;

                            if($el.data("item") == "action-details"){
                                openDetailPanel(row);
                            }
                        };
                        var openDetailPanel = function(row){
                            let self = this;
                            var win;
                            var w = $( window ).width();//document.body.clientWidth;
                            var h = $( window ).height();//(document.body.clientHeight || document.documentElement.clientHeight);
                            var wW = $( window ).width()*2/3;
                            var hH = $( window ).height()*2/3;
                            var lrwh = [(w-wW)/2, (h-hH)/2, wW, hH];
                            var tb = document.createElement('div');

                            $(tb).append(`<ul class="nav nav-tabs">
                                              <li class="active"><a href="#tab-detail" data-toggle="tab">Detail</a></li>
                                              <li class=""><a href="#tab-history" data-toggle="tab">History</a></li>
                                          </ul>
                                          <div class="tab-content">
                                              <div class="tab-pane fade active in" id="tab-detail">
                                                  <div class="panel" id="table-dblclick-show-panel" :model="model"></div>
                                              </div>
                                              <div class="tab-pane fade" id="tab-history">
                                                  <div id="panel-history"></div>
                                              </div>
                                          </div>`);
                            win = new mxWindow(row.id || row.host, tb, lrwh[0], lrwh[1], lrwh[2], lrwh[3], true, true);
                            win.setMaximizable(true);
                            win.setResizable(true);
                            win.setClosable(true);
                            win.setVisible(true);

                            _.delay(function(){
                                var panelVue = new Vue({
                                    delimiters: ['$', '$'],
                                    el: '#table-dblclick-show-panel',
                                    template: ` <div>
                                                    <div class="panel-body" style="padding:0px;">
                                                        <div class="input-group input-group-sm" style="width:100%;" v-for="(item,index) in _.sortBy(model,'name')">
                                                            <div class="input-group-addon" :id="item.name" style="width:200px;text-align: right;border:0px;border-bottom: 1px solid #ccc;border-radius: 0px;background-color:#f7f7f7;">$item.title$</div>
                                                            <textarea class="form-control" :id="item.name" :placeholder="item.title" style="border:0px;border-left: 1px solid #ccc;border-bottom: 1px solid #ccc;">$item.value$</textarea>
                                                        </div>
                                                    </div>
                                                    <div class="panel-footer">

                                                    </div>
                                                </div>`,
                                    data:{
                                        model:[]
                                    },
                                    mounted: function(){
                                        let self = this;

                                        self.$nextTick(function(){

                                            _.forEach(row, function(v,k){
                                                if(_.isObject(v) && v!=null){
                                                    self.model =  _.map(v,function(val,key){
                                                        return {name:key, title: _.upperFirst(key), value:val};
                                                    })
                                                }else {
                                                    self.model.push({name:k, title: _.upperFirst(k), value:v});
                                                }
                                            })

                                            $(self.$el).on('click keyup keydown', 'textarea', function () {
                                                $(this).height(0).height(this.scrollHeight);
                                            }).find('textarea').change();

                                        })

                                    },
                                    methods: {
                                        autosize: function(){
                                            let self = this;
                                            autosize($(self.$el).find("textarea"));
                                        }
                                    }
                                });

                                var historyVue = new Vue({
                                    delimiters: ['$', '$'],
                                    el: '#panel-history',
                                    template: ` <div>
                                                    <bootstrap-table :columns="model.columns"
                                                                 :options="model.options"
                                                                 :dataset="model.data"
                                                                 contextMenu=""></bootstrap-table>
                                                    <!-- context menu -->
                                                    <ul id="context-menu-history" class="dropdown-menu">
                                                        <li data-item="action-details"><a href="javascript:void(0)" style="cursor:hand;"><i class="fa fa-list fa-fw"></i> Details</a></li>
                                                    </ul>
                                                </div>`,
                                    data:{
                                        model:{
                                            columns: [],
                                            options: {
                                                resizable: true,
                                                showToggle: false,
                                                showColumns: true,
                                                pagination: false,
                                                toolbar: "",
                                                showExport: true,
                                                exportTypes: "['json', 'csv', 'excel']",
                                            },
                                            data: []
                                        }
                                    },
                                    mounted: function(){
                                        let self = this;

                                        self.$nextTick(function(){
                                            self.init();
                                        })

                                    },
                                    methods: {
                                        init: function(){
                                            let self = this;
                                            let _param = "id=" + row.id + " | top 100";

                                            let _list = fetchData(_parm);

                                            self.model.columns = _list.meta.columns;
                                            self.model.data = _.orderBy(_list.message,'vtime');

                                        }
                                    }
                                });
                            },500);
                        };

                        var dataVue = new Vue({
                            delimiters: ['${', '}'],
                            el: "#panel-data",
                            template: "#data-template",
                            data: {
                                model:{
                                    data: [],
                                    columns: [],
                                    options: {
                                        info: false
                                    }
                                },
                                table: {
                                    dataset: [],
                                    columns: [],
                                    options:  {
                                    }
                                },
                                result: {
                                    summary: {
                                        count: 0,
                                        time: 0.00,
                                    }
                                }

                            },
                            mounted: function() {
                                let me = this;

                                me.$nextTick(function () {
                                    me.initData();
                                })
                            },
                            methods: {
                                initData: function() {
                                    let me = this;

                                    let _param = `#` + appVue.class.tree.name + `/: | top 100`;

                                    let _stime = _.now();

                                    let _list = fetchData(_param);

                                    if(_.isEmpty(_list.message)) {
                                        me.model.columns = [];
                                        me.model.data = [];
                                        return false;
                                    }

                                    let _classKeys = _.keys(_list.meta.classes);
                                    let _columns = [];

                                    _.forEach(_list.meta.columns[_classKeys[0]],function (v) {
                                        let _sortable = false;

                                        if (v.type === 'timestamp'){
                                            _columns.push({
                                                field: v.name,
                                                title: _.startCase(v.title),
                                                sortable: true,
                                                render: function(data, type, row) {
                                                    return moment(data).format("LLL");
                                                }
                                            });
                                        } else if (v.type === 'date'){
                                            _columns.push({
                                                field: v.name,
                                                title: _.startCase(v.title),
                                                sortable: true,
                                                render: function(data, type, row) {
                                                    return moment(data).format("L");
                                                }
                                            });
                                        } else if (v.type === 'map'){
                                            _columns.push({
                                                field: v.name,
                                                title: v.title,
                                                render: function(data, type, row) {
                                                    return JSON.stringify(data);
                                                }
                                            });
                                        } else if (v.type === 'set' || v.type === 'list'){
                                            _columns.push({
                                                field: v.name,
                                                title: v.title,
                                                render: function(data, type, row) {
                                                    return data.join(",");
                                                }
                                            });
                                        } else if (v.type === 'smallint'){
                                            _columns.push({
                                                field: v.name,
                                                title: _.startCase(v.title),
                                                sortable: true,
                                                render: function(data, type, row) {

                                                    if(!v.enum) return false;

                                                    let _enum = v.enum[data];

                                                    if (!_.isEmpty(_enum)) {
                                                        return _enum[0];
                                                    } else {
                                                        return 'Unknown';
                                                    }

                                                },
                                                cellStyle: function(data, type, row){

                                                    if(!v.enum) return false;

                                                    let _enum = v.enum[data];

                                                    if (!_.isEmpty(_enum)) {
                                                        return {classes: v.name + data};
                                                    } else {
                                                        return {classes: v.name + '_1'};
                                                    }

                                                }
                                            });

                                        } else {
                                            _columns.push({
                                                field: v.name,
                                                title: _.startCase(v.title),
                                                sortable: _.sortable
                                            });
                                        }
                                    })

                                    // sort
                                    let _tmp = [];
                                    let _contact = [];

                                    _.forEach(appVue.class.tree.iskey,function(v){
                                        let _filter = _.filter(_columns, {field: v})[0];
                                        _.remove(_columns,{field:v});
                                        _tmp.push(_filter);
                                    })

                                    _concat = _.concat(_tmp,_columns);

                                    me.model.columns = _concat;

                                    me.model.data = _.filter(_list.message,{class:_classKeys[0]});

                                    me.result.summary.count = _.size(me.model.data);
                                    me.result.summary.time = moment().diff(moment(_stime), 'seond');

                                }
                            }
                        });
                    },
                    initQuery: function () {
                        let self = this;

                        let onContextMenu = function(row, $el){
                            let self = this;

                            if($el.data("item") == "action-details"){
                                openDetailPanel(row);
                            }
                        };

                        let openDetailPanel = function(row){
                            let self = this;
                            var win;
                            var w = $( window ).width();//document.body.clientWidth;
                            var h = $( window ).height();//(document.body.clientHeight || document.documentElement.clientHeight);
                            var wW = $( window ).width()*2/3;
                            var hH = $( window ).height()*2/3;
                            var lrwh = [(w-wW)/2, (h-hH)/2, wW, hH];
                            var tb = document.createElement('div');

                            $(tb).append(`<div class="panel" id="query-table-details-panel" :model="model"></div>`);
                            win = new mxWindow(row.id || row.host, tb, lrwh[0], lrwh[1], lrwh[2], lrwh[3], true, true);
                            win.setMaximizable(true);
                            win.setResizable(true);
                            win.setClosable(true);
                            win.setVisible(true);

                            _.delay(function(){
                                var panelVue = new Vue({
                                    delimiters: ['$', '$'],
                                    el: '#query-table-details-panel',
                                    template: ` <div>
                                                                          <div class="panel-body" style="padding:0px;">
                                                                              <div class="input-group input-group-sm" style="width:100%;" v-for="(item,index) in _.sortBy(model,'name')">
                                                                                  <div class="input-group-addon" :id="item.name" style="width:200px;text-align: right;border:0px;border-bottom: 1px solid #ccc;border-radius: 0px;background-color:#f7f7f7;">$item.title$</div>
                                                                                  <textarea class="form-control"
                                                                                            :id="'attr_'+item.name"
                                                                                            :placeholder="item.title"
                                                                                            style="border:0px;border-left: 1px solid #ccc;border-bottom: 1px solid #ccc;background-color: rgb(255, 255, 255);cursor:pointer;"
                                                                                            readonly>$item.value$</textarea>
                                                                              </div>
                                                                          </div>
                                                                          <div class="panel-footer">

                                                                          </div>
                                                                      </div>`,
                                    data:{
                                        model:[]
                                    },
                                    mounted: function(){
                                        let self = this;

                                        self.$nextTick(function(){

                                            _.forEach(row, function(v,k){
                                                if(_.isObject(v) && v!=null){
                                                    self.model.push({name:k, title: _.upperFirst(k), value: JSON.stringify(v,null,"\t")});
                                                }else {
                                                    self.model.push({name:k, title: _.upperFirst(k), value:v});
                                                }
                                                _.delay(function(){
                                                    $("#attr_"+k).editable({
                                                        type: _.isObject(v)?'textarea':'text',
                                                        emptytext: "-",
                                                        title: k,
                                                        container: 'body',
                                                        /*
                                                        pk: v.id,
                                                        url: "/mxobject/list/sql",
                                                        ajaxOptions: {
                                                            type: 'POST',
                                                            data: {
                                                                ctype: "obj",
                                                                sql: `INSERT JSON '` + JSON.stringify(row) + `'`;
                                                            }
                                                        }
                                                        */
                                                    });
                                                },500)
                                            })

                                            $(self.$el).on('click keyup keydown', 'textarea', function () {
                                                $(this).height(0).height(this.scrollHeight);
                                            }).find('textarea').change();

                                        })

                                    },
                                    methods: {
                                        autosize: function () {
                                            $("textarea").each(function(textarea) {
                                                $this.height( $this[0].scrollHeight );
                                            });
                                        },
                                        onSave: function(){
                                            let self = this;
                                            let _mql = `INSERT JSON '` + JSON.stringify(row) + `'`;
                                            let _rtn = putDataByMql(_mql);
                                        }
                                    }
                                });
                            },500);
                        };

                        let queryVue = new Vue({
                            delimiters: ['${', '}'],
                            el: "#panel-query",
                            template: "#query-template",
                            data: {
                                query: {
                                    editor: null,
                                },
                                result: {
                                    list: [],
                                    summary: {
                                        count: 0,
                                        time: 0.00,
                                    }
                                },
                                split: {
                                    obj: {}
                                }
                            },
                            mounted: function() {
                                let me = this;

                                me.$nextTick(function () {
                                    _.delay(function(){
                                        me.initEditor();
                                        me.initSplit();
                                    },300);
                                })
                            },
                            created: function() {
                                let me = this;

                            },
                            methods: {
                                initSplit: function () {
                                    let me = this;

                                    $(".gutter.gutter-vertical").remove();

                                    me.split.obj = Split(['#query_input', '#query_result'], {
                                        direction: 'vertical',
                                        cursor: 'row-resize',
                                        sizes: [42,32.5],
                                        onDragEnd: function (argument) {
                                            me.heightUpdate();
                                        }
                                    });
                                },
                                heightUpdate: function () {
                                    let me = this;

                                    let containerHeight = $('#query_input').outerHeight();
                                    let lineHeight = me.query.editor.renderer.lineHeight;
                                    let lines = Math.floor(containerHeight/lineHeight);

                                    me.query.editor.setOptions({
                                        minLines: lines,
                                        maxLines: lines,//Infinity,
                                    });
                                },
                                initEditor: function(){
                                    let me = this;

                                    me.query.editor = ace.edit("query_input");

                                    ace.require('ace/ext/settings_menu').init(me.query.editor);

                                    me.query.editor.getSession().on('change', function() {
                                        localStorage.setItem(appVue.class.tree.name,me.query.editor.getValue());
                                    });
                                    me.query.editor.$blockScrolling = Infinity;
                                    me.query.editor.setTheme("ace/theme/tomorrow");
                                    me.query.editor.getSession().setMode("ace/mode/sql");
                                    me.query.editor.focus();
                                    me.query.editor.setOptions({
                                        minLines: 10,
                                        maxLines: Infinity,
                                        enableBasicAutocompletion: true,
                                        enableSnippets: true,
                                        enableLiveAutocompletion: true,
                                        autoScrollEditorIntoView: true,
                                    });
                                    me.query.editor.container.style.lineHeight = 2;
                                    me.query.editor.renderer.updateFontSize();

                                    me.query.editor.commands.addCommands([{
                                        name: "showSettingsMenu",
                                        bindKey: {
                                            win: "Ctrl-9",
                                            mac: "Command-9"
                                        },
                                        exec: function(editor) {
                                            me.query.editor.showSettingsMenu();
                                        },
                                        readOnly: true
                                    }]);

                                    me.heightUpdate();

                                    me.query.editor.getSession().on('change', me.heightUpdate);

                                    let n = me.query.editor.getSession().getValue().split("\n").length;
                                    me.query.editor.gotoLine(n);

                                    $('#query_input').keydown(function (e) {

                                        if (e.ctrlKey && e.keyCode == 13) {
                                            me.onQuery();
                                        }

                                    });

                                    $("#query_result_table").on('click-row.bs.table', function (e, row, $element) {
                                        $('.info').removeClass('info');
                                        $($element).addClass('info');
                                        $("#query_result_table").removeClass('table-hover');
                                    });

                                    let colms =  _.without(appVue.class.tree.selected.Fields,"_tokens");
                                    let cls = "";
                                    if(_.isEmpty(colms)){
                                        cls = "*";
                                    } else {
                                        cls = colms.join(",");
                                    }
                                    let querySql = "select\n\t " + cls + "\nfrom\n\t " + appVue.class.tree.name;

                                    let _cache = me.loadCacheSql();

                                    if(!_.isEmpty(_cache)){
                                        me.query.editor.setValue(_cache);
                                    } else {
                                        me.query.editor.setValue(querySql);
                                    }

                                    me.query.editor.setValue(me.query.editor.getValue(), 1);

                                    //me.onFormat();

                                },
                                loadCacheSql: function() {
                                    let me = this;

                                    return localStorage.getItem(appVue.class.tree.name) || "";
                                },
                                onFormat: function() {
                                    let me = this;

                                    let _mql = me.query.editor.getValue();

                                    if(_.isEmpty(_mql)) return false;

                                    _mql = _mql.replace(/\r?\n/g, " ")
                                        .replace(/\s{0,}select /ig, "\nSELECT\n\t")
                                        .replace(/\s{0,}delete /ig, "\nDELETE\n\t")
                                        .replace(/\s{0,}from /ig, "\nFROM\n\t")
                                        .replace(/\s{0,}where /ig, "\nWHERE\n\t")
                                        .replace(/\s{0,}order\s{1,}by/ig,"\nORDER BY\n\t")
                                        .replace(/\s{0,}limit/ig, "\nLIMIT\n\t")
                                        .replace(/\s{0,}with version /ig, "\nWITH VERSION\n\t")
                                        .replace(/\s{0,}create class /ig, "\nCREATE CLASS\n\t")
                                        .replace(/\s{0,}drop class /ig, "\nDROP CLASS\n\t")
                                        .replace(/\s{0,}alert class /ig, "\nALERT CLASS\n\t")
                                        .replace(/\s{0,}\t/g,"\n\t");

                                    me.query.editor.setValue(_mql);

                                },
                                onQuery: function(){
                                    let me = this;
                                    let oneLevelLoading;
                                    let _sql = me.query.editor.getValue();
                                    let _stime = _.now();
                                    let _columns = [];
                                    let _objAttrList = ['contain','connect','depend','refer','runon'];

                                    if(_.isEmpty(me.query.editor.getValue())){
                                        return false;
                                    }

                                    if( me.query.editor.getSelectedText().length > 0 ) {
                                        _sql = me.query.editor.getSelectedText();
                                    }

                                    let _list = fetchDataByMql(_sql);

                                    if(_.isEmpty(_list)) return false;

                                    // MQL for  CRUD
                                    if( _.lowerCase(_list.message) == "ok" ){
                                        eventHub.$emit("class-tree-refresh-event",null);
                                        swal("Success!","","success");
                                        layer.close(oneLevelLoading);
                                    }

                                    let _data = _.attempt(JSON.parse.bind(null,_list.message));

                                    _columns.push({
                                        field: "num",
                                        formatter: asNumFormatter,
                                    });

                                    let _tmp = _.upperCase(_sql).split("FROM")[0].replace(/SELECT/g,"");

                                    if(_tmp.indexOf("*") > -1 || _.trim(_tmp).length < 1){
                                        _.map(_data[0], function(v,k) {

                                            let tmp = {};

                                            if(k.indexOf("time") > -1){
                                                tmp = {
                                                    field: k,
                                                    title: _.upperFirst(k),
                                                    sortable: true,
                                                    formatter: function(val){
                                                        return moment(val).format("LLL");
                                                    }
                                                };
                                            } else {
                                                if(_.indexOf(_objAttrList,k) > -1){

                                                    tmp = {
                                                        field: k,
                                                        title: _.upperFirst(k),
                                                        sortable: true,
                                                        formatter: function(value,row,index){
                                                            console.log(555,value,row,index)
                                                            return JSON.stringify(value);
                                                        },
                                                        editable: {
                                                            emptytext: "-",
                                                            title: k,
                                                            container: 'body',
                                                            inputclass: 'query-table-text',
                                                            type: 'textarea'
                                                        }
                                                    };
                                                } else {
                                                    tmp = {
                                                        field: k,
                                                        title: _.upperFirst(k),
                                                        sortable: true,
                                                        editable: {
                                                            emptytext: "-",
                                                            title: k,
                                                            container: 'body',
                                                            inputclass: 'query-table-text'
                                                        }
                                                    };
                                                }

                                            }
                                            _columns.push(tmp);
                                        });
                                    } else {
                                        let _cols = _tmp.split(" ");
                                        _.forEach(_cols,function(k){
                                            if(!_.isEmpty(k)){
                                                if(_.indexOf(_objAttrList,k) > -1){
                                                    _columns.push({
                                                        field: _.lowerCase(k),
                                                        title: _.upperFirst(k),
                                                        sortable: true,
                                                        editable: {
                                                            emptytext: "-",
                                                            title: k,
                                                            container: 'body',
                                                            inputclass: 'query-table-text'
                                                        }
                                                    });
                                                } else {
                                                    _columns.push({
                                                        field: _.lowerCase(k),
                                                        title: _.upperFirst(k),
                                                        sortable: true,
                                                        editable: {
                                                            emptytext: "-",
                                                            title: k,
                                                            container: 'body',
                                                            inputclass: 'query-table-text'
                                                        }
                                                    });
                                                }
                                            }
                                        })
                                    }

                                    let _hash = objectHash.sha1(_.trim(_sql));
                                    let _index = _.findIndex(me.result.list, {id: _hash});
                                    let _obj = {
                                        id: _hash,
                                        name: "query_" + _.size(me.result.list)+1,
                                        model:{
                                            options:{
                                                showColumns: false,
                                                pagination: false,
                                                showExport: false,
                                                contextMenu: '#context-menu',
                                                onContextMenuItem: onContextMenu,
                                                onEditableShown: function(editable, field, row, $el){
                                                    console.log(12,field[editable])
                                                },
                                                onEditableSave: function (field, row, oldValue, $el) {
                                                    me.onSave(row);
                                                }
                                            },
                                            columns: _columns,
                                            dataset: _data
                                        }
                                    };

                                    if(_index > -1){
                                        _obj.name = me.result.list[_index].name;
                                        me.result.list.splice(_index,1,_obj);
                                    } else {
                                        me.result.list.push(_obj);
                                    }

                                    $(".ul-query>li").removeClass("active");
                                    $(".ul-query").find("#"+_hash).addClass("active");

                                    $(".tab-query>li").removeClass("active");
                                    $(".tab-query").find("#"+_hash).addClass("active");

                                    me.result.summary.count = _.size(_data);
                                    me.result.summary.time = moment().diff(moment(_stime), 'seond');

                                },
                                onRemove: function(item){
                                    let me = this;
                                    let _index = _.findIndex(me.result.list, item);

                                    me.result.list.splice(_index,1);
                                },
                                onHelp: function() {
                                    mxLog.consoleName = 'M³ Debug Console';
                                    mxLog.show();
                                },
                                onSave: function(row){
                                    let me = this;
                                    let _mql = `INSERT JSON '` + JSON.stringify(row) + `'`;
                                    let _rtn = putDataByMql(_mql);
                                }
                            }
                        });
                    },
                    initTrigger: function () {
                        let self = this;

                        jQuery.ajax({
                            url: '/mxobject/trigger',
                            dataType: 'json',
                            type: 'GET',
                            data: {class: self.class.tree.name},
                            complete: function(xhr, textStatus) {
                                //called when complete
                            },
                            success: function(data, textStatus, xhr) {

                                var triggerVue = new Vue({
                                    delimiters: ['${', '}'],
                                    el: "#panel-trigger",
                                    template: "#trigger-template",
                                    data: {
                                        list: [],
                                        selected: []
                                    },
                                    mounted: function() {
                                        let self = this;

                                        self.$nextTick(function () {

                                            if( _.isEmpty(data.message) ) {
                                                self.list = [{  name: "",
                                                    time: moment().format("LLL"),
                                                    class: appVue.class.tree.name,
                                                    model:{
                                                        oldInput: "",
                                                        newInput: "",
                                                        mode: "lua"
                                                    }
                                                }];
                                            } else {
                                                self.list = _.values(_.map(data.message,function(v){
                                                    return _.map(v.script,function(val,key){
                                                        return   {  name: key,
                                                            time: v.vtime,
                                                            class: v.class,
                                                            model:{
                                                                oldInput: val,
                                                                newInput: val,
                                                                mode: "lua"
                                                            }
                                                        }
                                                    })
                                                }))[0];
                                            }
                                            self.selected = _.head(self.list);
                                        })
                                    },
                                    methods: {
                                        toggle: function(item) {
                                            let self = this;

                                            self.selected = item;
                                        },
                                        add: function() {
                                            let self = this;
                                            let _name = $("#trigger_name").val();

                                            jQuery.ajax({
                                                url: '/mxobject/trigger',
                                                dataType: 'json',
                                                type: 'PUT',
                                                data: {
                                                    class: appVue.class.tree.name,
                                                    name: _name,
                                                    script: ''
                                                },
                                                complete: function(xhr, textStatus) {
                                                    //called when complete
                                                },
                                                success: function(data, textStatus, xhr) {
                                                    self.refresh();
                                                },
                                                error: function(xhr, textStatus, errorThrown) {
                                                    //called when there is an error
                                                }
                                            })
                                        },
                                        save: function() {
                                            let self = this;
                                            let _name = self.selected.name;
                                            let _class = self.selected.class;
                                            let _editor = ace.edit("trigger_editor_"+_name);
                                            let _script = _editor.getValue();

                                            jQuery.ajax({
                                                url: '/mxobject/trigger',
                                                dataType: 'json',
                                                type: 'PUT',
                                                data: {
                                                    class: _class,
                                                    name: _name,
                                                    script: _script
                                                },
                                                complete: function(xhr, textStatus) {
                                                    //called when complete
                                                },
                                                success: function(data, textStatus, xhr) {
                                                    self.refresh();
                                                },
                                                error: function(xhr, textStatus, errorThrown) {
                                                    //called when there is an error
                                                }
                                            })
                                        },
                                        saveAs: function() {
                                            let self = this;
                                            let _name = $("#trigger_name").val();

                                        },
                                        refresh: function() {
                                            let self = this;

                                            jQuery.ajax({
                                                url: '/mxobject/trigger',
                                                dataType: 'json',
                                                type: 'GET',
                                                data: {
                                                    class: appVue.class.tree.name
                                                },
                                                complete: function(xhr, textStatus) {
                                                    //called when complete
                                                },
                                                success: function(data, textStatus, xhr) {

                                                    if( _.isEmpty(data.message)) {
                                                        self.list = [{  name: "",
                                                            time: moment().format("LLL"),
                                                            class: appVue.class.tree.name,
                                                            model:{
                                                                oldInput: "",
                                                                newInput: "",
                                                                mode: "lua"
                                                            }
                                                        }];
                                                    } else {
                                                        self.list = _.values(_.map(data.message,function(v){
                                                            return _.map(v.script,function(val,key){
                                                                return   {    name: key,
                                                                    time: v.vtime,
                                                                    class: v.class,
                                                                    model:{
                                                                        oldInput: val,
                                                                        newInput: val,
                                                                        mode: "lua"
                                                                    }
                                                                }
                                                            })
                                                        }))[0];
                                                    }
                                                    self.selected = _.head(self.list);
                                                },
                                                error: function(xhr, textStatus, errorThrown) {
                                                    //called when there is an error
                                                }
                                            });
                                        },
                                        remove: function(name) {
                                            let self = this;
                                            let _class = appVue.class.tree.name;
                                            let _name = name;

                                            jQuery.ajax({
                                                url: '/mxobject/trigger?class=' + _class + '&name=' + _name,
                                                dataType: 'json',
                                                type: 'DELETE',
                                                complete: function(xhr, textStatus) {
                                                    //called when complete
                                                },
                                                success: function(data, textStatus, xhr) {
                                                    self.refresh();
                                                },
                                                error: function(xhr, textStatus, errorThrown) {
                                                    //called when there is an error
                                                }
                                            })
                                        },
                                        debug: function () {
                                            let self = this;

                                            mxLog.consoleName = 'M³ Debug Console' + " Trigger";
                                            mxLog.show();

                                            let debugMe = function () {

                                                let _param = "#/matrix/consolelog/trigger: | sort vtime asc | top 50";

                                                jQuery.ajax({
                                                    url: '/mxobject/search',
                                                    type: 'POST',
                                                    dataType: 'json',
                                                    data: {
                                                        cond: _param,
                                                        flag: false
                                                    },
                                                    beforeSend:function(xhr){
                                                    },
                                                    complete: function(xhr, textStatus) {
                                                        //func.call();
                                                    },
                                                    success: function(data, textStatus, xhr) {

                                                        if(_.isEmpty(data.message)) {
                                                            return false;
                                                        }

                                                        let _tmp = _.map(data.message,_.partialRight(_.pick, ['vtime','msg']));
                                                        _.forEach(_tmp,function(v) {
                                                            mxLog.writeln("["+moment(v.vtime).format("LLL")+"] " + v.msg);
                                                        });
                                                    },
                                                    error: function(xhr, textStatus, errorThrown) {
                                                        mxLog.warn(errorThrown);
                                                    }
                                                })
                                            }

                                            debugMe();
                                            let _sched = later.parse.text('every 15 sec');
                                            let _timer = later.setInterval(debugMe, _sched);
                                        }
                                    }
                                });

                            },
                            error: function(xhr, textStatus, errorThrown) {
                                //called when there is an error
                            }
                        });
                    },
                    loadRels: function (){

                        var sql = `select json * from matrix.rels`;

                        jQuery.ajax({
                            url: '/mxobject/action',
                            type: 'POST',
                            dataType: 'json',
                            data: {
                                sql
                            },
                            complete: function(xhr, textStatus) {
                            },
                            success: function(data, textStatus, xhr) {
                                $("#realMaintainTable").bootstrapTable({data: JSON.parse(data.message)});
                                $("#realMaintainTable").bootstrapTable("load",JSON.parse(data.message));
                            },
                            error: function(xhr, textStatus, errorThrown) {
                                mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                            }
                        });
                    },
                    initRelation: function () {

                        var relationVue= new Vue({
                            delimiters: ['${', '}'],
                            el: '#panel-relation',
                            template: `#relation-template`,
                            data:{
                                model:[]
                            },
                            mounted: function() {
                                let self = this;

                                self.$nextTick(function () {
                                    var relQueryInputEditor = ace.edit("db_relation_input");
                                    relQueryInputEditor.setOptions({
                                        maxLines: Infinity,
                                        minLines: 10,
                                        enableBasicAutocompletion: true,
                                        enableSnippets: true,
                                        enableLiveAutocompletion: true
                                    });
                                    relQueryInputEditor.$blockScrolling = Infinity
                                    relQueryInputEditor.setTheme("ace/theme/xcode");
                                    relQueryInputEditor.getSession().setMode("ace/mode/lua");
                                    relQueryInputEditor.setAutoScrollEditorIntoView(true);

                                    $("#btn_relation_query_submit").click(function(){
                                        var query = relQueryInputEditor.getValue();

                                        if( relQueryInputEditor.getSelectedText().length > 0) query = relQueryInputEditor.getSelectedText();

                                        if(_.isEmpty(query)) {
                                            swal("Please confirm!","","warning");
                                            return false;
                                        }

                                        jQuery.ajax({
                                            url: "/mxobject/rel",
                                            dataType: 'json',
                                            type: 'POST',
                                            data: { query },
                                            beforeSend:function(xhr){
                                            },
                                            complete: function(xhr, textStatus) {
                                            },
                                            success: function (data, status) {

                                                if (_.isEmpty(data.message)) return false;

                                                var graphData = JSON.parse(data.message);

                                                var m = [20, 120, 20, 20],
                                                    w = 980 - m[1] - m[3],
                                                    h = 300 - m[0] - m[2],
                                                    i = 0,
                                                    root;

                                                var tree = d3.layout.tree()
                                                    .size([h, w]);

                                                var diagonal = d3.svg.diagonal()
                                                    .projection(function(d) { return [d.y, d.x]; });

                                                $("#relation-result").empty();

                                                var vis = d3.select("#relation-result").append("svg:svg")
                                                    .attr("width", w + m[1] + m[3])
                                                    .attr("height", h + m[0] + m[2])
                                                    .append("svg:g")
                                                    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

                                                var temp = [];
                                                graphData.forEach(function(d){
                                                    console.log(d)
                                                    var o = new Object();
                                                    o.name = d.id;
                                                    o.parent = null;
                                                    temp.push(o);
                                                })
                                                var ac = {};
                                                ac.name = "matrix";
                                                ac.children = temp;
                                                ac.parent = null;

                                                root = ac;

                                                root.x0 = h / 2;
                                                root.y0 = 0;

                                                function toggleAll(d) {
                                                    if (d.children) {
                                                        d.children.forEach(toggleAll);
                                                        toggle(d);
                                                    }
                                                }

                                                update(root);

                                                function update(source) {

                                                    var duration = d3.event && d3.event.altKey ? 5000 : 500;

                                                    // Compute the new tree layout.
                                                    var nodes = tree.nodes(root).reverse();

                                                    // Normalize for fixed-depth.
                                                    nodes.forEach(function(d) {
                                                        d.y = d.depth * 180;
                                                    });

                                                    // Update the nodes…
                                                    var node = vis.selectAll("g.node")
                                                        .data(nodes, function(d) { return d.id || (d.id = ++i); });

                                                    // Enter any new nodes at the parent's previous position.
                                                    var nodeEnter = node.enter().append("svg:g")
                                                        .attr("class", "node")
                                                        .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
                                                        .on("click", function(d) { toggle(d); update(d); });

                                                    nodeEnter.append("svg:circle")
                                                        .attr("r", 1e-6)
                                                        .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

                                                    nodeEnter.append('a')
                                                        .attr('xlink:href', function(d) {
                                                            return d.url;
                                                        })
                                                        .append("svg:text")
                                                        .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
                                                        .attr("dy", ".35em")
                                                        .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
                                                        .text(function(d) { return d.name; })
                                                        .style('fill', function(d) {
                                                            return d.free ? 'black' : '#999';
                                                        })
                                                        .style("fill-opacity", 1e-6);

                                                    nodeEnter.append("svg:title")
                                                        .text(function(d) {
                                                            return d.description;
                                                        });

                                                    // Transition nodes to their new position.
                                                    var nodeUpdate = node.transition()
                                                        .duration(duration)
                                                        .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

                                                    nodeUpdate.select("circle")
                                                        .attr("r", 6)
                                                        .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

                                                    nodeUpdate.select("text")
                                                        .style("fill-opacity", 1);

                                                    // Transition exiting nodes to the parent's new position.
                                                    var nodeExit = node.exit().transition()
                                                        .duration(duration)
                                                        .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
                                                        .remove();

                                                    nodeExit.select("circle")
                                                        .attr("r", 1e-6);

                                                    nodeExit.select("text")
                                                        .style("fill-opacity", 1e-6);

                                                    // Update the links…
                                                    var link = vis.selectAll("path.link")
                                                        .data(tree.links(nodes), function(d) { return d.target.id; });

                                                    // Enter any new links at the parent's previous position.
                                                    link.enter().insert("svg:path", "g")
                                                        .attr("class", "link")
                                                        .attr("d", function(d) {
                                                            var o = {x: source.x0, y: source.y0};
                                                            return diagonal({source: o, target: o});
                                                        })
                                                        .transition()
                                                        .duration(duration)
                                                        .attr("d", diagonal);

                                                    // Transition links to their new position.
                                                    link.transition()
                                                        .duration(duration)
                                                        .attr("d", diagonal);

                                                    // Transition exiting nodes to the parent's new position.
                                                    link.exit().transition()
                                                        .duration(duration)
                                                        .attr("d", function(d) {
                                                            var o = {x: source.x, y: source.y};
                                                            return diagonal({source: o, target: o});
                                                        })
                                                        .remove();

                                                    // Stash the old positions for transition.
                                                    nodes.forEach(function(d) {
                                                        d.x0 = d.x;
                                                        d.y0 = d.y;
                                                    });
                                                }

                                                // Toggle children.
                                                function toggle(d) {
                                                    if (d.children) {
                                                        d._children = d.children;
                                                        d.children = null;
                                                    } else {
                                                        d.children = d._children;
                                                        d._children = null;
                                                    }
                                                }
                                            },
                                            error: function(xhr, textStatus, errorThrown) {
                                                mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                                            }
                                        });
                                    });

                                    appVue.loadRels();

                                    $("#realAddModalSave").click(function(event) {
                                        var name = $("#realAddModal_name").val();
                                        var remedy = $("#realAddModal_remedy").val();
                                        var sql = `insert into matrix.rels json '{"name": "`+ name + `", "remedy": "` + remedy + `", "mtime": "` +  _.now() + `"}'`;

                                        jQuery.ajax({
                                            url: '/mxobject/action',
                                            type: 'POST',
                                            dataType: 'json',
                                            data: {
                                                sql
                                            },
                                            complete: function(xhr, textStatus) {
                                                appVue.loadRels();
                                            },
                                            success: function(data, textStatus, xhr) {

                                                swal("添加成功！","","success");
                                                $('#realAddModal').modal('hide');
                                                $("#realAddModal_name").val();
                                                $("#realAddModal_remedy").val();
                                            },
                                            error: function(xhr, textStatus, errorThrown) {
                                                mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                                            }
                                        });
                                    });

                                    $("#realRemove").click(function(event) {
                                        var item = $("#realMaintainTable").bootstrapTable('getSelections');
                                        var sql = `delete from matrix.rels where name ='` + item[0].name + `'`;
                                        jQuery.ajax({
                                            url: '/mxobject/action',
                                            type: 'POST',
                                            dataType: 'json',
                                            data: {
                                                sql
                                            },
                                            complete: function(xhr, textStatus) {
                                                appVue.loadRels();
                                            },
                                            success: function(data, textStatus, xhr) {
                                                swal("删除成功！","","success");
                                            },
                                            error: function(xhr, textStatus, errorThrown) {
                                                mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                                            }
                                        });
                                    });

                                    $("#btn_relation_help").click(function(event){
                                        appVue.onHelp();
                                    })
                                })
                            }
                        });
                    }
                }
            })

        })

        function classTableRowStyle(row,index){

            if(_.includes(appVue.class.tree.difference,row.name)){
                return {
                    classes: "grey"
                };
            } else {
                return {
                    classes: ""
                }
            }
        }

        function asNumFormatter(value, row, index) {
            return index+1;
        }

        function rowStyle(row, index) {
            var classes = ['active', 'info'];

            if (index % 2 === 0) {
                return {
                    classes: classes[0]
                };
            } else {
                return {
                    classes: classes[1]
                };
            }
            return {};
        }

        function formaterDate(value, row, index) {
            return moment(value).format('YYYY-MM-DD HH:MM:ss');
        }

        //-->
    })
</SCRIPT>


<script type="text/x-template" id="app-template">
    <div>
        <div id="sidebar" class="sidebar __web-inspector-hide-shortcut__" style="background-color:#ffffff;overflow:auto;padding-top:0px;">

            <div class="panel panel-grey" style="border-radius: 0px;border-right: 1px solid #f0f3f5;">

                <div class="panel-heading" style="padding:6.5px;">
                    <i class="fa fa-cubes toggle-nav"></i>
                    {{.SignedUser.Company.OSpace}}

                    <span class="pull-right">
                        <div class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                              <span class="caret"></span>
                            </a>
                            <ul id="menu3" class="dropdown-menu dropdown-menu-right" aria-labelledby="drop6">
                                <li>
                                    <a href="#" data-toggle="modal" data-target="#configAddModal" class="tippy" title="添加类定义"><i class="fa fa-plus fa-fw"></i> New Class</a>
                                </li>
                                <li>
                                    <a id="acc_btn_class_remove" href="#" class="tippy" title="删除当前类定义"><i class="fa fa-remove fa-fw"></i>Remove Class</a>
                                </li>
                                <li>
                                    <a id="acc_btn_class_toggle" href="#" class="tippy" title="切换显示"><i class="fa fa-camera fa-fw"></i>Toggle View</a>
                                </li>
                            </ul>
                        </div>

                    </span>
                </div>

                <div class="panel-body" style="border-top:1px solid #f0f3f5;">
                    <class-tree-component></class-tree-component>
                </div>

                <div class="panel-footer object-footer">
                    {{.SignedUser.Name}}
                </div>

            </div>

        </div>

        <div id="content" class="content content-full-width">
            <div class="vertical-box">
                <!-- TAB NAVIGATION -->
                <ul class="nav nav-tabs object" id="myTabMenu" role="tablist">
                </ul>
                <!-- TAB CONTENT -->
                <div class="tab-content object" id="myTabContent">
                </div>
            </div>
            <!-- context menu -->
            <ul id="context-menu" class="dropdown-menu">
                <li data-item="action-details"><a href="javascript:void(0)" style="cursor:hand;"><i class="fa fa-list fa-fw"></i> Details</a></li>
                <li data-item="action-history"><a href="javascript:void(0)" style="cursor:hand;"><i class="fa fa-clock-o fa-fw"></i> History</a></li>
                <li data-item="action-add"><a href="javascript:void(0)" style="cursor:hand;"><i class="fa fa-plus fa-fw"></i> New Action</a></li>
            </ul>
        </div>

        <div class="modal fade" id="configAddModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">请输入类名称</h4>
                    </div>
                    <div class="modal-body">

                        <label for="">类名称</label>
                        <input type="text" class="form-control" id="class_name">

                        <BR>
                        <label for="">类显示名称</label>
                        <input type="text" class="form-control" id="class_alias" >

                        <BR>
                        <label for="">备注</label>
                        <input type="text" class="form-control" id="class_remedy" >

                        <BR>
                        <label for="">颜色</label>
                        <input id="class_color" type="text" class="form-control" value="hsl(180, 50%, 50%)">

                        <BR>
                        <label for="">标签</label>
                        <select id="class_tags" class="form-control" multiple="multiple" style="width:100%;"></select>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="btn_class_new" data-dismiss="modal">提交</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="viewAddAndUpdateModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">视图</h4>
                    </div>
                    <div class="modal-body" style="padding:10px 0px 0px 0px;">

                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#grid" aria-controls="grid" role="tab" data-toggle="tab">页面设计</a></li>
                            <li><a href="#jsonview" aria-controls="jsonview" role="tab" data-toggle="tab">源码</a></li>
                        </ul>

                        <!--Tab container-->
                        <div class="tab-content">
                            <div role="tabpanel" class="tab-pane fade in active" id="grid" style="padding:10px 30px 0px 30px;">

                                <label for="">视图名称</label>
                                <input type="text" class="form-control" id="view_name">

                                <BR>
                                <label for="">图标</label>
                                <input type="text" class="form-control" id="view_icon" >

                                <BR>
                                <label for="">行[row]</label>
                                <input type="number" class="form-control" id="view_row" min="1" step="1">

                                <BR>
                                <label for="">列[col]</label>
                                <input type="number" class="form-control" id="view_col" min="1" step="1">

                                <BR>
                                <label for="">PortalLet</label>
                                <div class="well"></div>

                                <BR>
                                <label for="">是否显示</label><BR>
                                <input type="checkbox" class="form-control" id="view_active" >
                                <BR>
                                <BR>
                            </div>

                            <div role="tabpanel" class="tab-pane fade" id="jsonview">
                                <div id="view_config_textarea"></div>
                            </div>

                        </div>

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="btn_view_submit" data-dismiss="modal">提交</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/x-template" id="class-template">
    <div class="panel">
        <div class="panel-body panel-class">
            <div id="collapseAdvConfigInfo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">

                <div class='row'>

                    <div class="col-lg-6 col-lg-offset-2">
                        <p>
                        <form>
                            <div class="form-group">
                                <label for="">类显示名称</label>
                                <input id="class_define_alias" type="text" class="form-control" aria-label="类显示名称">
                            </div>
                            <div class="form-group">
                                <label for="">对象有效时间</label>
                                <input id="class_define_ttl" type="number" class="form-control" placeholder="-1">
                            </div>
                            <div class="form-group">
                                <label for="">备注</label>
                                <input id="class_define_remedy" type="text" class="form-control" aria-label="备注">
                            </div>
                            <div class="form-group">
                                <label for="">是否保留版本</label>
                                <input type="checkbox"
                                       name="ck_ifversion"
                                       checked>
                            </div>
                            <div class="form-group">
                                <label for="">默认搜索<AutoSearch></label>
                                <input type="checkbox"
                                       name="ck_ifautosearch"
                                       v-model="appVue.class.table.dataset.autosearch"
                                       true-value="1"
                                       false-value="0">
                            </div>
                        </form>
                        </p>
                    </div>
                </div>


            </div>

            <div id="class-table-toolbar">
            </div>
            <!-- Table -->
            <table class="table"
                   id="objectDataTable"
                   data-toggle="table"
                   data-height="550"
                   data-show-columns="true"
                   data-search="true"
                   data-pagination="false"
                   data-click-to-select="true"
                   data-show-export="true"
                   data-page-size="25"
                   data-page-list="[25,50,75,100]"
                   data-row-style="classTableRowStyle"
                   data-export-types="['json', 'xml', 'csv', 'txt', 'sql', 'excel']"
                   data-toolbar="#class-table-toolbar">
            </table>
            <!-- /Table -->
        </div>
        <div class="panel-footer object-footer class-panel-footer">
            Count:
        </div>
    </div>
    <div class="modal fade" role="dialog" aria-labelledby="gridSystemModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="gridSystemModalLabel">采集模版定义</h4>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-12">
                                <textarea id="texar_agentTempleate" class="form-control" rows="20" required="required"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary">提交</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
</script>

<script type="text/x-template" id="data-template">
    <div class="panel">
        <div id="data-table-toolbar">
        </div>
        <div class="panel-body">
            <vue-base-datatables-component id="data-list"
                                           :columns="model.columns"
                                           :dataset="model.data"
                                           :options="model.options"
                                           contextmenu="objectData"></vue-base-datatables-component>
            <table id="dataTable"
                   data-toggle="table"
                   class="table table-striped"
                   data-show-refresh="false"
                   data-show-toggle="false"
                   data-show-columns="true"
                   data-search="true"
                   data-pagination="false"
                   data-click-to-select="true"
                   data-show-export="true"
                   data-page-size="25"
                   data-page-list="[25,50,75,100]"
                   data-export-types="['json', 'xml', 'csv', 'txt', 'sql', 'excel']"
                   data-toolbar="#data-table-toolbar">
            </table>
        </div>
        <div class="panel-footer object-footer">
            <span><b>Count:</b> ${result.summary.count}  |  <b>Primary Key: </b> ${appVue.class.tree.iskey.join(",")} | <b>Use:</b> ${result.summary.time} ms</span>
        </div>
    </div>
</script>

<script type="text/x-template" id="query-template">
    <div class="panel">
        <div class="panel-heading" role="tab">
          <span>
            <i class="fa fa-newspaper-o"></i>
          </span>
            <div class="btn-group pull-right">
                <a href="javascript:void(0)" @click="onFormat" class="btn btn-xs btn-default tippy" title="Format">
                    <i class="fa fa-outdent"></i>
                </a>
                <a href="javascript:void(0)" @click="onQuery" class="btn btn-xs btn-success tippy" title="Query">
                    <i class="fa fa-play"></i>
                </a>
                <a href="javascript:void(0)" @click="onHelp" class="btn btn-xs btn-default tippy" title="Debug">
                    <i class="fa fa-television"></i>
                </a>
            </div>
        </div>

        <div class="panel-body" style="padding:0px;">
            <div id="query_input" class="split split-vertical sql"></div>
            <div id="query_result" class="split split-vertical" role="tabpanel">
                <div v-if="_.size(result.list) == 0" style="padding:15px;">
                    <div class="jumbotron">
                        <h2>No Data</h2>
                        <p>input mql to search data ...</p>
                    </div>
                </div>
                <!-- Nav tabs -->
                <ul class="nav nav-tabs ul-query" role="tablist">
                    <li role="presentation"
                        :class="_.size(result.list)==index+1?'active':''"
                        v-for="(item,index) in result.list"
                        style="display:-webkit-box;">
                        <a :href="'#'+item.id" :aria-controls="item.id" role="tab" data-toggle="tab">${item.name}</a>
                        <a  href="javascropt:void(0);"
                            @click="onRemove(item)"
                            style="color:#9f9f9f;cursor:pointer;">
                            <i class="fa fa-close"></i>
                        </a>
                    </li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content tab-query">
                    <div role="tabpanel" :class="_.size(result.list)==index+1?'tab-pane active':'tab-pane'" :id="item.id" v-for="(item,index) in result.list">
                        <query-table-component :columns="item.model.columns" :options="item.model.options" :dataset="item.model.dataset" classes="table-query"></query-table-component>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-footer object-footer">
            <span><b>Count: </b>${result.summary.count}  | <b>Use: </b>${result.summary.time} ms</span>
        </div>
    </div>
</script>

<script type="text/x-template" id="trigger-template">
    <div class="panel">
        <div class="panel-body">
            <div v-if="_.isEmpty(selected.name)">
                <div class="jumbotron trigger-jumbotron">
                    <h2>No Trigger</h2>
                    <p>The implementation of triggers includes the capability to register a trigger on a table using the familiar MQL syntax. The Trigger API is semi-private and subject to change. </p>
                    <p>
                        <a  class="btn btn-success btn-lg" style="cursor:pointer;padding:0px 5px;"
                            href="#modal-trigger-add" title="New Trigger" data-toggle="modal">
                            Add a trigger
                        </a>
                    </p>
                </div>
            </div>
            <div class="well well-sm" style="background-color:#F7F7F7;margin-bottom:0px;border-radius:0px;border:none;font-size:12px;" v-else>

                <div class="btn-group">
                    <a style="cursor:pointer;" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        ${selected.name} <i class="fa fa-angle-down"></i>
                    </a>
                    <ul class="dropdown-menu">
                        <li v-for="item in list" style="display: flex;">
                            <a href="javascript:void(0)" style="cursor:pointer;width:90%;"
                               @click="toggle(item)">
                                <i class="fa fa-tasks"></i> ${item.name}
                            </a>
                            <a  href="javascript:void(0)" style="float:right;color:#ddd;float:right;"
                                @click="remove(item.name)"><i class="fa fa-remove"></i></a>
                        </li>
                    </ul>
                </div>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <div class="btn-group pull-right">
                    <a  href="#modal-trigger-add"
                        class="btn btn-xs btn-default tippy"
                        title="New Trigger"
                        style="cursor:pointer;padding:0px 5px;"
                        data-toggle="modal">
                        <i class="fa fa-plus"></i>
                    </a>
                    <a  href="javascript:void(0)"
                        class="btn btn-xs btn-default tippy"
                        title="Save"
                        style="cursor:pointer;padding:0px 5px;"
                        @click="save">
                        <i class="fa fa-save"></i>
                    </a>
                    <a  href="javascript:void(0)"
                        class="btn btn-xs btn-default tippy"
                        title="Save as"
                        style="cursor:pointer;padding:0px 5px;">
                        <i class="fa fa-files-o"></i>
                    </a>
                    <a  href="javascript:void(0)"
                        class="btn btn-xs btn-default tippy"
                        title="Debug"
                        style="cursor:pointer;padding:0px 5px;"
                        @click="debug">
                        <i class="fa fa-television"></i>
                    </a>
                </div>

                <span class="pull-right">
                <a id="btn_agent_filter_fullscreen" style="cursor:pointer;">
                    <i class="fa fa-fullscreen"></i>
                </a>
              </span>
            </div>

            <div class="vertical-box">
                <div v-if="list[0].name.length > 0">
                    <script-editor-component :id="'trigger_editor_'+selected.name" :model="selected.model"></script-editor-component>
                </div>
                <div v-else>

                </div>
            </div>
        </div>

        <div class="modal fade" id="modal-trigger-add" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Name</h4>
                    </div>
                    <div class="modal-body">

                        <label for="">Name</label>
                        <input type="text" class="form-control" id="trigger_name" >

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" data-dismiss="modal" @click="add()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/x-template" id="graph-template">
    <div id="svg">
    </div>
</script>

<script type="text/x-template" id="relation-template">
    <div class="panel">

        <div class="panel-body" style="padding:0px;">
            <div role="tabpanel">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs nav-tabs-no-bg" role="tablist">
                    <li role="presentation" class="active">
                        <a href="#relation-query" aria-controls="relation-query" role="tab" data-toggle="tab">Query</a>
                    <li role="presentation">
                        <a href="#relation-maintain" aria-controls="relation-maintain" role="tab" data-toggle="tab">Maintain</a>
                    </li>
                    <li class="pull-right">
                        <div class="btn-group" style="padding:3px;">
                            <a href="javascript:void(0)" id="btn_relation_query_submit" class="btn btn-xs btn-success">
                                <i class="fa fa-play"></i>
                            </a>
                            <a href="javascript:void(0)" id="btn_relation_help" class="btn btn-xs btn-default">
                                <i class="fa fa-television"></i>
                            </a>
                        </div>
                    </li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="relation-query">
                        <div id="db_relation_input"></div>
                        <div id="relation-result" style="border-top:1px solid #efefef;">
                        </div>
                    </div>

                    <div role="tabpanel" class="tab-pane" id="relation-maintain">
                        <div id="toolbar1">
                            <button id="realAdd" class="btn btn-xs btn-success" data-toggle="modal" data-target="#realAddModal"><i class="fa fa-plus fa-fw"></i> Add</button>
                            <button id="realRemove" class="btn btn-xs btn-danger"><i class="fa fa-remove fa-fw"></i> Delete</button>
                        </div>
                        <div class="modal fade" class="modal fade" id="realAddModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                        <h4 class="modal-title">关系添加</h4>
                                    </div>
                                    <div class="modal-body">
                                        <div class='row'>

                                            <div class="col-lg-offset-1 col-lg-6">
                                                <label for="">名称</label>
                                                <input id="realAddModal_name" type="text" class="form-control" aria-label="名称">
                                            </div>

                                        </div>

                                        <BR/><BR/>

                                        <div class='row'>
                                            <div class="col-sm-offset-1 col-lg-6">
                                                <label for="">备注</label>
                                                <input id="realAddModal_remedy" type="text" class="form-control" placeholder="备注">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-xs btn-default" data-dismiss="modal">取消</button>
                                        <button type="button" class="btn btn-xs btn-primary" id="realAddModalSave">提交</button>
                                    </div>
                                </div><!-- /.modal-content -->
                            </div><!-- /.modal-dialog -->
                        </div>

                        <table id="realMaintainTable"
                               data-toggle="table"
                               class="table-striped"
                               data-toolbar="#toolbar1"
                               data-toolbar-align="right"
                               data-pagination="false"
                               data-page-size="25"
                               data-page-list="[25,50,75,100]"
                               data-search="false"
                               data-show-columns="false"
                               data-show-export="false"
                               data-export-types="['json', 'xml', 'csv', 'txt', 'sql', 'excel']"
                               data-height="300">
                            <thead>
                            <tr>
                                <th data-field="state" data-radio="true"></th>
                                <th data-field="name">名称</th>
                                <th data-field="remedy">备注</th>
                                <th data-field="mtime" data-formatter="formaterDate">创建时间</th>
                            </tr>
                            </thead>
                        </table>
                    </div>

                </div>
            </div>
        </div>

        <div class="panel-footer">
        </div>

    </div>
</script>

{{template "base/footer" .}}
