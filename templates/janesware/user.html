<!--

    [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]
    [::::::::::::::      ::::::::::::::]
    [::::::::::::::      ::::::::::::::]
    [::::::[[[[[[[:      :]]]]]]]::::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[    CODE BY WANGZD    ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [::::::[[[[[[[:      :]]]]]]]::::::]
    [::::::::::::::      ::::::::::::::]
    [::::::::::::::      ::::::::::::::]
    [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]

-->
{{template "base/head" .}}
<!-- zTree Core CSS -->
<link href="{{AppSubUrl}}/web/vendor/zTree/css/systemStyle/zTreeStyle.css" type="text/css" rel="stylesheet">

<style type="text/css">

    body {
        overflow: hidden;
    }

    .company-info,
    .company-update,
    .user-info,
    .user-update{
        overflow: auto;
        height: 82vh;
        background: rgb(255, 255, 255);
        padding: 15px;
    }

    .container-fluid {
        margin-bottom: 45px;
        margin: 20px 0px 0px -15px;
    }

    form .button-bars {
        text-align: center;
    }

    #nav .thumbnail{
        padding:0px;
        border: none;
    }

    #nav .thumbnail > .caption{
        padding: 10px 15px;
    }

    .upload-btn-wrapper {
        text-align: center;
    }

    .upload-btn-wrapper input[type=file] {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
    }

    #icon-list ul{
        padding-left: 0;
        list-style: none;
    }

    #icon-list ul > li{
        float: left;
        width: 7.3em;
        height: 115px;
        padding: 10px;
        font-size: 10px;
        line-height: 1.4;
        text-align: center;
        background-color: rgb(249, 249, 249);
        border: 1px solid rgb(255, 255, 255);
    }

    .media-object {
        width: 48px;
        height: 48px;
    }

    .logo-toggle{
        display: block;
        color: rgb(221, 221, 221);
        position: relative;
        right: -129px;
        cursor: pointer;
    }

    .sidebar,
    .sidebar-bg,
    .sidebar-toggle{
        display:none;
    }

</style>

<div id="app"></div>

<script src="{{AppSubUrl}}/web/js/handler/CompanyHandler.js" type="text/javascript"></script>

<!-- ECharts单文件引入 -->
<script src="{{AppSubUrl}}/web/vendor/echart/echarts.min.js"></script>

<!--zTree Core JS-->
<script src="{{AppSubUrl}}/web/vendor/zTree/js/jquery.ztree.core-3.5.js"></script>
<script src="{{AppSubUrl}}/web/vendor/zTree/js/jquery.ztree.excheck-3.5.js"></script>
<script src="{{AppSubUrl}}/web/vendor/zTree/js/jquery.ztree.exedit-3.5.js"></script>

<script type="text/javascript">

    $(function() {

        moment.locale('zh_CN');

        Vue.component('user-update',{
            delimiters: ['${', '}'],
            template: '#user-update-template',
            data: function(){
                return {

                }
            },
            computed: {
                email: function(){
                    const self = this;
                    let email = _.fill([''], {{.SignedUser.Email}});

                    return email.join(",");
                }
            },
            methods: {
                cancel: function(){
                    appVue.currentView = 'user-info';
                }
            }
        });

        Vue.component('user-info',{
            delimiters: ['${', '}'],
            template: '#user-info-template',
            data: function(){
                return {

                }
            },
            computed: {
                email: function(){
                    var self = this;
                    let email = _.fill([''], {{.SignedUser.Email}});

                    return email.join(",");
                },
                vtime: function(){
                    const self = this;
                    let vtime = _.fill([''], {{.SignedUser.Vtime}});

                    return moment(vtime[0]).format("LLL");
                }
            },
            methods: {
                update: function(){
                    appVue.currentView = 'user-update';
                }
            }
        });

        Vue.component('company-update',{
            delimiters: ['${', '}'],
            template: '#company-update-template',
            data: function(){
                return {
                    company:{
                        name: {{.company}},
                        fullname: {{.company_fullname}},
                        icon: {{.icon}},
                        logo: {{.logo}},
                        ospace: {{.ospace}},
                        title: {{.title}},
                        web: {{.website}}
                    },
                    license: null
                }
            },
            mounted: function(){
                const self = this;

                self.$nextTick(function(){
                    self.init();
                })

            },
            methods: {
                init: function(){
                    const self = this;

                    $(self.$el).find("#icon").attr("src",{{.icon}});
                    $(self.$el).find("#logo").attr("src",{{.logo}});

                    let _license = _.attempt(JSON.parse.bind(null, `{{.license}}`));

                    if(_.isEmpty(_license)){
                        self.license = "未经授权用户";
                    } else {
                        self.license = `截止日期：${_license.expire} 服务器数量：${_license.server} 代理数量：${_license.agent}`;
                    }

                },
                update: function(){
                    const self = this;

                    let _rtn = companyHandler.companyUpdate(self.company);

                    if(_rtn == 1){
                        document.location.href = mx.getPage();
                    }
                },
                cancel: function(){
                    appVue.currentView = 'user-info';
                },
                importLicense: function(event){
                    const self = this;

                    let file = event.target.files[0];

                    let rtn = licenseHandler.licenseImport(file);

                    if(rtn == 1){
                        document.location.href = mx.getPage();
                    }

                }
            }
        });

        var appVue = new Vue({
            delimiters: ['${', '}'],
            el: "#app",
            template: "#app-template",
            data: {
                currentView: 'user-info',
                logo: null,
                ifShow: true,
                license: null
            },
            created:function(){
                const self = this;


            },
            computed: {
                vtime: function(){
                    var self = this;
                    let vtime = "{{.SignedUser.Vtime}}";

                    return moment(vtime).format("YYYY-MM-DD HH:mm:ss");
                }
            },
            mounted: function(){
                var self = this;

                self.$nextTick(function(){
                    self.init();
                })
            },
            methods: {
                init: function(){
                    const self = this;

                    let _logo = `{{.logo}}`;

                    self.logo = _logo.replace(/"/g,"");

                    let _license = _.attempt(JSON.parse.bind(null, `{{.license}}`));

                    if(_.isEmpty(_license)){
                        self.license = "未经授权用户";
                    } else {
                        self.license = `${_license.expire}`;
                    }
                },
                update: function(){
                    const self = this;
                    let fullname = `{{.SignedUser.FullName}}.replace(/"/g,"")`;
                    let email = $("#email").val().split(",");
                    let password = $("#password").val();

                    jQuery.ajax({
                        url: '/admin/users/15305020520705546474',
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            fullname: fullname,
                            email: email,
                            password: password
                        },
                        beforeSend: function(xhr) {
                        },
                        complete: function(xhr, textStatus) {
                        },
                        success: function(data, textStatus, xhr) {
                            eventHub.$emit('tree-refresh-event',null);
                        },
                        error: function(xhr, textStatus, errorThrown) {
                            console.log(xhr,textStatus, errorThrown);
                            eventHub.$emit('tree-refresh-event',null);
                        }
                    });

                },
                toggleView: function(view){
                    const self = this;

                    self.currentView = view;
                },
                changeLogo: function(){
                    const self = this;

                    let _win = maxWindow.winInfo("更改Logo",'<div id="fs-info"></div>',null,$('#content'));

                    let _infoVue = new Vue({
                        delimiters: ['#{', '}#'],
                        el: "#fs-info",
                        template: `<div class="row" id="icon-list">
                                      <div class="col-md-12" style="display: list-item;height: 40em;overflow: auto;">
                                        <ul>
                                            <li v-for="icon in model.icon.list">
                                                <a href="#" class="thumbnail" style="border:none;" @click="triggerInput(icon.id)">
                                                  <img class="media-object" :src="icon | pickIcon" style="max-width: 55px;min-width: 55px;;">
                                                  <input type="radio" :ref="icon.id" :id="icon.id"  :value="'/fs'+icon.parent+'/'+icon.name+'?type=download&issys=true'" v-model="model.icon.value" >
                                                </a>
                                            </li>
                                        </ul>
                                      </div>
                                    </div>
                                    <div class="row" style="margin-top:15px;">
                                        <div class="col-md-12" style="text-align:center;">
                                            <a class="btn btn-sm btn-default" href="#home" aria-controls="home" role="tab" data-toggle="tab">返回</a></li>
                                        </div>
                                    </div>`,
                        data: {
                            model: {
                                icon: {
                                    value: '',
                                    list: []
                                }
                            }
                        },
                        watch: {
                            'model.icon.value': {
                                handler: function(val,oldVal){
                                    let me = this;

                                    me.toDataURL(val,function(dataUrl) {
                                        let _config = `{{.company_config}}`;
                                        let _company = {
                                            "name": "{{.company}}",
                                            "logo": dataUrl,
                                            "fullname": "{{.company_fullname}}",
                                            "icon": "{{.icon}}",
                                            "ospace": "{{.ospace}}",
                                            "title": "{{.title}}",
                                            "web": "{{.website}}",
                                            "config": {}
                                        };
                                        let _rtn = companyHandler.companyUpdate(_company);
                                        if(_rtn == 1){
                                            document.location.href = mx.getPage();
                                        }
                                    });
                                },
                                deep:true
                            }
                        },
                        mounted: function() {
                            let me = this;

                            me.$nextTick(function() {
                                me.init();
                            })
                        },
                        filters: {
                            pickIcon: function(item) {
                                return "/fs" + item.parent + "/" + item.name + "?type=download&issys=true";
                            }
                        },
                        methods: {
                            init: function(){
                                let me = this;

                                me.model.icon.list = fsHandler.fsList('/assets/images/files/png');
                            },
                            triggerInput: function(id){
                                const self = this;

                                $(self.$refs[id]).click()
                            },
                            toDataURL: function(url, callback) {
                                let xhr = new XMLHttpRequest();

                                xhr.onload = function() {
                                    var reader = new FileReader();
                                    reader.onloadend = function() {
                                        callback(reader.result);
                                    }
                                    reader.readAsDataURL(xhr.response);
                                };
                                xhr.open('GET', url);
                                xhr.responseType = 'blob';
                                xhr.send();
                            }
                        }
                    })
                }

            }
        })
    });

</script>

<script type="text/x-template" id="app-template">
    <div class="container-fluid">
        <div class="row-fluid">
            <div  class="col-lg-3" id="nav">
                <div class="thumbnail">
                    <div class="company-logo-bg upload-btn-wrapper" @click="changeLogo">
                        <span class="logo-toggle"><i class="fa fa-wrench"></i></span>
                        <img :src="logo" style="max-width:250px;padding: 20px 0 30px 0px;" title="点击更换Logo">
                    </div>
                    <div class="caption">
                        <h5>{{.i18n.Tr "company_info"}}</h5>
                        <p>{{.i18n.Tr "company_name"}}：{{.company}}</p>
                        <p>{{.i18n.Tr "company_fullname"}}：{{.company_fullname}}</p>
                        <p>{{.i18n.Tr "company_icon"}}：{{.icon}}</p>
                        <p>{{.i18n.Tr "company_ospace"}}：{{.ospace}}</p>
                        <p>{{.i18n.Tr "company_title"}}：{{.title}}</p>
                        <p>{{.i18n.Tr "company_license"}}：${license}</p>
                        <p>{{.i18n.Tr "company_product"}}：{{.i18n.Tr "app_desc"}}</p>
                        <div class="text-right">
                            <a class="btn btn-xs btn-white" href="http://{{.website}}" target="_blank"><i class="fa fa-thumbs-up"></i> {{.i18n.Tr "company_web"}} </a>
                            {{if .SignedUser.IsAdmin}}
                            <a class="btn btn-xs btn-success" href="javascript:void(0);" @click="toggleView('company-update')"><i class="fa fa-edit"></i> {{.i18n.Tr "company_update"}}</a>
                            {{end}}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-9" id="content">
                <component v-bind:is="currentView"></component>
            </div>
        </div>
    </div>
</script>


<script type="text/x-template" id="user-update-template">
    <div class="animated fadeIn">
        <h4>{{.i18n.Tr "user_info"}}</h4>
        <hr>
        <form action="/admin/users/15305020520705546474" method="post">
            {{.CsrfTokenHtml}}
            <div class="form-group {{if .Err_UserName}}error{{end}}">
                <label for="user_name">{{.i18n.Tr "username"}}</label>
                <input class="form-control" id="user_name" name="user_name" value="{{.SignedUser.UserName}}" autofocus required disabled="true">
            </div>

            <div class="form-group {{if .Err_Email}}error{{end}}">
                <label for="email">{{.i18n.Tr "email"}}</label>
                <input class="form-control" type="email" id="email" name="email" :value="email" required>
            </div>

            <div class="form-group {{if .Err_Password}}error{{end}}">
                <label for="password">{{.i18n.Tr "password"}}</label>
                <input class="form-control" type="password" id="password" name="password" value="{{.SignedUser.Passwd}}" required>
            </div>

            <div class="form-group button-bars">
                <button class="btn btn-sm btn-success">{{.i18n.Tr "submit"}}</button>
                <a href="javascript:void(0);" class="btn btn-sm btn-default" @click="cancel">{{.i18n.Tr "cancel"}}</a>
            </div>
        </form>

    </div>
</script>

<script type="text/x-template" id="user-info-template">
    <div class="animated fadeIn">
        <h4>{{.i18n.Tr "user_info"}}</h4>
        <hr>
        <form>
            <div class="form-group">
                <label for="user_name">{{.i18n.Tr "username"}}</label>
                <input id="user_name" class="form-control" value="{{.SignedUser.UserName}}" autofocus required disabled="true">
            </div>
            <div class="form-group">
                <label for="user_firstname">{{.i18n.Tr "firstname"}}</label>
                <input id="user_firstname" class="form-control" value="{{.SignedUser.FirstName}}" autofocus required disabled="true">
            </div>
            <div class="form-group">
                <label for="user_lastname">{{.i18n.Tr "lastname"}}</label>
                <input id="user_lastname" class="form-control" value="{{.SignedUser.LastName}}" autofocus required disabled="true">
            </div>
            <div class="form-group">
                <label for="user_group">{{.i18n.Tr "groupname"}}</label>
                <input id="user_group" class="form-control" value="{{.SignedUser.Parent}}" autofocus required disabled="true">
            </div>

            <div class="form-group">
                <label for="email">{{.i18n.Tr "email"}}</label>
                <input id="email" class="form-control" type="email" :value="email" required disabled="true">
            </div>

            <div class="form-group">
                <label for="mobile">{{.i18n.Tr "mobile"}}</label>
                <input id="mobile" class="form-control" type="number" value="{{.SignedUser.Mobile}}" required disabled="true">
            </div>

            <div class="form-group">
                <label for="password">{{.i18n.Tr "password"}}</label>
                <input id="password" class="form-control" type="password" value="{{.SignedUser.Passwd}}" required disabled="true">
            </div>

            <div class="form-group">
                <label for="vtime">{{.i18n.Tr "vtime"}}</label>
                <input id="vtime" class="form-control" :value="vtime" required disabled="true">
            </div>

            <div class="form-group">
                <label for="isactive">{{.i18n.Tr "isactive"}}</label>
                <input type="checkbox" id="isactive" checked="{{.SignedUser.IsActive}}" required disabled="true">
            </div>

            <div class="form-group">
                <label for="isadmin">{{.i18n.Tr "isadmin"}}</label>
                <input type="checkbox" checked="{{.SignedUser.IsAdmin}}" required disabled="true">
            </div>

            <div class="form-group button-bars">
                <a href="javascript:void(0);" class="btn btn-sm btn-success"  @click="update">{{.i18n.Tr "userinfo_update"}}</button>
            </div>
        </form>

    </div>
</script>

<script type="text/x-template" id="company-update-template">
    <div class="animated fadeIn">
        <h4>{{.i18n.Tr "company_info"}}</h4>
        <hr>
        <form>
            <div class="form-group">
                <label for="name">{{.i18n.Tr "company_name"}}</label>
                <input id="name" class="form-control"  v-model="company.name" autofocus required>
            </div>
            <div class="form-group">
                <label for="fullname">{{.i18n.Tr "company_fullname"}}</label>
                <input id="fullname" class="form-control" v-model="company.fullname" autofocus required>
            </div>

            <!--<div class="form-group">
                <label for="logo">{{.i18n.Tr "company_logo"}}</label>
                <img id="logo">
            </div>-->

            <div class="form-group">
                <label for="ospace">{{.i18n.Tr "company_ospace"}}</label>
                <input id="ospace" class="form-control" v-model="company.ospace" required disabled="true">
            </div>

            <div class="form-group">
                <label for="title">{{.i18n.Tr "company_title"}}</label>
                <input id="title" class="form-control" v-model="company.title" required>
            </div>

            <div class="form-group">
                <label for="web">{{.i18n.Tr "company_web"}}</label>
                <input id="web" class="form-control" v-model="company.web" required>
            </div>

            <div class="form-group">
                <label for="config">{{.i18n.Tr "company_license"}}</label>
                <div class="input-group">
                    <input id="config" class="form-control" :value="license" required disabled/>
                    <span class="input-group-btn">
                        <button class="btn btn-default fileinput-button" title="导入License">
                            <input type="file" name="loadfile" @change="importLicense">
                        </button>
                    </span>
                </div>
            </div>

            <!--<div class="form-group">-->
            <!--<label for="icon">{{.i18n.Tr "company_icon"}}</label>-->
            <!--<img id="icon">-->
            <!--</div>-->

            <div class="form-group button-bars">
                <a href="javascript:void(0);" class="btn btn-sm btn-success" @click="update">{{.i18n.Tr "submit"}}</a>
                <a href="javascript:void(0);" class="btn btn-sm btn-default" @click="cancel">{{.i18n.Tr "cancel"}}</a>
            </div>
        </form>

    </div>
</script>


{{template "base/footer" .}}
