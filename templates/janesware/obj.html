<!--

    [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]
    [::::::::::::::      ::::::::::::::]
    [::::::::::::::      ::::::::::::::]
    [::::::[[[[[[[:      :]]]]]]]::::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[    CODE BY WANGZD    ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [:::::[                      ]:::::]
    [::::::[[[[[[[:      :]]]]]]]::::::]
    [::::::::::::::      ::::::::::::::]
    [::::::::::::::      ::::::::::::::]
    [[[[[[[[[[[[[[[      ]]]]]]]]]]]]]]]

-->
{{template "base/head" .}}

<!-- zTree Core CSS -->
<link href="{{AppSubUrl}}/web/vendor/zTree/css/mxobjectTreeStyle/zTreeStyle.css" type="text/css" rel="stylesheet">

<style type="text/css">
   
    body {
        overflow: hidden;
        background-color: #d9e0e7;
    }

    div.mxWindowPane > div > .nav-tabs.nav-justified>.active>a, .nav-tabs.nav-justified>.active>a:focus, .nav-tabs.nav-justified>.active>a:hover, .nav-tabs>li.active>a, .nav-tabs>li.active>a:focus, .nav-tabs>li.active>a:hover {
        background-color: #fff;
        border-radius: 0px;
    }

    div.mxWindowPane > table > tbody > tr > td > textarea {
        background-color: #333;
        color: #4caf50;
    }

    #view_config_textarea {
        position: relative;
        border: 1px solid #f7f7f7;
        margin: 0px;
        height: 450px;
        width: 100%;
    }

    .nav-tabs {
        border-bottom: 0px solid #ddd;
        background-color: transparent;
    }

    .btn-xs{
      border-radius: 0px;
    }

    .item {
      cursor: pointer;
    }
    .bold {
      font-weight: bold;
    }

    ul {
      padding-left: 1em;
      line-height: 1.5em;
      list-style-type: dot;
    }

    .item li {
      padding: 0;
      margin: 0;
      list-style: none;/*square inside url('{{AppSubUrl}}/web/vendor/zTree/css/metroStyle/img/line_conn.png');*/
      line-height: 24px;
      text-align: left;
      white-space: nowrap;
      outline: 0;
    } 

    .item li :hover{
      background-color: #efefef;
    }
    .item li ::selection{padding-top:0px; background-color:#e5e5e5; color:black; height:24px; opacity:0.8;}
    
   
    .node {
      fill: #000;
      cursor: crosshair;
    }

    .node_selected {
      fill: #ff7f0e;
      stroke: #ff7f0e;
    }

    .drag_line {
      stroke: #999;
      stroke-width: 5;
      pointer-events: none;
    }

    .drag_line_hidden {
      stroke: #999;
      stroke-width: 0;
      pointer-events: none;
    }

    .link {
      stroke: #999;
      stroke-width: 5;
      cursor: crosshair;
    }

    .link_selected {
      stroke: #ff7f0e;
    }

    /* For Table Start*/

    table > tbody > tr:not(.detail-view):hover> td {
        background-color: #c3e4f5;
    }

    table > tbody > tr:not(.detail-view).selected> td {
        background-color: #c3e4f5;
    }

    th{
        background-color: #eeeeee;
        text-align: center;
        font-size: 12px;
    }
  
    .fixed-table-container tbody .selected td {
        background-color: rgba(210,210,210,0.6);/*rgba(3,169,244,0.6);*/
    }
    

    .fixed-table-toolbar{
        padding-left: 15px;
        padding-right: 15px;
    }

    .fixed-table-container{
        border-radius: 0px;
        border: none;
        border-left-style: none;
        border-right-style: none;
    }

    .fixed-table-pagination{
        padding-left:15px;
    }

    .bootstrap-table .table:not(.table-condensed), .bootstrap-table .table:not(.table-condensed) > tbody > tr > th, .bootstrap-table .table:not(.table-condensed) > tfoot > tr > th, .bootstrap-table .table:not(.table-condensed) > thead > tr > td, .bootstrap-table .table:not(.table-condensed) > tbody > tr > td, .bootstrap-table .table:not(.table-condensed) > tfoot > tr > td {
        padding: 5px;
        white-space: nowrap;
    }

    .pull-right.search > input {
        height: 30px;
    }

    /* For Table End*/

    .editable-click, a.editable-click, a.editable-click:hover {
        border-bottom: none 1px #000000;
    }

    #objectDataTable{
        white-space: nowrap;
    }
    #objectDataTable > tbody > tr > td:first-child {
        background-color: rgba(238,238,238,1);
        text-align: center;
    }
    #objectDataTable > thead > tr > th:first-child {
        min-width:20px;
        max-width:30px;
    }

    #dataTable > tbody > tr > td:first-child {
      background-color: rgba(238,238,238,1);
      text-align: center;
    }
    #dataTable > thead > tr > th:first-child {
      min-width:20px;
      max-width:30px;
    }
  



    /********************/
    svg {
      overflow: auto;
      padding-left: 35px;
    }
    
    .node {
      cursor: pointer;
    }
    .node circle {
        fill: #fff;
        stroke: steelblue;
        stroke-width: 5.5px;
    }
    .node text {
        font: 10px sans-serif;
    }
    .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 1.5px;
    }

    .fixed-table-container {
        border-bottom: 0px;
        border-top: 1px solid #e2e7ec;
    }
    
    /*----------  Class Table Start  ----------*/
    .panel-class {
       padding: 0px;
    }
    
    .panel-class > .bootstrap-table > .fixed-table-container > .fixed-table-body{
        height: calc(100vh - 215px);
    }


    /*----------  Data Table Start  ----------*/
    .panel-data {
       padding: 0px;
    }
    
    .panel-data > .bootstrap-table > .fixed-table-container > .fixed-table-body{
        height: calc(100vh - 215px);
    }

    /*----------  Query Input Start  ----------*/
    #query_input{
      min-height: 10vh;
      max-height: 80vh;
      border: 1px solid #f7f7f7;
      border-left: none;
      border-right: none;
      margin: auto;
      width: 100%!important;
    }

    #db_trigger_input{
      min-height: calc(100vh - 220px);
      max-height: calc(100vh - 220px);
      border: 1px solid #f7f7f7;
      border-left: none;
      border-right: none;
      margin: auto;
      height: 400px;
      width: 100%;
    }
    .script-editor-component {
      min-height: calc(100vh - 180px);
      max-height: calc(100vh - 180px);
      border: 1px solid #f7f7f7;
      border-left: none;
      border-right: none;
      margin: auto;
      height: 400px;
      width: 100%;
    }
    
    /*----------  Query Table Start  ----------*/
    .tab-query > .tab-pane > .bootstrap-table > .fixed-table-container > .fixed-table-body > table  > tbody > tr > td:first-child {
        background-color: rgba(238,238,238,1);
        text-align: center;
    }
    .tab-query > .tab-pane > .bootstrap-table > .fixed-table-container > .fixed-table-body > table > thead > tr > th:first-child {
        min-width:20px;
        max-width:30px;
    }
    
    .tab-query > .tab-pane > .bootstrap-table > .fixed-table-container > .fixed-table-body > table > thead th .th-inner {
        line-height: 6px;
    }

    .tab-query > .tab-pane > .bootstrap-table > .fixed-table-container > .fixed-table-body {
        min-height: 29vh;
        max-height: 60vh;
    }
    
    /*----------  Query UL Start  ----------*/
    .ul-query > li {
        padding: 2px 15px;
    }

    .ul-query > li > a {
        padding: 0px;
    } 

    .ul-query > li.active{
        background-color: #d9e0e8;
    }

    .ul-query > li.active > a{
        background-color: transparent;
    }

    /*----------  Tabs  ----------*/
    .tab-content {
        margin-bottom:  0px;
        padding: 0px;
    }
    
    /*----------  Panel  ----------*/
    .panel-footer {
        padding: 2px 15px;
    }

    /*----------  Split  ----------*/
    .split, .split-flex {
      -webkit-box-sizing: border-box;
         -moz-box-sizing: border-box;
              box-sizing: border-box;

      overflow-y: auto;
      overflow-x: hidden;
    }

    .gutter {
        background-color: #f7f7f7;

        background-repeat: no-repeat;
        background-position: 50%;
    }

    .gutter.gutter-horizontal {
      background-image: url('{{AppSubUrl}}/web/vendor/split/grips/vertical.png');
      cursor: ew-resize;
    }

    .gutter.gutter-vertical {
      background-image: url('{{AppSubUrl}}/web/vendor/split/grips/horizontal.png');
      cursor: ns-resize;
    }

    .split.split-horizontal, .gutter.gutter-horizontal {
        height: 100%;
        float: left;
    }

    .jumbotron {
        background-color: #FFFFFF;
    }

</style>

<div id="app"></div>

<!--zTree Core JS-->
<script src="{{AppSubUrl}}/web/vendor/zTree/js/jquery.ztree.core-3.5.js"></script>

<!-- Jquery Format JS/JSON/SQL JS -->
<script src="{{AppSubUrl}}/web/vendor/jquery-format/jquery.format.js"></script>

<!--Layer Core JS-->
<script src="{{AppSubUrl}}/web/vendor/layer/layer.js"></script>

<!-- D3 JS -->
<script src="{{AppSubUrl}}/web/vendor/d3/d3.v3.min.js"></script>


<!--Util JS-->
<script src="{{AppSubUrl}}/web/vendor/util.js"></script>


<SCRIPT type="text/javascript">

    <!--
    var loading,
        curTreeNodeField,
        viewCofigContent = `<div class="panel">
                              <div class="panel-heading">
                                <span><i class="fa fa-home"></i></span>
                                <span class="pull-right">
                                  
                                </span>
                              </div>

                              <div class="panel-body">
                                <div class="container-fluid">
                                  <div class="row-fluid"> 
                                    
                                    <div class="nav-secondary">
                                      <nav>
                                        <ul id="view_menu">

                                          <li id="li-app-plus">
                                            <a class="nav-secondary-plus" data-toggle="modal" href="#viewAddAndUpdateModal"><span class="fa fa-plus"></span></a>
                                          </li>
                                          
                                        </ul>
                                      </nav>
                                    </div>

                                  </div>
                                </div>
                                  
                              </div>

                            </div>`,
        keySpaceContent = `<div class="panel"> 
                            <!-- Default panel contents -->
                            <div class="panel-heading">
                              <span>
                                <ul id="keySpaceTabMenu" class="nav nav-tabs">
                                  <!--li id="keySpaceTabMenu_normal"> <a href="#keySpaceTabContent_normal" role="tab" data-toggle="tab" tabcloser="keySpaceTabMenu_normal"> <i class="fa fa-edit"></i> 通用  </a></span> </li-->
                                  <li id="keySpaceTabMenu_class"> <a href="#keySpaceTabContent_class" role="tab" data-toggle="tab" tabcloser="keySpaceTabMenu_class"> <i class="fa fa-edit"></i> class  </a></span> </li>
                                  <li id="keySpaceTabMenu_field"> <a href="#keySpaceTabContent_field" role="tab" data-toggle="tab" tabcloser="keySpaceTabMenu_field"> <i class="fa fa-edit"></i> field  </a></span> </li>
                                  <li id="keySpaceTabMenu_ftype"> <a href="#keySpaceTabContent_ftype" role="tab" data-toggle="tab" tabcloser="keySpaceTabMenu_ftype"> <i class="fa fa-edit"></i> ftype  </a></span> </li>
                                  <li id="keySpaceTabMenu_counter"> <a href="#keySpaceTabContent_counter" role="tab" data-toggle="tab" tabcloser="keySpaceTabMenu_counter"> <i class="fa fa-edit"></i> count  </a></span> </li>
                                  <li id="keySpaceTabMenu_object"> <a href="#keySpaceTabContent_object" role="tab" data-toggle="tab" tabcloser="keySpaceTabMenu_object"> <i class="fa fa-edit"></i> object </a></span> </li>
                                </ul>
                              </span>
                            </div>
                            <div class="panel-body">
                              
                                  
                              <div id="keySpaceTabContent" class="tab-content">
                                
                                <div role="tabpanel" class="tab-pane fade in" id="keySpaceTabContent_normal">
                                  <table id="keySpaceTabMenu_normal_Table"
                                          data-toggle="table" 
                                          class="table-striped"
                                          data-pagination="true"
                                          data-page-size="25"
                                          data-page-list="[25,50,75,100]"
                                          data-search="true" 
                                          data-show-columns="true" 
                                          data-show-toggle="true" 
                                          data-show-export="true" 
                                          data-export-types="['json', 'xml', 'csv', 'txt', 'sql', 'excel']" >
                                  </table>
                                </div>
                                <div role="tabpanel" class="tab-pane fade in" id="keySpaceTabContent_class">
                                  <table id="keySpaceTabContent_class_Table"
                                          data-toggle="table" 
                                          class="table-striped"
                                          data-pagination="true"
                                          data-page-size="25"
                                          data-page-list="[25,50,75,100]"
                                          data-search="true" 
                                          data-show-columns="true" 
                                          data-show-toggle="true" 
                                          data-show-export="true" 
                                          data-export-types="['json', 'xml', 'csv', 'txt', 'sql', 'excel']" >
                                  </table>
                                  
                                </div>
                                <div role="tabpanel" class="tab-pane fade in" id="keySpaceTabContent_field">
                                  <table id="keySpaceTabContent_field_Table"
                                          data-toggle="table" 
                                          class="table-striped"
                                          data-pagination="true"
                                          data-page-size="25"
                                          data-page-list="[25,50,75,100]"
                                          data-search="true" 
                                          data-show-columns="true" 
                                          data-show-toggle="true" 
                                          data-show-export="true" 
                                          data-export-types="['json', 'xml', 'csv', 'txt', 'sql', 'excel']" >
                                  </table>
                                </div>
                                <div role="tabpanel" class="tab-pane fade in" id="keySpaceTabContent_ftype">
                                  <table id="keySpaceTabContent_ftype_Table"
                                          data-toggle="table" 
                                          class="table-striped"
                                          data-pagination="true"
                                          data-page-size="25"
                                          data-page-list="[25,50,75,100]"
                                          data-search="true" 
                                          data-show-columns="true" 
                                          data-show-toggle="true" 
                                          data-show-export="true" 
                                          data-export-types="['json', 'xml', 'csv', 'txt', 'sql', 'excel']" >
                                  </table>
                                </div>
                                <div role="tabpanel" class="tab-pane fade in" id="keySpaceTabContent_counter">
                                  <table id="keySpaceTabContent_counter_Table"
                                          data-toggle="table" 
                                          class="table-striped"
                                          data-pagination="true"
                                          data-page-size="25"
                                          data-page-list="[25,50,75,100]"
                                          data-search="true" 
                                          data-show-columns="true" 
                                          data-show-toggle="true" 
                                          data-show-export="true" 
                                          data-export-types="['json', 'xml', 'csv', 'txt', 'sql', 'excel']" >
                                  </table>
                                </div>
                                <div role="tabpanel" class="tab-pane fade in" id="keySpaceTabContent_object">
                                  <table id="keySpaceTabContent_object_Table"
                                          data-toggle="table" 
                                          class="table-striped"
                                          data-pagination="true"
                                          data-page-size="25"
                                          data-page-list="[25,50,75,100]"
                                          data-search="true" 
                                          data-show-columns="true" 
                                          data-show-toggle="true" 
                                          data-show-export="true" 
                                          data-export-types="['json', 'xml', 'csv', 'txt', 'sql', 'excel']" >
                                  </table>
                                </div>

                              </div>
                          
                            </div>
                          </div>`,
        objRelationContent = `<div class="panel"> 
                              
                                <div class="panel-heading">
                                  <span>
                                    <i class="fa fa-home"></i>
                                  </span>
                                  <span id="db_resultinfo"></span>
                                  <span class="pull-right">
                                    <a id="btn_relation_query_submit" class="btn btn-xs btn-success">
                                      <i class="fa fa-play"></i>
                                    </a>
                                    <a id="btn_relation_help" class="btn btn-xs btn-default">
                                      <i class="fa fa-television"></i>
                                    </a>
                                  </span>
                                </div>
                                
                                <div class="panel-body" style="padding:0px;" >
                                    <div role="tabpanel">
                                      <!-- Nav tabs -->
                                      <ul class="nav nav-tabs" role="tablist">
                                        <li role="presentation" class="active">
                                          <a href="#relation-query" aria-controls="relation-query" role="tab" data-toggle="tab">Query</a>
                                        </li>
                                        <li role="presentation">
                                          <a href="#relation-result" aria-controls="relation-result" role="tab" data-toggle="tab">Result</a>
                                        </li>
                                        <li role="presentation">
                                          <a href="#relation-maintain" aria-controls="relation-maintain" role="tab" data-toggle="tab">Maintain</a>
                                        </li>
                                      </ul>
                                    
                                      <!-- Tab panes -->
                                      <div class="tab-content">
                                          <div role="tabpanel" class="tab-pane active" id="relation-query">
                                              <div id="db_relation_input"></div>
                                          </div>
                                          
                                          <div role="tabpanel" class="tab-pane" id="relation-result">
                                          </div>
                                          
                                          <div role="tabpanel" class="tab-pane" id="relation-maintain">
                                              <div id="toolbar1">
                                                <button id="realAdd" class="btn btn-xs btn-success" data-toggle="modal" data-target="#realAddModal"><i class="fa fa-plus fa-fw"></i> Add</button>
                                                <button id="realRemove" class="btn btn-xs btn-danger"><i class="fa fa-remove fa-fw"></i> Delete</button>
                                                </div>
                                              </div>
                                              <div class="modal fade" class="modal fade" id="realAddModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                                <div class="modal-dialog">
                                                  <div class="modal-content">
                                                    <div class="modal-header">
                                                      <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                                      <h4 class="modal-title">关系添加</h4>
                                                    </div>
                                                    <div class="modal-body">
                                                      <div class='row'>
                                                  
                                                        <div class="col-lg-offset-1 col-lg-6">
                                                          <label for="">名称</label>
                                                          <input id="realAddModal_name" type="text" class="form-control" aria-label="名称">
                                                        </div>

                                                      </div>

                                                      <BR><BR>
                               
                                                      <div class='row'>
                                                        <div class="col-sm-offset-1 col-lg-6">
                                                          <label for="">备注</label>
                                                          <input id="realAddModal_remedy" type="text" class="form-control" placeholder="备注">
                                                        </div>
                                                      </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                      <button type="button" class="btn btn-xs btn-default" data-dismiss="modal">取消</button>
                                                      <button type="button" class="btn btn-xs btn-primary" id="realAddModalSave">提交</button>
                                                    </div>
                                                  </div><!-- /.modal-content -->
                                                </div><!-- /.modal-dialog -->
                                              </div>
                                              <table id="realMaintainTable"
                                                    data-toggle="table" 
                                                    class="table-striped"
                                                    data-toolbar="#toolbar1"
                                                    data-toolbar-align="right"
                                                    data-pagination="false"
                                                    data-page-size="25"
                                                    data-page-list="[25,50,75,100]"
                                                    data-search="false" 
                                                    data-show-columns="false" 
                                                    data-show-export="false" 
                                                    data-export-types="['json', 'xml', 'csv', 'txt', 'sql', 'excel']">
                                                  <thead>
                                                      <tr>
                                                          <th data-field="state" data-radio="true"></th>
                                                          <th data-field="name">名称</th>
                                                          <th data-field="remedy">备注</th>
                                                          <th data-field="mtime" data-formatter="formaterDate">创建时间</th>
                                                      </tr>
                                                  </thead>
                                              </table>
                                          </div>
                                      </div>
                                    </div>
                                </div>

                                <div class="panel-footer">
                                </div>

                              </div>`,
        triggerContent = ``,
        queryContent = ``,
        dataContent = `<div class="panel"> 
                          <div class="panel-heading">
                            <span>
                              <i class="fa fa-home"></i>
                            </span>
                          </div>
                          <div class="panel-body panel-data" style="padding:0px 0px;">
                            
                            <!-- Table -->
                            <table id="dataTable"
                                   data-toggle="table" 
                                   class="table table-striped"
                                   data-show-refresh="false"
                                   data-show-toggle="false" 
                                   data-show-columns="true" 
                                   data-search="true" 
                                   data-pagination="false" 
                                   data-click-to-select="true"
                                   data-show-export="true" 
                                   data-page-size="25"
                                   data-page-list="[25,50,75,100]"
                                   data-export-types="['json', 'xml', 'csv', 'txt', 'sql', 'excel']"
                                   data-detail-view="false">
                            </table>
                            <!-- /Table -->
                          </div>
                       </div>`,
        tableContent = `<div class="panel">
                            <div class="panel-heading" role="tab" id="headingOne">
                              <span>
                                <i class="fa fa-home"></i>
                              </span>
                              <span id="div_define_info"></span>
                            </div>
                            
                            <div class="panel-body panel-class">
                                <div id="collapseAdvConfigInfo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
                                  
                                  <div class='row'>
                                    &nbsp;
                                  </div>

                                  <div class='row'>
                                    
                                    <div class="col-lg-offset-1 col-lg-6">
                                      <label for="">类显示名称</label>
                                      <input id="class_define_alias" type="text" class="form-control" aria-label="类显示名称">
                                    </div>

                                  </div>
                                  
                                  <div class='row'>
                                    &nbsp;
                                  </div>

                                  <div class='row'>
                                    <div class="col-sm-offset-1 col-lg-6">
                                      <label for="">对象有效时间</label>
                                      <input id="class_define_ttl" type="number" class="form-control" placeholder="-1">
                                    </div>
                                  </div>
                                  
                                  <div class='row'>
                                    &nbsp;
                                  </div>

                                  <div class='row'>
                                    <div class="col-lg-offset-1 col-lg-6">
                                      <label for="">备注</label>
                                      <input id="class_define_remedy" type="text" class="form-control" aria-label="备注">
                                    </div>
                                  </div>
                                  
                                  <div class='row'>
                                    &nbsp;
                                  </div>

                                  <div class='row'>
                                    <div class="col-sm-offset-1 col-lg-6">
                                      <label for="">是否保留版本</label>
                                      <BR>
                                      <input type="checkbox" 
                                             name="ck_ifversion" 
                                             checked>
                                    </div>
                                  </div>

                                  <div class='row'>
                                    &nbsp;
                                  </div>
                                </div> 
                            
                                <div id="toolbar">
                                    <!--button id="button" class="btn btn-default btn-ms fa fa-plus"> 添加</button-->
                                </div>
                                <!-- Table -->
                                <table class="table table-striped"
                                       id="objectDataTable"
                                       data-toggle="table" 
                                       data-show-columns="true" 
                                       data-search="true" 
                                       data-pagination="false" 
                                       data-click-to-select="true"
                                       data-show-export="true" 
                                       data-page-size="25"
                                       data-page-list="[25,50,75,100]"
                                       data-export-types="['json', 'xml', 'csv', 'txt', 'sql', 'excel']">
                                </table>
                                <!-- /Table -->
                            </div>
                        </div>
                        <div class="modal fade" role="dialog" aria-labelledby="gridSystemModalLabel">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="gridSystemModalLabel">采集模版定义</h4>
                              </div>
                              <div class="modal-body">
                                <div class="container-fluid">
                                  <div class="row">
                                    <div class="col-md-12">
                                        <textarea id="texar_agentTempleate" class="form-control" rows="20" required="required"></textarea>
                                    </div>                
                                  </div>
                                </div>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary">提交</button>
                              </div>
                            </div><!-- /.modal-content -->
                          </div><!-- /.modal-dialog -->
                        </div>`;


    var jumbotronStr = `<div id="panel_jumbotron" class="panel" style="background-color: transparent;-webkit-box-shadow: none;box-shadow: none;height:90vh;">
                           <div class="panel-body">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="well" style="background-color:#ffffff;border:none;color:#b6c2ca;">
                                            <h2 style="color:#b6c2ca;">{{.i18n.Tr "mxobject_info_title" }}</h2>
                                            <p>{{.i18n.Tr "mxobject_info_desc" }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <!-- begin col-3 -->
                                    <div class="col-md-3 col-sm-6">
                                      <div class="widget widget-stats bg-grey">
                                        <div class="stats-icon"><i class="fa fa-cubes"></i></div>
                                        <div class="stats-info">
                                          <p>CLASS</p>  
                                          <h4>Creation, maintenance</h4>
                                        </div>
                                        <div class="stats-link">
                                          <a href="javascript:;">View Describe <i class="fa fa-arrow-circle-o-right"></i></a>
                                        </div>
                                      </div>
                                    </div>
                                    <!-- end col-3 -->
                                    <!-- begin col-3 -->
                                    <div class="col-md-3 col-sm-6">
                                      <div class="widget widget-stats bg-grey">
                                        <div class="stats-icon"><i class="fa fa-tasks"></i></div>
                                        <div class="stats-info">
                                          <p>DATA</p> 
                                          <h4>data maintenance</h4>
                                        </div>
                                        <div class="stats-link">
                                          <a href="javascript:;">View Describe <i class="fa fa-arrow-circle-o-right"></i></a>
                                        </div>
                                      </div>
                                    </div>
                                    <!-- end col-3 -->
                                    <!-- begin col-3 -->
                                    <div class="col-md-3 col-sm-6">
                                      <div class="widget widget-stats bg-grey">
                                        <div class="stats-icon"><i class="fa fa-code"></i></div>
                                        <div class="stats-info">
                                          <p>CQL</p>  
                                          <h4>CQL execution window</h4>
                                        </div>
                                        <div class="stats-link">
                                          <a href="javascript:;">View Describe <i class="fa fa-arrow-circle-o-right"></i></a>
                                        </div>
                                      </div>
                                    </div>
                                    <!-- end col-3 -->
                                    <!-- begin col-3 -->
                                    <div class="col-md-3 col-sm-6">
                                      <div class="widget widget-stats bg-grey">
                                        <div class="stats-icon"><i class="fa fa-clock-o"></i></div>
                                        <div class="stats-info">
                                          <p>Trigger</p> 
                                          <h4>Trigger management</h4>
                                        </div>
                                        <div class="stats-link">
                                          <a href="javascript:;">View Describe <i class="fa fa-arrow-circle-o-right"></i></a>
                                        </div>
                                      </div>
                                    </div>
                                    <!-- end col-3 -->
                                </div>
                           </div>
                        </div>`;

    var apVue;
    
    /**
     * @author cnwangzd
     * @todo 初始化Document
     */
    $(document).ready(function(){

        $(".current-active-item").html(`<a class="active item" href="/janesware/object"><i class="fa fa-cube"></i> &nbsp;{{.i18n.Tr .ActiveView }}</a>`);

        Vue.component('bootstrap-table', {
            template: `<table :class="classes"></table>`,
            props: {
                columns: Array,
                dataset: Array,
                options: Object,
                classes: String
            },
            data: function(){
                return {
                    defaultOptions: {
                        //resizable: true,
                        //showToggle: false,
                        //showColumns: true,
                        //pagination: true,
                        //toolbar: "#custom-toolbar1",
                        //showExport: true,
                        //exportTypes: "['json', 'csv', 'excel']",
                    }
                }
            },
            watch: {
                dataset: function(val,oldVal) {
                    var self = this;

                    var cols= $(self.$el).bootstrapTable('getVisibleColumns');
                
                    if(_.isEmpty(cols)){ // table null
                        $(self.$el).bootstrapTable('destroy').bootstrapTable(_.extend({
                                                data: val,
                                                columns: self.columns
                                            }, self.defaultOptions, self.options));
                    } else {
                        $(self.$el).bootstrapTable('load',val);
                        $(self.$el).bootstrapTable('refreshOptions', _.extend(self.defaultOptions, val));
                    }
                }
            },
            mounted: function () {
                var self =  this;

                self.$nextTick(function () {
                    
                    $(self.$el).bootstrapTable(_.extend({
                                                    data: self.dataset,
                                                    columns: self.columns
                                                }, self.defaultOptions, self.options));


                })
            }
        });

        Vue.component('class-tree-component', {
            template: `<div id="tree" class="ztree"></div>`,
            props: {
                model:Array
            },
            data: function(){
                return {
                    setting: {
                        view: {
                            addHoverDom: this.addHoverDom,
                            removeHoverDom: this.removeHoverDom,
                            dblClickExpand: this.onDblClickExpand
                        },        
                        edit: {
                            enable: false
                        },
                        callback: {
                            onClick: this.onClick
                        },
                        data: {
                            simpleData: {
                                enable: true
                            },
                            key: {
                                name: 'name',
                                title: 'remedy'
                            }
                        },
                        check: {
                            enable: false
                        }
                    },
                    nodes: [],
                    tree: {}
                }
            },
            mounted: function () {
                var self =  this;

                self.$nextTick(function () {
                   
                    _.delay(function () {
                        self.init();
                        self.initTreeInfo();  
                    },500)
                    
                    $("#acc_btn_class_remove").on("click",function() {
                        if( appVue.class.tree.cid == null || appVue.class.tree.cid.length < 1){
                            swal("Please select class!","","info");
                            return false;
                        }
                        
                        swal({
                            title: appVue.class.tree.name, 
                            text: "Are you sure,delete it?", 
                            type: "warning",
                            showCancelButton: true,
                            
                            cancelButtonText: "Cancel",
                            confirmButtonText: "Delete",
                            confirmButtonColor: "#ff0000"
                        }).then((result) => {
                            if (result.value) {
                                jQuery.ajax({
                                    url: "/mxobject/del",
                                    dataType: 'json',
                                    type: 'POST',
                                    data: {
                                      id: appVue.class.tree.cid
                                    },
                                    success: function (data, status) {
                                        if(data.status == "ok") {
                                            swal("Success！", "", "success");
                                        } else {
                                            swal("Failed！", data.message, "warning");
                                        }   
                                    },
                                    error: function(xhr, textStatus, errorThrown) {
                                        mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                                    }
                                })

                            } else if (result.dismiss === 'cancel') {
                                swal(
                                  'Cancelled',
                                  appVue.class.tree.curTreeNodeCid,
                                  'info'
                                )
                            }
                        })
                    });

                    $("#btn_class_new").on("click",function() {
                        
                        let _treeNode = appVue.class.tree.selected;
                        
                        if(_.isEmpty(_treeNode)){
                            swal("Please select the parent class", "", "info");
                            return false;
                        }

                        let _class = appVue.class.tree.name + "/" + $("#class_name").val();
                        _class = _class.replace(/\/\//g,"/")
                        let alias = $("#class_alias").val();
                        let remedy = $("#class_remedy").val();
                        
                        if(_class == self.getSubNodeName(_treeNode)) {
                            swal("Please Confirm!", _class, "info");
                            return false;
                        } else {
                            var json = '',
                                jsonObj = new Object();
                            
                                jsonObj.pid = _treeNode.cid;
                                jsonObj.name = _class;
                                jsonObj.alias = alias;
                                jsonObj.remedy = remedy;
                                jsonObj.keymethod = _treeNode.keymethod;
                                jsonObj.ttl = _treeNode.ttl;
                                jsonObj.loption = _treeNode.loption;
                                jsonObj.Fields = _treeNode.Fields;
                                jsonObj.keys = _treeNode.keys;
                                jsonObj.readonly = _treeNode.readonly;
                                jsonObj.mtime = _treeNode.mtime;
                                jsonObj.fieldsObj = _treeNode.fieldsObj;

                                json = JSON.stringify(jsonObj);
                            
                            jQuery.ajax({
                                url: "/mxobject/iau",
                                dataType: 'json',
                                type: 'POST',
                                data: {
                                    json
                                },
                                success: function (data, status) {
                                    
                                    if(data.status == "ok") {
                                        swal("Success!", _class, "success");
                                    } else {
                                        swal("Failed!", _class, "warning");
                                    }
                                },
                                error: function(xhr, textStatus, errorThrown) {
                                    mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseJSON.error);
                                }  
                            });  
                        }   
                    })

                    $("#acc_btn_class_toggle").on("click",function(){
                        var zTree = $.fn.zTree.getZTreeObj("tree");
                        if(self.setting.data.key.name == "name"){
                          self.setting.data.key.name = "alias";
                          self.init();
                        } else {
                          self.setting.data.key.name = "name";
                          self.init();
                        }
                    })
                    
                })
            },
            methods:{
                init: function () {
                    var self = this;
                    
                    jQuery.ajax({
                        url: "/mxobject/get",
                        dataType: 'json',
                        type: 'POST',            
                        data: {
                          id:"-1"
                        },
                        beforeSend:function(xhr){ 
                          loading = layer.load(2, {
                                      shade: [0.1,'#ccc'],
                                      time: 30*1000
                                    });
                        }, 
                        complete: function(xhr, textStatus) {
                          layer.close(loading);
                        },
                        success: function(data, textStatus, xhr) {
                            
                            $.fn.zTree.init($("#tree"), self.setting, JSON.parse(data.message))

                            jQuery.ajax({
                                url: "/mxobject/get",
                                dataType: 'json',
                                type: 'POST',            
                                data: {
                                  id:"1"
                                },
                                complete: function(xhr, textStatus) {
                                    //called when complete
                                },
                                success: function(data, textStatus, xhr) {
                                    //called when successful
                                    
                                    var zTree = $.fn.zTree.getZTreeObj("tree");

                                    var nodes = zTree.getNodes();
                                    if (nodes.length > 0) {
                                        var tId = nodes[0].tId;
                                        var node = zTree.getNodeByTId(tId);
                                        
                                        // append sub nodes
                                        zTree.addNodes(node, JSON.parse(data.message));
                                    }   
                                },
                                error: function(xhr, textStatus, errorThrown) {
                                    //called when there is an error
                                    console.log(errorThrown);
                                }
                            });
                        },
                        error: function(xhr, textStatus, errorThrown) {
                            layer.close(loading);
                            console.log(errorThrown);
                        }
                    });
                },
                initTreeInfo: function () {
                    var self = this;

                    jQuery.ajax({
                      url: '/mxobject/count',
                      type: 'POST',
                      dataType: 'json',
                      data: {table: 'class'},
                      complete: function(xhr, textStatus) {
                        //called when complete
                      },
                      success: function(data, textStatus, xhr) {
                        //called when successful
                        $("#classInfo").html(JSON.parse(data.message)[0].count);
                      },
                      error: function(xhr, textStatus, errorThrown) {
                        //called when there is an error
                      }
                    });  
                },
                onClick: function (event, treeId, treeNode, clickFlisParentag) {     
        
                    appVue.class.tree.pid = treeNode.pid;
                    appVue.class.tree.cid = treeNode.cid;
                    appVue.class.tree.name = treeNode.name;

                    var loading;

                    // append sub nodes
                    jQuery.ajax({
                        url: "/mxobject/get",
                        dataType: 'json',
                        type: 'POST',            
                        data: {id: appVue.class.tree.cid},
                        beforeSend:function(xhr){ 
                          loading = layer.load(2, {
                                      shade: [0.1,'#ccc'],
                                      time: 30*1000
                                    });
                        }, 
                        complete: function(xhr, textStatus) {
                            layer.close(loading);

                            $("#panel_jumbotron").remove();

                            // append sub tree content
                            eventHub.$emit("tree-selected-event",{id: treeNode.cid, title: treeNode.name, obj: treeNode});
                        },
                        success: function(data, textStatus, xhr) {
                            
                            mxLog.debug("[" + moment().format("LLL") + "] [200] " + appVue.class.tree.cid + " " + JSON.stringify(data,null,2));
                            
                            var zTree = $.fn.zTree.getZTreeObj("tree");

                            var nodes = zTree.getSelectedNodes();
                            if (nodes && nodes.length>0) {
                                zTree.removeChildNodes(nodes[0]);
                            }
                            
                            // append sub nodes
                            zTree.addNodes(treeNode, JSON.parse(data.message));
                        },
                        error: function(xhr, textStatus, errorThrown) {
                            mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseJSON.error);
                            layer.close(loading);
                        }
                    });        
                },
                onDblClickExpand: function (treeId, treeNode) {
                    return treeNode.cid > 1;
                },
                removeHoverDom: function (treeId, treeNode) {
                    $("#addBtn_"+treeNode.tId).unbind().remove();
                },
                addHoverDom: function (treeId, treeNode) {
                    
                    $("#class_name").val();
                    $("#class_name").val(getSubNodeName(treeNode));

                    $("input#class_color").ColorPickerSliders({
                      placement: 'top',
                      color: 'red',
                      swatches: ['red', 'blue', '#green'],
                      customswatches: false,
                      order: {}
                    });

                    $("#class_tags").val($("#class_name").val());
                    $('#class_tags').select2({
                      tags: true,
                      placeholder: "标签",
                      language: "zh-CN",
                    });
                },
                getSubNodeName: function (treeNode) {
        
                    if(treeNode.cid == 1) {
                        return "/";
                    } else {
                        return treeNode.name + "/";
                    }
                }
            }
        });

        Vue.component('script-editor-component',{
              delimiters: ['${', '}'],
              template: `<div :id="id" style="height:45vh;"></div>`,
              props: {
                  id: String,
                  model: Object
              },
              data: function(){
                  return {
                      editor: Object,
                      inputText: String,
                  }
              },
              mounted: function(){
                  var self = this;

                  self.$nextTick(function(){
                      self.init();
                  })
              },
              watch: {
                  'model.oldInput': {
                    handler:function(val,oldVal){
                        var self = this;

                        self.editor.setValue(val);
                    },
                    deep:true
                }
              },
              created: function () {
                  var self = this;

              },
              methods: {
                  init: function() {
                      var self = this;

                      self.editor = ace.edit(self.id);

                      self.editor.setOptions({
                          minLines: 15,
                      });
                      self.editor.$blockScrolling = Infinity;

                      if(_.isEmpty(self.model.mode)) {
                          self.model.mode = "sql";
                      }

                      self.setTheme();
                      self.setMode();
                      self.setValue();
                      
                  },
                  setTheme: function(){
                      var self = this;

                      self.editor.setTheme("ace/theme/tomorrow");
                  },
                  setMode: function(){
                      var self = this;

                      self.editor.getSession().setMode("ace/mode/"+ self.model.mode);
                  },
                  setValue: function(){
                      var self = this;

                      self.editor.setValue(self.model.oldInput);
                  },
                  getSelected: function(){
                      var self = this;
                      var temp = self.editor.getSelectedText();

                      if(_.isEmpty(temp)){
                          self.inputText = self.editor.getValue();
                      } else {
                          self.inputText = temp;
                      }
                  }
              }
        })

        appVue = new Vue({
            delimiters: ['${', '}'],
            el: '#app',
            template: '#app-template',
            data: {
                class:{
                    tree: {
                        pid: "",
                        cid: "",
                        name: "",
                        selected: {}
                    },
                    table: {
                        columns:[
                                    {'name':'name','title':'Name'},
                                    {'name':'title','title':'Title'},
                                    {'name':'ftype','title':'Ftype'},
                                    {'name':'loption','title':'Loption', visible:false},
                                    {'name':'fparam','title':'Fparam', visible:false},
                                    {'name':'isindex','title':'ISindex'},
                                    {'name':'iskey','title':'ISkey'},
                                    {'name':'isreadonly','title':'ISreadonly'},
                                    {'name':'note','title':'Note'},
                                    {'name':'mtime','title':'Mtime'},
                                    {'name':'class','title':'Class'},
                                    {'name':'dispname','title':'Dispname'},
                                    {'name':'remedy','title':'Remedy'}
                                ],
                        dataset:[]
                    },
                    ftypeData: [],
                    nameData: [],
                    nameObjData: []
                },
                query: {
                    
                },
                tab: {
                    selectedTabId: null,
                }
            },
            created: function() {
                var self = this;

                eventHub.$on("tree-selected-event", self.addTabs);  
            },
            mounted:function() {
                var self = this;

                self.$nextTick(function(){
                    self.init();
                    self.initFtype();
                    self.initColumnByName();
                    self.initColumnByAll();
                    self.initTabsHandle();
                })
            },
            methods:{
                init: function() {
                    var self = this;

                    $("#myTabContent").append(jumbotronStr);

                },
                onHelp: function() {
                    mxLog.consoleName = 'M³ Debug Console';
                    mxLog.show();
                },
                initTabsHandle: function() {
                  var self = this;

                  /**
                   * @author  cnwangzd
                   * @todo Tab关闭按钮操作定义
                   */
                  $(".nav-tabs.object").on("click", "[tabclose]", function (e) {
                      self.closeTab();
                  });
                  
                  /**
                   * @author  cnwangzd
                   * @todo Tab双击关闭操作定义
                   */
                  $(".nav-tabs.object").on("dblclick", "[tabcloser]", function (e) {
                      self.closeTab();
                  });

                  /**
                   * @author  cnwangzd
                   * @todo Tab双击关闭操作定义
                   */
                  $(".nav-tabs.object").on("click", "a", function (e) {
                      self.tab.selectedTabId = $(this).attr("tabcloser");
                  });
                },
                initFtype: function () {
                    var self = this;

                    jQuery.ajax({
                        url: '/mxobject/list/column',
                        dataType: 'json',
                        type: 'POST',
                        data: {ctype:'all',colm:'name,remedy',table:'ftype'},
                        success: function (data, status) {

                            jQuery.each(JSON.parse(data.message),function(key,value){
                              var o = new Object();
                              o.value = value.name;
                              o.text = value.name;
                              self.class.ftypeData.push(o);
                            });

                            
                         },
                         error: function(xhr, textStatus, errorThrown) {
                            mxLog.warn(errorThrown);
                         }
                    });               
                },
                initColumnByName: function () {
                    var self = this;

                    jQuery.ajax({
                       url: '/mxobject/list/column',
                       dataType: 'json',
                       type: 'POST',
                       data: {ctype:'all',colm:'name',table:'field'},
                       success: function (data, status) {
                          
                           obj = JSON.parse(data.message);
                           jQuery.each(obj,function(key,value){
                              var o = new Object();
                              o.value = value.name;
                              o.text = value.name;
                              self.class.nameData.push(o);
                           }) 
                       },
                       error: function(xhr, textStatus, errorThrown) {
                          mxLog.warn(errorThrown);
                       } 
                    });
                },
                initColumnByAll: function () {
                    var self = this;

                    jQuery.ajax({
                       url: '/mxobject/list/column',
                       dataType: 'json',
                       type: 'POST',
                       data: {ctype:'all',colm:'*',table:'field'},
                       success: function (data, status) {                    
                           self.class.nameObjData = JSON.parse(data.message);
                       },
                       error: function(xhr, textStatus, errorThrown) {
                          mxLog.warn(errorThrown);
                       } 
                    });
                },
                addTabs: function(event) {
                    var self = this;

                    self.class.tree.selected = event.obj;

                    id1 = "tab1_1";// + obj.id;
                    id2 = "tab2_2";// + obj.id;
                    id3 = "tab3_3";// + obj.id;
                    id4 = "tab4_4";// + obj.id;
                    //id5 = "tab5_5";// + obj.id;
                    id6 = "tab6_6";// + obj.id;
                    id7 = "tab7_7";// + obj.id;
                    
                    //if (!$("#" + id1)[0]) {
                      //创建新TAB的title
                      title1 = '<li id="tab_' + id1 + '"> <a href="#' + id1 + '" role="tab" data-toggle="tab" tabcloser="' +id1 + '"> <i class="icon-edit"></i> {{.i18n.Tr "mxobject_class_define_title"}} &nbsp;<i class="icon-remove btn btn-xs" tabclose="' + id1 + '"></i> </a></span> </li> ';
                      title2 = '<li id="tab_' + id2 + '"> <a href="#' + id2 + '" role="tab" data-toggle="tab" tabcloser="' +id2 + '"> <i class="icon-table"></i>  {{.i18n.Tr "mxobject_class_data_title"}}</a></span></li> ';
                      title3 = '<li id="tab_' + id3 + '"> <a href="#' + id3 + '" role="tab" data-toggle="tab" tabcloser="' +id3 + '"> <i class="icon-search"></i>  {{.i18n.Tr "mxobject_class_query_title"}}</a></span></li> ';
                      title4 = '<li id="tab_' + id4 + '"> <a href="#' + id4 + '" role="tab" data-toggle="tab" tabcloser="' +id4 + '"> <i class="icon-exchange"></i>  {{.i18n.Tr "mxobject_class_trigger_title"}}</a></span></li> ';
                      //title5 = '<li id="tab_' + id5 + '"> <a href="#' + id5 + '" role="tab" data-toggle="tab" tabcloser="' +id5 + '"> <i class="icon-eye-open"></i>  视图配置</a></span></li> ';
                      title6 = '<li id="tab_' + id6 + '"> <a href="#' + id6 + '" role="tab" data-toggle="tab" tabcloser="' +id6 + '"> <i class="icon-sitemap"></i>  {{.i18n.Tr "mxobject_class_relation_title"}}</a></span></li> ';
                      //title7 = '<li id="tab_' + id7 + '"> <a href="#' + id7 + '" role="tab" data-toggle="tab" tabcloser="' +id7 + '"> <i class="icon-th-large"></i>  存储空间</a></span></li> ';
                      
                      //是否指定TAB内容
                      content1 = '<div role="tabpanel" class="tab-pane fade in" id="' + id1 + '">' + tableContent + '</div>';
                      content2 = '<div role="tabpanel" class="tab-pane fade in" id="' + id2 + '">' + dataContent + '</div>';
                      content3 = '<div role="tabpanel" class="tab-pane fade in" id="' + id3 + '"><div id="panel-query"></div></div>';
                      content4 = '<div role="tabpanel" class="tab-pane fade in" id="' + id4 + '"><div id="panel-trigger"></div></div>';
                      content6 = '<div role="tabpanel" class="tab-pane fade in" id="' + id6 + '">' + objRelationContent + '</div>';
                      //content7 = '<div role="tabpanel" class="tab-pane fade in" id="' + id7 + '">' + keySpaceContent + '</div>';

                      $("#myTabMenu").empty();
                      $("#myTabContent").empty();

                      //加入TABS
                      $(".nav-tabs.object").append(title1);
                      $(".nav-tabs.object").append(title2);
                      $(".nav-tabs.object").append(title3);
                      $(".nav-tabs.object").append(title4);
                      //$(".nav-tabs.object").append(title5);
                      $(".nav-tabs.object").append(title6);
                      //$(".nav-tabs.object").append(title7);

                      $("#myTabContent").append(content1).ready(function(){
                          self.initClass();
                      });

                      $("#myTabContent").append(content2).ready(function() {
                          self.initData();
                      });
                      $("#myTabContent").append(content3).ready(function(){
                          self.initQuery();
                      });
                      $("#myTabContent").append(content4).ready(function(){
                          self.initTrigger();
                      });
                      $("#myTabContent").append(content6).ready(function(){
                          self.initObjRelation();
                      });
                      //$("#myTabContent").append(content7).ready(function(){
                         //InitKeySapce(); 
                      //});
                    //}
                    
                    //激活TAB
                    if(appVue.tab.selectedTabId == null){
                      $("#tab_" + id1).addClass('active');
                      $("#" + id1).addClass("active");
                    } else {
                      $("#tab_" + appVue.tab.selectedTabId).addClass('active');
                      $("#" + appVue.tab.selectedTabId).addClass("active");
                    } 
                },
                closeTab: function () {
                    var self = this;

                    $("#myTabMenu").empty();
                    $('#myTabContent').empty();

                    if($("#myTabContent").children().length == 0){
                        $("#myTabContent").append(jumbotronStr);
                    }
                },
                initClass: function () {
                    let self = this;
                    let cols = [];

                    $("#div_define_info").html(appVue.class.tree.name);

                    $("#objectDataTable").bootstrapTable('destroy');
                    
                    cols.push({
                        field: "num",
                        formatter: asNumFormatter,
                    })

                    cols.push({
                        field: "state",
                        radio: true
                    })
                    
                    _.map(appVue.class.table.columns, function(v,k) { 
                      
                      if( v.name == "name" ){
                          cols.push({
                            field: v.name,
                            title: v.title,
                            sortable: true,
                            editable: {
                              title: "选择属性",
                              type: "select",
                              source: _.sortBy(appVue.class.nameData,"text"),
                              emptytext: "---",
                              success: function(response,newValue){
                                var index = $('.selected').attr('data-index');
                                $.map(appVue.class.nameObjData,function(e) {
                                      
                                    if(newValue == e['name']) {
                                      $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        name: e["name"],
                                        title: e['title'],
                                        ftype: e['ftype'],
                                        loption: e['loption'],
                                        fparam:  e['fparam'],
                                        isindex: e['isindex'],
                                        iskey:   e['iskey'],
                                        isreadonly: e['isreadonly'],
                                        note: e['note'],
                                        mtime: e['mtime'],
                                        class: e['class'],
                                        dispname: e['dispname'],
                                        remedy: e['remedy']
                                      }});
                                     }
                                });
                              }
                            }
                          }) 
                      } else if( v.name=="title" ){
                        cols.push({
                            field: v.name,
                            title: v.title,
                            sortable: true,
                            editable: {
                              title: "输入显示名称",
                              emptytext: "---"
                            }
                        })
                      } else if( v.name=="note" ){
                        cols.push({
                            field: v.name,
                            title: v.title,
                            sortable: true,
                            editable: {
                              title: "输入备注",
                              emptytext: "---"
                            }
                        })
                      } else if( v.name=="ftype" ){
                        cols.push({
                          field: v.name,
                          title: v.title,
                          sortable: true,
                          editable: {
                              title: "选择数据类型",
                              type: "select",
                              emptytext: "---",
                              source: _.sortBy(appVue.class.ftypeData,"text"),
                              success: function(response, newValue) {
                                var index = $('.selected').attr('data-index');
                                switch (newValue) {
                                  case 'text':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: newValue,
                                        loption: '{"type":"text"}',
                                        fparam: "[]"
                                    }});
                                    break;
                                  case 'varchar':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: newValue,
                                        loption: '{"type":"string"}',
                                        fparam: "[]"
                                    }});
                                    break;
                                  case 'int':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: newValue,
                                        loption: '{"type":"integer"}',
                                        fparam: "[]"
                                    }});
                                    break;
                                  case 'bigint':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: newValue,
                                        loption: '{"type":"long"}',
                                        fparam: "[]"
                                    }});
                                    break;
                                  case 'double':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: newValue,
                                        loption: '{"type":"double"}',
                                        fparam: "[]"
                                    }});
                                    break;
                                  case 'float':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: newValue,
                                        loption: '{"type":"float"}',
                                        fparam: "[]"
                                    }});
                                    break;
                                  case 'blob':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: newValue,
                                        loption: '{"type":"bytes"}',
                                        fparam: "[]"
                                    }});
                                    break;
                                  case 'timestamp':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: newValue,
                                        loption: '{"type":"date", "pattern":"timestamp"}',
                                        fparam: "[]"
                                    }});
                                    break;
                                  case 'uuid':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: newValue,
                                        loption: '{"type":"uuid"}',
                                        fparam: "[]"
                                    }});
                                    break;
                                  case 'inet':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: newValue,
                                        loption: '{"type":"uuid"}',
                                        fparam: "[]"
                                    }});
                                    break;
                                  case 'boolean':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: newValue,
                                        loption: '{"type":"boolean"}',
                                        fparam: "[]"
                                    }});
                                    break;
                                  case 'varint':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: newValue,
                                        loption: '{"type":"bigint"}',
                                        fparam: "[]"
                                    }});
                                    break;
                                  case 'map':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: 'map<bigint,varchar>',
                                        loption: '{"type":"string"}',
                                        fparam: "[\'varchar\']"
                                    }});
                                    break;
                                  case 'set':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: 'set',
                                        loption: '{"type":"string"}',
                                        fparam: "[\'varchar\']"
                                    }});
                                    break;
                                  case 'list':
                                    $('#objectDataTable').bootstrapTable('updateRow', {index: index, row: {
                                        ftype: 'list<varchar>',
                                        loption: '{"type":"string"}',
                                        fparam: "[\'varchar\']"
                                    }});
                                    break;
                                  return false;
                                }
                              }
                          }
                        })
                      } else if( v.name=="loption" ){
                        cols.push({
                          field: v.name,
                          title: v.title,
                          sortable: true,
                          visible: v.visible
                        })
                      } else if( v.name=="fparam" ){
                        cols.push({
                          field: v.name,
                          title: v.title,
                          sortable: true,
                          visible: v.visible,
                          editable: {
                            emptytext: ""
                          }
                        })
                      } else if( v.name == "isindex" ) {
                        cols.push({
                          field: v.name,
                          title: v.title,
                          sortable: true,
                          editable: {
                              title: "是否作为索引",
                              type: 'select',
                              source: [
                                {value: 1, text: '是'},
                                {value: 0, text: '否'}
                              ]
                          }
                        })
                      } else if( v.name=="iskey" ){
                        cols.push({
                          field: v.name,
                          title: v.title,
                          sortable: true,
                          editable: {
                              title: "是否作为主键",
                              type: 'select',
                              source: [
                                {value: 1, text: '是'},
                                {value: 0, text: '否'}
                              ]
                          }
                        })
                      } else if( v.name=="isreadonly" ){
                        cols.push({
                          field: v.name,
                          title: v.title,
                          sortable: true,
                          editable: {
                              title: "是否只读",
                              type: 'select',
                              source: [
                                {value: 1, text: '是'},
                                {value: 0, text: '否'}
                              ]
                          }
                        })
                      } else if( v.name=="class" || v.name=="dispname" || v.name=="remedy" ){
                        cols.push({
                          field: v.name,
                          title: v.title,
                          sortable: true,
                          visible: false
                        })
                      } else if( v.name == "mtime" ){

                          cols.push({
                                       field: v.name,
                                       title: v.title,
                                       sortable: true,
                                       formatter: function(val){
                                                      return moment(val).format("YYYY-MM-DD HH:mm:ss");
                                                  }
                                    });
                      } else {
                        cols.push({
                            field: v.name,
                            title: v.title,
                            sortable: true
                        }) 
                      }
                    });
                          
                    $("#objectDataTable").bootstrapTable({columns: cols});
                    
                    let jsonObj;
                    jQuery.ajax({
                        url: "/mxobject/get",
                        dataType: 'json',
                        type: 'POST',
                        data: {id: appVue.class.tree.pid},
                        success: function (data, status) {
                            
                            if(_.isEmpty(data.message)) return false;

                            let _data = _.attempt(JSON.parse.bind(null, data.message));
                            self.class.table.dataset = _.filter(_data,function(v){ return v.cid == appVue.class.tree.cid;})[0];

                            $("#class_define_alias").val(self.class.table.dataset.alias);
                            $("#class_define_remedy").val(self.class.table.dataset.remedy);
                            $("#class_define_ttl").val(self.class.table.dataset.ttl);

                            $("#objectDataTable").bootstrapTable('load',_.sortBy(self.class.table.dataset.fieldsObj,"name"));

                        },
                        error: function(xhr, textStatus, errorThrown){
                            mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                        } 
                    });

                    _.delay(function(){
                        $(".keep-open.btn-group").before(`<div class="btn-group"><button id="obj_add_button" class="btn btn-sm btn-default" type="button"><i class="icon-plus"></i>{{.i18n.Tr "mxobject_class_define_tool_new"}}</button></div>
                                                      <div class="btn-group"><button id="obj_del_button" class="btn btn-sm btn-danger" type="button"><i class="icon-remove"></i>{{.i18n.Tr "mxobject_class_define_tool_delete"}}</button></div>`);
                        $(".export.btn-group").after(`<div class="btn-group"><button id="obj_advance_button" class="btn btn-sm btn-default" type="button" data-toggle="collapse" data-target="#collapseAdvConfigInfo"><i class="icon-wrench"></i>{{.i18n.Tr "mxobject_class_define_tool_advanced"}}</button></div>
                                                      <div class="btn-group"><button id="obj_submit_button" class="btn btn-sm btn-success" type="button"><i class="icon-save"></i>{{.i18n.Tr "mxobject_class_define_tool_submit"}}</button></div>`);
                        $(".keep-open").find(".btn.btn-default.dropdown-toggle").addClass('btn-sm');
                        $(".export.btn-group").find(".btn.btn-default.dropdown-toggle").addClass('btn-sm');
                        $(".pull-right.search").find("input").css("height","30px");

                        $("#obj_add_button").click(function () {
                            $("#objectDataTable").bootstrapTable("insertRow",{index: 0, row: {
                                                                                                name: '',
                                                                                                title: '',
                                                                                                ftype: '',
                                                                                                loption: '',
                                                                                                fparam: '',
                                                                                                isindex: 1,
                                                                                                iskey: 0,
                                                                                                isreadonly: 0,
                                                                                                note: '',
                                                                                                class: [],
                                                                                                dispname: {},
                                                                                                remedy: {}
                                                                                            }
                                                                              }
                                                                );
                        });

                        $("#obj_del_button").click(function () {
                            var ids = $.map($("#objectDataTable").bootstrapTable('getSelections'), function (row) {
                                return row.name;
                            });
                            $("#objectDataTable").bootstrapTable('remove', {
                                field: 'name',
                                values: ids
                            });
                        });

                        $("#obj_submit_button").on("click",function() {

                            self.class.table.dataset.alias = $("#class_define_alias").val();
                            self.class.table.dataset.remedy = $("#class_define_remedy").val();
                            self.class.table.dataset.ttl = parseFloat($("#class_define_ttl").val());

                            var obj = $("#objectDataTable").bootstrapTable('getData');

                            jQuery.each(obj, function(index, val) {
                                if(val.name == null || val.name == '---') {
                                    obj.splice(index, 1);
                                }
                            });

                            jQuery.each(obj, function(index, val) {
                              
                              val['fparam'] = eval(val['fparam']);

                              val['isindex'] = eval(val['isindex']);

                              val['iskey'] = eval(val['iskey']);

                              val['isreadonly'] = eval(val['isreadonly']);

                            });
                            
                            self.class.table.dataset.fieldsObj = obj;
                            
                            jQuery.ajax({
                              url: "/mxobject/iau",
                              dataType: 'json',
                              type: 'POST',
                              data: {
                                  json: JSON.stringify(self.class.table.dataset)
                              },
                              success: function (data, status) {    

                                 if(data.status == "ok"){
                                    swal("Success!",self.class.tree.name,"success"); 
                                    return false;
                                 } else {
                                    swal("Failed!",self.class.tree.name,"warning"); 
                                    return false;
                                 }
                                 
                              },
                              error: function(xhr, textStatus, errorThrown){
                                  mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseText);
                              }  
                            });
                        });
                    },500)
                },
                initData: function () {
                    
                    _.delay(function(){
                        $(".panel-data").find(".bootstrap-table").find(".fixed-table-toolbar").remove();
                    },500)

                    var zTree = $.fn.zTree.getZTreeObj("tree");
                    var treeNode = zTree.getSelectedNodes()[0];
                    var param = `# ` + treeNode.name + `/: | top 100`;
                    
                    var onContextMenu = function(row, $el){
                        var self = this;

                        if($el.data("item") == "action-details"){
                            openDetailPanel(row);
                        }
                    };
                    var openDetailPanel = function(row){
                        var self = this;
                        var win;
                        var w = $( window ).width();//document.body.clientWidth;
                        var h = $( window ).height();//(document.body.clientHeight || document.documentElement.clientHeight);
                        var wW = $( window ).width()*2/3;
                        var hH = $( window ).height()*2/3;
                        var lrwh = [(w-wW)/2, (h-hH)/2, wW, hH];
                        var tb = document.createElement('div');

                        $(tb).append(`<ul class="nav nav-tabs">
                                          <li class="active"><a href="#tab-detail" data-toggle="tab">Detail</a></li>
                                          <li class=""><a href="#tab-history" data-toggle="tab">History</a></li>
                                      </ul>
                                      <div class="tab-content">
                                          <div class="tab-pane fade active in" id="tab-detail" style="margin: -15px;">
                                              <div class="panel" id="table-dblclick-show-panel" :model="model"></div>
                                          </div>
                                          <div class="tab-pane fade" id="tab-history">
                                              <div id="panel-history"></div>
                                          </div>
                                      </div>`);
                        win = new mxWindow(row.id || row.host, tb, lrwh[0], lrwh[1], lrwh[2], lrwh[3], true, true);
                        win.setMaximizable(true);
                        win.setResizable(true);
                        win.setClosable(true);
                        win.setVisible(true);
                        
                        _.delay(function(){
                            var panelVue = new Vue({
                                delimiters: ['$', '$'],
                                el: '#table-dblclick-show-panel',
                                template: ` <div>
                                                <div class="panel-body" style="padding:0px;">
                                                    <div class="input-group input-group-sm" style="width:100%;" v-for="(item,index) in _.sortBy(model,'name')">
                                                        <div class="input-group-addon" :id="item.name" style="width:200px;text-align: right;border:0px;border-bottom: 1px solid #ccc;border-radius: 0px;background-color:#f7f7f7;">$item.title$</div>
                                                        <textarea class="form-control" :id="item.name" :placeholder="item.title" style="border:0px;border-left: 1px solid #ccc;border-bottom: 1px solid #ccc;">$item.value$</textarea>
                                                    </div>
                                                </div>
                                                <div class="panel-footer">
                                                    
                                                </div>
                                            </div>`,
                                data:{
                                    model:[]
                                },
                                mounted: function(){
                                    var self = this;

                                    self.$nextTick(function(){
                                       
                                        _.forEach(row, function(v,k){
                                            if(_.isObject(v) && v!=null){
                                               self.model =  _.map(v,function(val,key){
                                                    return {name:key, title: _.upperFirst(key), value:val};
                                                })
                                            }else {
                                                self.model.push({name:k, title: _.upperFirst(k), value:v});
                                            }
                                        })

                                        $(self.$el).on('click keyup keydown', 'textarea', function () {
                                            $(this).height(0).height(this.scrollHeight);
                                        }).find('textarea').change();
                                       
                                    })

                                },
                                methods: {
                                    autosize: function(){
                                        var self = this;
                                        autosize($(self.$el).find("textarea"));
                                    }
                                }
                            });

                            var historyVue = new Vue({
                                delimiters: ['$', '$'],
                                el: '#panel-history',
                                template: ` <div>
                                                <bootstrap-table :columns="model.columns" 
                                                             :options="model.options" 
                                                             :dataset="model.data" 
                                                             contextMenu=""></bootstrap-table>
                                                <!-- context menu -->
                                                <ul id="context-menu-history" class="dropdown-menu">
                                                    <li data-item="action-details"><a href="javascript:void(0)" style="cursor:hand;"><i class="fa fa-list fa-fw"></i> Details</a></li>
                                                </ul>  
                                            </div>`,
                                data:{
                                    model:{
                                        columns: [],
                                        options: {
                                            resizable: true,
                                            showToggle: false,
                                            showColumns: true,
                                            pagination: false,
                                            toolbar: "",
                                            showExport: true,
                                            exportTypes: "['json', 'csv', 'excel']",
                                        },
                                        data: []
                                    }
                                },
                                mounted: function(){
                                    var self = this;

                                    self.$nextTick(function(){
                                        self.init();
                                    })

                                },
                                methods: {
                                    init: function(){
                                        var self = this;
                                        var param = "id=" + row.id + " | top 100";

                                        jQuery.ajax({
                                            url: '/mxobject/search',
                                            type: 'POST',
                                            dataType: 'json',
                                            data: { 
                                                cond: param, 
                                                flag: false 
                                            },
                                            beforeSend:function(xhr){ 
                                            },
                                            complete: function(xhr, textStatus) {
                                                //func.call();
                                            },
                                            success: function(data, textStatus, xhr) {
                                                
                                                var list = data.message;
                                                var columns = [];

                                                self.model.columns = data.meta.columns;
                                                self.model.data = _.orderBy(list,'vtime');
                                            },
                                            error: function(xhr, textStatus, errorThrown) {
                                                mxLog.warn(errorThrown);
                                            }
                                        })
                                    }
                                }
                            });

                        },500);
                    };

                    $("#dataTable").on('click-row.bs.table', function (e, row, $element) {
                        $('.info').removeClass('info');
                        $($element).addClass('info');
                        $("#dataTable").removeClass('table-hover');
                    });
                    
                    jQuery.ajax({
                        url: '/mxobject/search',
                        type: 'POST',
                        dataType: 'json',
                        data: { 
                          cond: param, flag: false 
                        },
                        beforeSend:function(xhr){ 
                        },
                        complete: function(xhr, textStatus) {              
                        },
                        success: function(data, textStatus, xhr) {
                          
                          if(_.isEmpty(data.message)) return false;
                          
                          var data = data.message;
                          
                          var cols = [];

                          $("#dataTable").bootstrapTable('destroy');

                          cols.push({
                            field: "num",
                            formatter: asNumFormatter,
                          })
                          
                          $.map(data[0], function(v,k) { 
                             
                            var tmp = {};
                            
                            if(k.indexOf("time") > -1 || k == 'day' || k == 'obd_time'){
                                tmp = {
                                         field: k,
                                         title: _.upperFirst(k),
                                         sortable: true,
                                         formatter: function(val){
                                                        return moment(val).format("YYYY-MM-DD HH:mm:ss");
                                                    }
                                      };
                            } else if( k == 'contain' || k == 'tag'  || k=='portlet' || k=='theme' || k=='auth' || k=='out' || k=='err' || k=='remark'){
                                tmp = {
                                         field: k,
                                         title: _.upperFirst(k),
                                         formatter: function(value,row,index){
                                                          if(typeof value === "object"){
                                                            var val = JSON.stringify(value,null,"\t");  
                                                            
                                                            if(val.length>0 && val.length>100){
                                                              return `<a data-toggle="collapse" href="#collapse_`+index+`" aria-expanded="false" aria-controls="collapse_`+index+`">
                                                                      `+val.substring(0,100)+`
                                                                    </a><i class="fa fa-level-down"></i>
                                                                    <div class="collapse" id="collapse_`+index+`">
                                                                      `+val.substring(100,val.length)+`
                                                                    </div>`;
                                                            } else {
                                                              return val;
                                                            }
                                                          } else{
                                                            if(value.length>0 && value.length>100){
                                                              return `<a data-toggle="collapse" href="#collapse_`+index+`" aria-expanded="false" aria-controls="collapse_`+index+`">
                                                                      `+value.substring(0,100)+`
                                                                    </a><i class="fa fa-level-down"></i>
                                                                    <div class="collapse" id="collapse_`+index+`">
                                                                      `+value.substring(100,value.length)+`
                                                                    </div>`;
                                                            } else {
                                                              return value;
                                                            }
                                                          }
                                                    }
                                      };
                            } else if( k == "attr") {
                                tmp = {
                                         field: k,
                                         title: _.upperFirst(k),
                                         visible: false
                                      };
                            } else {
                                tmp = {
                                         field: k,
                                         title: _.upperFirst(k),
                                         sortable: true
                                      };
                            }
                             
                            cols.push(tmp);
                          });
                          
                          $("#dataTable").bootstrapTable(_.extend({
                                                                    columns: cols,
                                                                    contextMenu: '#context-menu',
                                                                    onContextMenuItem: onContextMenu,
                                                                    options:{
                                                                      class:"table table-striped",
                                                                      toolbar: "",
                                                                    }
                                                                  })
                                                        );

                          $("#dataTable").bootstrapTable('load', data);

                          /**
                           * @author cnwangzd
                           * @todo 显示历史数据
                           */
                          $("#dataTable").on('expand-row.bs.table', function (e, index, row, $detail) {
                                
                                var twoLevelLoading;

                                var table=$("<table></table>").addClass("table table-striped")
                                            .attr("id","table-" + index)
                                            .attr("data-show-header","true")
                                            //.attr("data-row-style", "subRowStyle")
                                            .attr("data-click-to-select", "true")
                                            .attr("data-undefined-text", "")
                                            .attr("data-fixed-columns", "true")
                                            .attr("data-key-events", "true");
                                var cols = [];
                                var param = treeNode.name  + `/: 
                                                | id=` + row.id + `
                                                | top 100
                                                | today`;
                                                
                                $subTable = $("#table-" + index);

                                $(".info").removeClass('info');
                                      $("[data-index='"+ index + "']").addClass('info'); 
                                      $($detail).addClass('info');

                                $("#table-" + index).bootstrapTable('destroy');

                                jQuery.ajax({
                                  url: "/mxobject/search",
                                  dataType: 'json',
                                  type: 'POST',
                                  data: {
                                    cond:param, 
                                    flag:false
                                  },
                                  beforeSend:function(xhr){ 
                                      twoLevelLoading = layer.load(2, {
                                        shade: [0.1,'#ccc'],
                                        time: 30*1000
                                      });
                                  },
                                  complete: function(xhr, textStatus) {
                                      layer.close(twoLevelLoading);
                                  },
                                  success: function (data, status) {
                                    
                                    var data = data.message;

                                    if(data.length < 1) {
                                                swal("没有版本数据！", "", "warning");
                                                return false;
                                            }

                                    cols[0]={
                                            field: "state",
                                            checkbox: "true"
                                    }

                                    $.map(data[0], function(v,k) { 
                                       
                                        var tmp = {};
                            
                                        if(k.indexOf("time") > -1 || k == 'day'){
                                            tmp = {
                                                     field: k,
                                                     title: _.upperFirst(k),
                                                     sortable: true,
                                                     formatter: function(val){
                                                                    return moment(val).format("YYYY-MM-DD HH:mm:ss");
                                                                }
                                                  };
                                        } else {
                                            tmp = {
                                                     field: k,
                                                     title: _.upperFirst(k),
                                                     sortable: true
                                                  };
                                        }
                                       
                                        cols.push(tmp);

                                    });

                                    $("#table-" + index).bootstrapTable({
                                      columns: cols
                                    });

                                    $("#table-" + index).bootstrapTable('load',data);
                                      
                                  },
                                  error: function(xhr, textStatus, errorThrown) {
                                    mxLog.warn(errorThrown);
                                    layer.close(twoLevelLoading);
                                  }

                                });
                                var div=$("<div style='padding-left:18px;'></div>").append(table);
                                $detail.html(div);
                          });
                        },
                        error: function(xhr, textStatus, errorThrown) {
                          mxLog.warn(errorThrown)
                        }
                    })
                },
                initQuery: function () {
                    var self = this;

                    var queryVue = new Vue({
                                      delimiters: ['${', '}'],
                                      el: "#panel-query",
                                      template: "#query-template",
                                      data: {
                                          query: {
                                              editor: {}
                                          },
                                          result: {
                                              list: [],
                                              summary: {
                                                  count: 0,
                                                  time: 0.00,
                                              }
                                          },
                                          split: {
                                              obj: {}
                                          }
                                      },
                                      mounted: function() {
                                          let self = this;

                                          self.$nextTick(function () {
                                              _.delay(function(){
                                                  self.initEditor();
                                                  self.initSplit();
                                                },500);
                                          })
                                      },
                                      created: function() {
                                          let self = this;

                                          
                                      },
                                      methods: {
                                          initSplit: function () {
                                              let self = this;

                                              if(_.isEmpty(self.split.obj)){
                                                  self.split.obj = Split(['#query_input', '#query_result'], {
                                                                      direction: 'vertical',
                                                                      cursor: 'row-resize',
                                                                      sizes: [45,29],
                                                                      onDragEnd: function (argument) {
                                                                          return false;
                                                                          let _minHeight = self.viewportToPixels('100vh') - self.split.obj.getSizes()[1]*document.documentElement.clientHeight/100 - 125;
                                                                          let _maxHeight = self.viewportToPixels('100vh') - self.split.obj.getSizes()[1]*document.documentElement.clientHeight/100;
                                                                          let _height = self.split.obj.getSizes()[0]*document.documentElement.clientHeight/100;
                                                                          $("#query_input").css({
                                                                              "min-height": _minHeight,
                                                                              "max-height": _maxHeight
                                                                          });
                                                                      }
                                                                  });  
                                              }
                                          },
                                          initEditor: function(){
                                              let self = this;
                                              
                                              self.query.editor = ace.edit("query_input");
                                              self.query.editor.setOptions({
                                                  minLines: 30,
                                                  //maxLines: Infinity
                                              });

                                              self.query.editor.getSession().on('change', function() {
                                                  localStorage.setItem(appVue.class.tree.name,self.query.editor.getValue());
                                              });
                                              self.query.editor.$blockScrolling = Infinity;
                                              //self.query.editor.setTheme("ace/theme/tomorrow_night_eighties");
                                              //self.query.editor.setTheme("ace/theme/tomorrow_night_blue");
                                              self.query.editor.setTheme("ace/theme/tomorrow");
                                              self.query.editor.getSession().setMode("ace/mode/sql");
                                              self.query.editor.focus();
                                              let n = self.query.editor.getSession().getValue().split("\n").length;
                                              self.query.editor.gotoLine(n);

                                              $('#query_input').keydown(function (e) {

                                                if (e.ctrlKey && e.keyCode == 13) {
                                                    self.onQuery();
                                                }

                                              });

                                              $("#query_result_table").on('click-row.bs.table', function (e, row, $element) {
                                                  $('.info').removeClass('info');
                                                  $($element).addClass('info');
                                                  $("#query_result_table").removeClass('table-hover');
                                              });

                                              let colms =  appVue.class.tree.selected.Fields;
                                              let cls = "";
                                              if(_.isEmpty(colms)){
                                                  cls = "*";
                                              } else {
                                                  cls = colms.join(",\n");
                                              }
                                              let querySql = "select " + cls + " from " + appVue.class.tree.name;
                                              
                                              let _cache = self.loadCacheSql();
                                              if(!_.isEmpty(_cache)){
                                                  self.query.editor.setValue(_cache);  
                                              } else {
                                                  self.query.editor.setValue(querySql);  
                                              }
                                              
                                              self.query.editor.setValue(self.query.editor.getValue(), 1);
                                              
                                          },
                                          loadCacheSql: function() {
                                              let self = this;

                                              return localStorage.getItem(appVue.class.tree.name);
                                          },
                                          onQuery: function(){ 
                                              let self = this;
                                              let oneLevelLoading;
                                              let _sql = self.query.editor.getValue();
                                              let _stime = _.now();
                                              let _columns = [];

                                              if(_.isEmpty(self.query.editor.getValue())){
                                                  return false;
                                              }

                                              if( self.query.editor.getSelectedText().length > 0 ) {
                                                  _sql = self.query.editor.getSelectedText(); 
                                              }

                                              let onContextMenu = function(row, $el){
                                                                      let self = this;

                                                                      if($el.data("item") == "action-details"){
                                                                          queryVue.openDetailPanel(row);
                                                                      }
                                                                  };

                                              let openDetailPanel = function(row){
                                                                        var self = this;
                                                                        var win;
                                                                        var w = $( window ).width();//document.body.clientWidth;
                                                                        var h = $( window ).height();//(document.body.clientHeight || document.documentElement.clientHeight);
                                                                        var wW = $( window ).width()*2/3;
                                                                        var hH = $( window ).height()*2/3;
                                                                        var lrwh = [(w-wW)/2, (h-hH)/2, wW, hH];
                                                                        var tb = document.createElement('div');

                                                                        $(tb).append(`<div class="panel" id="table-dblclick-show-panel" :model="model"></div>`);
                                                                        win = new mxWindow(row.id || row.host, tb, lrwh[0], lrwh[1], lrwh[2], lrwh[3], true, true);
                                                                        win.setMaximizable(true);
                                                                        win.setResizable(true);
                                                                        win.setClosable(true);
                                                                        win.setVisible(true);
                                                                        
                                                                        _.delay(function(){
                                                                            var panelVue = new Vue({
                                                                                delimiters: ['$', '$'],
                                                                                el: '#table-dblclick-show-panel',
                                                                                template: ` <div>
                                                                                                <div class="panel-body" style="padding:0px;">
                                                                                                    <div class="input-group input-group-sm" style="width:100%;" v-for="(item,index) in _.sortBy(model,'name')">
                                                                                                        <div class="input-group-addon" :id="item.name" style="width:200px;text-align: right;border:0px;border-bottom: 1px solid #ccc;border-radius: 0px;background-color:#f7f7f7;">$item.title$</div>
                                                                                                        <textarea class="form-control" :id="item.name" :placeholder="item.title" style="border:0px;border-left: 1px solid #ccc;border-bottom: 1px solid #ccc;">$item.value$</textarea>
                                                                                                    </div>
                                                                                                </div>
                                                                                                <div class="panel-footer">
                                                                                                    
                                                                                                </div>
                                                                                            </div>`,
                                                                                data:{
                                                                                    model:[]
                                                                                },
                                                                                mounted: function(){
                                                                                    var self = this;

                                                                                    self.$nextTick(function(){
                                                                                       
                                                                                        _.forEach(row, function(v,k){
                                                                                            if(_.isObject(v) && v!=null){
                                                                                               self.model =  _.map(v,function(val,key){
                                                                                                    return {name:key, title: _.upperFirst(key), value:val};
                                                                                                })
                                                                                            }else {
                                                                                                self.model.push({name:k, title: _.upperFirst(k), value:v});
                                                                                            }
                                                                                        })

                                                                                        $(self.$el).on('click keyup keydown', 'textarea', function () {
                                                                                            $(this).height(0).height(this.scrollHeight);
                                                                                        }).find('textarea').change();
                                                                                       
                                                                                    })

                                                                                },
                                                                                methods: {
                                                                                    autosize: function () {
                                                                                        $("textarea").each(function(textarea) {
                                                                                            $this.height( $this[0].scrollHeight );
                                                                                        });
                                                                                    }
                                                                                }
                                                                            });
                                                                        },500);
                                                                    };
                                              
                                              jQuery.ajax({
                                                  url: "/mxobject/list/sql",
                                                  dataType: 'json',
                                                  type: 'POST',
                                                  data: {
                                                      ctype:"obj",
                                                      sql:_sql
                                                  },
                                                  beforeSend:function(xhr){ 
                                                        oneLevelLoading = layer.load(2, {
                                                                shade: [0.1,'#ccc'],
                                                                time: 30*1000
                                                              });
                                                  },
                                                  complete: function(xhr, textStatus) {
                                                      layer.close(oneLevelLoading);
                                                  },
                                                  success: function (data, status) {
                                                      
                                                      mxLog.debug("[" + moment().format("LLL") + "] [200] " + JSON.stringify(data,null,2))
                                                      
                                                      // MQL for  CRUD
                                                      if(data.message == "OK"){
                                                          swal("Success!","","success");
                                                          layer.close(oneLevelLoading);
                                                      } 

                                                      let _data = _.attempt(JSON.parse.bind(null,data.message));
                                                      
                                                      _columns.push({
                                                          field: "num",
                                                          formatter: asNumFormatter,
                                                      });

                                                      let _tmp = _.upperCase(_sql).split("FROM")[0].replace(/SELECT/g,"");
                                                      
                                                      if(_tmp.indexOf("*") > -1 || _.trim(_tmp).length < 1){
                                                          _.map(_data[0], function(v,k) { 
                                                          
                                                            let tmp = {};
                                                      
                                                            if(k.indexOf("time") > -1){
                                                                tmp = {
                                                                         field: k,
                                                                         title: _.upperFirst(k),
                                                                         sortable: true,
                                                                         formatter: function(val){
                                                                                        return moment(val).format("LLL");
                                                                                    }
                                                                      };
                                                            } else {
                                                                tmp = {
                                                                         field: k,
                                                                         title: _.upperFirst(k),
                                                                         sortable: true
                                                                      };
                                                            }
                                                            _columns.push(tmp);
                                                          });
                                                      } else {
                                                         let _cols = _tmp.split(" ");
                                                         _.forEach(_cols,function(k){
                                                           if(!_.isEmpty(k)){
                                                              _columns.push({
                                                                              field: _.lowerCase(k),
                                                                              title: _.upperFirst(k),
                                                                              sortable: true
                                                                            });
                                                            }
                                                         })
                                                      }

                                                      let _hash = objectHash.sha1(_.trim(_sql));
                                                      let _index = _.findIndex(self.result.list, {id: _hash});
                                                      let _obj = {
                                                                    id: _hash,
                                                                    name: "query_" + _.size(self.result.list)+1,
                                                                    model:{
                                                                            options:{
                                                                                showColumns: false,
                                                                                pagination: false,
                                                                                showExport: false,
                                                                                contextMenu: '#context-menu',
                                                                                onContextMenuItem: onContextMenu
                                                                            },
                                                                            columns: _columns,
                                                                            dataset: _data
                                                                          }
                                                                  };

                                                      if(_index > -1){
                                                          _obj.name = self.result.list[_index].name;
                                                          self.result.list.splice(_index,1,_obj);
                                                      } else {
                                                          self.result.list.push(_obj);
                                                      }

                                                      $(".ul-query>li").removeClass("active");
                                                      $(".ul-query").find("#"+_hash).addClass("active");
                                                      
                                                      $(".tab-query>li").removeClass("active");
                                                      $(".tab-query").find("#"+_hash).addClass("active");

                                                      self.result.summary.count = _.size(_.data);
                                                      self.result.summary.time = moment().diff(moment(_stime), 'seond');
                                                      
                                                  },
                                                  error: function(xhr, textStatus, errorThrown){
                                                       mxLog.warn("["+ moment().format("LLL")+"] [" + xhr.status + "] " + xhr.responseJSON.error);
                                                       layer.close(oneLevelLoading);
                                                  } 
                                              });
                                          },
                                          onRemove: function(item){
                                              let self = this;
                                              let _index = _.findIndex(self.result.list, item);

                                              self.result.list.splice(_index,1);
                                          },
                                          onHelp: function() {
                                              mxLog.consoleName = 'M³ Debug Console';
                                              mxLog.show();
                                          }
                                      }
                                  });
                },
                initTrigger: function () {
                    var self = this;

                    jQuery.ajax({
                        url: '/mxobject/trigger',
                        dataType: 'json',
                        type: 'GET',
                        data: {class: self.class.tree.name},
                        complete: function(xhr, textStatus) {
                            //called when complete
                        },
                        success: function(data, textStatus, xhr) {
                            
                            var triggerVue = new Vue({
                                delimiters: ['${', '}'],
                                el: "#panel-trigger",
                                template: "#trigger-template",
                                data: {
                                    list: [],
                                    selected: []
                                },
                                mounted: function() {
                                    var self = this;

                                    self.$nextTick(function () {
                                        
                                        if( _.isEmpty(data.message) ) {
                                            self.list = [{  name: "",
                                                            time: moment().format("LLL"), 
                                                            class: appVue.class.tree.name,
                                                            model:{
                                                                oldInput: "",
                                                                newInput: "",
                                                                mode: "lua"
                                                            }
                                                        }];
                                        } else {
                                            self.list = _.values(_.map(data.message,function(v){
                                                                    return _.map(v.script,function(val,key){
                                                                        return   {    name: key,
                                                                                    time: v.vtime, 
                                                                                    class: v.class,
                                                                                    model:{
                                                                                        oldInput: val,
                                                                                        newInput: val,
                                                                                        mode: "lua"
                                                                                    }
                                                                                }
                                                                    })
                                                                }))[0];  
                                        }
                                        self.selected = _.head(self.list);
                                    })
                                },
                                methods: {
                                    toggle: function(item) {
                                        var self = this;

                                        self.selected = item;
                                    },
                                    add: function() {
                                        var self = this;
                                        let _name = $("#trigger_name").val();
                                        
                                        jQuery.ajax({
                                            url: '/mxobject/trigger',
                                            dataType: 'json',
                                            type: 'PUT',
                                            data: {
                                                class: appVue.class.tree.name, 
                                                name: _name, 
                                                script: ''
                                            },
                                            complete: function(xhr, textStatus) {
                                                //called when complete
                                            },
                                            success: function(data, textStatus, xhr) {
                                                self.refresh();
                                            },
                                            error: function(xhr, textStatus, errorThrown) {
                                                //called when there is an error
                                            }
                                        })
                                    },
                                    save: function() {
                                        var self = this;
                                        let _name = self.selected.name;
                                        let _class = self.selected.class;
                                        let _editor = ace.edit("trigger_editor_"+_name);
                                        let _script = _editor.getValue();
                                        
                                        jQuery.ajax({
                                            url: '/mxobject/trigger',
                                            dataType: 'json',
                                            type: 'PUT',
                                            data: {
                                                class: _class, 
                                                name: _name, 
                                                script: _script
                                            },
                                            complete: function(xhr, textStatus) {
                                                //called when complete
                                            },
                                            success: function(data, textStatus, xhr) {
                                                self.refresh();
                                            },
                                            error: function(xhr, textStatus, errorThrown) {
                                                //called when there is an error
                                            }
                                        })
                                    },
                                    saveAs: function() {
                                        var self = this;
                                        let _name = $("#trigger_name").val();
                                        return false;
                                        jQuery.ajax({
                                            url: '/mxobject/trigger',
                                            dataType: 'json',
                                            type: 'PUT',
                                            data: {
                                                class: appVue.class.tree.name, 
                                                name: _name, 
                                                script: ''
                                            },
                                            complete: function(xhr, textStatus) {
                                                //called when complete
                                            },
                                            success: function(data, textStatus, xhr) {
                                                self.refresh();
                                            },
                                            error: function(xhr, textStatus, errorThrown) {
                                                //called when there is an error
                                            }
                                        })
                                    },
                                    refresh: function() {
                                        var self = this;

                                        jQuery.ajax({
                                            url: '/mxobject/trigger',
                                            dataType: 'json',
                                            type: 'GET',
                                            data: {
                                                class: appVue.class.tree.name
                                            },
                                            complete: function(xhr, textStatus) {
                                                //called when complete
                                            },
                                            success: function(data, textStatus, xhr) {
                                                
                                                if( _.isEmpty(data.message)) { 
                                                    self.list = [{  name: "",
                                                                    time: moment().format("LLL"), 
                                                                    class: appVue.class.tree.name,
                                                                    model:{
                                                                        oldInput: "",
                                                                        newInput: "",
                                                                        mode: "lua"
                                                                    }
                                                                }];
                                                } else {
                                                    self.list = _.values(_.map(data.message,function(v){
                                                                            return _.map(v.script,function(val,key){
                                                                                return   {    name: key,
                                                                                            time: v.vtime, 
                                                                                            class: v.class,
                                                                                            model:{
                                                                                                oldInput: val,
                                                                                                newInput: val,
                                                                                                mode: "lua"
                                                                                            }
                                                                                        }
                                                                            })
                                                                        }))[0];  
                                                }
                                                self.selected = _.head(self.list);
                                            },
                                            error: function(xhr, textStatus, errorThrown) {
                                                //called when there is an error
                                            }
                                        });
                                    },
                                    remove: function(name) {
                                        var self = this;
                                        let _class = appVue.class.tree.name;
                                        let _name = name;
                                        
                                        jQuery.ajax({
                                            url: '/mxobject/trigger?class=' + _class + '&name=' + _name,
                                            dataType: 'json',
                                            type: 'DELETE',
                                            complete: function(xhr, textStatus) {
                                                //called when complete
                                            },
                                            success: function(data, textStatus, xhr) {
                                                self.refresh();
                                            },
                                            error: function(xhr, textStatus, errorThrown) {
                                                //called when there is an error
                                            }
                                        })
                                    },
                                    debug: function () {
                                        var self = this;
                                        
                                        mxLog.consoleName = 'M³ Debug Console' + " Trigger";
                                        mxLog.show();

                                        let debugMe = function () {

                                            let _param = "#/matrix/consolelog/trigger: | sort vtime asc | top 50";
                                            
                                            jQuery.ajax({
                                                url: '/mxobject/search',
                                                type: 'POST',
                                                dataType: 'json',
                                                data: { 
                                                    cond: _param, 
                                                    flag: false 
                                                },
                                                beforeSend:function(xhr){ 
                                                },
                                                complete: function(xhr, textStatus) {
                                                    //func.call();
                                                },
                                                success: function(data, textStatus, xhr) {
                                                    
                                                    if(_.isEmpty(data.message)) {
                                                      return false;
                                                    }

                                                    let _tmp = _.map(data.message,_.partialRight(_.pick, ['vtime','msg']));
                                                    _.forEach(_tmp,function(v) {
                                                        mxLog.writeln("["+moment(v.vtime).format("LLL")+"] " + v.msg); 
                                                    });
                                                },
                                                error: function(xhr, textStatus, errorThrown) {
                                                    mxLog.warn(errorThrown);
                                                }
                                            })   
                                        }

                                        debugMe();
                                        let _sched = later.parse.text('every 15 sec');
                                        let _timer = later.setInterval(debugMe, _sched);
                                    }
                                }
                            });
                            
                        },
                        error: function(xhr, textStatus, errorThrown) {
                            //called when there is an error
                        }
                    });
                },
                loadRels: function (){

                    var sql = `select json * from matrix.rels`;

                    jQuery.ajax({
                      url: '/mxobject/action',
                      type: 'POST',
                      dataType: 'json',
                      data: {
                          sql
                      },
                      complete: function(xhr, textStatus) {
                      },
                      success: function(data, textStatus, xhr) {
                          $("#realMaintainTable").bootstrapTable({data: JSON.parse(data.message)});
                          $("#realMaintainTable").bootstrapTable("load",JSON.parse(data.message));
                      },
                      error: function(xhr, textStatus, errorThrown) {
                          mxLog.warn(errorThrown);
                      }
                    });
                },
                initObjRelation: function () {
                    let self = this;

                    var relQueryInputEditor = ace.edit("db_relation_input");
                      relQueryInputEditor.setOptions({
                        maxLines: Infinity,
                        minLines: 10,
                        enableBasicAutocompletion: true,
                        enableSnippets: true,
                        enableLiveAutocompletion: true
                    });
                    relQueryInputEditor.$blockScrolling = Infinity
                    relQueryInputEditor.setTheme("ace/theme/xcode");
                    relQueryInputEditor.getSession().setMode("ace/mode/lua");
                    relQueryInputEditor.setAutoScrollEditorIntoView(true);

                    $("#btn_relation_query_submit").click(function(){ 
                        var oneLevelLoading;
                        var query = relQueryInputEditor.getValue();

                        if( relQueryInputEditor.getSelectedText().length > 0) query = relQueryInputEditor.getSelectedText(); 
                        
                        if(_.isEmpty(query)) {
                          swal("请确认条件","","warning");
                          return false;
                        }

                        jQuery.ajax({
                            url: "/mxobject/rel",
                            dataType: 'json',
                            type: 'POST',
                            data: {query},
                            beforeSend:function(xhr){ 
                              oneLevelLoading = layer.load(2, {
                                          shade: [0.1,'#ccc'],
                                          time: 30*1000
                                        });
                            },
                            complete: function(xhr, textStatus) {
                                layer.close(oneLevelLoading);
                            },
                            success: function (data, status) {
                              
                              var graphData = JSON.parse(data.message);

                              mxLog.debug(data.message);//JSON.stringify(data,null,'\t'));

                              var m = [20, 120, 20, 20],
                                  w = 980 - m[1] - m[3],
                                  h = 300 - m[0] - m[2],
                                  i = 0,
                                  root;

                              var tree = d3.layout.tree()
                                  .size([h, w]);

                              var diagonal = d3.svg.diagonal()
                                  .projection(function(d) { return [d.y, d.x]; });

                              $("#relation-result").empty();

                              var vis = d3.select("#relation-result").append("svg:svg")
                                  .attr("width", w + m[1] + m[3])
                                  .attr("height", h + m[0] + m[2])
                                .append("svg:g")
                                  .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

                              var temp = [];
                              graphData.forEach(function(d){
                                var o = new Object();
                                o.name = d.id;
                                o.parent = null;
                                temp.push(o);
                              })
                              var ac = {};
                              ac.name = "matrix";
                              ac.children = temp;
                              ac.parent = null;

                              root = ac;
                              
                              root.x0 = h / 2;
                              root.y0 = 0;

                              function toggleAll(d) {
                                if (d.children) {
                                  d.children.forEach(toggleAll);
                                  toggle(d);
                                }
                              }

                              update(root);

                              function update(source) {
                                
                                var duration = d3.event && d3.event.altKey ? 5000 : 500;

                                // Compute the new tree layout.
                                var nodes = tree.nodes(root).reverse();

                                // Normalize for fixed-depth.
                                nodes.forEach(function(d) { 
                                  d.y = d.depth * 180; 
                                });

                                // Update the nodes…
                                var node = vis.selectAll("g.node")
                                    .data(nodes, function(d) { return d.id || (d.id = ++i); });

                                // Enter any new nodes at the parent's previous position.
                                var nodeEnter = node.enter().append("svg:g")
                                    .attr("class", "node")
                                    .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
                                    .on("click", function(d) { toggle(d); update(d); });

                                nodeEnter.append("svg:circle")
                                    .attr("r", 1e-6)
                                    .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

                                nodeEnter.append('a')
                                    .attr('xlink:href', function(d) {
                                      return d.url;
                                    })
                                    .append("svg:text")
                                    .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
                                    .attr("dy", ".35em")
                                    .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
                                    .text(function(d) { return d.name; })
                                    .style('fill', function(d) {
                                      return d.free ? 'black' : '#999';
                                    })
                                    .style("fill-opacity", 1e-6);

                                nodeEnter.append("svg:title")
                                  .text(function(d) {
                                    return d.description;
                                  });

                                // Transition nodes to their new position.
                                var nodeUpdate = node.transition()
                                    .duration(duration)
                                    .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

                                nodeUpdate.select("circle")
                                    .attr("r", 6)
                                    .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

                                nodeUpdate.select("text")
                                    .style("fill-opacity", 1);

                                // Transition exiting nodes to the parent's new position.
                                var nodeExit = node.exit().transition()
                                    .duration(duration)
                                    .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
                                    .remove();

                                nodeExit.select("circle")
                                    .attr("r", 1e-6);

                                nodeExit.select("text")
                                    .style("fill-opacity", 1e-6);

                                // Update the links…
                                var link = vis.selectAll("path.link")
                                    .data(tree.links(nodes), function(d) { return d.target.id; });

                                // Enter any new links at the parent's previous position.
                                link.enter().insert("svg:path", "g")
                                    .attr("class", "link")
                                    .attr("d", function(d) {
                                      var o = {x: source.x0, y: source.y0};
                                      return diagonal({source: o, target: o});
                                    })
                                  .transition()
                                    .duration(duration)
                                    .attr("d", diagonal);

                                // Transition links to their new position.
                                link.transition()
                                    .duration(duration)
                                    .attr("d", diagonal);

                                // Transition exiting nodes to the parent's new position.
                                link.exit().transition()
                                    .duration(duration)
                                    .attr("d", function(d) {
                                      var o = {x: source.x, y: source.y};
                                      return diagonal({source: o, target: o});
                                    })
                                    .remove();

                                // Stash the old positions for transition.
                                nodes.forEach(function(d) {
                                  d.x0 = d.x;
                                  d.y0 = d.y;
                                });
                              }

                              // Toggle children.
                              function toggle(d) {
                                if (d.children) {
                                  d._children = d.children;
                                  d.children = null;
                                } else {
                                  d.children = d._children;
                                  d._children = null;
                                }
                              }
                            },
                            error: function(xhr, textStatus, errorThrown) {
                              mxLog.warn(errorThrown);
                              layer.close(oneLevelLoading);
                            }
                        });
                    });
                    
                    self.loadRels();

                    $("#realAddModalSave").click(function(event) {
                      var name = $("#realAddModal_name").val();
                      var remedy = $("#realAddModal_remedy").val();
                      var sql = `insert into matrix.rels json '{"name": "`+ name + `", "remedy": "` + remedy + `", "mtime": "` +  _.now() + `"}'`; 
                      jQuery.ajax({
                        url: '/mxobject/action',
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            sql
                        },
                        complete: function(xhr, textStatus) {
                          self.loadRels();
                        },
                        success: function(data, textStatus, xhr) {
                          
                          swal("添加成功！","","success");
                          $('#realAddModal').modal('hide');
                          $("#realAddModal_name").val();
                          $("#realAddModal_remedy").val();
                        },
                        error: function(xhr, textStatus, errorThrown) {
                          mxLog.warn(errorThrown);
                        }
                      });
                    });

                    $("#realRemove").click(function(event) {
                      var item = $("#realMaintainTable").bootstrapTable('getSelections');
                      var sql = `delete from matrix.rels where name ='` + item[0].name + `'`; 
                      jQuery.ajax({
                        url: '/mxobject/action',
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            sql
                        },
                        complete: function(xhr, textStatus) {
                          self.loadRels();
                        },
                        success: function(data, textStatus, xhr) {
                          
                          swal("删除成功！","","success");
                        },
                        error: function(xhr, textStatus, errorThrown) {
                          mxLog.warn(errorThrown);
                        }
                      });
                    });

                    $("#btn_relation_help").click(function(event){
                        appVue.onHelp();
                    })
                }
            }
        });

    });

    
    /*************************************** InitTable *******************************************/
    /**
     * @author  cnwangzd
     * @todo 初始化类定义页面内容
     */
      
    
    function asNumFormatter(value, row, index) {
      return index+1; 
    }

    function getIfLive(field){

      jQuery.ajax({
        url: '/mxobject/count',
        type: 'POST',
        dataType: 'json',
        data: {table: "field where name='" + field + "'"},
        complete: function(xhr, textStatus) {
          //called when complete
        },
        success: function(data, textStatus, xhr) {
          //called when successful
          return JSON.parse(data.message)[0].count;
        },
        error: function(xhr, textStatus, errorThrown) {
          //called when there is an error
          return null;
        }
      });  
    }

    
    function rowStyle(row, index) {
        var classes = ['active', 'info'];

        if (index % 2 === 0) {
            return {
                classes: classes[0]
            };
        } else {
          return {
              classes: classes[1]
          };
        }
        return {};
    }

    
    /*************************************** InitObjRelation *******************************************/

    

    /*************************************** InitKeySapce *******************************************/
    
    function InitKeySapce(){
      
      $("#keySpaceTabMenu_class").addClass("active");
      $("#keySpaceTabContent_class").addClass("active");

      //initKeySpaceNormalInfo();

      initTableAndData("class", "cid");
      initTableAndData("field", "name");
      initTableAndData("ftype", "tid");
      initTableAndData("counter", "id");
      initTableAndData("object", "id");
      
    }

    /*
    function initKeySpaceNormalInfo(t,o){
      var cols = [],
          colsField = [];
      jQuery.ajax({
        url: 'mxobject/columns',
        type: 'POST',
        dataType: 'json',
        data: {kp:'matrix',coln:t},
        complete: function(xhr, textStatus) {
          
        },
        success: function(data, textStatus, xhr) {
          $.map(JSON.parse(data.message), function(v) { 
             cols.push({
                 field: v.column_name,
                 title: v.column_name,
                 sortable: true
             })
             colsField.push(v.column_name);
          });
          
          $("#keySpaceTabContent_" + t + "_Table").bootstrapTable({columns: _.sortBy(cols, 'field')});

          loadData(colsField.join(","), t, o);
        },
        error: function(xhr, textStatus, errorThrown) {
          //called when there is an error
        }
      });
    }
    */

    function initTableAndData(t,o){
      var cols = [],
          colsField = [];
      jQuery.ajax({
        url: 'mxobject/columns',
        type: 'POST',
        dataType: 'json',
        data: {kp:'matrix',coln:t},
        complete: function(xhr, textStatus) {
          
        },
        success: function(data, textStatus, xhr) {
            $.map(JSON.parse(data.message), function(v) { 
                
                cols.push({
                             field: v.column_name,
                             title: _.upperFirst(v.column_name),
                             sortable: true
                          });

                colsField.push(v.column_name);
            });

            $("#keySpaceTabContent_" + t + "_Table").bootstrapTable({columns: _.sortBy(cols, 'field')});

            loadData(colsField.join(","), t, o);
        },
        error: function(xhr, textStatus, errorThrown) {
          //called when there is an error
        }
      });
    }

    function loadData(s,t, o) {
            
        var sql = `SELECT  &COLUMNS& FROM ` + t + ` limit 500`;
            sql = sql.replace("&COLUMNS&", s);
        
        jQuery.ajax({
             url: "/mxobject/list/sql",
             dataType: 'json',
             type: 'POST',
             data: {ctype:"all",sql},
             success: function (data, status) {
                $("#keySpaceTabContent_" + t + "_Table").bootstrapTable("load", _.sortBy(JSON.parse(data.message),o));
             },
             error: function(err){
                 console.log(err);
             }  
        });
    }

    /*************************************** InitViewConfig *******************************************/

    function InitViewConfig(obj) {

      jQuery.ajax({
        url: '/mxconfig/get',
        type: 'POST',
        dataType: 'json',
        data: {key:"/matrix/etc/mxserver/module/view"},
        complete: function(xhr, textStatus) {
          //called when complete
        },
        success: function(data, textStatus, xhr) {

          var view = JSON.parse(data.message.node.value)[obj.name];
          
          if(view == undefined) return false;
          
          jQuery.each(view, function(index, val) {
            $("#view_menu").before(`<li class="active">
                                      <a id="view_cur_a_` + val.name + `" class="wuxify-me" data-toggle="modal" href="#viewAddAndUpdateModal"><span class="` + val.icon + `"></span>` + val.name + `</a>
                                    </li>`);
            $("#view_cur_a_" + val.name).data("json",JSON.stringify(view[index]));
          });

          $('#viewAddAndUpdateModal').on('show.bs.modal', function (event) {
            
            var a = $(event.relatedTarget);
            var obj = JSON.parse(a.data("json"));
            
            var modal = $(this);
            modal.find('.modal-title').text('视图 ' + obj.name);
            modal.find('.modal-body #view_name').val(obj.name);
            modal.find('.modal-body #view_icon').val(obj.icon);
            modal.find('.modal-body #view_row').val(_.size(obj.row.split(",")));
            modal.find('.modal-body #view_col').val(_.size(obj.col.split(",")));
            //modal.find('#view_icon').value(obj.icon)
            
            var editorer = ace.edit("view_config_textarea");
            editorer.setOptions({
                maxLines: Infinity
            });
            
            editorer.$blockScrolling = Infinity
            editorer.setTheme("ace/theme/xcode");
            editorer.getSession().setMode("ace/mode/json");
            editorer.setValue(JSON.stringify(JSON.parse(a.data("json")),null,'\t'));
            editorer.setValue(editorer.getValue(), 1);
            editorer.resize();
            
          });
        },
        error: function(xhr, textStatus, errorThrown) {
          //called when there is an error
        }
      });

      // 初始化添加事件
      $(".nav-secondary-plus").on('show.bs.modal', function (event) {
            
            
      });

      $("#btn_view_submit").on("click",function(e){
        var modal = $(this).parent().parent(".modal");
        
        modal.find('.modal-title').text('视图 ' + obj.name);
        
        var key = "/matrix/etc/mxserver/view/" + obj.name + "/" +  modal.find('.modal-body #view_name').val();
        var value = `{}`;
        var ttl = -1;
        jQuery.ajax({
          url: '/mxconfig/set',
          type: 'POST',
          dataType: 'json',
          data: {key,value,ttl},
          complete: function(xhr, textStatus) {
            //called when complete
          },
          success: function(data, textStatus, xhr) {
            //called when successful
            $("#view_menu").before(`<li class="active">
                                      <a class="wuxify-me" href="#"><span class="icon-dashboard"></span>` + obj.name + '视图' + `</a>
                                    </li>`);
            swal("提交成功！")
          },
          error: function(xhr, textStatus, errorThrown) {
            //called when there is an error
          }
        });
      })
      /*
      $(".nav-secondary-plus").on("click",function(){
        $("#view_menu").before(`<li class="active">
          <a class="wuxify-me" href="#"><span class="icon-dashboard"></span>` + obj.name + '视图' + `</a>
                                </li>`);
        var key = "/matrix/etc/mxserver/view/" + obj.name.replace(/\//g,".");
        var value = `{}`;
        var ttl = -1;
        jQuery.ajax({
          url: '/mxconfig/set',
          type: 'POST',
          dataType: 'json',
          data: {key,value,ttl},
          complete: function(xhr, textStatus) {
            //called when complete
          },
          success: function(data, textStatus, xhr) {
            //called when successful
            swal("提交成功！")
          },
          error: function(xhr, textStatus, errorThrown) {
            //called when there is an error
          }
        });
      })
      */
      /**
       * @author  cnwangzd
       * @todo 删除视图定义
       */
      $(".view-close").on("click", "[viewclose]", function (e) {
          console.log(e.target.viewclose);
         
      });
        
    }

    function formaterDate(value, row, index) {
        return moment(value).format('YYYY-MM-DD HH:MM:ss');
    }

    //-->
</SCRIPT>


<script type="text/x-template" id="app-template">
    <div>
        <div id="sidebar" class="sidebar __web-inspector-hide-shortcut__" style="background-color:transparent;overflow:auto;">
      
            <div>
              <select id="select_keyspace" class="form-control" style="width:100%;height:40px;background-color:transparent;border:none;">
                <option value="{{.SignedUser.Company.OSpace}}" selected>{{.SignedUser.Company.OSpace}}</option>
                <option value="add"><i class="fa fa-plus"></i> {{.i18n.Tr "mxobject_tablespace_new"}}</option>
              </select>
            </div>
          
            <div class="panel-group" id="accordion1" role="tablist" aria-multiselectable="true">
                
                <div class="panel" style="border-radius: 0px;border-right: 1px solid #f0f3f5;">

                    <div class="panel-heading" role="tab" id="headingOne">
                        <i class="fa fa-cubes toggle-nav"></i> 
                        <a data-toggle="collapse" data-parent="#accordion1"  href="#collapse_class">
                            {{.i18n.Tr "mxobject_treemenu_heading_title"}}
                        </a>                          
                        
                        <span class="pull-right">
                            <div class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                                  <span class="caret"></span>
                                </a>
                                <ul id="menu3" class="dropdown-menu dropdown-menu-right" aria-labelledby="drop6">
                                    <li>
                                        <a id="acc_btn_class_add" href="#" title="添加类定义" data-toggle="modal" data-target="#configAddModal" ><i class="fa fa-plus fa-fw"></i> New Class</a>
                                    </li>
                                    <li>
                                        <a id="acc_btn_class_remove" href="#" title="删除当前类定义"><i class="fa fa-remove fa-fw"></i>Remove Class</a>
                                    </li>
                                    <li>
                                        <a id="acc_btn_class_toggle" href="#" title="切换显示"><i class="fa fa-camera fa-fw"></i>Toggle View</a>
                                    </li>
                                </ul>
                            </div>

                        </span>
                    </div>

                    <div id="collapse_class" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
                      
                        <div class="panel-body" style="border-top:1px solid #f0f3f5;">
                            <class-tree-component></class-tree-component>
                        </div>
                      
                        <div class="panel-footer">
                        </div>
                    </div>          

                </div>
            </div>
        </div>
        <div id="content" class="content content-full-width">
            <div class="vertical-box">
                <ul id="myTabMenu" class="nav nav-tabs object"></ul>
                <div id="myTabContent" class="tab-content object"></div>
                <!-- context menu -->
                <ul id="context-menu" class="dropdown-menu">
                    <li data-item="action-details"><a href="javascript:void(0)" style="cursor:hand;"><i class="fa fa-list fa-fw"></i> Details</a></li>
                    <li data-item="action-history"><a href="javascript:void(0)" style="cursor:hand;"><i class="fa fa-clock-o fa-fw"></i> History</a></li>
                    <li data-item="action-add"><a href="javascript:void(0)" style="cursor:hand;"><i class="fa fa-plus fa-fw"></i> New Action</a></li>
                </ul>
            </div>
        </div>

        <!-- Node Add Modal -->
        <div class="modal fade" id="configAddModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">请输入类名称</h4>
              </div>
              <div class="modal-body">
                
                <label for="">类名称</label>
                <input type="text" class="form-control" id="class_name">
                
                <BR>
                <label for="">类显示名称</label>
                <input type="text" class="form-control" id="class_alias" >

                <BR>
                <label for="">备注</label>
                <input type="text" class="form-control" id="class_remedy" >
                
                <BR>
                <label for="">颜色</label>
                <input id="class_color" type="text" class="form-control" value="hsl(180, 50%, 50%)">
                
                <BR>
                <label for="">标签</label>
                <select id="class_tags" class="form-control" multiple="multiple" style="width:100%;"></select>

              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="btn_class_new" data-dismiss="modal">提交</button>
              </div>
            </div>
          </div>
        </div> 
        <!-- /Node Add Modal -->

        <!-- /view Add Modal -->
        <div class="modal fade" id="viewAddAndUpdateModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">视图</h4>
              </div>
              <div class="modal-body" style="padding:10px 0px 0px 0px;">
                
                <ul class="nav nav-tabs">
                  <li class="active"><a href="#grid" aria-controls="grid" role="tab" data-toggle="tab">页面设计</a></li>
                  <li><a href="#jsonview" aria-controls="jsonview" role="tab" data-toggle="tab">源码</a></li>
                </ul>

                <!--Tab container-->
                <div class="tab-content">
                  <div role="tabpanel" class="tab-pane fade in active" id="grid" style="padding:10px 30px 0px 30px;">
                    
                    <label for="">视图名称</label>
                    <input type="text" class="form-control" id="view_name">
                    
                    <BR>
                    <label for="">图标</label>
                    <input type="text" class="form-control" id="view_icon" >
                    
                    <BR>
                    <label for="">行[row]</label>
                    <input type="number" class="form-control" id="view_row" min="1" step="1">
                    
                    <BR>
                    <label for="">列[col]</label>
                    <input type="number" class="form-control" id="view_col" min="1" step="1">
                    
                    <BR>
                    <label for="">PortalLet</label>
                    <div class="well"></div>

                    <BR>
                    <label for="">是否显示</label><BR>
                    <input type="checkbox" class="form-control" id="view_active" >
                    <BR>
                    <BR>
                  </div>
                  
                  <div role="tabpanel" class="tab-pane fade" id="jsonview">
                    <div id="view_config_textarea"></div>
                  </div>

                </div>

              </div>
              
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="btn_view_submit" data-dismiss="modal">提交</button>
              </div>
              
            </div>
          </div>
        </div>
        <!-- /view Add Modal -->
    </div>
</script>

<script type="text/x-template" id="query-template">
    <div class="panel">
        <div class="panel-heading" role="tab">
          <span>
            <i class="fa fa-newspaper-o"></i>
          </span>
          <div class="btn-group pull-right">
            <a href="javascript:void(0)" @click="onQuery" class="btn btn-xs btn-success">
              <i class="fa fa-play"></i>
            </a>
            <a href="javascript:void(0)" @click="onHelp" class="btn btn-xs btn-default">
              <i class="fa fa-television"></i>
            </a>
          </div>
        </div>

        <div class="panel-body" style="padding:0px 0px 0px 0px;" >
            <div id="query_input" class="split split-vertical"></div>
            <div id="query_result" class="split split-vertical" role="tabpanel">
                <div v-if="_.size(result.list) == 0">
                    <div class="jumbotron">
                      <div class="container">
                        <h3>No Data</h3>
                        <p>input mql to search data ...</p>
                      </div>
                    </div>
                </div>
                <!-- Nav tabs -->
                <ul class="nav nav-tabs ul-query" role="tablist">
                  <li role="presentation" 
                      :class="_.size(result.list)==index+1?'active':''" 
                      v-for="(item,index) in result.list"
                      style="display:-webkit-box;">
                      <a :href="'#'+item.id" :aria-controls="item.id" role="tab" data-toggle="tab" style="background-color:transparent;">${item.name}</a>
                      <a href="javascropt:void(0);" @click="onRemove(item)" style="color:#9f9f9f;cursor:pointer;" style="background-color:transparent;"><i class="fa fa-close"></i></a>
                  </li>
                </ul>
              
                <!-- Tab panes -->
                <div class="tab-content tab-query">
                    <div role="tabpanel" :class="_.size(result.list)==index+1?'tab-pane active':'tab-pane'" :id="item.id" v-for="(item,index) in result.list">
                        <bootstrap-table :columns="item.model.columns" :options="item.model.options" :dataset="item.model.dataset" classes="table-query"></bootstrap-table>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-footer">
            <span>Count: ${result.summary.count}  ⎪  Use: ${result.summary.time} ms</span>
        </div>
    </div>  
</script>

<script type="text/x-template" id="trigger-template">
    <div class="panel">
      <div class="panel-body" style="padding:0px;">
          <div class="well well-sm" style="background-color:#F7F7F7;margin-bottom:0px;border-radius:0px;border:none;font-size:12px;">
                  
              <div class="btn-group">
                <a style="cursor:pointer;" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    ${selected.name} <i class="fa fa-angle-down"></i> 
                </a>
                <ul class="dropdown-menu">
                  <li v-for="item in list" style="display: flex;">
                    <a href="javascript:void(0)" style="cursor:pointer;width:90%;"
                       @click="toggle(item)">
                        <i class="fa fa-tasks"></i> ${item.name}
                    </a>
                    <a  href="javascript:void(0)" style="float:right;color:#ddd;float:right;" 
                        @click="remove(item.name)"><i class="fa fa-remove"></i></a>
                  </li>
                </ul>
              </div>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              <div class="btn-group pull-right">
                  <a  class="btn btn-xs btn-default" style="cursor:pointer;padding:0px 5px;"
                      href="#modal-trigger-add" title="New Trigger" data-toggle="modal">
                      <i class="fa fa-plus"></i>
                  </a>
                  <a  href="javascript:void(0)" 
                      class="btn btn-xs btn-default" 
                      style="cursor:pointer;padding:0px 5px;"
                      @click="save">
                      <i class="fa fa-save"></i>
                  </a>
                  <a class="btn btn-xs btn-default" style="cursor:pointer;padding:0px 5px;">
                      <i class="fa fa-files-o"></i>
                  </a>
                  <a href="javascript:void(0)" @click="debug" class="btn btn-xs btn-default" style="cursor:pointer;padding:0px 5px;">
                      <i class="fa fa-television"></i>
                  </a>
              </div>
              
              <span class="pull-right">
                <a id="btn_agent_filter_fullscreen" style="cursor:pointer;">
                <i class="fa fa-fullscreen"></i>
                </a>
              </span>
          </div>
          
          <div class="vertical-box">
                <div v-if="list[0].name.length > 0">
                    <script-editor-component :id="'trigger_editor_'+selected.name" :model="selected.model"></script-editor-component>
                </div>
                <div v-else>
                    
                </div>
          </div>
      </div>
      <div id="div_agent_footer_info" class="panel-footer">
      </div>

      <div class="modal fade" id="modal-trigger-add" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Name</h4>
              </div>
              <div class="modal-body">
                
                <label for="">Name</label>
                <input type="text" class="form-control" id="trigger_name" >
                
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" @click="add()">Save</button>
              </div>
            </div>
          </div>
      </div> 
    </div>
</script>

<script type="text/x-template" id="graph-template">
  <div id="svg">
  </div>
</script>

{{template "base/footer" .}}
