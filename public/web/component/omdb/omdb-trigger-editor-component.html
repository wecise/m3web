<code>

	<style>
		/*----------  style  ----------*/

		.omdb-trigger-editor-component {
			background-color: rgb(246, 246, 246);
			width:100%;
			height: 100%;
			position: relative;
		}


		.omdb-trigger-editor-component .ace_editor{
			border: none;
			margin: 0px 0px 10px 0px;
			width: 100%;
			height:calc(100% - 50px)!important;
			position: relative !important;
			overflow: auto;
		}

		.omdb-trigger-editor-component .ace_keyword {
			color: #a70909!important;
		}

		.omdb-trigger-editor-component .editor-container{
			width: 100%;
			height: 100%;
		}

		/* For Tool Bar */
		.omdb-trigger-editor-component .editorToolBar{
			height: 30px;
			background-color: rgb(246, 246, 246);/*rgb(33, 149, 243);*/
			width: 100%;
		}

		.omdb-trigger-editor-component .editorToolBar .btn-primary,
		.omdb-trigger-editor-component .editorToolBar .btn-primary:hover{
			background-color: rgb(246, 246, 246);
			color: #333333;
			border:none;
		}

		.omdb-trigger-editor-component .editorToolBar > .btn-group {
			top: 1px;
			width: 100%;
		}

		.omdb-trigger-editor-component .editorToolBar .btn-group > a > i{
			color: #666666;
		}

		.omdb-trigger-editor-component .statusBar {
			display: -webkit-box;
			position: fixed;
			width: 100%;
			height: 30px;
			padding: 7px;
			background: rgb(246, 246, 246);
		}

	</style>

	
	/*----------  最外层element会自动增加组件同名 class="omdb-trigger-editor-component"  ----------*/
	<template>
		<div class="editor-container">
			<div class="editorToolBar" :id="id+'_editorToolBar'">
				<div class="btn-group" role="group">

					<a href="javascript:void(0);"
					   class="btn btn-sm btn-primary"
					   :id="id+'_trigger_list_contextmenu'"
					   title="选择触发器" data-tooltip="tooltip" style="padding-left:10px;font-weight: 600;">
						${selected.name} <i class="fas fa-angle-down"></i>
					</a>
					<a  href="javascript:void(0)"
					    class="btn btn-sm btn-primary">
						|
					</a>
					<a  href="#javascript:void(0)"
					    class="btn btn-sm btn-primary"
					    title="新建触发器"
					    data-tooltip="tooltip"
					    @click="add">
						<i class="fas fa-plus"></i>
					</a>
					<a  href="#javascript:void(0)"
					    class="btn btn-sm btn-primary"
					    title="删除触发器"
					    data-tooltip="tooltip"
					    @click="remove" >
						<i class="fas fa-trash"></i>
					</a>
					<a  href="javascript:void(0)"
					    class="btn btn-sm btn-primary"
					    title="保存触发器"
					    data-tooltip="tooltip"
					    @click="save">
						<i class="fas fa-save"></i>
					</a>

					<a href="javascript:void(0)" v-if="list.length > 0">
						<a href="javascript:void(0)" class="pretty p-icon p-toggle p-plain" style="margin:8px 6px;" data-tooltip="tooltip" :title="selectedTitle">
							<input type="checkbox" v-model.Boolean="selected.disable" @click="update"/>
							<div class="state p-success-o p-on">
								<i class="icon fas fa-play"></i>
								<label></label>
							</div>
							<div class="state p-default-o p-off">
								<i class="icon fas fa-pause"></i>
								<label></label>
							</div>
						</a>
					</a>
					<a href="javascript:void(0)" :class="'btn btn-sm btn-link pull-right editor-select-theme-'+objectHash.sha1(className)" title="主题" data-tooltip="tooltip"><i class="fas fa-tshirt"></i></a>

				</div>
			</div>
			<div :id="id" ></div>
			<div :id="id+'_statusBar'" class="statusBar"></div>
		</div>
	</template>

	/*----------  id是vue组件的name，内容是vue组件的option参数  ----------*/
	<script id="omdb-trigger-editor-component">
	{
	    delimiters: ['${', '}'],
        props: {
            id: String,
			className: String,
            model: Object,
            showToolsBar: Boolean,
			showStatusBar: Boolean
        },
        data: function(){
            return {
                editor: null,
                result: null,
                list: [],
                selected: {
                    name: "",
                    disable: null,
                    time: moment().format("YYYY-MM-DD hh:mm:ss"),
                    class: "",
	                script: ""
                },
	            statusBarInfo: ""
            }
        },
        mounted: function(){
            let self = this;

            self.$nextTick(function(){
                self.init();
                self.initData();
                _.delay(function(){
	                self.initMenu();
	                self.initToolTip();
                },500)
            })
        },
        watch: {
	        selected:{
	            handler:function(val,oldVal){
	                let self = this;

                    self.editor.setValue(val.script);
	            },
		        deep:true
	        },
            result: function(val,oldVal){
                    let self = this;

                    if(val != oldVal) {
                        eventHub.$emit("QUERY-RESULT-TRIGGER-EVENT",self.result);
                    }
            }

        },
        computed:{
            selectedTitle: function(){
                let self = this;

                _.delay(self.initToolTip,1500);

                return self.selected.disable == 'true' ? '启用中。。。' : '禁用中。。。';
            }
        },
        methods: {
            init: function() {
                let self = this;

                self.editor = ace.edit(self.id);
                
                self.editor.setOptions({
                    //maxLines: Infinity,
                    // minLines: 20,
                    autoScrollEditorIntoView: true,
                    enableBasicAutocompletion: true,
                    enableSnippets: true,
                    enableLiveAutocompletion: false
                });
                self.editor.$blockScrolling = Infinity;
                self.editor.getSession().setUseSoftTabs(true);

                self.setTheme();
                self.setMode();

				self.toggleToolsBar();

				self.toggleStatusBar();

                self.editor.commands.addCommand({
                    name: "save",
                    exec: self.save,
                    bindKey: { win: "ctrl-s", mac: "cmd-s" }
                });

                // init Theme
                _.delay(function(){
                    self.initTheme();
                },3000)

            },
            setOptions: function(){
                let self = this;

                if(!_.isEmpty(self.model.options)){
                    self.editor.setOptions(self.model.options);
                } 
            },
            setTheme: function(){
                let self = this;

                let localTheme = localStorage.getItem(`editor-select-theme-${objectHash.sha1(self.className)}`);

                if(localTheme){
                    self.editor.setTheme("ace/theme/" + localTheme);
                    return false;
                }

                if(_.isEmpty(self.model.theme)){
                	self.editor.setTheme("ace/theme/tomorrow");
                } else {
                	self.editor.setTheme("ace/theme/"+self.model.theme);
                }
                
            },
            setMode: function(){
                let self = this;

                if(_.isEmpty(self.model.mode)){
                	self.editor.getSession().setMode("ace/mode/lua");
                } else {
                	self.editor.getSession().setMode("ace/mode/"+ self.model.mode);
                }
                
            },
            getSelected: function(){
                let self = this;
                let temp = self.editor.getSelectedText();

                if(_.isEmpty(temp)){
                    self.inputText = self.editor.getValue();
                } else {
                    self.inputText = temp;
                }
            },
            toggleToolsBar: function(){
                let self = this;

                if(self.showToolsBar){
                    $(".toolsBar").show();
                } else {
                    $(".toolsBar").hide();
                }
            },
	        toggleStatusBar: function(){
                let self = this;

                if(self.showStatusBar) {
                    let StatusBar = ace.require("ace/ext/statusbar").StatusBar;
                    let statusBar = new StatusBar(self.editor, document.getElementById(`${self.id}_statusBar`));
                }
	        },
	        copyIt: function(){
		        let self = this;

                new Clipboard(".copy", {
                    text: function(trigger) {
                        alertify.log("已复制");
                        return self.editor.getValue();
                    }
                });

	        },
            pasteIt: function(){
                let self = this;

                document.execCommand("paste");
                alertify.log("已粘贴");
            },
	        selectAll: function(){
                let self = this;

                self.editor.selection.selectAll();
            },
            clearIt: function(){
                let self = this;

                self.editor.setValue();
                alertify.log("已清空");
            },
            initTheme: function(){
                let self = this;
                let id = objectHash.sha1(self.className);

                $.contextMenu({
                    selector: `.editor-select-theme-${id}`,
                    trigger: 'left',
                    callback: function (key, options) {
                        if(key !== 'bright' && key !== 'dark'){
                            self.editor.setTheme("ace/theme/"+key);

                            localStorage.setItem(`editor-select-theme-${id}`,key);
                        }
                    },
                    items: {
                        "bright": { name: "亮色", items: {
                                "chrome": { name: "chrome"},
                                "clouds": { name: "clouds"},
                                "crimson_editor": { name: "crimson_editor"},
                                "dawn": { name: "dawn"},
                                "dreamweaver": { name: "dreamweaver"},
                                "eclipse": { name: "eclipse"},
                                "github": { name: "github"},
                                "iplastic": { name: "iplastic"},
                                "solarized_light": { name: "solarized_light"},
                                "textmate": { name: "textmate"},
                                "tomorrow": { name: "tomorrow"},
                                "xcode": { name: "xcode"},
                                "kuroir": { name: "kuroir"},
                                "katzenmilch": { name: "katzenmilch"},
                                "sqlserver": { name: "sqlserver"}
                            }
                        },
                        "dark": { name: "暗色", items: {
                                "ambiance": { name: "ambiance"},
                                "chaos": { name: "chaos"},
                                "clouds_midnight": { name: "clouds_midnight"},
                                "dracula": { name: "dracula"},
                                "cobalt": { name: "cobalt"},
                                "gruvbox": { name: "gruvbox"},
                                "gob": { name: "gob"},
                                "idle_fingers": { name: "idle_fingers"},
                                "kr_theme": { name: "kr_theme"},
                                "merbivore": { name: "merbivore"},
                                "merbivore_soft": { name: "merbivore_soft"},
                                "mono_industrial": { name: "mono_industrial"},
                                "monokai": { name: "monokai"},
                                "pastel_on_dark": { name: "pastel_on_dark"},
                                "solarized_dark": { name: "solarized_dark"},
                                "terminal": { name: "terminal"},
                                "tomorrow_night": { name: "tomorrow_night"},
                                "tomorrow_night_blue": { name: "tomorrow_night_blue"},
                                "tomorrow_night_bright": { name: "tomorrow_night_bright"},
                                "tomorrow_night_eighties": { name: "tomorrow_night_eighties"},
                                "twilight": { name: "twilight"},
                                "vibrant_ink": { name: "vibrant_ink"}
                            }
                        }
                    }
                });
            },
            // 触发器数据结构化整理
            treatNode: function(event){
                return _.map(event.script,function(v,k){
                    let attr = {disable:false};

                    if(event.attr && event.attr != null){
                        if(event.attr[k]) {
                            attr = JSON.parse(event.attr[k] || '{}');
                        }
                    }

                    return _.merge(attr,{name:k,script:event.script[k],class:event.class,vtime:event.vtime});
                });
            },
	        initData: function(){
                let self = this;

                let rtn = triggerHandler.triggerList(self.className);

                let list = [];

                if(!_.isEmpty(rtn)){
                    list = self.treatNode(rtn[0]);
                }

                if(!_.isEmpty(list)){
                    self.list = _.map(list,function(v,k){
                        return   {
                            name: _.trim(v.name),
                            disable: v.disable,
                            time: v.vtime,
                            class: v.class,
	                        script: v.script
                        }
                    });

                    self.selected = _.head(_.orderBy(self.list,['name'],['asc']));
                }

            },
            initMenu:function(){
                let self = this;

                $.contextMenu({
                    selector: `#${self.id}_trigger_list_contextmenu`,
                    /*position: function(opt, x, y){
                        //opt.$menu.position({ of: this, offset: "0 5"});
                    },*/
                    trigger: 'left',
                    hideOnSecondTrigger: true,
                    className: `animated slideIn`,
                    build: function($trigger, e) {

                        let items = {};

                        _.forEach(self.list,function(v,k){
                            _.merge(items, {[v.name]:{name:v.name, icon: "fas fa-toggle-on", item: v}});
                        });

                        return {
                            callback: function(key, options) {
                                self.selected = _.groupBy(self.list,'name')[key][0];
                            },
                            items: items,
                        }
                    },
                    events: {
                        show: function(opt) {

                            let $this = this;


                        },
                        hide: function(opt) {

                            let $this = this;



                        }
                    }
                });
            },
            initToolTip: function(){
                $("[data-tooltip='tooltip']").tooltip('destroy').tooltip({
                    container: 'body',
                    trigger : 'hover',
                    template: `<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>`
                });

            },
            toggle: function(item) {
                let self = this;

                self.selected = item;
            },
            add: function() {
                let self = this;

                alertify.prompt("新增触发器", function (e, str) {
                    if (e) {
                        let _rtn = triggerHandler.triggerNew({class: self.className, name: _.trim(str), script:''});

                        if(_rtn === 1) {
                            self.refresh(str);
                        }
                    } else {

                    }
                }, "触发器名称");
                $(".alertify-prompt .alertify-message").css('height','5vh');
            },
            save: function() {
                let self = this;

                let script = self.editor.getValue();

                let _rtn = triggerHandler.triggerNew({class: self.className, name: self.selected.name, script: script, attr:{disable: `${self.selected.disable}`}});

                if(_rtn === 1) {
                    self.refresh(self.selected.name);
                }
            },
            update: function(){
                let self = this;

                let script = self.editor.getValue();

                let _rtn = triggerHandler.triggerNew({class: self.className, name: self.selected.name, script: script, attr:{disable: `${self.selected.disable}`}});

                if(_rtn === 1) {
                    self.refresh(self.selected.name);
                }
            },
            refresh: function(name) {
                let self = this;


                let rtn = triggerHandler.triggerList(self.className);

                if(!_.isEmpty(rtn)){
                    self.list = _.map(self.treatNode(rtn[0]),function(v,k){
                        return   {
                            name: v.name,
                            disable: v.disable,
                            time: v.vtime,
                            class: v.class,
	                        script: v.script
                        }
                    });

                    self.selected = _.groupBy(_.orderBy(self.list,['name'],['asc']),'name')[name][0];

                } else {
                    self.list = [];
                    self.selected = { name: ""};
                }

                self.initToolTip();

            },
            remove: function() {
                let self = this;

                alertify.confirm(`确认删除触发器：${self.selected.name}`, function(e) {
                    if(e) {
                        let _rtn = triggerHandler.triggerDelete(self.className, self.selected.name);

                        if(_rtn === 1){
                            let name = self.list.length>0 ? _.head(self.list).name : null
                            self.refresh(name);
                        }
                    } else {
                        // user clicked "cancel"
                    }
                });

            }
        }
    
	
	}
	</script>

</code>
