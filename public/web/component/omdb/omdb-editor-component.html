<code>

	<style scoped>
		/*----------  style  ----------*/
		.omdb-editor-component {
			background-color: rgb(246, 246, 246);
			width:100%;
			height: 100%;
			position: relative;
		}

		.omdb-editor-component .ace_editor{
			border: none;
			margin: 0px 0px 10px 0px;
			width: 100%;
			height:calc(100% - 50px)!important;
			position: relative !important;
			overflow: auto;
		}

		.lm_maximised .omdb-editor-component .ace_editor{
			border: none;
			margin: 0px 0px 10px 0px;
			width: 100%;
			height:calc(100% - 50px)!important;
			position: relative !important;
			overflow: auto;
		}

		.ace_keyword {
			color: #a70909!important;
		}

		.editorToolBar{
			height: 30px;
			background-color: rgb(246, 246, 246);/*rgb(33, 149, 243);*/
			width: 100%;
		}

		.editorToolBar .btn-primary,
		.editorToolBar .btn-primary:hover{
			background-color: rgb(246, 246, 246);
			color: #333333;
			border:none;
		}

		.editorToolBar > .btn-group {
			top: 1px;
			width: 100%;
		}

		.editorToolBar .btn-group > a > i{
			color: #666666;
		}

		.scrollmargin {
			height: 500px;
			text-align: center;
		}

		.editor-container{
			width: 100%;
			height: 100%;
		}

		.omdb-editor-component .statusBar {
			display: -webkit-box;
			position: fixed;
			width: 100%;
			height: 30px;
			padding: 7px;
			background: rgb(246, 246, 246);
		}

		
	</style>

	
	/*----------  最外层element会自动增加组件同名 class="omdb-editor-component"  ----------*/
	<template>
		<div class="editor-container">
			<div class="editorToolBar" id="editorToolBar">
				<div class="btn-group" role="group">
					<a href="javascript:void(0);" class="btn btn-sm btn-primary saveas" @click="saveToFs" title="另存到文件系统" data-tooltip="tooltip"><i class="fas fa-save"></i></a>
					<a href="javascript:void(0);" class="btn btn-sm btn-primary load" @click="loadFromFs" title="加载" data-tooltip="tooltip"><i class="fas fa-arrow-circle-down"></i></a>
					<a href="javascript:void(0);" class="btn btn-sm btn-primary copy" @click="copyIt" title="复制" data-tooltip="tooltip"><i class="fas fa-copy"></i></a>
					<a href="javascript:void(0);" class="btn btn-sm btn-primary paste" @click="pasteIt" title="粘贴" data-tooltip="tooltip"><i class="fas fa-paste"></i></a>
					<a href="javascript:void(0);" class="btn btn-sm btn-primary selectAll" @click="selectAll" title="全选" data-tooltip="tooltip"><i class="fas fa-check"></i></a>
					<a href="javascript:void(0);" class="btn btn-sm btn-primary clear" @click="clearIt" title="清空" data-tooltip="tooltip"><i class="fas fa-trash"></i></a>
					<a href="javascript:void(0);" class="btn btn-sm btn-primary query" @click="query"  title="执行" data-tooltip="tooltip"><i class="fas fa-play"></i></a>
					<!--<a href="javascript:void(0);" class="btn btn-sm btn-primary queryPlus" @click="queryPlus"  title="在新窗口执行"><i class="fa fa-play"></i>+</a>-->
					<a href="javascript:void(0);" class="btn btn-sm btn-primary queryAndSave" @click="queryAndSave"  title="执行并保存到文件" data-tooltip="tooltip"><i class="fas fa-forward"></i></a>
					<a href="javascript:void(0)" :class="'btn btn-sm btn-link pull-right editor-select-theme-'+objectHash.sha1(id)" title="主题" data-tooltip="tooltip"><i class="fas fa-tshirt"></i></a>
				</div>
			</div>
			<div :id="id" ></div>
			<div :id="id+'_statusBar'" class="statusBar"></div>
		</div>
	</template>

	/*----------  id是vue组件的name，内容是vue组件的option参数  ----------*/
	<script id="omdb-editor-component">
	{
	    delimiters: ['${', '}'],
        props: {
            id: String,
			bid: String,
            model: Object,
            showToolsBar: Boolean,
			showStatusBar: Boolean
        },
        data: function(){
            return {
                langTools:null,
                editor: null,
                inputText: "",
	            result: null
            }
        },
        mounted: function(){
            var self = this;

            self.$nextTick(function(){
                self.init();
            })
        },
        watch: {
            'model.newInput': {
            	handler:function(val,oldVal){
                    let self = this;
                    
                    self.editor.setValue(val);
                },
                deep:true
            }

        },
        created: function () {
            let self = this;

        },
        methods: {
            init: function() {
                let self = this;

                self.langTools = ace.require("ace/ext/language_tools");
                self.editor = ace.edit(self.id);
                
                self.editor.setOptions({
                    // maxLines: 1000,
                    // minLines: 20,
                    autoScrollEditorIntoView: true,
                    enableBasicAutocompletion: true,
                    enableSnippets: true,
                    enableLiveAutocompletion: false
                });
                //self.editor.$blockScrolling = Infinity;
                self.editor.setShowPrintMargin(self.model.printMargin);
                self.editor.setReadOnly(self.model.readOnly);
                self.editor.getSession().setUseSoftTabs(true);

                self.editor.getSession().setTabSize(2);
                self.editor.getSession().setUseWrapMode(true);

                self.setTheme();
                self.setMode();
                self.setOptions();

				self.toggleToolsBar();

				self.toggleStatusBar();

                // Customer Auto Completer
	            let customerCompleter = {
                    getCompletions: function(editor, session, pos, prefix, callback) {

                        if (prefix.length === 0) {
                            callback(null, []);
                            return
                        }

                        let rtn = fetchDataByMql(`select name from /matrix/ where name like '${prefix}*'`);

                        if(_.isEmpty(rtn)) return;

                        let word = rtn.message;

                        callback(null,_.map(word,function(ea) {
                            return {
                                name: ea.name,
                                value: ea.name,
                                score: 300,
                                meta: ea.class
                            }
                        }));

                    }
                };

                self.langTools.addCompleter(customerCompleter);


                // Add commands
                self.editor.commands.addCommand({
	                    name: "query",
                        bindKey: {mac: "cmd-enter", win: "ctrl-enter"},
	                    exec: self.query
	                },
                    {
                        name: "save",
                        bindKey: {mac: "cmd-S", win: "ctrl-S"},
                        exec: self.saveToFs
                    });

                // init Theme
                _.delay(function(){
                    self.initTheme();
                },3000)

                
            },
            setOptions: function(){
                let self = this;

                if(!_.isEmpty(self.model.options)){
                    self.editor.setOptions(self.model.options);
                } 
            },
            setTheme: function(){
                let self = this;

                let localTheme = localStorage.getItem(`editor-select-theme-${objectHash.sha1(self.id)}`);

                if(localTheme){
                    self.editor.setTheme("ace/theme/" + localTheme);
                    return false;
                }

                if(_.isEmpty(self.model.theme)){
                	self.editor.setTheme("ace/theme/tomorrow");
                } else {
                	self.editor.setTheme("ace/theme/"+self.model.theme);
                }
                
            },
            setMode: function(){
                let self = this;

                if(_.isEmpty(self.model.mode)){
                	self.editor.getSession().setMode("ace/mode/json");
                } else {
                	self.editor.getSession().setMode("ace/mode/"+ self.model.mode);
                }
                
            },
            setValue: function(){
                let self = this;

                self.editor.setValue(self.model.oldInput);
            },
            getSelected: function(){
                let self = this;
                var temp = self.editor.getSelectedText();

                if(_.isEmpty(temp)){
                    self.inputText = self.editor.getValue();
                } else {
                    self.inputText = temp;
                }
            },
            toggleToolsBar: function(){
                let self = this;

                if(self.showToolsBar){
                    $(".editorToolBar").show();
                } else {
                    $(".editorToolBar").hide();
                }
            },
	        toggleStatusBar: function(){
                let self = this;

                if(self.showStatusBar) {
                    let StatusBar = ace.require("ace/ext/statusbar").StatusBar;
                    let statusBar = new StatusBar(self.editor, document.getElementById(`${self.id}_statusBar`));
                }
	        },
	        copyIt: function(){
		        let self = this;

                new Clipboard(".copy", {
                    text: function(trigger) {
                        alertify.log("已复制");
                        return self.editor.getValue();
                    }
                });

	        },
            pasteIt: function(){
                let self = this;

                document.execCommand("paste");
                alertify.log("已粘贴");
            },
	        selectAll: function(){
                let self = this;

                self.editor.selection.selectAll();
            },
            clearIt: function(){
                let self = this;

                self.editor.setValue();
                alertify.log("已清空");
            },
            query: function(){
                let self = this;

                let _mql = self.editor.getValue();

                if(_.isEmpty(self.editor.getValue())){
                    return false;
                }

                if( self.editor.getSelectedText().length > 0 ) {
                    _mql = self.editor.getSelectedText();
                }

                let _list = omdbHandler.fetchDataByMql(_mql);

                if(_list.status === 'ok'){
                    eventHub.$emit("LOG-CONSOLE-APPEND-EVENT", 'info', _list)
                } else {

                    // 设置表格为空
                    self.result = { id:self.id, bid: self.bid, type: 'table-update', data: [], columns: [] };
                    eventHub.$emit(`QUERY-RESULT-TRIGGER-EVENT`,self.result);
                    eventHub.$emit(`QUERY-RESULT-TRIGGER-EVENT-${self.bid}`,self.result);

                    // 输出日志
                    eventHub.$emit("LOG-CONSOLE-APPEND-EVENT", 'error', _list)
	                return false;
                }


                if(_.isEmpty(_list)) {
                    alertify.log("查询结果为空");
                    return false;
                }


                // MQL for  CRUD
                if(_.includes(['create'],_list.meta.type)){
                    alertify.success("创建成功");
                    eventHub.$emit("OMDB-CLASS-REFRESH-EVENT", {type:'console', pattern: 'create-class', node: null});
                    return false;
                }

                if(_.includes(['drop'],_list.meta.type)){
                    alertify.success("删除成功");
                    eventHub.$emit("OMDB-CLASS-REFRESH-EVENT", {type:'console', pattern: 'drop-class', node: null});
                    return false;
                }

                if(_.includes(['create edge'],_list.meta.type)){
                    alertify.success("创建成功");
                    eventHub.$emit("OMDB-CLASS-REFRESH-EVENT", {type:'console', pattern: 'create-edge-type', node: null});
                    return false;
                }

                if(_.includes(['drop edge'],_list.meta.type)){
                    alertify.success("删除成功");
                    eventHub.$emit("OMDB-CLASS-REFRESH-EVENT", {type:'console', pattern: 'drop-edge-type', node: null});
                    return false;
                }

                if(_list.meta.type === 'alter'){
                    alertify.success("修改成功");
                    eventHub.$emit("OMDB-CLASS-REFRESH-EVENT", {type:'console', pattern: 'alter-class', node: null});
                    return false;
                }

                if(_list.meta.type === 'insert'){
                    alertify.success("插入成功");
                    eventHub.$emit("OMDB-CLASS-REFRESH-EVENT", {type:'console', pattern: 'insert-class', node: null});
                    return false;
                }


                let _data = _list.message;

                let _columns = mx.columnsParse(_list.meta);


                // Graph
                if(_list.meta.type === 'graph'){

                    //有数据
                    if(_list.message){   
                        self.result = {id:self.id, bid: self.bid, type: 'graph-update', data: _data[0].graph};

                        eventHub.$emit(`QUERY-RESULT-TRIGGER-EVENT`,self.result);
                        return false;
                    }
                    // 没数据 
                    else{
                        self.result = {id:self.id, bid: self.bid, type: 'graph-update', data: {nodes:[],edges:[]}};

                        eventHub.$emit(`QUERY-RESULT-TRIGGER-EVENT`,self.result);
                        return false;
                    }
                }

                // Graph-PATH
                if(_list.meta.type === 'path'){

                    self.result = {id:self.id, bid: self.bid, type: 'graph-update', data: _data[0].graph};

                    eventHub.$emit(`QUERY-RESULT-TRIGGER-EVENT`,self.result);

                    return false;
                }

                // Path
                // if(_list.meta.type === 'path'){

                //     let dataset = [];
                //     let cols = {
                //                     "path":_.concat([{field:"num",title:"序号"}],_.map(_data[0].graph.pathtags,function(v){ return {field:v,title:v}}))
                //                 };
                    
                //     _.forEach(_data[0].graph.paths,function(v,index){
                //         dataset.push( _.merge({num:`路径${++index}`,class:"path"},v));
                //     })
                //     self.result = {id:self.id, bid: self.bid, type: 'table-update', data: _.groupBy(dataset,'class'), columns: cols};
                    
                //     eventHub.$emit(`QUERY-RESULT-TRIGGER-EVENT`,self.result);
                //     eventHub.$emit(`QUERY-RESULT-TRIGGER-EVENT-${self.bid}`,self.result);

                //     return false;
                // }

                // For Select count Pattern
	            // 判断数据中没有返回class属性，如果没有将meta中的class属性赋值到数据中，构造Table所需要的结构
	            let temp = _list.message;

                if(!_.has(temp[0],'class')) {
                    _data = _.map(_data,function(v){ return _.merge(v,{class:_.keys(_list.meta.classes)[0]})});
                }

                self.result = { id:self.id, bid: self.bid, type: 'table-update', data: _.groupBy(_data,'class'), columns: _columns };
                
                eventHub.$emit(`QUERY-RESULT-TRIGGER-EVENT`,self.result);
                eventHub.$emit(`QUERY-RESULT-TRIGGER-EVENT-${self.bid}`,self.result);

            },
            queryPlus: function(){
                let self = this;

                let _mql = self.editor.getValue();

                if(_.isEmpty(self.editor.getValue())){
                    return false;
                }

                if( self.editor.getSelectedText().length > 0 ) {
                    _mql = self.editor.getSelectedText();
                }

                let _list = omdbHandler.fetchDataByMql(_mql);

                if(_list.status === 'ok'){
                    eventHub.$emit("LOG-CONSOLE-APPEND-EVENT", 'info', _list)
                } else {
                    eventHub.$emit("LOG-CONSOLE-APPEND-EVENT", 'error', _list)
                }


                if(_.isEmpty(_list)) {

                    alertify.log("查询结果为空");

                    return false;
                }

                // MQL for  CRUD
                if(_.includes(['create'],_list.meta.type)){
                    alertify.success("创建成功");
                    //eventHub.$emit("OMDB-CLASS-REFRESH-EVENT", {type:'console', pattern: 'create-class', node: null});
                    return false;
                }

                if(_.includes(['drop'],_list.meta.type)){
                    alertify.success("删除成功");
                    //eventHub.$emit("OMDB-CLASS-REFRESH-EVENT", {type:'console', pattern: 'drop-class', node: null});
                    return false;
                }

                if(_.includes(['create edge'],_list.meta.type)){
                    alertify.success("创建成功");
                    //eventHub.$emit("OMDB-CLASS-REFRESH-EVENT", {type:'console', pattern: 'create-edge-type', node: null});
                    return false;
                }

                if(_.includes(['drop edge'],_list.meta.type)){
                    alertify.success("删除成功");
                    //eventHub.$emit("OMDB-CLASS-REFRESH-EVENT", {type:'console', pattern: 'drop-edge-type', node: null});
                    return false;
                }

                if(_list.meta.type === 'alter'){
                    alertify.success("修改成功");
                    //eventHub.$emit("OMDB-CLASS-REFRESH-EVENT", {type:'console', pattern: 'alter-class', node: null});
                    return false;
                }

                if(_list.meta.type === 'insert'){
                    alertify.success("插入成功");
                    //eventHub.$emit("OMDB-CLASS-REFRESH-EVENT", {type:'console', pattern: 'insert-class', node: null});
                    return false;
                }


                let _data = _list.message;

                let _columns = mx.columnsParse(_list.meta);


                // Graph
                if(_list.meta.type === 'graph'){

                    self.result = {id:self.id, bid: self.bid, type: 'graph-new', data: _data[0].graph};

                    eventHub.$emit(`QUERY-RESULT-TRIGGER-EVENT`,self.result);

                    return false;
                }

                self.result = {id:self.id, bid: self.bid, type: 'table-new', data: _.groupBy(_data,'class'), columns: _columns};
                eventHub.$emit(`QUERY-RESULT-TRIGGER-EVENT`,self.result);
                eventHub.$emit(`QUERY-RESULT-TRIGGER-EVENT-${self.bid}`,self.result);

            },
            queryAndSave: function(){
                let self = this;

                let _mql = self.editor.getValue();

                if(_.isEmpty(self.editor.getValue())){
                    return false;
                }

                if( self.editor.getSelectedText().length > 0 ) {
                    _mql = self.editor.getSelectedText();
                }

                _mql = _mql.replace(/\n/g,' ').replace(/\t/g,' ').replace(/\\/g,' ');

                let _list = omdbHandler.fetchDataByMql(_mql);
                let _content = JSON.stringify({mql: _mql, result: {message: _list.message, meta: _list.meta}},null,4).replace(/   /g, ' ');
                let _ftype = "html";
                let _attr = {remark: "", ctime: _.now(), author: window.SignedUser_UserName, type: _ftype};
				let _name = '查询_' + moment().format("LLL");
				let _html = `<!DOCTYPE html>
							<html>
								<head>
								    <meta charset="UTF-8">
								    <title></title>
								</head>
								<body>
									<pre>${_content}</pre>
								</body>
							</html>`;

                let _url = fsHandler.fsTemp(_ftype, _name + "." + _ftype, _html, _attr);

                alertify.log(`已保存${_url}，<a class="btn btn-success" href="/fs${_url}?type=open&issys=${window.SignedUser_IsAdmin}" target="_blank">点击查看</a>`);
            },
            saveToFs: function(){
                let self = this;

                let mql = self.editor.getValue();

                if(_.isEmpty(mql)) return false;

                let user = window.SignedUser_UserName;
                let attr = {remark: '', ctime: _.now(), author: user, type: 'txt'};
                let rtn = fsHandler.fsNew('file', `/${user}/temp`, 'cache_mql_script.txt', mql, attr);
            },
            loadFromFs: function(){
                let self = this;

                let user = window.SignedUser_UserName;
                let mql = fsHandler.fsContent(`/${user}/temp`, 'cache_mql_script.txt');

                self.editor.setValue(mql);

            },
            initTheme: function(){
                let self = this;
				let id = objectHash.sha1(self.id);

                $.contextMenu({
                    selector: `.editor-select-theme-${id}`,
                    trigger: 'left',
                    callback: function (key, options) {
                        if(key !== 'bright' && key !== 'dark'){
                            self.editor.setTheme("ace/theme/"+key);

                            localStorage.setItem(`editor-select-theme-${id}`,key);
                        }
                    },
                    items: {
                        "bright": { name: "亮色", items: {
                                "chrome": { name: "chrome"},
                                "clouds": { name: "clouds"},
                                "crimson_editor": { name: "crimson_editor"},
                                "dawn": { name: "dawn"},
                                "dreamweaver": { name: "dreamweaver"},
                                "eclipse": { name: "eclipse"},
                                "github": { name: "github"},
                                "iplastic": { name: "iplastic"},
                                "solarized_light": { name: "solarized_light"},
                                "textmate": { name: "textmate"},
                                "tomorrow": { name: "tomorrow"},
                                "xcode": { name: "xcode"},
                                "kuroir": { name: "kuroir"},
                                "katzenmilch": { name: "katzenmilch"},
                                "sqlserver": { name: "sqlserver"}
                            }
                        },
                        "dark": { name: "暗色", items: {
                                "ambiance": { name: "ambiance"},
                                "chaos": { name: "chaos"},
                                "clouds_midnight": { name: "clouds_midnight"},
                                "dracula": { name: "dracula"},
                                "cobalt": { name: "cobalt"},
                                "gruvbox": { name: "gruvbox"},
                                "gob": { name: "gob"},
                                "idle_fingers": { name: "idle_fingers"},
                                "kr_theme": { name: "kr_theme"},
                                "merbivore": { name: "merbivore"},
                                "merbivore_soft": { name: "merbivore_soft"},
                                "mono_industrial": { name: "mono_industrial"},
                                "monokai": { name: "monokai"},
                                "pastel_on_dark": { name: "pastel_on_dark"},
                                "solarized_dark": { name: "solarized_dark"},
                                "terminal": { name: "terminal"},
                                "tomorrow_night": { name: "tomorrow_night"},
                                "tomorrow_night_blue": { name: "tomorrow_night_blue"},
                                "tomorrow_night_bright": { name: "tomorrow_night_bright"},
                                "tomorrow_night_eighties": { name: "tomorrow_night_eighties"},
                                "twilight": { name: "twilight"},
                                "vibrant_ink": { name: "vibrant_ink"}
                            }
                        }
                    }
                });
            }
        }
    
	
	}
	</script>

</code>
