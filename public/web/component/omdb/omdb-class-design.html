<code>

	<style>
		/*----------  style  ----------*/
        .omdb-class-design{
            height: calc(100vh - 85px);
            background: #fff;
        }

        .omdb-class-design .vertical-toolbar{
            position: absolute;
            width: 29px;
            height: auto;
            background: #ffffff;
            z-index: 1000;
            right: 25px;
            bottom: 100px;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 0px 6px;
        }
        .omdb-class-design .vertical-toolbar > button{
            margin: 0 5px;
        }

        .omdb-class-design .vertical-toolbar .el-divider.el-divider--horizontal{
            margin: 0px;
        }

        
        .omdb-class-design .el-collapse {
            border-top: unset;
            border-bottom: unset;
        }
        
        .omdb-class-design .el-collapse-item__header{
            font-size: 12px;
            font-weight: normal;
            height:30px;
            line-height: 30px;
            padding: 0 10px;
            white-space: nowrap;
            background: #f7f7f7;
        }
        .omdb-class-design .header-bg-white .el-collapse-item__header{
            font-size: 12px;
            font-weight: normal;
            height:30px;
            line-height: 30px;
            padding: 0 10px;
            white-space: nowrap;
            background: #fff;
        }

        .omdb-class-design .el-collapse-item__content{
            background: #fff;
            height: 100%;
            overflow: auto;
        }
        .omdb-class-design .el-collapse-item__content:not("#directoryContainer .el-collapse-item__content"){
            display: flex;
            flex-wrap:wrap;
            align-items: flex-start;
        }

        .omdb-class-design .el-collapse-item__content > img{
            margin:5px;
        }
        .omdb-class-design .el-collapse-item__wrap.transition{
            background: #f7f7f7;
            box-shadow: unset!important;
            text-align: center;
            height: 60vh;
        }
        .omdb-class-design .el-collapse-item .el-collapse-item__wrap{
            border-bottom: unset!important;
        }

        /* mxPopuMenu */
        div.mxPopupMenu{
            -webkit-box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1)!important;
            -moz-box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1)!important;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1)!important;
            border: unset!important;
            background-image: unset!important;
            background: #ffffff!important;
        }
        /* mxToolTip */
        div.mxTooltip {
            background: #fff;
            border: unset!important;
            font-family: inherit;
            font-size: 12px;
            padding: 10px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
	</style>

	
	/*----------  最外层element会自动增加组件同名 class="omdb-class-design"  ----------*/
	<template>
        <el-container>
            <el-header style="height:30px;line-height:30px;background: #f7f7f7;border-bottom:1px solid #ddd;">
                <el-dropdown trigger="click">
                    <span class="el-dropdown-link">
                        <el-button type="text">
                            打开 <i class="el-icon--right"></i>
                        </el-button>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item @click.native="onNew">新建</el-dropdown-item>
                        <el-dropdown-item @click.native="dialogOpen.visible=true" divided>打开</el-dropdown-item>
                        <el-dropdown-item @click.native="onSave" divided>保存</el-dropdown-item>
                        <el-dropdown-item @click.native="dialogSaveAs.visible=true">另存为</el-dropdown-item>
                        <el-dropdown-item @click.native="onDelete" divided>删除</el-dropdown-item>
                        <el-dropdown-item @click.native="editor.execute('print')" divided>打印</el-dropdown-item>
                        <el-dropdown-item @click.native="onClose" divided>关闭</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown>
                <el-dropdown trigger="click">
                    <span class="el-dropdown-link">
                        <el-button type="text">
                            编辑 <i class="el-icon--right"></i>
                        </el-button>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item @click.native="editor.execute('undo')">撤销</el-dropdown-item>
                        <el-dropdown-item  @click.native="editor.execute('redo')">重做</el-dropdown-item>
                        <el-dropdown-item  @click.native="onDelete" divided v-if="!_.isEmpty(doc)">删除</el-dropdown-item>
                        <el-dropdown-item divided>关闭</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown>
                <el-dropdown trigger="click">
                    <span class="el-dropdown-link">
                        <el-button type="text">
                            视图 <i class="el-icon--right"></i>
                        </el-button>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item @click.native="editor.execute('show')">预览</el-dropdown-item>
                        <el-dropdown-item  @click.native="editor.execute('toggleOutline')" divided>缩略图</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown>
                <el-dropdown trigger="click">
                    <span class="el-dropdown-link">
                        <el-button type="text">
                            工具 <i class="el-icon--right"></i>
                        </el-button>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item  @click.native="editor.execute('showMql')">MQL</el-dropdown-item>
                        <el-dropdown-item  @click.native="editor.execute('export')" divided>源文件</el-dropdown-item>
                        <el-dropdown-item  @click.native="editor.execute('exportImage')">导出图片</el-dropdown-item>
                        
                    </el-dropdown-menu>
                </el-dropdown>
                
            </el-header>
            <el-container style="border-top:1px solid #fff;height:calc(100vh - 145px);min-height: calc(100vh - 145px);">
                <el-aside width="100px" style="height:100%;background:#f7f7f7;border-right: 1px solid #ddd;overflow:hidden;">
                    <!-- Creates a container for the toolboox -->
                    <el-collapse accordion vlaue="1" id="sidebarContainer" ref="sidebarContainer">
                        <el-collapse-item title="类" name="1" id="tableContainer">
                        </el-collapse-item>
                        <el-collapse-item title="属性" name="2" id="columnContainer">
                        </el-collapse-item>
                        <el-collapse-item title="属性字典" name="3" id="directoryContainer">
                            <el-collapse accordion>
                                <el-collapse-item :title="'  ' + key" v-for="(item,key) in allColumns" :key="key" :id="'directory-'+key" class="header-bg-white">
                                    <!--el-button type="text" :index="sub.name" v-for="sub in _.uniqBy(item,'name')" :key="sub.name" style="margin:5px;padding:5px 10px 0px 10px;box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.1);background: #b8c3cc;border-color:#b8c3cc;color:#fff;">
                                        <span style="font-size: 12px;font-weight: 600;">#{sub.name}#</span>
                                        <p style="transform: scale(0.9);">#{sub.ftype}#</p>
                                    </el-button-->
                                </el-collapse-item>
                            </el-collapse>
                        </el-collapse-item>
                    </el-collapse>
                </el-aside>
                <el-main style="padding:0px;overflow: hidden;">
                    
                    <!-- Creates a container for the graph -->
                    <div id="graphContainer"
                        style="width:100vw;height:100vh;min-width:100vw;position:releative;overflow:hidden;padding:0px;" ref="graphContainer">
                    </div>
    
                    <div class="vertical-toolbar animated fadeIn">
                        <el-tooltip content="刷新" open-delay="500" placement="left">
                            <el-button type="text" @click="editor.execute('refresh')">
                                 <i class="el-icon-refresh" style="font-size:18px;">
                            </el-button>
                        </el-tooltip>
                        <el-tooltip content="放大" open-delay="500" placement="left">
                           <el-button type="text" @click="editor.execute('zoomIn')">
                                <i class="el-icon-zoom-in" style="font-size:18px;">
                           </el-button>
                       </el-tooltip>
                       <el-divider></el-divider>
                       <el-tooltip content="缩小" open-delay="500" placement="left">
                           <el-button type="text" @click="editor.execute('zoomOut')">
                                <i class="el-icon-zoom-out" style="font-size:18px;">
                           </el-button>
                       </el-tooltip>
                       <el-divider></el-divider>
                       <el-tooltip content="实际大小" open-delay="500" placement="left">
                           <el-button type="text" @click="editor.execute('actualSize')">
                                <i class="el-icon-s-help" style="font-size:18px;">
                           </el-button>
                       </el-tooltip>
                       <el-divider></el-divider>
                       <el-tooltip content="适合页面" open-delay="500" placement="left">
                           <el-button type="text" @click="editor.execute('fit')">
                                <i class="el-icon-help" style="font-size:18px;">
                           </el-button>
                       </el-tooltip>
                       <el-divider></el-divider>
                       <el-tooltip content="收起所有" open-delay="500" placement="left">
                           <el-button type="text" @click="editor.execute('collapseAll')">
                                <i class="el-icon-menu" style="font-size:18px;">
                           </el-button>
                       </el-tooltip>
                       <el-divider></el-divider>
                       <el-tooltip content="展开所有" open-delay="500" placement="left">
                           <el-button type="text" @click="editor.execute('expandAll')">
                                <i class="el-icon-s-grid" style="font-size:18px;">
                           </el-button>
                       </el-tooltip>
                   </div>
                   <!-- 打开窗口 -->
                   <el-dialog :title="dialogOpen.title" :visible.sync="dialogOpen.visible">
                        <mx-fs-open dfsRoot="/home/admin/Documents/class" ref="dfsOpen" v-if="dialogOpen.visible"></mx-fs-open>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="dialogOpen.visible = false">取 消</el-button>
                            <el-button type="primary" @click="onOpen(false)">打 开</el-button>
                        </div>
                    </el-dialog>
                    <!-- 保存窗口 -->
                    <el-dialog :title="dialogSaveAs.title" :visible.sync="dialogSaveAs.visible">
                        <mx-fs-saveas dfsRoot="/home/admin/Documents" ref="dfsSaveas"></mx-fs-saveas>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="dialogSaveAs.visible = false">取 消</el-button>
                            <el-button type="primary" @click="onSaveAs">保存</el-button>
                        </div>
                    </el-dialog>
                    <!-- MQL -->
                    <el-dialog :title="dialogInfo.title" :visible.sync="dialogInfo.visible">
                        <el-container>
                            <el-main style="padding:0px;height:300px;border:1px solid #ddd;" ref="dialogInfoEditor"></el-main>
                        </el-container>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="dialogInfo.visible = false">取 消</el-button>
                            <el-button type="primary" @click="onExecute">执行MQL</el-button>
                        </div>
                    </el-dialog>
                    <!-- 源码窗口 -->
                    <el-dialog :title="dialogSource.title" :visible.sync="dialogSource.visible">
                        <el-container>
                            <el-main style="padding:0px;height:300px;border:1px solid #ddd;" ref="dialogSourceEditor"></el-main>
                        </el-container>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="dialogSource.visible = false">取 消</el-button>
                            <el-button type="primary" @click="applyMqlToFile">更新到当前文件</el-button>
                        </div>
                    </el-dialog>
                    <!-- 类窗口 -->
                    <el-dialog :title="dialogClassProperties.cell.value.name" 
                        :visible.sync="dialogClassProperties.visible"
                        v-if="dialogClassProperties.cell">
                        <el-form label-position="right" label-width="100px">
                            <el-form-item label="名称">
                                <el-input v-model="dialogClassProperties.cell.value.name" autocomplete="off"></el-input>
                            </el-form-item>
                            <el-form-item label="TTL">
                                <el-input type="number"  v-model="dialogClassProperties.cell.value.ttl" autocomplete="off"></el-input>
                            </el-form-item>
                            <el-form-item label="别名">
                                <el-input  v-model="dialogClassProperties.cell.value.alias" autocomplete="off"></el-input>
                            </el-form-item>
                            <el-form-item label="简称">
                                <el-input  v-model="dialogClassProperties.cell.value.nickname" autocomplete="off"></el-input>
                            </el-form-item>
                            <el-form-item label="分区键(Partition)">
                                <el-input  v-model="dialogClassProperties.cell.value.partition" autocomplete="off"></el-input>
                            </el-form-item>
                            <el-form-item label="Ckeys">
                                <el-input  v-model="dialogClassProperties.cell.value.ckeys" autocomplete="off"></el-input>
                            </el-form-item>
                            <el-form-item label="是否搜索">
                                <el-checkbox v-model="dialogClassProperties.cell.value.autosearch"></el-checkbox>
                            </el-form-item>
                        </el-form>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="dialogClassProperties.visible = false">取 消</el-button>
                            <el-button type="primary" @click="onUpdateClassProperties(dialogClassProperties.cell)">确 定</el-button>
                        </div>
                    </el-dialog>
                    <!-- 属性窗口 -->
                    <el-dialog :title="dialogProperties.title+'【'+ dialogProperties.cell.value.name +'】'" 
                        :visible.sync="dialogProperties.visible"
                        v-if="dialogProperties.cell">
                        <el-form label-position="right" label-width="100px">
                            <el-form-item label="属性">
                                <el-input  v-model="dialogProperties.cell.value.name" autocomplete="off"></el-input>
                            </el-form-item>
                            <el-form-item label="名称">
                                <el-input  v-model="dialogProperties.cell.value.title" autocomplete="off"></el-input>
                            </el-form-item>
                            <el-form-item label="类型">
                                <el-select v-model="dialogProperties.cell.value.ftype">
                                    <el-option :key="item.value" 
                                        :label="item.label"
                                        :value="item.value"
                                        v-for="item in dialogProperties.model.ftypeList">
                                    </el-option>
                                </el-select>
                                <div v-if="dialogProperties.cell.value.ftype == 'set' || dialogProperties.cell.value.ftype == 'list'">
                                    <el-select v-model="dialogProperties.cell.value.ftypeOption.value1">
                                        <el-option :key="item.value" 
                                            :label="item.label"
                                            :value="item.value"
                                            v-for="item in dialogProperties.model.ftypeList">
                                        </el-option>
                                    </el-select>
                                </div>
                                <div v-if="dialogProperties.cell.value.ftype == 'map'">
                                    <el-select v-model="dialogProperties.cell.value.ftypeOption.value1">
                                        <el-option :key="item.value" 
                                            :label="item.label"
                                            :value="item.value"
                                            v-for="item in dialogProperties.model.ftypeList">
                                        </el-option>
                                    </el-select>
                                    <el-select v-model="dialogProperties.cell.value.ftypeOption.value2">
                                        <el-option :key="item.value" 
                                            :label="item.label"
                                            :value="item.value"
                                            v-for="item in dialogProperties.model.ftypeList">
                                        </el-option>
                                    </el-select>
                                </div>
                            </el-form-item>
                            <el-form-item label="是否为主键">
                                <el-checkbox v-model="dialogProperties.cell.value.iskey"></el-checkbox>
                            </el-form-item>
                            <el-form-item label="是否为索引">
                                <el-checkbox v-model="dialogProperties.cell.value.isindex"></el-checkbox>
                            </el-form-item>
                        </el-form>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="dialogProperties.visible = false">取 消</el-button>
                            <el-button type="primary" @click="onUpdateProperties(dialogProperties.cell)">确 定</el-button>
                        </div>
                    </el-dialog>
                </el-main>
            </el-container>
            <el-footer style="height:30px;line-height: 30px;background: #f7f7f7;">
                <span v-if="!_.isEmpty(doc)">
                    <i class="el-icon-notebook-2"></i> #{doc.fullname}#
                </span>
                <span v-else>未保存</span>
                <el-divider direction="vertical"></el-divider>
                <el-dropdown>
                    <span class="el-dropdown-link" style="cursor: pointer;">
                        <i class="el-icon-office-building"></i> #{docInfo.classes.list.length}#
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item v-for="item in docInfo.classes.list" :key="item" :command="item">
                            #{item}#
                        <el-dropdown-item
                    </el-dropdown-menu>
                </el-dropdown>
                <el-divider direction="vertical"></el-divider>
                <el-dropdown>
                    <span class="el-dropdown-link" style="cursor: pointer;">
                        <i class="el-icon-notebook-2"></i> #{docInfo.columns.list.length}#
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item v-for="(item,key) in allColumns" :key="key" :command="key">
                            <el-dropdown>
                                <span class="el-dropdown-link" style="cursor: pointer;">
                                    <i class="el-icon-notebook-2"></i> <span>#{key}#</span><i class="el-icon-arrow-right"></i> 
                                </span>
                                <el-dropdown-menu slot="dropdown">
                                    <el-dropdown-item v-for="sub in _.uniqBy(item,'name')" :key="sub.name" :command="sub.name">
                                        <span>#{sub.name}#</span>
                                        <span>#{sub.ftype}#</span>
                                    <el-dropdown-item
                                </el-dropdown-menu>
                            </el-dropdown>
                        <el-dropdown-item
                    </el-dropdown-menu>
                </el-dropdown>
            </el-footer>
        </el-container>
	</template>

	/*----------  id是vue组件的name，内容是vue组件的option参数  ----------*/
	<script id="omdb-class-design">
	{
        delimiters: ['#{', '}#'],
		props: {
        	
		},
		data(){
          	return {
                editor: null,
                defaultExpand: false,
                doc:null,
                layout: {
                    default: "tree_horizontal",
                    inst: null,
                    edgeStyle: 4
                },
                docInfo: {
                    classes:{
                        count:0,
                        list: []
                    },
                    columns:{
                        count: 0,
                        list: []
                    }
                },
                dialogOpen:{
                    title: "打开",
                    content: "",
                    visible: false
                },
                dialogSaveAs:{
                    title: "另存为",
                    content: "",
                    visible: false
                },
                dialogInfo:{
                    title: "",
                    content: "",
                    visible: false
                },
                dialogSource: {
                    title: "",
                    content: "",
                    visible: false
                },
                dialogClassProperties: {
                    cell: null,
                    model:{
                        name: "",
                        ttl:"",
                        alias:"",
                        nickname:"",
                        autosearch: true,
                        partition: "",
                        ckeys: ""
                    },
                    visible: false
                },
                dialogProperties: {
                    title: "",
                    cell: null,
                    model:{
                        name:"",
                        title:"",
                        ftype: "varchar",
                        ftypeOption: {
                            value1: "",
                            value2: ""
                        },
                        iskey:false,
                        isindex:false,
                        ftypeList: [],
                    },
                    visible: false
                }
			}
        },
        computed:{
            allColumns(){
                return  _.groupBy(_.sortBy(this.docInfo.columns.list,['name'],['asc']),(v)=>{ 
                            
                            let name = v.name.slice(0,1);
                            
                            if(!_.isEmpty(name) && name == "_"){
                                return "其它"; 
                            }
                            
                            if(!_.isEmpty(name)){
                                return _.upperCase(name); 
                            }

                            return "其它"; 
                        });
            }
        },
        watch:{
            allColumns:function(val,oldVal){
                let node = _.map(val,(v)=>{
                    return _.uniqBy(v,'name');
                })
                this.addDirectoryToSidebar(val);
            },
            defaultExpand:function(val,oldVal){
                if(val){
                    this.editor.execute('expandAll');
                } else {
                    this.editor.execute('collapseAll')
                }
            }
        },
        created(){
            try{
                let ftypeList = fsHandler.callFsJScript("/matrix/omdb/getFileldTypeList.js",null).message;
                _.extend( this.dialogProperties.model,{ftypeList:ftypeList} );
            } catch(err) {
                
            }
            
        },
		mounted(){
            this.main(this.$refs.graphContainer,
                    this.$refs.sidebarContainer.$el);

            this.$nextTick(()=>{

                _.delay(()=>{
                    // 初始化滚轮图缩放事件监听
                    this.addScrollListener(this.$refs.graphContainer, this.wheelHandle);
                },1500)
            })
        },
		methods: {
            // Program starts here. Creates a sample graph in the
            // DOM node with the specified ID. This function is invoked
            // from the onLoad event handler of the document (see below).
            main(container, sidebar) {
                const self = this;

                // Checks if the browser is supported
                if (!mxClient.isBrowserSupported()) {
                    // Displays an error message if the browser is not supported.
                    mxUtils.error('Browser is not supported!', 200, false);
                } else {
                    // Specifies shadow opacity, color and offset
                    mxConstants.SHADOW_OPACITY = 0.5;
                    mxConstants.SHADOWCOLOR = '#C0C0C0';
                    mxConstants.SHADOW_OFFSET_X = 5;
                    mxConstants.SHADOW_OFFSET_Y = 6;
                    
                    // Table icon dimensions and position
                    mxSwimlane.prototype.imageSize = 20;
                    mxSwimlane.prototype.imageDx = 16;
                    mxSwimlane.prototype.imageDy = 4;
                    
                    // Changes swimlane icon bounds
                    mxSwimlane.prototype.getImageBounds = function(x, y, w, h) {
                        return new mxRectangle(x + this.imageDx, y + this.imageDy, this.imageSize, this.imageSize);
                    };
                    
                    // Defines an icon for creating new connections in the connection handler.
                    // This will automatically disable the highlighting of the source vertex.
                    mxConnectionHandler.prototype.connectImage = new mxImage('/fs/assets/images/graph/tools/connector.gif?type=open&issys=true', 16, 16);

                    // Prefetches all images that appear in colums
                    // to avoid problems with the auto-layout
                    var keyImage = new Image();
                    keyImage.src = "/fs/assets/images/graph/tools/key.png?type=open&issys=true";

                    var plusImage = new Image();
                    plusImage.src = "/fs/assets/images/graph/tools/plus.png?type=open&issys=true";

                    var checkImage = new Image();
                    checkImage.src = "/fs/assets/images/graph/tools/check.png?type=open&issys=true";
                    
                    // Workaround for Internet Explorer ignoring certain CSS directives
                    if (mxClient.IS_QUIRKS) {
                        document.body.style.overflow = 'hidden';
                        new mxDivResizer(container);
                        new mxDivResizer(outline);
                        new mxDivResizer(sidebar);
                    }
                    
                    // Creates the graph inside the given container. The
                    // editor is used to create certain functionality for the
                    // graph, such as the rubberband selection, but most parts
                    // of the UI are custom in this example.
                    let editor = null;
                    this.editor = editor = new mxEditor();
                    let graph = editor.graph;
                    let model = graph.model;
                    
                    // Disables some global features
                    graph.setConnectable(true);
                    graph.setCellsDisconnectable(false);
                    graph.setCellsCloneable(false);
                    graph.swimlaneNesting = false;
                    graph.dropEnabled = true;
                    // 容器大小自适应 
                    graph.setResizeContainer(false);

                    // Does not allow dangling edges
                    graph.setAllowDanglingEdges(false);

                    // Clones the source if new connection has no target
                    graph.connectionHandler.setCreateTarget(true);
                    
                    // Forces use of default edge in mxConnectionHandler
                    graph.connectionHandler.factoryMethod = null;

                    // Only tables are resizable
                    graph.isCellResizable = function(cell) {
                        return this.isSwimlane(cell);
                    };
                    
                    // Only tables are movable
                    graph.isCellMovable = function(cell) {
                        return this.isSwimlane(cell);
                    };

                    // Sets the graph container and configures the editor
                    editor.setGraphContainer(container);
                    // var config = mxUtils.load(
                    //     'editors/config/keyhandler-minimal.xml').
                    //         getDocumentElement();
                    // editor.configure(config);

                    // Configures the automatic layout for the table columns
                    editor.layoutSwimlanes = true;
                    editor.createSwimlaneLayout = function () {
                        var layout = new mxStackLayout(editor.graph, false);
                        layout.fill = true;
                        layout.resizeParent = true;
                        
                        // Overrides the function to always return true
                        layout.isVertexMovable = function(cell) {
                            return true;
                        };
                        
                        return layout;
                    };

                    // Text label changes will go into the name field of the user object
                    graph.model.valueForCellChanged = function(cell, value) {
                        if (value.name != null) {
                            return mxGraphModel.prototype.valueForCellChanged.apply(this, arguments);
                        } else {
                            var old = cell.value.name;
                            cell.value.name = value;
                            return old;
                        }
                    };
                    
                    // Columns are dynamically created HTML labels
                    graph.isHtmlLabel = function(cell) {
                        return !this.isSwimlane(cell) &&
                            !this.model.isEdge(cell);
                    };
                    
                    // Edges are not editable
                    graph.isCellEditable = function(cell) {
                        return !this.model.isEdge(cell);
                    };
                    
                    // Returns the name field of the user object for the label
                    graph.convertValueToString = function(cell) {
                        if (cell.value != null && cell.value.name != null)
                        {
                            return cell.value.name;
                        }

                        return mxGraph.prototype.convertValueToString.apply(this, arguments); // "supercall"
                    };
                    
                    // Returns the type as the tooltip for column cells
                    graph.getTooltip = function(state) {
                        
                        // if (this.isHtmlLabel(state.cell)) {
                        //     return 'Type: '+state.cell.value.type;
                        // } else if (this.model.isEdge(state.cell)) {
                        //     var source = this.model.getTerminal(state.cell, true);
                        //     var parent = this.model.getParent(source);
                            
                        //     return parent.value.name+'.'+source.value.name;
                        // }
                        
                        // return mxGraph.prototype.getTooltip.apply(this, arguments); // "supercall"
                    };
                    
                    // Creates a dynamic HTML label for column fields
                    graph.getLabel = function(cell) {
                        if (this.isHtmlLabel(cell)) {
                            var label = '';
                            
                            if (cell.value.iskey){
                                label += '<img title="Primary Key" src="/fs/assets/images/graph/tools/key.png?type=open&issys=true" width="16" height="16" align="top">&nbsp;';
                            } else {
                                label += '<img src="/fs/assets/images/graph/tools/spacer.gif?type=open&issys=true" width="16" height="1">&nbsp;';
                            }
                                                    
                            if (cell.value.isindex) {
                                label += '<img src="/fs/assets/images/graph/tools/index.png?type=open&issys=true" width="16" height="16" align="top">&nbsp;';
                            } else {
                                label += '<img src="/fs/assets/images/graph/tools/spacer.gif?type=open&issys=true" width="16" height="1">&nbsp;';
                            }

                            return label + mxUtils.htmlEntities(cell.value.name, false) + ': ' +
                                mxUtils.htmlEntities(cell.value.ftype, false);
                        }
                        
                        return mxGraph.prototype.getLabel.apply(this, arguments); // "supercall"
                    };
                    
                    // Removes the source vertex if edges are removed
                    graph.addListener(mxEvent.REMOVE_CELLS, (sender, evt)=> {
                        this.summaryInfo();
                    });

                    // Add the source vertex
                    graph.addListener(mxEvent.ADD_CELLS, (sender, evt)=> {
                        let target = evt.getProperty("target");
                        
                        if (target != null && graph.isSwimlane(target)) {
                            
                            let name = mxUtils.prompt('请输入类名称', '/matrix');

                            if(!_.isEmpty(name)){
                                target.value.name = name;
                            }
                            
                            graph.setSelectionCell(target);
                        }
                        evt.consume();

                        this.summaryInfo();
                    });

                    // MOUSE_DOWN for graph
                    graph.addListener(mxEvent.CELLS_FOLDED,(sender,evt)=>{
                        this.toCenter();
                    })

                    // Disables drag-and-drop into non-swimlanes.
                    graph.isValidDropTarget = function(cell, cells, evt) {
                        return this.isSwimlane(cell);
                    };

                    // Installs a popupmenu handler using local function (see below).
                    graph.popupMenuHandler.factoryMethod = function(menu, cell, evt){
                        self.createPopupMenu(editor, graph, menu, cell, evt);
                    };

                    // Adds all required styles to the graph (see below)
                    this.configureStylesheet(graph);
                    
                    // Init sidebar and Adds sidebar icon for the table object
                    this.initSideBar(graph,sidebar);

                    // Adds child columns for new connections between tables
                    /* graph.addEdge = function(edge, parent, source, target, index) {
                        Finds the primary key child of the target table
                        var iskey = null;
                        var childCount = this.model.getChildCount(target);
                        
                        for (var i=0; i < childCount; i++) {
                            var child = this.model.getChildAt(target, i);
                            
                            if (child.value.iskey)
                            {
                                iskey = child;
                                break;
                            }
                        }
                        
                        if (iskey == null) {
                            self.$message({
                                type: "info",
                                message: "类需要定义主键！"
                            })
                            return;
                        }
                    
                        this.model.beginUpdate();
                        try {
                            var col1 = this.model.cloneCell(column);
                            col1.value.name = iskey.value.name;
                            col1.value.ftype = iskey.value.ftype;
                            col1.value.title = iskey.value.title;
                        
                            this.addCell(col1, source);
                            source = col1;				
                            target = iskey;
                            
                            return mxGraph.prototype.addEdge.apply(this, arguments); // "supercall"
                        } finally {
                            this.model.endUpdate();
                        }
                        
                        return null;
                    }; */
                    
                    // Defines action
                    editor.addAction('mxProperties', (editor, cell)=>{
                        
                        if (cell == null) {
                            cell = graph.getSelectionCell();
                        }
                        
                        if (graph.isHtmlLabel(cell) || cell.value.constructor.name == 'Table' || cell.value.constructor.name == 'Column') {
                            this.showProperties(graph, cell);
                        }
                    });
                    // Defines a create MQL action
                    editor.addAction('showMql', (editor, cell)=>{
                        var mql = this.createMql(graph,cell);
                        
                        if (mql.length > 0){
                            this.showDialogInfo('MQL', mql);
                        } else {
                            this.$message({
                                type: "info",
                                message: "MQL为空!"
                            })
                        }
                    });

                    // Defines export XML action
                    editor.addAction('export', (editor, cell)=>{
                        let enc = new mxCodec(mxUtils.createXmlDocument());
                        let node = enc.encode(editor.graph.getModel());
                        
                        this.showDialogSource('源文件', mxUtils.getPrettyXml(node));
                    });
                    
                    // Defines Delete action
                    editor.addAction('deleteAll',(editor,cell)=>{
                        this.deleteCells(true);
                    })

                    // Defines Auto Save XML action
                    // var mgr = new mxAutoSaveManager(editor.graph);
                    // mgr.autoSaveDelay = 5;
                    // mgr.save = function(){
                    //     self.onSave()
                    // };

                    // Animates the changes in the graph model
                    // graph.getModel().addListener(mxEvent.CHANGE, (sender, evt)=>{
                    //     var changes = evt.getProperty('edit').changes;
                    //     mxEffects.animateChanges(graph, changes);
                    // });

                    // 自动打开最后一次打开文件
                    this.doc = JSON.parse(localStorage.getItem("CLASS-DESIGN-OPEN-FILE"))
                    this.onOpen(true);

                    // 是否展开节点
                    if(this.defaultExpand){
                        this.editor.execute('expandAll');
                    } else {
                        this.editor.execute('collapseAll')
                    }
                }
            }, 
            addScrollListener(element, wheelHandle) {
                if (typeof element != 'object') return;
                if (typeof wheelHandle != 'function') return;

                // 监测浏览器
                if (typeof arguments.callee.browser == 'undefined') {
                    var user = navigator.userAgent;
                    var b = {};
                    b.opera = user.indexOf("Opera") > -1 && typeof window.opera == "object";
                    b.khtml = (user.indexOf("KHTML") > -1 || user.indexOf("AppleWebKit") > -1 || user.indexOf("Konqueror") > -1) && !b.opera;
                    b.ie = user.indexOf("MSIE") > -1 && !b.opera;
                    b.gecko = user.indexOf("Gecko") > -1 && !b.khtml;
                    arguments.callee.browser = b;
                }
                if (element == window)
                    element = document;
                if (arguments.callee.browser.ie)
                    element.attachEvent('onmousewheel', wheelHandle);
                else
                    element.addEventListener(arguments.callee.browser.gecko ? 'DOMMouseScroll' : 'mousewheel', wheelHandle, false);
            },
            wheelHandle(e) {
                var upcheck;

                if (e.wheelDelta) {
                    upcheck = e.wheelDelta > 0 ? 1 : 0;
                } else {
                    upcheck = e.detail < 0 ? 1 : 0;
                }
                if (upcheck) {
                    this.editor.graph.zoomIn();
                }
                else {
                    this.editor.graph.zoomOut();
                }

                if (window.event) {
                    e.returnValue = false;
                    window.event.cancelBubble = true;
                } else {
                    e.preventDefault();
                    e.stopPropagation();
                }
            },
            toCenter(){
                this.editor.graph.center(false,true,0.5,0.5);//将画布放到容器中间
            },
            executeLayout(){
                let graph = this.editor.graph;
                let parent = this.editor.graph.getDefaultParent();
                let layout = this.layout;
                console.log(1,graph)
                // 布局定义
                if(layout.default === 'hierarchical'){
                    // Layout hierarchical
                    graph.getModel().beginUpdate();
                    try {
                        layout.inst = new mxHierarchicalLayout(graph);
                        layout.inst.edgeStyle = layout.edgeStyle;
                        layout.inst.intraCellSpacing = 80;
                        layout.inst.interRankCellSpacing = 80;
                        layout.inst.execute(parent);
                    } catch (e) {
                        throw e;
                    } finally {
                        var morph = new mxMorphing(graph);  
                        morph.addListener(mxEvent.DONE, function(){  
                            graph.getModel().endUpdate();  
                        });  
                            
                        morph.startAnimation();  
                    }
                    
                } else if(layout.default === 'organic'){
                    // Layout Organic
                    graph.getModel().beginUpdate();
                    try {
                        layout.inst = new mxFastOrganicLayout(graph);
                        layout.inst.forceConstant = 140;
                        layout.inst.execute(parent);
                    } catch (e) {
                        throw e;
                    } finally {
                        graph.getModel().endUpdate();
                    }
                    
                } else if(layout.default === 'tree_vertical'){
                    /* Layout tree vertical */
                    graph.getModel().beginUpdate();
                    try {
                        layout.inst = new mxCompactTreeLayout(graph, false, false);
                        layout.inst.useBoundingBox = true;
                        layout.inst.edgeRouting = false;
                        layout.inst.levelDistance = 40;
                        layout.inst.nodeDistance = 60;
                        layout.edgeStyle = 4;
                        layout.inst.execute(parent);
                        layout.inst.isVertexMovable = function(cell){
                            return true;
                        };
                        var layoutMgr = new mxLayoutManager(graph);

                        layoutMgr.getLayout = function(cell){
                            if (cell.getChildCount() > 0){
                                return layout.inst;
                            }
                        };
                    } catch (e) {
                        throw e;
                    } finally {
                        graph.getModel().endUpdate();
                    }
                } else if(layout.default === 'tree_horizontal'){
                    /* Layout tree horizontal */
                    graph.getModel().beginUpdate();
                    try {
                        layout.inst = new mxCompactTreeLayout(graph, true, false);
                        layout.inst.useBoundingBox = true;
                        layout.inst.edgeRouting = false;
                        layout.inst.levelDistance = 40;
                        layout.inst.nodeDistance = 60;
                        layout.edgeStyle = 4;
                        layout.inst.execute(parent);
                        layout.inst.isVertexMovable = function(cell){
                            return true;
                        };
                        var layoutMgr = new mxLayoutManager(graph);

                        layoutMgr.getLayout = function(cell){
                            if (cell.getChildCount() > 0){
                                return layout.inst;
                            }
                        };
                        
                    } catch (e) {
                        throw e;
                    } finally {
                        graph.getModel().endUpdate();
                    }
                } else {
                    /* Layout Circle */
                    graph.getModel().beginUpdate();
                    try {
                        layout.inst = new mxCircleLayout(graph);
                        layout.inst.execute(parent);
                    } catch (e) {
                        throw e;
                    } finally {
                        graph.getModel().endUpdate();
                    }
                }
            },
            addSidebarIcon(graph, sidebar, prototype, image){
                // Function that is executed when the image is dropped on
                // the graph. The cell argument points to the cell under
                // the mousepointer if there is one.
                const self = this;
                var funct = function(graph, evt, cell) {
                    graph.stopEditing(false);

                    var pt = graph.getPointForEvent(evt);
                    
                    var parent = graph.getDefaultParent();
                    var model = graph.getModel();
                    
                    var isTable = graph.isSwimlane(prototype);
                    var name = null;				
                    
                    if (!isTable) {
                        parent = cell;
                        var pstate = graph.getView().getState(parent);
                        
                        if (parent == null || pstate == null){
                            self.$message({
                                type: "info",
                                message: "请先确定类！"
                            })

                            return;
                        }
                        
                        pt.x -= pstate.x;
                        pt.y -= pstate.y;
                        
                        // 判断是否已经有该属性
                        if(cell.children){
                            _.forEach(cell.children,(v)=>{
                                if(v.value.name == prototype.value.name){
                                    self.$message({
                                        type: "info",
                                        message: "已有同名属性"
                                    })
                                    self.editor.execute('undo', cell);
                                }
                            })
                        }

                        var columnCount = graph.model.getChildCount(parent)+1;
                        name = prototype.value.name=='COLUMNNAME'?'属性'+columnCount:prototype.value.name;
                        
                    } else {
                        var tableCount = 0;
                        var childCount = graph.model.getChildCount(parent);
                        
                        for (var i=0; i<childCount; i++) {
                            if (!graph.model.isEdge(graph.model.getChildAt(parent, i))) {
                                tableCount++;
                            }
                        }
                        
                        /* self.$prompt('请输入类名称', '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            }).then(({ value }) => {
                                
                                name =  value;

                                if(_.isEmpty(name)){
                                    name = '/新类'+(tableCount+1);
                                }
                                
                                if (name != null) {
                    
                                    var v1 = model.cloneCell(prototype);
                                    
                                    model.beginUpdate();
                                    try {
                                        v1.value.name = name;
                                        v1.geometry.x = pt.x;
                                        v1.geometry.y = pt.y;
                                        
                                        graph.addCell(v1, parent);
                                        
                                        if (isTable) {
                                            v1.geometry.alternateBounds = new mxRectangle(0, 0, v1.geometry.width, v1.geometry.height);
                                            v1.children[0].value.name = name + '_ID';
                                        }
                                    } finally {
                                        model.endUpdate();
                                    }
                                    
                                    graph.setSelectionCell(v1);
                                }
                            }).catch(() => {
                                
                            }); */

                        name = mxUtils.prompt('请输入类名称', '');

                        if(_.isEmpty(name)){
                            name = '/新类'+(tableCount+1);
                        }
                    }
                    
                    if (name != null) {
                        
                        var v1 = model.cloneCell(prototype);
                        
                        model.beginUpdate();
                        try {
                            v1.value.name = name;
                            v1.geometry.x = pt.x;
                            v1.geometry.y = pt.y;
                            
                            graph.addCell(v1, parent);
                            
                            if (isTable) {
                                v1.geometry.alternateBounds = new mxRectangle(0, 0, v1.geometry.width, v1.geometry.height);
                                v1.children[0].value.name = name + '_ID';
                            }

                        } finally {
                            model.endUpdate();
                        }
                        
                        graph.setSelectionCell(v1);
                    }
                }
                
                // Creates the image which is used as the sidebar icon (drag source)                
                if(!_.isEmpty(image)){
                    var div = document.createElement('div');
                    div.style.width = '55px';
                    div.style.height = '55px';
                    div.style.textAlign = 'center';
                    div.style.margin = '5px';
                    div.style.padding = '5px';

                    var img = document.createElement('img');
                    img.setAttribute('src', image);
                    img.style.width = '38px';
                    img.style.height = '38px';
                    img.title = '拖拽到画布生成新的类或属性';
                    div.appendChild(img)

                    var sdiv = document.createElement('div');
                    sdiv.innerHTML = prototype.value.ftype?prototype.value.ftype:'新建类';
                    div.appendChild(sdiv);

                    sidebar.appendChild(div);
                    
                                        
                    // Creates the image which is used as the drag icon (preview)
                    var dragImage = img.cloneNode(true);
                    var ds = mxUtils.makeDraggable(img, graph, funct, dragImage);

                    // Adds highlight of target tables for columns
                    ds.highlightDropTargets = true;
                    ds.getDropTarget = function(graph, x, y) {
                        if (graph.isSwimlane(prototype)) {
                            return null;
                        } else {
                            var cell = graph.getCellAt(x, y);
                            
                            if (graph.isSwimlane(cell)) {
                                return cell;
                            } else {
                                var parent = graph.getModel().getParent(cell);
                                
                                if (graph.isSwimlane(parent))
                                {
                                    return parent;
                                }
                            }
                        }
                    }
                } else {
                    var btn = document.createElement('button');
                    btn.style.width = '80px';
                    btn.style.height = '55px';
                    btn.style.textAlign = 'center';
                    btn.style.margin = '5px';
                    btn.style.padding = '5px';
                    btn.className = "el-button el-button-text";
                    
                    var sdiv = document.createElement('div');
                    sdiv.innerHTML = prototype.value.name;
                    sdiv.style.fontSize = "12px";
                    sdiv.style.fontWeight = "600";
                    btn.appendChild(sdiv)

                    var sdiv = document.createElement('div');
                    sdiv.innerHTML = prototype.value.ftype;
                    sdiv.style.fontSize = "11px";
                    btn.appendChild(sdiv);

                    sidebar.appendChild(btn);
                                        
                    // Creates the image which is used as the drag icon (preview)
                    var dragImage = btn.cloneNode(true);
                    var ds = mxUtils.makeDraggable(btn, graph, funct, dragImage);

                    // Adds highlight of target tables for columns
                    ds.highlightDropTargets = true;
                    ds.getDropTarget = function(graph, x, y) {
                        if (graph.isSwimlane(prototype)) {
                            return null;
                        } else {
                            var cell = graph.getCellAt(x, y);
                            
                            if (graph.isSwimlane(cell)) {
                                return cell;
                            } else {
                                var parent = graph.getModel().getParent(cell);
                                
                                if (graph.isSwimlane(parent))
                                {
                                    return parent;
                                }
                            }
                        }
                    }
                }
            },
            initSideBar(graph,sidebar){
                // Defines the column user object
                function Column(name){
                        this.name = name;
                };

                Column.prototype.ftype = 'varchar';

                Column.prototype.ftypeOption = {value1: "",value2: ""};

                Column.prototype.title = '';
                
                Column.prototype.iskey = false;
                
                Column.prototype.isindex = false;
                
                Column.prototype.clone = function() {
                    return mxUtils.clone(this);
                };

                Table.prototype.ttl = 86400 * 365;

                Table.prototype.alias = '';
                
                Table.prototype.nickname = '';

                Table.prototype.autosearch = true;

                Table.prototype.partition = "";

                Table.prototype.ckeys = "";

                Table.prototype.clone = function() {
                    return mxUtils.clone(this);
                };

                const self = this;
                
                let addIcon = function(name){
                    var columnObject = new Column('COLUMNNAME');
                    var column = new mxCell(columnObject, new mxGeometry(0, 0, 0, 26));
                    column.setVertex(true);
                    column.value.ftype = name;
                    column.setConnectable(false);

                    self.addSidebarIcon(graph, $(sidebar).find("#columnContainer .el-collapse-item__content")[0], column, `/fs/assets/images/omdb/${name}.png?type=open&issys=true`);

                    // Adds primary key field into table
                    if(name=='varchar'){
                        var firstColumn = column.clone();
                        
                        firstColumn.value.name = 'CLASSNAME_ID';
                        firstColumn.value.title = '';
                        firstColumn.value.ftype = 'varchar';
                        firstColumn.value.ftypeOption = {value1: "",value2: ""};;
                        firstColumn.value.iskey = true;
                        firstColumn.value.isindex = false;
                        
                        table.insert(firstColumn);
                    }
                }
                
                // Defines the table user object
                function Table(name){
                    this.name = name;
                };
                Table.prototype.clone = function(){
                    return mxUtils.clone(this);
                };

                // Adds sidebar icon for the table object
                var tableObject = new Table('CLASSNAME');
                var table = new mxCell(tableObject, new mxGeometry(0, 0, 200, 28), 'table');
                table.setVertex(true);
                this.addSidebarIcon(graph, $(sidebar).find("#tableContainer .el-collapse-item__content")[0], table, '/fs/assets/images/omdb/class.png?type=open&issys=true');
                
                // varchar for the column object
                _.forEach(["bigint", "blob", "boolean", "date", "double", "float", "int", "list", "map", "set", "smallint", "text", "timestamp", "varchar"],(v)=>{
                    addIcon(v);
                })
                
            },
            addDirectoryToSidebar(item){

                // Defines the column user object
                function Column(name){
                    this.name = name;
                };

                Column.prototype.ftype = 'varchar';

                Column.prototype.ftypeOption = {value1: "",value2: ""};;

                Column.prototype.title = '';
                
                Column.prototype.iskey = false;
                
                Column.prototype.isindex = false;
                
                Column.prototype.clone = function() {
                    return mxUtils.clone(this);
                };

                const self = this;
                
                let addIcon = function(node,el){
                    var columnObject = new Column('COLUMNNAME');
                    var column = new mxCell(columnObject, new mxGeometry(0, 0, 0, 26));
                    column.setVertex(true);
                    column.value.name = node.name;
                    column.value.title = node.title;
                    column.value.ftype = node.ftype;
                    column.value.ftypeOption = node.ftypeOption;
                    column.value.iskey = node.iskey;
                    column.value.isindex = node.isindex;
                    column.setConnectable(false);
                    
                    _.delay(()=>{
                        $(el).find(".el-collapse-item__content").empty();
                        let sidebar = $($(el).find(".el-collapse-item__content"))[0];
                        self.addSidebarIcon(self.editor.graph, sidebar, column, null);
                    },1000)

                }
                
                // varchar for the column object
                _.forEach(item,(v,k)=>{
                    _.forEach(_.uniqBy(v,'name'),(node)=>{
                        addIcon(node, `#directory-${k}`);
                    });
                })
            },
            summaryInfo(){
                this.docInfo.classes.list = [];
                this.docInfo.columns.list = [];

                let parent = this.editor.graph.getDefaultParent();
                let childCount = this.editor.graph.model.getChildCount(parent);

                for(var i=0; i<childCount; i++){
                    var child = this.editor.graph.model.getChildAt(parent, i);
                    if (!this.editor.graph.model.isEdge(child)){
                        
                        // Classes
                        this.docInfo.classes.list.push(child.value.name);
                        
                        var columnCount = this.editor.graph.model.getChildCount(child);

                        if (columnCount > 0){
                            for (var j=0; j<columnCount; j++){
                                // Columns
                                this.docInfo.columns.list.push(this.editor.graph.model.getChildAt(child, j).value);
                            }
                        }
                    }
                }

            },
            showDialogInfo(title, content) {
                
                this.dialogInfo.title = "";
                this.dialogInfo.content = "";
                this.dialogInfo.title = title;
                this.dialogInfo.visible = true;
                
                _.delay(()=>{
                    // Editor
                    let editor = ace.edit(this.$refs.dialogInfoEditor.$el);
                    editor.setOptions({
                        //maxLines: 1000,
                        minLines: 20,
                        autoScrollEditorIntoView: true,
                        enableBasicAutocompletion: true,
                        enableSnippets: true,
                        enableLiveAutocompletion: true
                    });
                    editor.setTheme("ace/theme/tomorrow");
                    editor.getSession().setMode("ace/mode/mql");
                    editor.setValue(content);
                },50)
            },
            showDialogSource(title, content) {
                this.dialogSource.title = "";
                this.dialogSource.content = "";

                this.dialogSource.title = title;
                this.dialogSource.visible = true;

                _.delay(()=>{
                    // Editor
                    let editor = ace.edit(this.$refs.dialogSourceEditor.$el);
                    editor.setOptions({
                        //maxLines: 1000,
                        minLines: 20,
                        autoScrollEditorIntoView: true,
                        enableBasicAutocompletion: true,
                        enableSnippets: true,
                        enableLiveAutocompletion: true
                    });
                    editor.setTheme("ace/theme/tomorrow");
                    editor.getSession().setMode("ace/mode/xml");
                    editor.setValue(content);
                },50)
            },
            applyMqlToFile(){
                let doc = mxUtils.parseXml(this.dialogSource.content);
                console.log(doc)
                let codec = new mxCodec(doc);
                codec.decode(doc.documentElement, this.editor.graph.getModel());
                this.dialogSource.visible = false;
            },
            configureStylesheet(graph) {
                var style = new Object();
                style[mxConstants.STYLE_SHAPE] = mxConstants.SHAPE_RECTANGLE;
                style[mxConstants.STYLE_PERIMETER] = mxPerimeter.RectanglePerimeter;
                style[mxConstants.STYLE_ALIGN] = mxConstants.ALIGN_LEFT;
                style[mxConstants.STYLE_VERTICAL_ALIGN] = mxConstants.ALIGN_MIDDLE;
                style[mxConstants.STYLE_FONTCOLOR] = '#000000';
                style[mxConstants.STYLE_FONTSIZE] = '12';
                style[mxConstants.STYLE_FONTSTYLE] = 0;
                style[mxConstants.STYLE_CELL_WIDTH] = '300';
                style[mxConstants.STYLE_SPACING_LEFT] = '4';
                style[mxConstants.STYLE_SPACING_RIGHT] = '4';
                style[mxConstants.STYLE_IMAGE_WIDTH] = '48';
                style[mxConstants.STYLE_IMAGE_HEIGHT] = '48';
                graph.getStylesheet().putDefaultVertexStyle(style);

                style = new Object();
                style[mxConstants.STYLE_SHAPE] = mxConstants.SHAPE_SWIMLANE;
                style[mxConstants.STYLE_PERIMETER] = mxPerimeter.RectanglePerimeter;
                style[mxConstants.STYLE_ALIGN] = mxConstants.ALIGN_RIGHT;
                style[mxConstants.STYLE_VERTICAL_ALIGN] = mxConstants.ALIGN_TOP;
                style[mxConstants.STYLE_GRADIENTCOLOR] = '#41B9F5';
                style[mxConstants.STYLE_FILLCOLOR] = '#8CCDF5';
                style[mxConstants.STYLE_SWIMLANE_FILLCOLOR] = '#ffffff';
                style[mxConstants.STYLE_STROKECOLOR] = '#1B78C8';
                style[mxConstants.STYLE_FONTCOLOR] = '#FFFFFF';
                style[mxConstants.STYLE_STROKEWIDTH] = '1';
                style[mxConstants.STYLE_STARTSIZE] = '28';
                style[mxConstants.STYLE_VERTICAL_ALIGN] = 'middle';
                style[mxConstants.STYLE_FONTSIZE] = '12';
                style[mxConstants.STYLE_FONTSTYLE] = 1;
                style[mxConstants.STYLE_IMAGE] = '/fs/assets/images/graph/tools/table.png?type=open&issys=true';
                // Looks better without opacity if shadow is enabled
                //style[mxConstants.STYLE_OPACITY] = '80';
                style[mxConstants.STYLE_SHADOW] = 1;
                graph.getStylesheet().putCellStyle('table', style);

                style = graph.stylesheet.getDefaultEdgeStyle();
                style[mxConstants.STYLE_LABEL_BACKGROUNDCOLOR] = '#FFFFFF';
                style[mxConstants.STYLE_STROKEWIDTH] = '2';
                style[mxConstants.STYLE_ROUNDED] = true;
                style[mxConstants.STYLE_EDGE] = mxEdgeStyle.EntityRelation;
            },
            // Function to create the entries in the popupmenu
            createPopupMenu(editor, graph, menu, cell, evt) {
                if (cell != null) {

                    if (graph.isHtmlLabel(cell) || cell.value.constructor.name=='Table' || cell.value.constructor.name=='Column' ){
                        menu.addItem('属性', null, function(){
                            editor.execute('mxProperties', cell);
                        });
                        menu.addSeparator();
                    }
                    
                    menu.addItem('删除', null, function(){
                        editor.execute('delete', cell);
                    });
                    menu.addSeparator();
                }

                menu.addItem('撤销', null, function(){
                    editor.execute('undo', cell);
                });
                
                menu.addItem('重做', null, function(){
                    editor.execute('redo', cell);
                });

                menu.addSeparator();

                menu.addItem('清空', null, function(){
                    editor.execute('deleteAll');
                });
                
                menu.addSeparator();
                
                menu.addItem('MQL', null, function(){
                    editor.execute('showMql', cell);
                });	

                menu.addSeparator();
                    
                var submenuLayout = menu.addItem('布局', null, null);
                
                var submenuLayoutHierarchical = menu.addItem('分层布局', null, null,submenuLayout);
                menu.addItem('折线', null, ()=>{
                    this.layout.default = 'hierarchical';
                    this.layout.edgeStyle = 2;
                    this.executeLayout();
                    localStorage.setItem("TOPOLOGICAL-RENDER-EDGESTYLE",this.layout.edgeStyle);
                }, submenuLayoutHierarchical);
                menu.addItem('直线', null, ()=>{
                    this.layout.default = 'hierarchical';
                    this.layout.edgeStyle = 3;
                    this.executeLayout();
                    localStorage.setItem("TOPOLOGICAL-RENDER-EDGESTYLE",this.layout.edgeStyle);
                }, submenuLayoutHierarchical);
                menu.addItem('圆角', null, ()=>{
                    this.layout.default = 'hierarchical';
                    this.layout.edgeStyle = 4;
                    this.executeLayout();
                    localStorage.setItem("TOPOLOGICAL-RENDER-EDGESTYLE",this.layout.edgeStyle);
                }, submenuLayoutHierarchical);
                
                
                var submenuLayoutTree = menu.addItem('树形布局', null, null,submenuLayout);

                menu.addItem('上下', null, ()=>{
                    this.layout.default = 'tree_vertical';
                    this.executeLayout();
                }, submenuLayoutTree);
                menu.addItem('左右', null, ()=>{
                    this.layout.default = 'tree_horizontal';
                    this.executeLayout();
                }, submenuLayoutTree);

                menu.addItem('随机布局', null, ()=>{
                    this.layout.default = 'organic';
                    this.executeLayout();
                }, submenuLayout);
                menu.addItem('圆形布局', null, ()=>{
                    this.layout.default = 'circle';
                    this.executeLayout();
                }, submenuLayout);
            },
            showProperties(graph, cell){

                if(cell.value.constructor.name == 'Table'){
                    
                    this.dialogClassProperties.title = cell.value.name;
                    _.extend(this.dialogClassProperties, {cell:cell});
                    this.dialogClassProperties.visible = true;

                } else {
                    var parent = graph.model.getParent(cell);
                    var className = parent.value.name;
                    var columnName = cell.value.name;
                    
                    this.dialogProperties.title = className;
                    _.extend(this.dialogProperties, {cell:cell});
                    this.dialogProperties.visible = true;
                }

            },
            onUpdateProperties(cell){
                
                let clone = cell.value.clone();
				
                this.editor.graph.model.setValue(cell, clone);
                
                this.onSave();

                this.dialogProperties.visible = false;

            }, 
            onUpdateClassProperties(cell){
                
                let clone = cell.value.clone();
				
                this.editor.graph.model.setValue(cell, clone);
                
                this.onSave();

                this.dialogClassProperties.visible = false;

            },  
            createMql(graph,cell) {
                console.log(11,cell)

                let mql = [[],[],[]];

                if(cell){
                    var child = cell;
                    
                    if (!graph.model.isEdge(child)){
                        
                        mql[0].push('CREATE CLASS IF NOT EXISTS '+child.value.name+' (');
                        
                        // Gen class cfg
                        let classCfg = [];

                        if(child.value.ttl){
                            classCfg.push(`ttl=${child.value.ttl / 86400} day`);
                        }
                        if(child.value.alias){
                            classCfg.push(`alias='${child.value.alias}'`);
                        }
                        if(child.value.nickname){
                            classCfg.push(`nickname='${child.value.nickname}'`);
                        }

                        if(child.value.autosearch){
                            classCfg.push(`autosearch=${child.value.autosearch==1?true:false}`);
                        }

                        if(child.value.partition){
                            classCfg.push(`partition=${child.value.partition}`);
                        }

                        if(child.value.ckeys){
                            classCfg.push(`ckeys=${child.value.ckeys}`);
                        }
                        
                        // Gen column cfg
                        var columnCount = graph.model.getChildCount(child);

                        if (columnCount > 0){
                            for (var j=0; j<columnCount; j++){
                                var column = (graph.model.getChildAt(child, j).value).clone();
                                
                                if(_.includes(['list','set'],column.ftype)){
                                    console.log(_.values(column.ftypeOption))
                                    column.ftype += `<${_.values(column.ftypeOption).join(",").slice(0,-1)}>`;
                                }

                                if(_.includes(['map'],column.ftype)){
                                    console.log(_.values(column.ftypeOption))
                                    column.ftype += `<${_.values(column.ftypeOption).join(",")}>`;
                                }

                                mql[0].push('\n    '+`"${column.name}"`+'  '+column.ftype+'  "'+column.title + '"');
                                
                                if (column.iskey){
                                    mql[1].push(column.name);
                                }
                                
                                if (column.isindex) {
                                    mql[2].push(column.name);
                                }
                                
                                mql[0].push(',');
                            }
                            // merge key
                            if(!_.isEmpty(mql[1])){
                                mql[0].push('\n\t key('+mql[1].join(',')+')');
                                mql[0].push(',');
                            }
                            // merge index
                            if(!_.isEmpty(mql[2])){
                                mql[0].push('\n\t index('+mql[2].join(',')+')');
                                mql[0].push(',');
                            }

                            mql[0].splice(mql[0].length-1, 1);

                            mql[0].push('\n)');
                            
                            // class cfg
                            if(!_.isEmpty(classCfg)){
                                mql[0].push(` with ${classCfg.join(", ")}`);
                            }

                            mql[0].push(';');

                            
                        }
                        
                        mql[0].push('\n\n');
                    }
                } else {
   
                    let parent = graph.getDefaultParent();
                    let childCount = graph.model.getChildCount(parent);

                    for (var i=0; i<childCount; i++){
                        var child = graph.model.getChildAt(parent, i);
                        
                        if (!graph.model.isEdge(child)){
                            
                            mql[0].push('CREATE CLASS IF NOT EXISTS '+child.value.name+' (');
                            
                            // Gen class cfg
                            let classCfg = [];

                            if(child.value.ttl){
                                classCfg.push(`ttl=${child.value.ttl}`);
                            }
                            if(child.value.alias){
                                classCfg.push(`alias='${child.value.alias}'`);
                            }
                            if(child.value.nickname){
                                classCfg.push(`nickname='${child.value.nickname}'`);
                            }

                            if(child.value.autosearch){
                                classCfg.push(`autosearch=${child.value.autosearch}`);
                            }

                            if(child.value.partition){
                                classCfg.push(`partition=${child.value.partition}`);
                            }

                            if(child.value.ckeys){
                                classCfg.push(`ckeys=${child.value.ckeys}`);
                            }
                            
                            // Gen column cfg
                            var columnCount = graph.model.getChildCount(child);

                            if (columnCount > 0){
                                for (var j=0; j<columnCount; j++){
                                    var column = (graph.model.getChildAt(child, j).value).clone();
                                    
                                    if(_.includes(['list','set'],column.ftype)){
                                        console.log(_.values(column.ftypeOption))
                                        column.ftype += `<${_.values(column.ftypeOption).join(",").slice(0,-1)}>`;
                                    }

                                    if(_.includes(['map'],column.ftype)){
                                        console.log(_.values(column.ftypeOption))
                                        column.ftype += `<${_.values(column.ftypeOption).join(",")}>`;
                                    }

                                    mql[0].push('\n    '+`"${column.name}"`+'  '+column.ftype+'  "'+column.title + '"');
                                    
                                    if (column.iskey){
                                        mql[1].push(column.name);
                                    }
                                    
                                    if (column.isindex) {
                                        mql[2].push(column.name);
                                    }
                                    
                                    mql[0].push(',');
                                }
                                // merge key
                                if(!_.isEmpty(mql[1])){
                                    mql[0].push('\n\t key('+mql[1].join(',')+')');
                                    mql[0].push(',');
                                }
                                // merge index
                                if(!_.isEmpty(mql[2])){
                                    mql[0].push('\n\t index('+mql[2].join(',')+')');
                                    mql[0].push(',');
                                }

                                mql[0].splice(mql[0].length-1, 1);

                                mql[0].push('\n)');
                                
                                // class cfg
                                if(!_.isEmpty(classCfg)){
                                    mql[0].push(` with ${classCfg.join(", ")}`);
                                }

                                mql[0].push(';');

                                
                            }
                            
                            mql[0].push('\n\n');
                        }
                    }
                }
                

                return mql[0].join('');
            },
            onNew(){
                this.deleteCells(true);
                this.summaryInfo();
                this.doc = null;
            },
            onOpen(auto){
                try{

                    // 选择文件打开
                    if(!auto){
                        this.doc = this.$refs.dfsOpen.node;
                    }
                    
                    let xml = fsHandler.fsContent(this.doc.parent, this.doc.name);
                    let doc = mxUtils.parseXml(xml);
                    let codec = new mxCodec(doc);
                    codec.decode(doc.documentElement, this.editor.graph.getModel());
                } catch(err){
                    console.error(err);
                } finally {
                    this.dialogOpen.visible = false;
                    this.summaryInfo();

                    
                    _.delay(()=>{
                        this.executeLayout();
                        this.toCenter();
                    },500)


                    // 记录最后一次打开文件
                    localStorage.setItem("CLASS-DESIGN-OPEN-FILE",JSON.stringify(this.doc));

                }
                
            },
            onSaveAs(){
                
                let enc = new mxCodec(mxUtils.createXmlDocument());
                let node = enc.encode(this.editor.graph.getModel());
                let xml = mxUtils.getPrettyXml(node);
                let attr = {};
                
                let parent = this.$refs.dfsSaveas.node.fullname;
                let name = this.$refs.dfsSaveas.node.name;
                let rtn = fsHandler.fsNew('file',parent, name, xml, attr);
                if(rtn == 1){
                    this.$message({
                        type:"success",
                        message: "保存成功！"
                    })
                    
                    this.doc = {parent:parent, name:name, fullname: [parent,name].join("/")};
                }

                this.dialogSaveAs.visible = false;
            },
            onExecute(){
                let editor = ace.edit(this.$refs.dialogInfoEditor.$el);
                let mql = editor.getSelectedText();

                if(_.isEmpty(mql)){
                    mql = editor.getValue();
                }

                // execute
                this.$confirm(`确定执行:<br>${mql}`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning',
                        center: true
                        }).then(() => {

                            let rtn = omdbHandler.fetchDataByMql(mql);
                            
                            // output
                            if(rtn.status === 'ok'){
                                
                                // MQL for  CRUD
                                if(rtn.meta.type === 'create'){
                                    this.$message({
                                        type: "success",
                                        message: "类创建成功"
                                    });
                                    return false;
                                }

                                if(rtn.meta.type === 'alter'){
                                    this.$message({
                                        type: "success",
                                        message: "属性修改成功"
                                    });
                                    return false;
                                }

                            } else {
                                this.$message({
                                    type: "error",
                                    message: rtn.message,
                                    showClose: true
                                })
                            }
                        }).catch(() => {
                        
                        });

            }, 
            onSave(){
                if(this.doc){
                    let enc = new mxCodec(mxUtils.createXmlDocument());
                    let node = enc.encode(this.editor.graph.getModel());
                    let xml = mxUtils.getPrettyXml(node);
                    let attr = _.extend(this.doc, {});
                    let rtn = fsHandler.fsNew('file',this.doc.parent, this.doc.name, xml, attr);
                    if(rtn == 1){
                        this.$message({
                            type:"success",
                            message: "保存成功！"
                        })
                    }
                } else {
                    // this.$message({
                    //     type: "info",
                    //     message: "该文档未保存！"
                    // })
                    this.dialogSaveAs.visible = true;
                }
            },
            onClose(){
                this.editor.execute("deleteAll");
                this.doc = null;
                this.summaryInfo();
            },
            onDelete(){
                if(this.doc){

                    this.$confirm(`确认要删除该设计文档：${this.doc.name}？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        let rtn = fsHandler.fsDelete(this.doc.parent,this.doc.name);
    
                        if (rtn == 1){
                            this.$message({
                                type: "success",
                                message: "删除成功！"
                            });
                            this.deleteCells(true);
                            this.doc = null;
                            localStorage.setItem("CLASS-DESIGN-OPEN-FILE",'');
                            this.summaryInfo();
                        } else {
                            this.$message({
                                type: "error",
                                message: "删除失败 " + rtn.message
                            })
                        } 
                    }).catch(() => {
                        
                    });
                }
            },
            deleteCells(includeEdges){
                
                // Cancels interactive operations
                let graph = this.editor.graph;
                graph.escape();
                //var cells = graph.getDeletableCells(graph.getSelectionCells());
                let cells = graph.getChildVertices(graph.getDefaultParent());
                if (cells != null && cells.length > 0){
                    var parents = graph.model.getParents(cells);
                    graph.removeCells(cells, includeEdges);
                    
                    // Selects parents for easier editing of groups
                    if (parents != null){
                        var select = [];
                        
                        for (var i = 0; i < parents.length; i++){
                            if (graph.model.contains(parents[i]) &&
                                (graph.model.isVertex(parents[i]) ||
                                graph.model.isEdge(parents[i]))){
                                select.push(parents[i]);
                            }
                        }
                        graph.setSelectionCells(select);
                    }
                }
            }
		}
	
	}
	</script>

</code>
