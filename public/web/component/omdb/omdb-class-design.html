<code>

	<style>
		/*----------  style  ----------*/
        .omdb-class-design{
            height: calc(100vh - 85px);
            background: #fff;
        }

        .omdb-class-design .vertical-toolbar{
            position: absolute;
            width: 29px;
            height: auto;
            background: #ffffff;
            z-index: 1000;
            right: 25px;
            bottom: 100px;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 0px 6px;
        }
        .omdb-class-design .vertical-toolbar > button{
            margin: 0 5px;
        }

        .omdb-class-design .vertical-toolbar .el-divider.el-divider--horizontal{
            margin: 0px;
        }

        /* mxPopuMenu */
        div.mxPopupMenu{
            -webkit-box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1)!important;
            -moz-box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1)!important;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1)!important;
            border: unset!important;
            background-image: unset!important;
            background: #ffffff!important;
        }
        /* mxToolTip */
        div.mxTooltip {
            background: #fff;
            border: unset!important;
            font-family: inherit;
            font-size: 12px;
            padding: 10px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
	</style>

	
	/*----------  最外层element会自动增加组件同名 class="omdb-class-design"  ----------*/
	<template>
        <el-container>
            <el-header style="height:30px;line-height:30px;background: #f7f7f7;border-bottom:1px solid #ddd;">
                <el-dropdown trigger="click">
                    <span class="el-dropdown-link">
                        <el-button type="text">
                            打开 <i class="el-icon--right"></i>
                        </el-button>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item @click.native="onNew">新建</el-dropdown-item>
                        <el-dropdown-item @click.native="dialogOpen.visible=true" divided>打开</el-dropdown-item>
                        <el-dropdown-item @click.native="onSave" divided>保存</el-dropdown-item>
                        <el-dropdown-item @click.native="dialogSaveAs.visible=true">另存为</el-dropdown-item>
                        <el-dropdown-item @click.native="onDelete" divided>删除</el-dropdown-item>
                        <el-dropdown-item @click.native="editor.execute('print')" divided>打印</el-dropdown-item>
                        <el-dropdown-item @click.native="onClose" divided>关闭</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown>
                <el-dropdown trigger="click">
                    <span class="el-dropdown-link">
                        <el-button type="text">
                            编辑 <i class="el-icon--right"></i>
                        </el-button>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item @click.native="editor.execute('undo')">撤销</el-dropdown-item>
                        <el-dropdown-item  @click.native="editor.execute('redo')">重做</el-dropdown-item>
                        <el-dropdown-item  @click.native="onDelete" divided v-if="!_.isEmpty(doc)">删除</el-dropdown-item>
                        <el-dropdown-item divided>关闭</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown>
                <el-dropdown trigger="click">
                    <span class="el-dropdown-link">
                        <el-button type="text">
                            视图 <i class="el-icon--right"></i>
                        </el-button>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item @click.native="editor.execute('show')">预览</el-dropdown-item>
                        <el-dropdown-item  @click.native="editor.execute('toggleOutline')" divided>缩略图</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown>
                <el-dropdown trigger="click">
                    <span class="el-dropdown-link">
                        <el-button type="text">
                            工具 <i class="el-icon--right"></i>
                        </el-button>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item  @click.native="editor.execute('showMql')">生成MQL</el-dropdown-item>
                        <el-dropdown-item  @click.native="editor.execute('export')" divided>源文件</el-dropdown-item>
                        <el-dropdown-item  @click.native="editor.execute('exportImage')">导出图片</el-dropdown-item>
                        
                    </el-dropdown-menu>
                </el-dropdown>
                
            </el-header>
            <el-container style="height:100%;border-top:1px solid #fff;">
                <el-aside width="60px" style="height:100%;background:#f7f7f7;">
                    <!-- Creates a container for the toolboox -->
                    <div id="sidebarContainer"
                        style="overflow:hidden;max-width:52px;width:56px;padding-top:10px;padding-left:4px;"
                        ref="sidebarContainer">
                    </div>
                </el-aside>
                <el-main style="padding:0px;">
                    
                    <!-- Creates a container for the graph -->
                    <div id="graphContainer"
                        style="height:100%;" ref="graphContainer">
                    </div>
    
                    <div class="vertical-toolbar animated fadeIn">
                        <el-tooltip content="刷新" open-delay="500" placement="left">
                            <el-button type="text" @click="editor.execute('refresh')">
                                 <i class="el-icon-refresh" style="font-size:18px;">
                            </el-button>
                        </el-tooltip>
                        <el-tooltip content="放大" open-delay="500" placement="left">
                           <el-button type="text" @click="editor.execute('zoomIn')">
                                <i class="el-icon-zoom-in" style="font-size:18px;">
                           </el-button>
                       </el-tooltip>
                       <el-divider></el-divider>
                       <el-tooltip content="缩小" open-delay="500" placement="left">
                           <el-button type="text" @click="editor.execute('zoomOut')">
                                <i class="el-icon-zoom-out" style="font-size:18px;">
                           </el-button>
                       </el-tooltip>
                       <el-divider></el-divider>
                       <el-tooltip content="实际大小" open-delay="500" placement="left">
                           <el-button type="text" @click="editor.execute('actualSize')">
                                <i class="el-icon-s-help" style="font-size:18px;">
                           </el-button>
                       </el-tooltip>
                       <el-divider></el-divider>
                       <el-tooltip content="适合页面" open-delay="500" placement="left">
                           <el-button type="text" @click="editor.execute('fit')">
                                <i class="el-icon-help" style="font-size:18px;">
                           </el-button>
                       </el-tooltip>
                       <el-divider></el-divider>
                       <el-tooltip content="收起所有" open-delay="500" placement="left">
                           <el-button type="text" @click="editor.execute('collapseAll')">
                                <i class="el-icon-menu" style="font-size:18px;">
                           </el-button>
                       </el-tooltip>
                       <el-divider></el-divider>
                       <el-tooltip content="展开所有" open-delay="500" placement="left">
                           <el-button type="text" @click="editor.execute('expandAll')">
                                <i class="el-icon-s-grid" style="font-size:18px;">
                           </el-button>
                       </el-tooltip>
                   </div>
                   <el-dialog :title="dialogOpen.title" :visible.sync="dialogOpen.visible">
                        <mx-fs-open dfsRoot="/home/admin/Documents" ref="dfsOpen"></mx-fs-open>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="dialogOpen.visible = false">取 消</el-button>
                            <el-button type="primary" @click="onOpen">打 开</el-button>
                        </div>
                    </el-dialog>
                    <el-dialog :title="dialogSaveAs.title" :visible.sync="dialogSaveAs.visible">
                        <mx-fs-saveas dfsRoot="/home/admin/Documents" ref="dfsSaveas"></mx-fs-saveas>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="dialogSaveAs.visible = false">取 消</el-button>
                            <el-button type="primary" @click="onSaveAs">另存为</el-button>
                        </div>
                    </el-dialog>
                    <el-dialog :title="dialogInfo.title" :visible.sync="dialogInfo.visible">
                        <el-container>
                            <el-main style="padding:0px;height:300px;border:1px solid #ddd;" ref="dialogInfoEditor"></el-main>
                        </el-container>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="dialogInfo.visible = false">取 消</el-button>
                            <el-button type="primary" @click="dialogInfo.visible = false">确 定</el-button>
                        </div>
                    </el-dialog>
                    <el-dialog :title="dialogSource.title" :visible.sync="dialogSource.visible">
                        <el-container>
                            <el-main style="padding:0px;height:300px;border:1px solid #ddd;" ref="dialogSourceEditor"></el-main>
                        </el-container>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="dialogSource.visible = false">取 消</el-button>
                            <el-button type="primary" @click="applyMqlToFile">更新到当前文件</el-button>
                        </div>
                    </el-dialog>
                    <el-dialog :title="dialogProperties.title+'【'+ dialogProperties.cell.value.name +'】'" 
                        :visible.sync="dialogProperties.visible"
                        v-if="dialogProperties.cell">
                        <el-form label-position="right" label-width="100px">
                            <el-form-item label="属性">
                                <el-input  v-model="dialogProperties.cell.value.name" autocomplete="off"></el-input>
                            </el-form-item>
                            <el-form-item label="名称">
                                <el-input  v-model="dialogProperties.cell.value.title" autocomplete="off"></el-input>
                            </el-form-item>
                            <el-form-item label="类型">
                                <el-select v-model="dialogProperties.cell.value.ftype">
                                    <el-option :key="item.value" 
                                        :label="item.label"
                                        :value="item.value"
                                        v-for="item in dialogProperties.model.ftypeList">
                                    </el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="是否为主键">
                                <el-checkbox v-model="dialogProperties.cell.value.iskey"></el-checkbox>
                            </el-form-item>
                            <el-form-item label="是否为索引">
                                <el-checkbox v-model="dialogProperties.cell.value.isindex"></el-checkbox>
                            </el-form-item>
                        </el-form>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="dialogProperties.visible = false">取 消</el-button>
                            <el-button type="primary" @click="onUpdateProperties(dialogProperties.cell)">确 定</el-button>
                        </div>
                    </el-dialog>
                </el-main>
            </el-container>
            <el-footer style="height:30px;line-height: 30px;background: #f7f7f7;">
                <span v-if="!_.isEmpty(doc)">
                    <i class="el-icon-notebook-2"></i> ${doc.fullname}
                </span>
                <el-divider direction="vertical"></el-divider>
                <el-dropdown>
                    <span class="el-dropdown-link" style="cursor: pointer;">
                        <i class="el-icon-office-building"></i> ${docInfo.classes.list.length}
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item v-for="item in docInfo.classes.list" :key="item" :command="item">
                            ${item}
                        <el-dropdown-item
                    </el-dropdown-menu>
                </el-dropdown>
                <el-divider direction="vertical"></el-divider>
                <el-dropdown>
                    <span class="el-dropdown-link" style="cursor: pointer;">
                        <i class="el-icon-notebook-2"></i> ${docInfo.columns.list.length}
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item v-for="item in docInfo.columns.list" :key="item" :command="item">
                            <span>${item.name}</span>
                            <span>${item.ftype}</span>
                        <el-dropdown-item
                    </el-dropdown-menu>
                </el-dropdown>
            </el-footer>
        </el-container>
	</template>

	/*----------  id是vue组件的name，内容是vue组件的option参数  ----------*/
	<script id="omdb-class-design">
	{
        delimiters: ['${', '}'],
		props: {
        	
		},
		data(){
          	return {
                editor: null,
                doc:null,
                docInfo: {
                    classes:{
                        count:0,
                        list: []
                    },
                    columns:{
                        count: 0,
                        list: []
                    }
                },
                dialogOpen:{
                    title: "打开",
                    content: "",
                    visible: false
                },
                dialogSaveAs:{
                    title: "另存为",
                    content: "",
                    visible: false
                },
                dialogInfo:{
                    title: "",
                    content: "",
                    visible: false
                },
                dialogSource: {
                    title: "",
                    content: "",
                    visible: false
                },
                dialogProperties: {
                    title: "",
                    cell: null,
                    model:{
                        cell: null,
                        name:"",
                        title:"",
                        ftype: "varchar",
                        iskey:false,
                        isindex:false,
                        ftypeList: [],
                    },
                    visible: false
                }
			}
        },
        created(){
            try{
                let ftypeList = fsHandler.callFsJScript("/matrix/omdb/getFileldTypeList.js",null).message;
                _.extend(this.dialogProperties.model,{ftypeList:_.map(ftypeList,(v,k)=>{ return {value:k,label:k};  })});
            } catch(err){
                console.log(err)
            }
            
        },
		mounted(){
            this.main(this.$refs.graphContainer,
                    this.$refs.sidebarContainer);
        },
		methods: {
            // Program starts here. Creates a sample graph in the
            // DOM node with the specified ID. This function is invoked
            // from the onLoad event handler of the document (see below).
            main(container, sidebar) {
                const self = this;

                // Defines the column user object
                function Column(name){
                        this.name = name;
                };

                Column.prototype.ftype = 'varchar';

                Column.prototype.title = '';
                
                Column.prototype.iskey = false;
                
                Column.prototype.isindex = false;
                
                Column.prototype.clone = function() {
                    return mxUtils.clone(this);
                };
                
                // Defines the table user object
                function Table(name){
                    this.name = name;
                };
                Table.prototype.clone = function(){
                    return mxUtils.clone(this);
                };

                // Checks if the browser is supported
                if (!mxClient.isBrowserSupported()) {
                    // Displays an error message if the browser is not supported.
                    mxUtils.error('Browser is not supported!', 200, false);
                } else {
                    // Specifies shadow opacity, color and offset
                    mxConstants.SHADOW_OPACITY = 0.5;
                    mxConstants.SHADOWCOLOR = '#C0C0C0';
                    mxConstants.SHADOW_OFFSET_X = 5;
                    mxConstants.SHADOW_OFFSET_Y = 6;
                    
                    // Table icon dimensions and position
                    mxSwimlane.prototype.imageSize = 20;
                    mxSwimlane.prototype.imageDx = 16;
                    mxSwimlane.prototype.imageDy = 4;
                    
                    // Changes swimlane icon bounds
                    mxSwimlane.prototype.getImageBounds = function(x, y, w, h) {
                        return new mxRectangle(x + this.imageDx, y + this.imageDy, this.imageSize, this.imageSize);
                    };
                    
                    // Defines an icon for creating new connections in the connection handler.
                    // This will automatically disable the highlighting of the source vertex.
                    mxConnectionHandler.prototype.connectImage = new mxImage('/fs/assets/images/graph/tools/connector.gif?type=open&issys=true', 16, 16);

                    // Prefetches all images that appear in colums
                    // to avoid problems with the auto-layout
                    var keyImage = new Image();
                    keyImage.src = "/fs/assets/images/graph/tools/key.png?type=open&issys=true";

                    var plusImage = new Image();
                    plusImage.src = "/fs/assets/images/graph/tools/plus.png?type=open&issys=true";

                    var checkImage = new Image();
                    checkImage.src = "/fs/assets/images/graph/tools/check.png?type=open&issys=true";
                    
                    // Workaround for Internet Explorer ignoring certain CSS directives
                    if (mxClient.IS_QUIRKS) {
                        document.body.style.overflow = 'hidden';
                        new mxDivResizer(container);
                        new mxDivResizer(outline);
                        new mxDivResizer(sidebar);
                    }
                    
                    // Creates the graph inside the given container. The
                    // editor is used to create certain functionality for the
                    // graph, such as the rubberband selection, but most parts
                    // of the UI are custom in this example.
                    let editor = null;
                    this.editor = editor = new mxEditor();
                    let graph = editor.graph;
                    let model = graph.model;
                    
                    // Disables some global features
                    graph.setConnectable(true);
                    graph.setCellsDisconnectable(false);
                    graph.setCellsCloneable(false);
                    graph.swimlaneNesting = false;
                    graph.dropEnabled = true;

                    // Does not allow dangling edges
                    graph.setAllowDanglingEdges(false);

                    // Clones the source if new connection has no target
                    graph.connectionHandler.setCreateTarget(true);
                    
                    // Forces use of default edge in mxConnectionHandler
                    graph.connectionHandler.factoryMethod = null;

                    // Only tables are resizable
                    graph.isCellResizable = function(cell) {
                        return this.isSwimlane(cell);
                    };
                    
                    // Only tables are movable
                    graph.isCellMovable = function(cell) {
                        return this.isSwimlane(cell);
                    };

                    // Sets the graph container and configures the editor
                    editor.setGraphContainer(container);
                    // var config = mxUtils.load(
                    //     'editors/config/keyhandler-minimal.xml').
                    //         getDocumentElement();
                    // editor.configure(config);

                    // Configures the automatic layout for the table columns
                    editor.layoutSwimlanes = true;
                    editor.createSwimlaneLayout = function () {
                        var layout = new mxStackLayout(editor.graph, false);
                        layout.fill = true;
                        layout.resizeParent = true;
                        
                        // Overrides the function to always return true
                        layout.isVertexMovable = function(cell) {
                            return true;
                        };
                        
                        return layout;
                    };
                    
                    // Text label changes will go into the name field of the user object
                    graph.model.valueForCellChanged = function(cell, value) {
                        if (value.name != null) {
                            return mxGraphModel.prototype.valueForCellChanged.apply(this, arguments);
                        } else {
                            var old = cell.value.name;
                            cell.value.name = value;
                            return old;
                        }
                    };
                    
                    // Columns are dynamically created HTML labels
                    graph.isHtmlLabel = function(cell) {
                        return !this.isSwimlane(cell) &&
                            !this.model.isEdge(cell);
                    };
                    
                    // Edges are not editable
                    graph.isCellEditable = function(cell) {
                        return !this.model.isEdge(cell);
                    };
                    
                    // Returns the name field of the user object for the label
                    graph.convertValueToString = function(cell) {
                        if (cell.value != null && cell.value.name != null)
                        {
                            return cell.value.name;
                        }

                        return mxGraph.prototype.convertValueToString.apply(this, arguments); // "supercall"
                    };
                    
                    // Returns the type as the tooltip for column cells
                    graph.getTooltip = function(state) {
                        if (this.isHtmlLabel(state.cell))
                        {
                            return 'Type: '+state.cell.value.type;
                        }
                        else if (this.model.isEdge(state.cell))
                        {
                            var source = this.model.getTerminal(state.cell, true);
                            var parent = this.model.getParent(source);
                            
                            return parent.value.name+'.'+source.value.name;
                        }
                        
                        return mxGraph.prototype.getTooltip.apply(this, arguments); // "supercall"
                    };
                    
                    // Creates a dynamic HTML label for column fields
                    graph.getLabel = function(cell) {
                        if (this.isHtmlLabel(cell)) {
                            var label = '';
                            
                            if (cell.value.iskey){
                                label += '<img title="Primary Key" src="/fs/assets/images/graph/tools/key.png?type=open&issys=true" width="16" height="16" align="top">&nbsp;';
                            } else {
                                label += '<img src="/fs/assets/images/graph/tools/spacer.gif?type=open&issys=true" width="16" height="1">&nbsp;';
                            }
                                                    
                            if (cell.value.isindex) {
                                label += '<img src="/fs/assets/images/graph/tools/index.png?type=open&issys=true" width="16" height="16" align="top">&nbsp;';
                            } else {
                                label += '<img src="/fs/assets/images/graph/tools/spacer.gif?type=open&issys=true" width="16" height="1">&nbsp;';
                            }

                            return label + mxUtils.htmlEntities(cell.value.name, false) + ': ' +
                                mxUtils.htmlEntities(cell.value.ftype, false);
                        }
                        
                        return mxGraph.prototype.getLabel.apply(this, arguments); // "supercall"
                    };
                    
                    // Removes the source vertex if edges are removed
                    graph.addListener(mxEvent.REMOVE_CELLS, function(sender, evt) {
                        self.summaryInfo();
                    });

                    // Add the source vertex
                    graph.addListener(mxEvent.ADD_CELLS, function(sender, evt) {
                        self.summaryInfo();
                    });

                    // Disables drag-and-drop into non-swimlanes.
                    graph.isValidDropTarget = function(cell, cells, evt) {
                        return this.isSwimlane(cell);
                    };

                    // Installs a popupmenu handler using local function (see below).
                    graph.popupMenuHandler.factoryMethod = function(menu, cell, evt){
                        self.createPopupMenu(editor, graph, menu, cell, evt);
                    };

                    // Adds all required styles to the graph (see below)
                    this.configureStylesheet(graph);
                    
                    // Adds sidebar icon for the table object
                    var tableObject = new Table('CLASSNAME');
                    var table = new mxCell(tableObject, new mxGeometry(0, 0, 200, 28), 'table');
                    table.setVertex(true);
                    this.addSidebarIcon(graph, sidebar, table, '/fs/assets/images/graph/tools/table.png?type=open&issys=true');
                    
                    // Adds sidebar icon for the column object
                    var columnObject = new Column('COLUMNNAME');
                    var column = new mxCell(columnObject, new mxGeometry(0, 0, 0, 26));
                    column.setVertex(true);
                    column.setConnectable(false);

                    this.addSidebarIcon(graph, sidebar, column, '/fs/assets/images/graph/tools/column.png?type=open&issys=true');
                    
                    // Adds primary key field into table
                    var firstColumn = column.clone();
                    
                    firstColumn.value.name = 'CLASSNAME_ID';
                    firstColumn.value.title = '';
                    firstColumn.value.ftype = 'varchar';
                    firstColumn.value.iskey = true;
                    firstColumn.value.isindex = false;
                    
                    table.insert(firstColumn);

                    // Adds child columns for new connections between tables
                    /* graph.addEdge = function(edge, parent, source, target, index) {
                        Finds the primary key child of the target table
                        var iskey = null;
                        var childCount = this.model.getChildCount(target);
                        
                        for (var i=0; i < childCount; i++) {
                            var child = this.model.getChildAt(target, i);
                            
                            if (child.value.iskey)
                            {
                                iskey = child;
                                break;
                            }
                        }
                        
                        if (iskey == null) {
                            self.$message({
                                type: "info",
                                message: "类需要定义主键！"
                            })
                            return;
                        }
                    
                        this.model.beginUpdate();
                        try {
                            var col1 = this.model.cloneCell(column);
                            col1.value.name = iskey.value.name;
                            col1.value.ftype = iskey.value.ftype;
                            col1.value.title = iskey.value.title;
                        
                            this.addCell(col1, source);
                            source = col1;				
                            target = iskey;
                            
                            return mxGraph.prototype.addEdge.apply(this, arguments); // "supercall"
                        } finally {
                            this.model.endUpdate();
                        }
                        
                        return null;
                    }; */
                    
                    // Defines action
                    editor.addAction('mxProperties', (editor, cell)=>{
                        console.log('mxProperties 1 ',cell)
                        if (cell == null) {
                            cell = graph.getSelectionCell();
                        }
                        
                        if (graph.isHtmlLabel(cell)) {
                            console.log('mxProperties 2 ',cell)
                            this.showProperties(graph, cell);
                        }
                    });
                    // Defines a create MQL action
                    editor.addAction('showMql', (editor, cell)=>{
                        var mql = this.createMql(graph);
                        
                        if (mql.length > 0){
                            this.showDialogInfo('MQL', mql);
                        } else {
                            this.$message({
                                type: "info",
                                message: "MQL为空!"
                            })
                        }
                    });

                    // Defines export XML action
                    editor.addAction('export', (editor, cell)=>{
                        let enc = new mxCodec(mxUtils.createXmlDocument());
                        let node = enc.encode(editor.graph.getModel());
                        
                        this.showDialogSource('源文件', mxUtils.getPrettyXml(node));
                    });

                    // Defines Delete action
                    editor.addAction('deleteAll',(editor,cell)=>{
                        this.deleteCells(true);
                    })

                    // Defines Auto Save XML action
                    // var mgr = new mxAutoSaveManager(editor.graph);
                    // mgr.autoSaveDelay = 5;
                    // mgr.save = function(){
                    //     self.onSave()
                    // };

                    // Animates the changes in the graph model
                    // graph.getModel().addListener(mxEvent.CHANGE, (sender, evt)=>{
                    //     var changes = evt.getProperty('edit').changes;
                    //     mxEffects.animateChanges(graph, changes);
                    // });
                    
                }
            }, 
            summaryInfo(){
                this.docInfo.classes.list = [];
                this.docInfo.columns.list = [];

                let parent = this.editor.graph.getDefaultParent();
                let childCount = this.editor.graph.model.getChildCount(parent);

                for(var i=0; i<childCount; i++){
                    var child = this.editor.graph.model.getChildAt(parent, i);
                    if (!this.editor.graph.model.isEdge(child)){
                        
                        // Classes
                        this.docInfo.classes.list.push(child.value.name);
                        
                        var columnCount = this.editor.graph.model.getChildCount(child);

                        if (columnCount > 0){
                            for (var j=0; j<columnCount; j++){
                                // Columns
                                this.docInfo.columns.list.push(this.editor.graph.model.getChildAt(child, j).value);
                            }
                        }
                    }
                }
            },
            showDialogProperties(className, columnName, cell){
                this.dialogProperties.title = className;
                _.extend(this.dialogProperties, {cell:cell});
                this.dialogProperties.visible = true;
            },
            showDialogInfo(title, content) {
                
                this.dialogInfo.title = "";
                this.dialogInfo.content = "";
                this.dialogInfo.title = title;
                this.dialogInfo.visible = true;
                
                _.delay(()=>{
                    // Editor
                    let editor = ace.edit(this.$refs.dialogInfoEditor.$el);
                    editor.setOptions({
                        //maxLines: 1000,
                        minLines: 20,
                        autoScrollEditorIntoView: true,
                        enableBasicAutocompletion: true,
                        enableSnippets: true,
                        enableLiveAutocompletion: true
                    });
                    editor.setTheme("ace/theme/tomorrow");
                    editor.getSession().setMode("ace/mode/mql");
                    editor.setValue(content);
                },50)
            },
            showDialogSource(title, content) {
                this.dialogSource.title = "";
                this.dialogSource.content = "";

                this.dialogSource.title = title;
                this.dialogSource.visible = true;

                _.delay(()=>{
                    // Editor
                    let editor = ace.edit(this.$refs.dialogSourceEditor.$el);
                    editor.setOptions({
                        //maxLines: 1000,
                        minLines: 20,
                        autoScrollEditorIntoView: true,
                        enableBasicAutocompletion: true,
                        enableSnippets: true,
                        enableLiveAutocompletion: true
                    });
                    editor.setTheme("ace/theme/tomorrow");
                    editor.getSession().setMode("ace/mode/xml");
                    editor.setValue(content);
                },50)
            },
            addSidebarIcon(graph, sidebar, prototype, image){
                // Function that is executed when the image is dropped on
                // the graph. The cell argument points to the cell under
                // the mousepointer if there is one.
                const self = this;
                var funct = function(graph, evt, cell) {
                    graph.stopEditing(false);

                    var pt = graph.getPointForEvent(evt);
                    
                    var parent = graph.getDefaultParent();
                    var model = graph.getModel();
                    
                    var isTable = graph.isSwimlane(prototype);
                    var name = null;				
                    
                    if (!isTable) {
                        parent = cell;
                        var pstate = graph.getView().getState(parent);
                        
                        if (parent == null || pstate == null){
                            self.$message({
                                type: "info",
                                message: "请先确定类！"
                            })

                            return;
                        }
                        
                        pt.x -= pstate.x;
                        pt.y -= pstate.y;

                        var columnCount = graph.model.getChildCount(parent)+1;
                        name = '属性'+columnCount;
                    } else {
                        var tableCount = 0;
                        var childCount = graph.model.getChildCount(parent);
                        
                        for (var i=0; i<childCount; i++) {
                            if (!graph.model.isEdge(graph.model.getChildAt(parent, i))) {
                                tableCount++;
                            }
                        }
                        
                        var name = '/新类'+(tableCount+1);
                    }
                    
                    if (name != null) {
                        var v1 = model.cloneCell(prototype);
                        
                        model.beginUpdate();
                        try {
                            v1.value.name = name;
                            v1.geometry.x = pt.x;
                            v1.geometry.y = pt.y;
                            
                            graph.addCell(v1, parent);
                            
                            if (isTable) {
                                v1.geometry.alternateBounds = new mxRectangle(0, 0, v1.geometry.width, v1.geometry.height);
                                v1.children[0].value.name = name + '_ID';
                            }
                        } finally {
                            model.endUpdate();
                        }
                        
                        graph.setSelectionCell(v1);
                    }
                }
                
                // Creates the image which is used as the sidebar icon (drag source)
                var img = document.createElement('img');
                img.setAttribute('src', image);
                img.style.width = '48px';
                img.style.height = '48px';
                img.title = 'Drag this to the diagram to create a new vertex';
                sidebar.appendChild(img);
                                    
                // Creates the image which is used as the drag icon (preview)
                var dragImage = img.cloneNode(true);
                var ds = mxUtils.makeDraggable(img, graph, funct, dragImage);

                // Adds highlight of target tables for columns
                ds.highlightDropTargets = true;
                ds.getDropTarget = function(graph, x, y) {
                    if (graph.isSwimlane(prototype)) {
                        return null;
                    } else {
                        var cell = graph.getCellAt(x, y);
                        
                        if (graph.isSwimlane(cell)) {
                            return cell;
                        } else {
                            var parent = graph.getModel().getParent(cell);
                            
                            if (graph.isSwimlane(parent))
                            {
                                return parent;
                            }
                        }
                    }
                }
            },
            applyMqlToFile(){
                let doc = mxUtils.parseXml(this.dialogSource.content);
                let codec = new mxCodec(doc);
                codec.decode(doc.documentElement, this.editor.graph.getModel());
                this.dialogSource.visible = false;
            },
            configureStylesheet(graph) {
                var style = new Object();
                style[mxConstants.STYLE_SHAPE] = mxConstants.SHAPE_RECTANGLE;
                style[mxConstants.STYLE_PERIMETER] = mxPerimeter.RectanglePerimeter;
                style[mxConstants.STYLE_ALIGN] = mxConstants.ALIGN_LEFT;
                style[mxConstants.STYLE_VERTICAL_ALIGN] = mxConstants.ALIGN_MIDDLE;
                style[mxConstants.STYLE_FONTCOLOR] = '#000000';
                style[mxConstants.STYLE_FONTSIZE] = '12';
                style[mxConstants.STYLE_FONTSTYLE] = 0;
                style[mxConstants.STYLE_SPACING_LEFT] = '4';
                style[mxConstants.STYLE_IMAGE_WIDTH] = '48';
                style[mxConstants.STYLE_IMAGE_HEIGHT] = '48';
                graph.getStylesheet().putDefaultVertexStyle(style);

                style = new Object();
                style[mxConstants.STYLE_SHAPE] = mxConstants.SHAPE_SWIMLANE;
                style[mxConstants.STYLE_PERIMETER] = mxPerimeter.RectanglePerimeter;
                style[mxConstants.STYLE_ALIGN] = mxConstants.ALIGN_RIGHT;
                style[mxConstants.STYLE_VERTICAL_ALIGN] = mxConstants.ALIGN_TOP;
                style[mxConstants.STYLE_GRADIENTCOLOR] = '#41B9F5';
                style[mxConstants.STYLE_FILLCOLOR] = '#8CCDF5';
                style[mxConstants.STYLE_SWIMLANE_FILLCOLOR] = '#ffffff';
                style[mxConstants.STYLE_STROKECOLOR] = '#1B78C8';
                style[mxConstants.STYLE_FONTCOLOR] = '#FFFFFF';
                style[mxConstants.STYLE_STROKEWIDTH] = '1';
                style[mxConstants.STYLE_STARTSIZE] = '28';
                style[mxConstants.STYLE_VERTICAL_ALIGN] = 'middle';
                style[mxConstants.STYLE_FONTSIZE] = '12';
                style[mxConstants.STYLE_FONTSTYLE] = 1;
                style[mxConstants.STYLE_IMAGE] = '/fs/assets/images/graph/tools/table.png?type=open&issys=true';
                // Looks better without opacity if shadow is enabled
                //style[mxConstants.STYLE_OPACITY] = '80';
                style[mxConstants.STYLE_SHADOW] = 1;
                graph.getStylesheet().putCellStyle('table', style);

                style = graph.stylesheet.getDefaultEdgeStyle();
                style[mxConstants.STYLE_LABEL_BACKGROUNDCOLOR] = '#FFFFFF';
                style[mxConstants.STYLE_STROKEWIDTH] = '2';
                style[mxConstants.STYLE_ROUNDED] = true;
                style[mxConstants.STYLE_EDGE] = mxEdgeStyle.EntityRelation;
            },
            // Function to create the entries in the popupmenu
            createPopupMenu(editor, graph, menu, cell, evt) {
                if (cell != null) {
                    
                    if (graph.isHtmlLabel(cell)){
                        menu.addItem('属性', null, function(){
                            editor.execute('mxProperties', cell);
                        });
                        menu.addSeparator();
                    }
                    
                    menu.addItem('删除', null, function(){
                        editor.execute('delete', cell);
                    });
                    menu.addSeparator();
                }

                menu.addItem('撤销', null, function(){
                    editor.execute('undo', cell);
                });
                
                menu.addItem('重做', null, function(){
                    editor.execute('redo', cell);
                });

                menu.addSeparator();

                menu.addItem('清空', null, function(){
                    editor.execute('deleteAll');
                });
                
                menu.addSeparator();
                
                menu.addItem('显示MQL', null, function(){
                    editor.execute('showMql', cell);
                });	
                menu.addItem('执行MQL', null, function(){
                    editor.execute('showMql', cell);
                });	
            },
            showProperties(graph, cell){
                console.log('showProperties ', cell)
                
                var parent = graph.model.getParent(cell);
                var className = parent.value.name;
                var columnName = cell.value.name;
                this.showDialogProperties(className,columnName, cell);
            },
            onUpdateProperties(cell){
                console.log('onUpdateProperties ',cell.value)
                let clone = cell.value.clone();
				
                this.editor.graph.model.setValue(cell, clone);
                
                this.onSave();

                this.dialogProperties.visible = false;

            },  
            createMql(graph) {
                let mql = [[],[],[]];
                let parent = graph.getDefaultParent();
                let childCount = graph.model.getChildCount(parent);

                for (var i=0; i<childCount; i++){
                    var child = graph.model.getChildAt(parent, i);
                    
                    if (!graph.model.isEdge(child)){

                        mql[0].push('CREATE CLASS IF NOT EXISTS '+child.value.name+' (');
                        
                        var columnCount = graph.model.getChildCount(child);

                        if (columnCount > 0){
                            for (var j=0; j<columnCount; j++){
                                var column = graph.model.getChildAt(child, j).value;
                                
                                mql[0].push('\n    '+column.name+'  '+column.ftype+'  "'+column.title + '"');
                                
                                if (column.iskey){
                                    mql[1].push(column.name);
                                }
                                
                                if (column.isindex) {
                                    mql[2].push(column.name);
                                }
                                
                                mql[0].push(',');
                            }
                            // merge key
                            if(!_.isEmpty(mql[1])){
                                mql[0].push('\n key('+mql[1].join(',')+')');
                                mql[0].push(',');
                            }
                            // merge index
                            if(!_.isEmpty(mql[2])){
                                mql[0].push('\n index('+mql[2].join(',')+')');
                                mql[0].push(',');
                            }

                            mql[0].splice(mql[0].length-1, 1);
                            mql[0].push('\n);');

                            
                        }
                        
                        mql[0].push('\n');
                    }
                }

                

                return mql[0].join('');
            },
            onNew(){
                this.deleteCells(true);
                this.summaryInfo();
                this.doc = null;
            },
            onOpen(){
                try{
                    this.doc = this.$refs.dfsOpen.node;
                    let xml = fsHandler.fsContent(this.doc.parent, this.doc.name);
                    let doc = mxUtils.parseXml(xml);
                    let codec = new mxCodec(doc);
                    codec.decode(doc.documentElement, this.editor.graph.getModel());
                } catch(err){
                    console.error(err);
                } finally {
                    this.dialogOpen.visible = false;

                    this.summaryInfo();

                    _.delay(()=>{
                        this.editor.execute('fit');
                    },2000)
                    
                }
                
            },
            onSaveAs(){
                
                let enc = new mxCodec(mxUtils.createXmlDocument());
                let node = enc.encode(this.editor.graph.getModel());
                let xml = mxUtils.getPrettyXml(node);
                let attr = {};
                
                let parent = this.$refs.dfsSaveas.node.fullname;
                let name = this.$refs.dfsSaveas.node.name;
                let rtn = fsHandler.fsNew('file',parent, name, xml, attr);
                if(rtn == 1){
                    this.$message({
                        type:"success",
                        message: "保存成功！"
                    })
                }
                this.dialogSaveAs.visible = false;
            },
            onSave(){
                if(this.doc){
                    let enc = new mxCodec(mxUtils.createXmlDocument());
                    let node = enc.encode(this.editor.graph.getModel());
                    let xml = mxUtils.getPrettyXml(node);
                    let attr = _.extend(this.doc, {});
                    let rtn = fsHandler.fsNew('file',this.doc.parent, this.doc.name, xml, attr);
                    if(rtn == 1){
                        this.$message({
                            type:"success",
                            message: "保存成功！"
                        })
                    }
                } else {
                    // this.$message({
                    //     type: "info",
                    //     message: "该文档未保存！"
                    // })
                    this.dialogSaveAs.visible = true;
                }
            },
            onClose(){
                this.editor.execute("deleteAll");
                this.doc = null;
                this.summaryInfo();
            },
            onDelete(){
                if(this.doc){

                    this.$confirm(`确认要删除该设计文档：${this.doc.name}？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        let rtn = fsHandler.fsDelete(this.doc.parent,this.doc.name);
    
                        if (rtn == 1){
                            this.$message({
                                type: "success",
                                message: "删除成功！"
                            });
                            this.deleteCells(true);
                            this.doc = null;
                            this.summaryInfo();
                        } else {
                            this.$message({
                                type: "error",
                                message: "删除失败 " + rtn.message
                            })
                        } 
                    }).catch(() => {
                        
                    });
                }
            },
            deleteCells(includeEdges){
                
                // Cancels interactive operations
                let graph = this.editor.graph;
                graph.escape();
                //var cells = graph.getDeletableCells(graph.getSelectionCells());
                let cells = graph.getChildVertices(graph.getDefaultParent());
                if (cells != null && cells.length > 0){
                    var parents = graph.model.getParents(cells);
                    graph.removeCells(cells, includeEdges);
                    
                    // Selects parents for easier editing of groups
                    if (parents != null){
                        var select = [];
                        
                        for (var i = 0; i < parents.length; i++){
                            if (graph.model.contains(parents[i]) &&
                                (graph.model.isVertex(parents[i]) ||
                                graph.model.isEdge(parents[i]))){
                                select.push(parents[i]);
                            }
                        }
                        graph.setSelectionCells(select);
                    }
                }
            }
		}
	
	}
	</script>

</code>
