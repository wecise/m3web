<code>

        <style scoped>
            /*----------  style  ----------*/
            .fs-view-component .fs-node-highlight {
                -webkit-box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
                -moz-box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
                box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
            }
    
            .fs-view-component .fs-node-selected {
                -webkit-box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
                -moz-box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
                box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
            }
            
            .fs-view-component .fs-node-selected::before {
                content: '\2713 ';
                font-size: 16px;
                font-weight: 600;
                color: rgba(37, 45, 73, 0.5);
                position: absolute;
                bottom: 5px;
                right: 5px;
            }
    
            .fs-view-component .fs-footer{
                position:fixed;
                bottom:30px;
            }
    
            .editable-click, a.editable-click, a.editable-click:hover {
                border-bottom: none;
            }
    
            .fs-view-component .fa-bars {
                color: rgb(144, 144, 144);
            }

            #fs-editor-main > .el-tabs > .el-tabs__header{
                clear:both;
                min-height: 30px;
            }
    
            /* For note-view */
            #note {
                padding-left:0px;
                flex-flow: nowrap;
                display: flex;
                flex-direction: column;
            }
    
            #note ul{
                padding-left: 0;
                list-style: none;
            }
    
            #note ul > li{
                width: 20em;
                float: left;
                height: 250px;
                padding: 5px;
                font-size: 10px;
                line-height: 1;
                text-align: center;
            }
    
            #note .bg-silver {
                background: rgb(255, 255, 255) !important;
                border: 1px solid rgb(221, 221, 221);
            }
    
            #note .widget-stats.bg-silver .stats-link a{
                background: rgb(249, 249, 249);
            }
    
            #note .tags{
                border: none;
            }
    
            #note .fs-name i {
                color: rgb(153, 153, 153);
            }
    
            /* For list-view */
            #list {
                padding-left:0px;
                flex-flow: nowrap;
                display: flex;
                flex-direction: column;
            }
    
            #list ul{
                padding-left: 0;
                list-style: none;
            }
    
            #list ul > li{
                width: 20em;
                float: left;
                height: 250px;
                padding: 5px;
                font-size: 10px;
                line-height: 1;
                text-align: center;
            }
    
            #list .bg-silver {
                background: rgb(255, 255, 255) !important;
                border: 1px solid #f6f6f6;
            }
    
            #list .widget-stats.bg-silver .stats-link a{
                background: rgb(249, 249, 249);
            }
    
            #list .tags{
                border: none;
            }
    
            #list .fs-name i {
                color: rgb(153, 153, 153);
            }
    
    
            /* For grid-view */
            #grid ul{
                padding-left: 0;
                list-style: none;
            }
    
            #grid ul > li{
                float: left;
                width: 10em;
                height: 105px;
                font-size: 10px;
                line-height: 1.4;
                text-align: center;
                background-color: rgb(249, 249, 249);
                border: 1px solid rgb(255, 255, 255);
                margin: 5px 5px 0px 0px;
            }
    
    
            #fs-deploy-icon-list ul,
            #icon-list ul{
                padding-left: 0;
                list-style: none;
            }
    
            #fs-deploy-icon-list ul > li,
            #icon-list ul > li{
                float: left;
                width: 7.3em;
                height: 115px;
                padding: 10px;
                font-size: 10px;
                line-height: 1.4;
                text-align: center;
                background-color: rgb(249, 249, 249);
                border: 1px solid rgb(255, 255, 255);
            }
    
            .media-object {
                width: 48px;
                height: 48px;
            }
    
            /*
            *   File Upload
            */
            .progress {
                height: 18px;
                border-radius: 0px;
                display: block;
                position: relative;
                bottom: 16px;
            }
    
            .progress small {
                color: #444444;
                width: 100%;
                position: absolute;
                z-index: 10;
                top: 0;
                left: 0;
            }
    
            #files ul{
                margin: 10px;
                padding-left: 0;
                list-style: none;
            }
    
            #files ul > li{
                float: left;
                width: 100pt;
                height: 100px;
                font-size: 12px;
                line-height: 1.4;
                text-align: center;
                background-color: rgb(249, 249, 249);
                border: 1px solid rgb(255, 255, 255);
                padding-top: 5px;
                margin: 5px 0px 20px 5px;
            }
    
            #files ul > li > canvas {
                height: 65%;
                width: auto;
            }
    
            #files ul > li > a {
                background-color: rgb(249, 249, 249);
                border-radius: 0px;
            }
    
            #files ul > li > button {
                margin-top: -50px;
            }
    
            #files ul > li > .preview-null {
                width: 100px;
                padding-top: 10px;
                height: 64px;
                color: rgb(221, 221, 221);
            }
    
            .preview-img-responsive{
                max-width: 100%;
                height: auto;
                display: block;
            }
    
            .fs-view-component #grid,
            .fs-view-component .dataTables_scroll{
                height: 75vh;
                overflow: auto;
                padding: 0 10px;
            }
    
            .fs-name {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }
    
    
            /* For view-container */
            .note-view,
            .list-view,
            .grid-view,
            .table-view{
                overflow: auto;
                height: calc(100vh - 185px);/* 70vh; */
            }
            
            .fs-view-component{
                height: 100%;
            }

            .el-icon-caret-right:before{
                color: #333333;
            }

            /* el tabs */
            .el-tabs__item {
                height: 30px;
                line-height: 30px;
                font-size: 12px;
            }
            .el-tabs__nav-prev,
            .el-tabs__nav-next{
                line-height: 30px;
            }

            .el-card__header{
                padding:0 5px;
            }
            .el-card__header > .clearfix > span {
                font-size: 14px;
                font-weight: 600;
            }
            
            .el-tabs--border-card{
                border:none;
                -webkit-box-shadow:unset;
                box-shadow:unset;
            }
            .el-tabs--border-card>.el-tabs__content {
                padding: 0px;
                height: 100%;
            }

            .el-tabs--border-card>.el-tabs__header {
                border-bottom: unset;
            }

            .el-tabs--border-card>.el-tabs__header .el-tabs__item.is-active {
                border-right-color: #ffffff;
                border-left-color: #ffffff;
            }

            .el-tree-node__content:hover {
                background-color: #f6f6f6;
            }
            .el-tree-node:focus>.el-tree-node__content {
                background-color: #b2dcfa;
            }
    
        </style>
    
        
        /*----------  最外层element会自动增加组件同名 class="fs-view-component"  ----------*/
        <template>
            <el-container>
                <el-header style="padding:0 10px;height:50px;line-heigh:50px;margin-bottom:10px;">
                    <el-row>
                        <el-col :span="24">
                            <!-- <el-breadcrumb>
                                <el-breadcrumb-item @click="openIt(null,'/')">${rootName}</el-breadcrumb-item>
                                <el-breadcrumb-item @click="openIt(item,_.slice(filePath,0,index+1).join('/'))" v-for="(item,index) in filePath">${item}</el-breadcrumb-item>
                            </el-breadcrumb> -->
                            <ul style="list-style: none;display: flex;padding:0px;height:20px;line-height:20px;">
                                <li>
                                    <el-button type="text" @click="openIt(null,'/')" icon="el-icon-s-home"> ${rootName} </el-button>
                                </li>
                                <li>
                                    <ol class="breadcrumb">
                                        <li v-for="(item,index) in filePath" >
                                            <el-button type="text" @click="openIt(item,_.slice(filePath,0,index+1).join('/'))">${item}</el-button>               
                                        </li>
                                    </ol>
                                </li>
                            </ul>
                        </el-col>
                    </el-row>
                
                    <el-row>
                        <el-col :span="24">
                            <div style="padding:0px;text-align:right;height:30px;line-height:30px;width:100%;">
    
                                <el-button-group style="margin-right:10px;">
                                    <el-tooltip content="格子视图" placement="top">
                                        <el-button type="text" @click="currentView='list-view'" icon="el-icon-picture">
                                        </el-button>
                                    </el-tooltip>
                                    <el-tooltip content="列表视图" placement="top">
                                        <el-button type="text" @click="currentView='grid-view'" icon="el-icon-s-grid">
                                        </el-button>
                                    </el-tooltip>
                                    <el-tooltip content="表格视图" placement="top">
                                        <el-button type="text" @click="currentView='table-view'" icon="el-icon-menu">
                                        </el-button>
                                    </el-tooltip>
                                </el-button-group>

                                <el-tooltip content="刷新" placement="top">
                                    <el-button type="text" @click="load();refreshTree();" icon="el-icon-refresh">
                                    </el-button>
                                </el-tooltip>

                                <el-tooltip content="排序" placement="top">
                                    <el-button type="text" class="fs-order" icon="el-icon-sort">
                                    </el-button>
                                </el-tooltip>
    
                                <el-tooltip content="新建目录" placement="top">
                                    <el-button type="text" @click="newDir" icon="el-icon-folder-add">
                                    </el-button>
                                </el-tooltip>
    
                                <el-tooltip content="新建文件" placement="top">
                                    <el-button type="text" @click="newFile" icon="el-icon-document-add">
                                    </el-button>
                                </el-tooltip>
    
                                <el-tooltip content="选择所有" placement="top">
                                    <el-button type="text" @click="selectAll" icon="el-icon-document-checked">
                                    </el-button>
                                </el-tooltip>
    
                                <el-tooltip content="复制到" placement="top">
                                    <el-button type="text" @click="copyTo" icon="el-icon-document-copy">
                                    </el-button>
                                </el-tooltip>
    
                                <el-tooltip content="移动到" placement="top">
                                    <el-button type="text" @click="moveTo" icon="el-icon-shopping-cart-full">
                                    </el-button>
                                </el-tooltip>
                                
                                <!--el-tooltip content="复制" placement="top">
                                    <el-button type="text" @click="copyThem">
                                        <i class="fas fa-copy"></i>
                                    </el-button>
                                </el-tooltip>
    
                                <el-tooltip content="粘贴到" placement="top">
                                    <el-button type="text" @click="pasteIt">
                                        <i class="fas fa-paste"></i>
                                    </el-button>
                                </el-tooltip>
    
                                <el-tooltip content="移动到" placement="top">
                                    <el-button type="text" @click="moveIt">
                                        <i class="fas fa-people-carry"></i>
                                    </el-button>
                                </el-tooltip-->
    
                                <el-tooltip content="删除" placement="top">
                                    <el-button type="text" @click="deleteThem" icon="el-icon-delete">
                                    </el-button>
                                </el-tooltip>
    
                                <el-tooltip content="上传文件" placement="top">
                                    <el-button type="text" class="fileinput-button" style="color:#16e216;" icon="el-icon-upload">
                                        <input id="file-upload" type="file" name="uploadfile" multiple>
                                    </el-button>
                                </el-tooltip>
                                <!--<el-button type="text" @click="downloadThem">
                                    <i class="fas fa-download""></i>
                                </el-button>-->
                                <!-- <el-button type="text" @click="toggleView('grid-view')">
                                    <i class="fas fa-th"></i>
                                </el-button>
                                <el-button type="text" @click="toggleView('table-view')">
                                    <i class="fas fa-bars"></i>
                                </el-button> -->
                                <el-tooltip content="导出备份" placement="top">
                                    <el-button type="text" @click="exportIt(rootPath)" icon="el-icon-download">
                                    </el-button>
                                </el-tooltip>
    
                                <el-tooltip content="导入恢复" placement="top">
                                    <el-button type="text" class="fileinput-button" icon="el-icon-upload2">
                                        <input type="file" name="loadfile" multiple @change="importIt">
                                    </el-button>
                                </el-tooltip>
    
                                <el-tooltip content="版本同步" placement="top">
                                    <el-button type="text" @click="syncIt" icon="el-icon-attract">
                                    </el-button>
                                </el-tooltip>
    
                            </div>
                        </el-col>
                    </el-row>
                </el-header>
                <el-main style="padding:0 5px;overflow:hidden;">
                    <component v-bind:is="currentView" :model.sync="model" @dblclick.native="resetStatus"></component>
                </el-main>
                <el-footer style="padding:0 10px;height:30px;line-height:30px;">
                    <small>数量：${model.length}  | 已选中：${selectedItem.length} </small>
                </el-footer>
            </el-container>>
    
        </template>
    
        /*----------  id是vue组件的name，内容是vue组件的option参数  ----------*/
        <script id="fs-view-component">
        {
            delimiters: ['${', '}'],
            props: {
                id: String,
                root: String,
                rootName: String,
                defaultView: String
            },
            data: function () {
    
                Vue.component('note-view',{
                    delimiters: ['#{', '}#'],
                    props: {
                        model: Array
                    },
                    template: `<div id="note">
                                   <ul>
                                      <li :class="item.ftype=='dir'?'dir fs-node context-menu-file':'fs-node context-menu-file'"
                                           :id="'fs_node_'+item.id"
                                           @mouseover="eventHub.$emit('FS-NODE-MOUSEOVER-EVENT',item)"
                                           @mouseout="eventHub.$emit('FS-NODE-MOUSEOUT-EVENT',item)"
                                           style="cursor: pointer;"
                                           :title="item.name"
                                           v-for="item in model">
                                          <div class="widget widget-stats bg-silver animated flipInX" :id="'fs_node_widget_'+item.id" @click="eventHub.$emit('FS-NODE-SELECTIT-EVENT',item)" @dblclick="eventHub.$emit('FS-NODE-OPENIT-EVENT',item, item.parent+'/'+item.name)">
                                              <div class="stats-info">
                                                  <p><img class="media-object" :src="item | pickIcon" onerror="this.src='${window.ASSETS_ICON}files/png/dir.png?type=open&issys=${window.SignedUser_IsAdmin}';"></p>
                                              </div>
                                              <div class="stats-link">
                                                  <a class="fs-name" :data-pk="item.id" href="javascript:void(0);" style="text-align: left;margin:15px -15px -15px -15px;padding: 10px;" :title="item.title" :data-info="JSON.stringify(item)">
                                                      <p style="margin: 0 0 8.5px;"><i class="fas fa-plug"></i>  名称：#{item.name}#</p>
                                                      <p style="margin: 0 0 8.5px;"><i class="fas fa-user"></i>  作者：#{item|pickAuthor}# </p>
                                                      <p style="margin: 0 0 8.5px;"><i class="fas fa-clock"></i> 创建：#{moment(item.vtime).format("YYYY-MM-DD hh:mm:ss")}# </p>
                                                      <!--<p><i class="fas fa-tree"></i>  类型：#{item.ftype=='dir'?'目录':item.ftype}#</p>-->
                                                      <p style="margin: 0 0 8.5px;"><i class="fas fa-tags"></i>  标签：<input type="text" class="tags" name="tags" :value="item|pickTags"></p>
                                                      <p style="margin: 0 0 8.5px;"><i class="fab fa-readme"></i>  描述：#{item|pickRemark}#</p>
                                                  </a>
                                              </div>
                                              <div class="list-context-menu" :data-item="JSON.stringify(item)" style="position: absolute;right: 10px;top: 5px;cursor:pointer;">
                                                  <i class="fa fa-bars"></i>
                                              </div>
                                          </div>
                                      </li>
                                  </ul></div>`,
                    data:function(){
                        return {}
                    },
                    filters: {
                        pickName: function(item){
    
                            if (_.isEmpty(item)) return '';
    
                            let _name = _.head(item.name.split("."));
    
                            if(!_.isEmpty(_name)){
                                _name = _.truncate(_name, {
                                    'length': 9
                                });
                            }
    
                            return _name;
                        },
                        pickIcon: function(item){
    
                            // extend || ...
                            if( item.fullname === '/extend' ){
                                return `${window.ASSETS_ICON}/files/png/dir-lock.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                            } else {
    
                                try{
                                    return _.attempt(JSON.parse.bind(null, item.attr)).icon || `${window.ASSETS_ICON}/files/png/${item.ftype}.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                                }
                                catch(error){
                                    return `${window.ASSETS_ICON}/files/png/${item.ftype}.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                                }
                            }
    
                        },
                        pickTags: function(item){
    
                            if(item.tags){
                                return item.tags.join(",");
                            } else {
                                return "";
                            }
                        },
                        pickAuthor: function(item){
                            if (!_.isEmpty(item.attr) && !_.isEqual(item.attr, 'null')) {
                                return _.attempt(JSON.parse.bind(null, item.attr)).author;
                            } else {
                                return "";
                            }
                        },
                        pickRemark: function(item){
                            if (!_.isEmpty(item.attr) && !_.isEqual(item.attr, 'null')) {
                                return _.attempt(JSON.parse.bind(null, item.attr)).remark;
                            } else {
                                return "";
                            }
                        }
                    },
                    watch:{
                        model:{
                            handler:function(val,oldVal){
                                const me = this;
    
                                let tagify = $('input[name=tags]').data("tagify");
                                
                                if(tagify){
                                    tagify.removeAllTags.bind(tagify);
                                }
                                
                                me.init();
    
                            },
                            deep:true
                        }
                    },
                    mounted: function(){
    
                        const me = this;
    
                        me.init();
    
                    },
                    methods: {
                        init:function(){
                            const me = this;
    
                            // init Tagify script on the above inputs
                            $('input[name=tags]').tagify()
                                .on('add', me.onAddTag)
                                .on('remove', me.onRemoveTag);
                        },
                        onAddTag: function(event,tagName){
                            const me = this;
    
                            let item = $(event.currentTarget).parent().parent().data("info");
    
                            let input = {class: item.class, action: "+", tag: tagName.value, id: item.id};
                            let rtn = fsHandler.callFsJScript("/matrix/tags/tag_service.js", encodeURIComponent(JSON.stringify(input)));
    
                            if(rtn.status == 'ok'){
                                me.$parent.init();
                            }
    
                        },
                        onRemoveTag: function(event,tagName){
                            const me = this;
                            let item = $(event.currentTarget).parent().parent().data("info");
                            let input = {class: item.class, action: "-", tag: tagName.value, id: item.id};
                            let rtn = fsHandler.callFsJScript("/matrix/tags/tag_service.js", encodeURIComponent(JSON.stringify(input)));
    
                            if(rtn.status == 'ok'){
                                me.$parent.init();
                            }
    
                        }
    
                    }
                });
    
                Vue.component('list-view',{
                    delimiters: ['#{', '}#'],
                    props: {
                        model: Array
                    },
                    template: `<div id="list">
                                   <ul>
                                      <li :class="item.ftype=='dir'?'dir fs-node context-menu-file':'fs-node context-menu-file'"
                                           :id="'fs_node_'+item.id"
                                           @mouseover="eventHub.$emit('FS-NODE-MOUSEOVER-EVENT',item)"
                                           @mouseout="eventHub.$emit('FS-NODE-MOUSEOUT-EVENT',item)"
                                           style="cursor: pointer;"
                                           :title="item.name"
                                           v-for="item in model">
                                          <div class="widget widget-stats bg-silver animated flipInX" :id="'fs_node_widget_'+item.id" @click="eventHub.$emit('FS-NODE-SELECTIT-EVENT',item)" @dblclick="eventHub.$emit('FS-NODE-OPENIT-EVENT',item, item.parent+'/'+item.name)">
                                              <div class="stats-info">
                                                  <p><img class="media-object" :src="item | pickIcon" onerror="this.src='${window.ASSETS_ICON}files/png/dir.png?type=open&issys=${window.SignedUser_IsAdmin}';"></p>
                                              </div>
                                              <div class="stats-link">
                                                  <a class="fs-name" :data-pk="item.id" href="javascript:void(0);" style="text-align: left;margin:15px -15px -15px -15px;padding: 10px;" :title="item.title" :data-info="JSON.stringify(item)">
                                                    <p style="margin: 0 0 8.5px;"><i class="fas fa-plug"></i>  名称：#{item.name}#</p>
                                                    <p style="margin: 0 0 8.5px;"><i class="fas fa-user"></i>  作者：#{item|pickAuthor}# </p>
                                                    <p style="margin: 0 0 8.5px;"><i class="fas fa-clock"></i> 创建：#{moment(item.vtime).format("YYYY-MM-DD hh:mm:ss")}# </p>
                                                    <!--<p><i class="fas fa-tree"></i>  类型：#{item.ftype=='dir'?'目录':item.ftype}#</p>-->
                                                    <p style="margin: 0 0 8.5px;"><i class="fas fa-tags"></i>  标签：<input type="text" class="tags" name="tags" :value="item|pickTags"></p>
                                                    <p style="margin: 0 0 8.5px;"><i class="fab fa-readme"></i>  描述：#{item|pickRemark}#</p>
                                                  </a>
                                              </div>
                                              <div class="list-context-menu" :data-item="JSON.stringify(item)" style="position: absolute;right: 10px;top: 5px;cursor:pointer;">
                                                  <i class="fa fa-bars"></i>
                                              </div>
                                          </div>
                                      </li>
                                  </ul></div>`,
                    data:function(){
                        return {}
                    },
                    filters: {
                        pickName: function(item){
    
                            if (_.isEmpty(item)) return '';
    
                            let _name = _.head(item.name.split("."));
    
                            if(!_.isEmpty(_name)){
                                _name = _.truncate(_name, {
                                    'length': 9
                                });
                            }
    
                            return _name;
                        },
                        pickIcon: function(item){
                            // extend || ...
                            if( item.fullname === '/extend' ){
                                return `${window.ASSETS_ICON}/files/png/dir-lock.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                            } else {
    
                                try {
                                    return _.attempt(JSON.parse.bind(null, item.attr)).icon || `${window.ASSETS_ICON}/files/png/${item.ftype}.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                                }
                                catch(error){
                                    return `${window.ASSETS_ICON}/files/png/${item.ftype}.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                                }
                            }
    
                        },
                        pickTags: function(item){
    
                            if(item.tags){
                                return item.tags.join(",");
                            } else {
                                return "";
                            }
                        },
                        pickAuthor: function(item){
                            if (!_.isEmpty(item.attr) || !_.isEqual(item.attr, 'null')) {
                                return _.attempt(JSON.parse.bind(null, item.attr)).author;
                            }
                        },
                        pickRemark: function(item){
                            if (!_.isEmpty(item.attr) || !_.isEqual(item.attr, 'null')) {
                                return _.attempt(JSON.parse.bind(null, item.attr)).remark;
                            }
                        }
                    },
                    watch:{
                      model:{
                          handler:function(val,oldVal){
                              const me = this;
    
                              let tagify = $('input[name=tags]').data("tagify");

                              if(tagify){
                                tagify.removeAllTags.bind(tagify);
                              }
                              me.init();
    
                          },
                          deep:true
                      }
                    },
                    mounted: function(){
    
                        const me = this;
    
                        me.init();
    
                    },
                    methods: {
                        init:function(){
                            const me = this;
    
                            // init Tagify script on the above inputs
                            $('input[name=tags]').tagify()
                                      .on('add', me.onAddTag)
                                      .on('remove', me.onRemoveTag);
                        },
                        onAddTag: function(event,tagName){
                            const me = this;
    
                            let item = $(event.currentTarget).parent().parent().data("info");
    
                            let input = {class: item.class, action: "+", tag: tagName.value, id: item.id};
                            let rtn = fsHandler.callFsJScript("/matrix/tags/tag_service.js", encodeURIComponent(JSON.stringify(input)));
    
                            if(rtn.status == 'ok'){
                                me.$parent.init();
                            }
    
                        },
                        onRemoveTag: function(event,tagName){
                            const me = this;
                            let item = $(event.currentTarget).parent().parent().data("info");
                            let input = {class: item.class, action: "-", tag: tagName.value, id: item.id};
                            let rtn = fsHandler.callFsJScript("/matrix/tags/tag_service.js", encodeURIComponent(JSON.stringify(input)));
    
                            if(rtn.status == 'ok'){
                                me.$parent.init();
                            }
    
                        }
    
                    }
                });
    
                Vue.component('grid-view',{
                    delimiters: ['#{', '}#'],
                    props: {
                        model: Array
                    },
                    template: `<div id="grid">
                                   <ul>
                                      <li  :class="item.ftype=='dir'?'dir fs-node context-menu-file':'fs-node context-menu-file'"
                                           :id="'fs_node_'+item.id"
                                           @mouseover="eventHub.$emit('FS-NODE-MOUSEOVER-EVENT',item)"
                                           @mouseout="eventHub.$emit('FS-NODE-MOUSEOUT-EVENT',item)"
                                           style="cursor: pointer;"
                                           :title="item.name"
                                           v-for="item in model">
                                          <div class="widget widget-stats bg-silver animated flipInX" :id="'fs_node_widget_'+item.id" @click="eventHub.$emit('FS-NODE-SELECTIT-EVENT',item)" @dblclick="eventHub.$emit('FS-NODE-OPENIT-EVENT',item, item.parent+'/'+item.name)" >
                                              <div class="stats-info">
                                                  <p><img class="media-object" :src="item | pickIcon" onerror="this.src='${window.ASSETS_ICON}/files/png/dir.png?type=open&issys=${window.SignedUser_IsAdmin}';"></p>
                                              </div>
                                              <div class="stats-link">
                                                  <a class="fs-name" data-edit="true" :data-pk="item.id" href="javascript:void(0);" style="text-align: left;margin:15px -15px -15px -15px;padding: 5px;" :title="item.name" :data-info="JSON.stringify(item)">
                                                      #{item.name}#
                                                  </a>
                                              </div>
                                              <div class="list-context-menu" :data-item="JSON.stringify(item)" style="position: absolute;right: 10px;top: 5px;cursor:pointer;">
                                                  <i class="fa fa-bars"></i>
                                              </div>
                                          </div>
                                      </li>
                                  </ul></div>`,
                    filters: {
                        pickName: function(item){
    
                            if (_.isEmpty(item)) return '';
    
                            let _name = _.head(item.name.split("."));
    
                            if(!_.isEmpty(_name)){
                                _name = _.truncate(_name, {
                                    'length': 9
                                });
                            }
    
                            return _name;
                        },
                        pickIcon: function(item){
    
                            // extend || ...
                            if( item.fullname === '/extend' ){
                                return `${window.ASSETS_ICON}/files/png/dir-lock.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                            } else {
                                try{
                                    if(_.includes(['png','jpeg'],item.ftype)){
                                        return `/fs${item.parent}/${item.name}?type=open&issys=${window.SignedUser_IsAdmin}`;    
                                    } else {
                                        return _.attempt(JSON.parse.bind(null, item.attr)).icon || `${window.ASSETS_ICON}/files/png/${item.ftype}.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                                    }
                                }
                                catch(error){
                                    return `${window.ASSETS_ICON}/files/png/${item.ftype}.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                                }
                            }
                        }
                    }
                });
    
                Vue.component('table-view',{
                    delimiters: ['#{', '}#'],
                    props: {
                        model: Array
                    },
                    data(){
                        return {
                            dt:{
                                rows: [],
                                columns: []
                            }
                        }
                    },
                    template:   `<el-table style="width: 100%"
                                    :data="model"
                                    stripe>
                                    <el-table-column type="selection" align="center"></el-table-column> 
                                    <el-table-column
                                        sortable 
                                        show-overflow-tooltip
                                        v-for="(item,index) in dt.columns"
                                        :key="index"
                                        :prop="item.field"
                                        :label="item ? item.title : ''"
                                        :width="item.width"
                                        v-if="item.visible">
                                            <template slot-scope="scope">
                                                <div v-html='item.render(scope.row, scope.column, scope.row[item.field], scope.$index)' 
                                                    v-if="typeof item.render === 'function'">
                                                </div>
                                                <div v-else-if="item.field==='name'">
                                                    <el-link type="info" :underline="false" @click.native.prevent="forward(scope.row)" >#{scope.row[item.field]}#</el-link>
                                                </div>
                                                <div v-else>
                                                    #{scope.row[item.field]}#
                                                </div>
                                                
                                            </template>
                                    </el-table-column>
                                </el-table>`,
                    created(){
                        let tmp = fsHandler.callFsJScript("/matrix/fs/fs_data.js", null).message.columns;
                        _.extend(this.dt, {columns: _.map(tmp, function(v){
                                    
                            if(_.isUndefined(v.visible)){
                                _.extend(v, { visible: true });
                            }

                            if(!v.render){
                                return v;
                            } else {
                                return _.extend(v, { render: eval(v.render) });
                            }
                            
                        })});
                        
                        _.extend(this.dt, { rows:this.model } );
                    },
                    methods:{
                        forward(row){
                            eventHub.$emit('FS-NODE-OPENIT-EVENT',row, row.parent+'/'+row.name)
                        },  
                        onCellClick(row,column,cell,event){

                        }
                    }
                });
    
                Vue.component('fs-editor-view-by-html',{
                    props:{
                        id: String
                    },
                    template:   `<div class="embed-responsive embed-responsive-16by9" style="overflow-y:auto;">
                                    <iframe class="embed-responsive-item" :src="src"></iframe>
                                </div>`,
                    data(){
                        return {
                            src: ""
                        }
                    },
                    watch: {
                        src(val, oldVal) {
                            document.getElementsByTagName('iframe')[0].src = val;
                        }
                    },
                    created() {
                        eventHub.$on(`FS-EDITOR-RUN-EVENT-${this.id}`, this.setSrc)
                    },
                    methods: {
                        setSrc(event) {
                            this.src = event;
                        }
                    }
                })
    
                Vue.component('fs-editor-view-by-other',{
                    delimiters: ['#{', '}#'],
                    props:{
                        id: String,
                        output: Object
                    },
                    template: `<fs-output-component :id="'editor-output-'+id" :bid="id"
                                    :model="model"
                                    showToolsBar="false"
                                    showStatusBar="false"></fs-output-component>`,
                    data(){
                        return{
                            model: {
                                oldInput: "",
                                newInput: "",
                                mode: "json",
                                theme: "tomorrow",
                                printMargin: false,
                                readOnly: false,
                            }
                        }
                    },
                    watch: {
                        output: {
                            handler(val,oldVal){
                                _.extend(this.model,{newInput: JSON.stringify(this.output, null, 2)});
                                //eventHub.$on(`FS-EDITOR-RUN-EVENT-${this.id}`, this.setData)
                                //this.setData(val);
                            },
                            deep:true,
                            immediate:true
                        }
                    },
                    mounted() {
                        const self = this;
    
                        self.$nextTick(function () {
                            self.init();
                        })
                    },
                    methods: {
                        init() {
                            const self = this;
    
                            let rtn = fsHandler.callFsJScript(item.name, '');
    
                            self.model.newInput = JSON.stringify(rtn.message, null, 4);
                        },
                        setData(event) {
                            const self = this;
                            
                            if(event.message) {
                                
                                if (typeof event.message === 'object') {
                                    _.extend( self.model, {newInput: JSON.stringify(event.message, null, 2)} );
                                } else {
                                    _.extend( self.model, {newInput: JSON.stringify(event.message, null, 4)} );
                                }
    
                            } else {
                                _.extend( self.model, {newInput: event} );
                            }
                        }
                    }
    
                })
                
                // 日志
                Vue.component('fs-editor-log-console',{
                    delimiters: ['${', '}'],
                    props: {
                        //规则名称
                        id: String   
                    },
                    template:   `<el-container>
                                    <el-header style="height:30px;line-height:30px;padding:5px 30px;">
                                        <el-tooltip content="清空" open-delay="500">
                                            <el-button type="text" @click="onReset"><i class="fas fa-trash"></i></el-button>
                                        </el-tooltip>
                                        <el-tooltip content="重新加载" open-delay="500">
                                            <el-button type="text" @click="onLoad"><i class="fas fa-sync"></i></el-button>
                                        </el-tooltip>
                                    </el-header>
                                    <el-main>
                                        <el-table :data="rows" style="width: 100%" max-height="200" stripe :default-sort="{prop: 'vtime', order: 'descending'}" 
                                                :row-class-name="rowClassName"
                                                :header-cell-style="headerRender"
                                                @selection-change="handleSelectionChange">
                                            <el-table-column type="selection" width="55"></el-table-column>                                                
                                            <el-table-column :label="item.title" 
                                                            :prop="item.data" 
                                                            v-for="(item,index) in columns" 
                                                            :formatter="item.render" 
                                                            sortable 
                                                            :width="item.width"
                                                            v-if="item.visible">
                                            </el-table-column>
                                            <!--el-table-column align="right">
                                                <template slot="header" slot-scope="scope">
                                                    <el-input size="mini" placeholder="输入关键字搜索"/>
                                                </template>
                                            </el-table-column-->
                                        </el-table>
                                    </el-main>
                                </el-container>`,
                    data(){
                        return {
                            rows: [],
                            columns: [],
                            selectedRows: [],
                            ifDeleteVersionData: false
                        }
                    },
                    created(){
                        let rtn = fsHandler.callFsJScript("/matrix/fs/log-by-name.js", encodeURIComponent(this.id)).message;
                        this.rows = rtn.rows;
                        this.columns = _.map(rtn.columns,function(v){
                                            if(v.render){
                                                v.render = eval(v.render);
                                            }
                                            return v;
                                        });
                        
                        // 更新DataTable
                        eventHub.$on("FS-LOG-UPDATE-EVENT",()=>{
                            let rtn = fsHandler.callFsJScript("/matrix/config/fs-by-name.js", encodeURIComponent(this.id)).message;
                            this.rows = rtn.rows;
                        })
                    },
                    methods:{
                        rowClassName({row, rowIndex}){
                            return `row-${rowIndex}`;
                        },
                        headerRender({ row, column, rowIndex, columnIndex }){
                            if (rowIndex === 0) {
                                //return 'text-align:center;';
                            }
                        },
                        onReset(){
                            let item = {class:"/matrix/consolelog/scriptjs", ids: _.map(this.selectedRows,'id').join("', '"), ifDeleteVersionData: self.ifDeleteVersionData}
                            let act = fsHandler.callFsJScript("/matrix/fs/action-by-delete.js",encodeURIComponent(JSON.stringify(item))).message;
                            _.delay(()=>{
                                let rtn = fsHandler.callFsJScript("/matrix/fs/log-by-name.js", encodeURIComponent(this.id)).message;
                                this.rows = rtn.rows;
                            })
                        },
                        onLoad(){
                            let rtn = fsHandler.callFsJScript("/matrix/fs/log-by-name.js", encodeURIComponent(this.id)).message;
                            this.rows = rtn.rows;
                        },
                        handleSelectionChange(val) {
                            this.selectedRows = val;
                        }
                    }
                })

                Vue.component("fs-editor-view",{
                    props:{
                        id: String,
                        item: Object
                    },
                    template: `<el-container style="height:100%;min-height:300px;">
                                    <el-main style="padding:1px 0px 0px 0px;overflow:hidden;" ref="mainView">
                                        <fs-editor-component :id="'editor-'+id" :bid="'output-'+id"
                                            :model="model"
                                            showToolsBar="false"
                                            showStatusBar="false"></fs-editor-component>
                                    </el-main>
                                    <el-footer style="background-color:#ddd;overflow:hidden;padding:0px;height:200px;" ref="footerView">
                                        <el-tabs value="result" type="border-card" style="height:100%;">
                                            <el-tab-pane label="日志" name="log" style="height:100%;">
                                                <fs-editor-log-console :id="item.fullname" v-if="!_.isEmpty(item)"></fs-editor-log-console> 
                                            </el-tab-pane>
                                            <el-tab-pane label="预览" name="result" style="height:100%;overflow:auto;padding-top: 1px;">
                                                <fs-editor-view-by-html :id="'output-'+id" :output="model.fs.output" v-if="item.ftype=='html'" style="height:100%;"></fs-editor-view-by-html>
                                                <fs-editor-view-by-other :id="'output-'+id" :output="model.fs.output" style="height:100%;" v-else></fs-editor-view-by-other>
                                            </el-tab-pane>
                                        </el-tabs>
                                    </el-footer>
                                </el-container>`,
                    data() {
                        return{
                            model: {
                                oldInput: "",
                                newInput: "",
                                mode: "javascript",
                                theme: "tomorrow",
                                printMargin: false,
                                readOnly: false
                            }
                        }
                    },
                    watch: {
                        item: {
                            handler(val,oldVal){
                                _.extend(this.model,{fs: val, mode: this.mode()});
                            },
                            deep: true,
                            immediate:true
                        }
                    },
                    mounted() {
                        this.init();
                        this.initSplit();
                    },
                    methods: {
                        init() {
                            let rtn = fsHandler.fsContent(this.item.parent, this.item.name);
    
                            _.extend(this.model, {newInput:rtn});
                            
                        },
                        initSplit(){
                            Split([this.$refs.mainView.$el, this.$refs.footerView.$el], {
                                sizes: [80, 20],
                                minSize: [0, 0],
                                gutterSize: 5,
                                cursor: 'row-resize',
                                direction: 'vertical',
                                onDragEnd:function(sizes) {
                                    eventHub.$emit(`LAYOUT-DATATABLE-RESIZE-EVENT`,sizes[1]);
                                }
                            });
                        },
                        // 应用扩展名影射不同的编辑模式
                        mode(){
                            let list = {js:'javascript', ltsv: 'toml', file: 'text', html: 'html', md: 'markdown', json: 'json', csv: 'csv'};
                            return list[this.item.ftype] || 'javascript';
                        }
                    }
    
                })
                
                return {
                    rootPath: this.root,
                    model: [],
                    selectedItem: [],
                    datatable: {},
                    upload:{
                        option: {
                            url: '/fs/temp',
                            dataType: 'json',
                            autoUpload: true,
                            acceptFileTypes: /(\.|\/)(gif|jpe?g|png|csv|log|pdf|html|txt|iso|mp3|mp4)$/i,
                            maxFileSize: 999*000,
                            disableImageResize: /Android(?!.*Chrome)|Opera/.test(window.navigator.userAgent),
                            previewMaxWidth: 100,
                            previewMaxHeight: 100,
                            previewCrop: true
                        },
                        swal: {}
                    },
                    action: {
                        from: null,
                        to: null
                    },
                    signedUserName: '',
                    currentView: 'grid-view'
                }
            },
            created() {
                const self = this
    
                self.init();
                
                eventHub.$on("FS-NODE-SELECTIT-EVENT",self.selectIt);
                eventHub.$on("FS-NODE-OPENIT-EVENT",self.openIt);
    
                eventHub.$on("FS-NODE-MOUSEOVER-EVENT",self.mouseOver);
                eventHub.$on("FS-NODE-MOUSEOUT-EVENT",self.mouseOut);
    
                eventHub.$on("FS-FORWARD-EVENT", self.openIt);
                eventHub.$on("PATH-CHANGE-EVENT", self.setRootPath);
            },
            mounted() {
                const self = this
    
                self.$nextTick(function () {
    
                    self.initPlugIn();
    
                })
            },
            watch: {
                root: function(val,oldVal){
                    const self = this
    
                    self.rootPath = val;
    
                    self.load();
                },
                rootPath: function(val,oldVal){
                    const self = this
    
                    let _extName = _.split(val,'.');
    
                    //if(_extName.length == 1){
                        self.load();
                    //}
    
                    let _url = val.replace(/\/\//g,'/');
    
                    // system || extend || ... 判断第一级
                    if(window.SignedUser_IsAdmin){
                        _url += '?issys=true';
                    }
    
                    $('#file-upload').fileupload({url: `/fs${_url}`});
    
                },
                selectedItem:function(val,oldVal){
                    const self = this
    
                    $(".fs-node-selected").removeClass("fs-node-selected");
    
                    _.forEach(val,function(v){
                        let node = $(`#fs_node_widget_${v.id}`);
    
                        $(node).addClass("fs-node-selected");
                    })
                }
            },
            computed: {
                filePath(){
                    return this.rootPath.split("/");
                }
            },
            methods: {
                init(){
                    this.load();
                    this.signedUserName = window.SignedUser_UserName;
                },
                initPlugIn(){
                    const self = this;
    
                    self.initFileUpload();
    
                    self.initContextMenu();
    
                    if(!_.isEmpty(self.defaultView)){
                        self.currentView = self.defaultView;
                    }
    
                    self.orderIt();
    
                    // 非选择区域事件
                    // $(document).mouseup(function(e) {
                    //     let items = $("li.dir.fs-node");
                    //     let exclude = $("div.btn-group > a");
                        
                    //     if (!items.is(e.target) && items.has(e.target).length === 0) {
                    //         self.selectedItem = [];
                    //         window.fsSelectedItem = [];
                    //     }
                    // });
    
                    // 排他事件
                    $('*[data-edit="true"]').click(function(e) {
                        //e.preventDefault();
                        e.stopPropagation();
                    });
    
                },
                toggleView(view){
                    const self = this
    
                    self.currentView = view;
                },
                initContextMenu(){
                    const self = this
    
                    $.contextMenu("destroy").contextMenu({
                        selector: '.list-context-menu',
                        trigger: 'left',
                        build: function($trigger, e) {
                            
                            let _item = null;
    
                            if(!_.isEmpty(e.target.attributes.getNamedItem('data-item').value)) {
                                _item = _.attempt(JSON.parse.bind(null, e.target.attributes.getNamedItem('data-item').value));
                            }
    
                            if(_.includes(['js'], _item.ftype)){
                                return {
    
                                    items: {
    
                                        "read": {
                                            name: "下载", icon: "fas fa-download", callback: function (key, opt) {
                                                self.downloadIt(_item,true);
                                            }
                                        },
                                        "run": {
                                            name: "编辑/运行", icon: "fas fa-play", callback: function (key, opt) {
                                                self.editIt(_item);
                                            }
                                        },
                                        "sep1": "---------",
                                        "delete": {
                                            name: "删除", icon: "fas fa-trash", callback: function (key, opt) {
                                                self.deleteIt(_item,true);
                                            }
                                        },
                                        "sep3": "---------",
                                        "share": {
                                            name: "共享", icon: "fas fa-share-square", callback: function (key, opt) {
                                                self.shareIt(_item);
                                            }
                                        },
                                        "sep4": "---------",
                                        "info": {
                                            name: "属性", icon: "fas fa-info", callback: function (key, opt) {
                                                self.info(_item);
                                            }
                                        }
                                    }
    
                                }
                            } else if(_.includes(['html','htm'], _item.ftype)){
                                return {
    
                                    items: {
                                        "deploy": {
                                            name: "发布应用", icon: "fab fa-codepen", callback: function (key, opt) {
                                                self.deployIt(_item);
                                            }
                                        },
                                        "read": {
                                            name: "下载", icon: "fas fa-download", callback: function (key, opt) {
                                                self.downloadIt(_item,true);
                                            }
                                        },
                                        "edit": {
                                            name: "编辑", icon: "fas fa-edit", callback: function (key, opt) {
                                                self.editIt(_item);
                                            }
                                        },
                                        "run": {
                                            name: "运行", icon: "fas fa-play", callback: function (key, opt) {
                                                self.runHtml(_item);
                                            }
                                        },
                                        "runUrl": {
                                            name: "运行链接", icon: "fas fa-map-marker-alt", callback: function ($element,key, opt) {
                                                self.copyUrl(_item);
                                            }
                                        },
                                        "sep1": "---------",
                                        "delete": {
                                            name: "删除", icon: "fas fa-trash", callback: function (key, opt) {
                                                self.deleteIt(_item,true);
                                            }
                                        },
                                        "sep3": "---------",
                                        "share": {
                                            name: "共享", icon: "fas fa-share-square", callback: function (key, opt) {
                                                self.shareIt(_item);
                                            }
                                        },
                                        "sep4": "---------",
                                        "info": {
                                            name: "属性", icon: "fas fa-info", callback: function (key, opt) {
                                                self.info(_item);
                                            }
                                        }
                                    }
    
                                }
                            } else if(_.includes(['md','json'], _item.ftype)){
                                return {
    
                                    items: {
                                        "read": {
                                            name: "下载", icon: "fas fa-download", callback: function (key, opt) {
                                                self.downloadIt(_item,true);
                                            }
                                        },
                                        "edit": {
                                            name: "编辑", icon: "fas fa-edit", callback: function (key, opt) {
                                                self.editIt(_item);
                                            }
                                        },
                                        "run": {
                                            name: "打开", icon: "fas fa-play", callback: function (key, opt) {
                                                self.openIt(_item,null);
                                            }
                                        },
                                        "runUrl": {
                                            name: "打开链接", icon: "fas fa-map-marker-alt", callback: function ($element,key, opt) {
                                                self.copyUrl(_item);
                                            }
                                        },
                                        "sep1": "---------",
                                        "delete": {
                                            name: "删除", icon: "fas fa-trash", callback: function (key, opt) {
                                                self.deleteIt(_item,true);
                                            }
                                        },
                                        "sep3": "---------",
                                        "share": {
                                            name: "共享", icon: "fas fa-share-square", callback: function (key, opt) {
                                                self.shareIt(_item);
                                            }
                                        },
                                        "sep4": "---------",
                                        "info": {
                                            name: "属性", icon: "fas fa-info", callback: function (key, opt) {
                                                self.info(_item);
                                            }
                                        }
                                    }
    
                                }
                            } else if(_.includes(['imap','iflow','ishow'], _item.ftype)){
                                return {
    
                                    items: {
    
                                        "read": {
                                            name: "下载", icon: "fas fa-download", callback: function (key, opt) {
                                                self.downloadIt(_item,true);
                                            }
                                        },
                                        "run": {
                                            name: "编辑", icon: "fas fa-edit", callback: function (key, opt) {
                                                self.editIt(_item);
                                            }
                                        },
                                        "sep1": "---------",
                                        "delete": {
                                            name: "删除", icon: "fas fa-trash", callback: function (key, opt) {
                                                self.deleteIt(_item,true);
                                            }
                                        },
                                        "sep3": "---------",
                                        "share": {
                                            name: "共享", icon: "fas fa-share-square", callback: function (key, opt) {
                                                self.shareIt(_item);
                                            }
                                        },
                                        "sep4": "---------",
                                        "info": {
                                            name: "属性", icon: "fas fa-info", callback: function (key, opt) {
                                                self.info(_item);
                                            }
                                        }
                                    }
    
                                }
                            } else {
                                return {
    
                                    items: {
                                        "open": {
                                            name: "打开", icon: "fas fa-folder-open", callback: function (key, opt) {
                                                self.openIt(_item);
                                            }
                                        },
                                        "sep1": "---------",
                                        "download": {
                                            name: "下载", icon: "fas fa-download", callback: function (key, opt) {
                                                if(_item.ftype==='dir'){
                                                    self.exportIt(_item.fullname);
                                                } else {
                                                    self.downloadIt(_item,true);
                                                }
                                            }
                                        },
                                        "sep2": "---------",
                                        "copy": {
                                            name: "复制", icon: "fas fa-copy", callback: function (key, opt) {
                                                self.copyIt(_item);
                                            }
                                        },
                                        "paste": {
                                            name: "粘贴", icon: "fas fa-paste", callback: function (key, opt) {
                                                self.pasteIt();
    
                                            }
                                        },
                                        "sep3": "---------",
                                        "delete": {
                                            name: "删除", icon: "fas fa-trash", callback: function (key, opt) {
                                                self.deleteIt(_item,true);
                                            }
                                        },
                                        "sep4": "---------",
                                        "share": {
                                            name: "共享", icon: "fas fa-share-square", callback: function (key, opt) {
                                                self.shareIt(_item);
                                            }
                                        },
                                        "sep5": "---------",
                                        "info": {
                                            name: "属性", icon: "fas fa-info", callback: function (key, opt) {
                                                self.info(_item);
                                            }
                                        }
                                    }
    
                                }
                            }
    
                        }
                    });
                },
                initEditName(){
                    const self = this
    
                    $(".fs-name[data-edit='true']").editable({
                        title: "重命名",
                        type: "text",
                        pk: $(this).data("pk"),
                        container: 'body',
                        validate: function (value) {
                            if (!$.trim(value)) {
                                return '不能为空';
                            }
                        },
                        display: function(value, sourceData) {
                            if(value.length > 10) {
                                $(this).html(_.split(value,"",9).join("")+"...");
                            }
                        },
                        success: function (response,newValue) {
    
                            let _item = $(this).data("info");
    
                            let _old = _.trim(_item.parent + "/" + $(this).editable('getValue', true));
                            let _new = _.trim(_item.parent + "/" + newValue);
    
                            let _check = fsHandler.fsCheck( _item.parent, newValue);
                            if(_check) {
                                alertify.error("文件已存在，请确认！")
                                return false;
                            }
    
                            let _rtn = fsHandler.fsRename(_old, _new);
    
                            if(_rtn == 1){
                                self.load();
                            } else {
                                $(this).innerHTML($(this).editable('getValue', true));
                            }
                        }
                    });
    
                },
                initFileUpload(){
                    const self = this
                    let uploadButton = $('<button/>')
                        .addClass('btn btn-xs btn-primary')
                        .prop('disabled', true)
                        .text('准备中...')
                        .on('click', function () {
                            var $this = $(this),
                                data = $this.data();
                            $this
                                .off('click')
                                .text('中止')
                                .on('click', function () {
                                    $this.remove();
                                    data.abort();
                                });
                            data.submit().always(function () {
                                $this.remove();
                            });
                        });
    
                    $('#file-upload').fileupload(self.upload.option)
                        .on('fileuploadadd', function (e, data) {
    
                            let title = "上传";
    
                            let wnd = maxWindow.winUpload(title, '<div id="files" class="files"></div>', null,null);
    
                            // 更新信息栏信息
                            new Vue({
                                delimiters: ['#{', '}#'],
                                el: `#jsPanel-upload-footer-${objectHash.sha1(title)}`,
                                template: `<div class="pull-left" style="width: 100%;"><i class="fas fa-clock"></i> #{stime}# | 上传文件：#{total}# </div>`,
                                data: {
                                    stime: moment().format("LLL"),
                                    utime: '',
                                    upload: 0,
                                    total: data.originalFiles.length,
                                    interval: null
                                },
                                created: function(){
                                    //eventHub.$on("UPLOAD-UPDATE-STATUS-EVENT",this.update);
    
                                    /*this.interval = setInterval(function(){
                                        this.utime = moment(this.stime).fromNow();
                                    },1000)*/
                                },
                                methods: {
                                    update: function(event){
    
                                        if(event.stop){
                                            //clearInterval(this.interval);
                                        }
    
                                        if(event.upload){
                                            this.upload += event.upload;
                                        }
    
                                    }
                                }
                            });
    
                            data.context = $('<ul/>').appendTo('#files');
    
                            $.each(data.files, function (index, file) {
    
                                let _name = file.name;
    
                                if(!_.isEmpty(file.name) && _.size(file.name) > 9){
                                    _name = _.split(file.name,"",9).join("")+"..."
                                }
    
                                var node = $('<li/>')
                                    .append($(`<a href="#" class="thumbnail" style="border:none;-webkit-box-shadow: unset;box-shadow: unset;"/>`)
                                        .text(_name))
                                    .attr("title",file.name)
                                    .append($(`<div id="progress_${objectHash.sha1(file.name)}" class="progress">
                                                    <div class="progress-bar progress-bar-success"></div>
                                               </div>`));
                                if (!index) {
                                    node
                                        .append(uploadButton.clone(true).data(data));
                                }
                                node.appendTo(data.context);
                            });
                        })
                        .on('fileuploadprocessalways', function (e, data) {
                            var index = data.index,
                                file = data.files[index],
                                node = $(data.context.children()[index]);
    
                            if (file.preview) {
                                node
                                    .prepend(file.preview);
                            }else{
                                node
                                    .prepend(`<span class="fa fa-file fa-4x preview-null"></span>`);
                            }
    
                            if (file.error) {
                                node
                                    .append('<hr>')
                                    .append($('<span class="text-danger"/>').text(file.error));
                            }
                            if (index + 1 === data.files.length) {
                                data.context.find('button')
                                    .text('上传')
                                    .css('display','none')
                                    .prop('disabled', !!data.files.error);
                            }
    
                            //更新底部状态信息
                            //eventHub.$emit("UPLOAD-UPDATE-STATUS-EVENT",{total: null, etime: null, upload: index + 1})
                        })
                        .on('fileuploadprogress', function (e, data) {
    
                            let _name = objectHash.sha1(data.files[0].name);
                            let progress = parseInt(data.loaded / data.total * 100, 10);
                            $(`#progress_${_name} .progress-bar`).css(
                                'width',
                                progress + '%'
                            ).html(`<small>${parseInt(data.loaded/1024,10)} KB / ${parseInt(data.total/1024,10)} KB</small>`);
                        })
                        .on('fileuploaddone', function (e, data) {
    
                            $.each(data.files, function (index, file) {
    
                                if (file.name) {
                                    // var link = $('<a>')
                                    //     .attr('target', '_blank')
                                    //     .prop('href', file.url);
                                    // $(data.context.children()[index])
                                    //     .wrap(link);
                                    $(`#progress_${objectHash.sha1(file.name)} .progress-bar`).html(`<small>已完成</small>`);
                                } else if (file.error) {
                                    var error = $('<span class="text-danger"/>').text(file.error);
                                    $(data.context.children()[index])
                                        .append('<br>')
                                        .append(error);
                                }
                            });
    
                            self.load();
    
                            //更新底部状态信息
                            //eventHub.$emit("UPLOAD-UPDATE-STATUS-EVENT",{total: null, etime: _.now(), upload: 0, stop: true})
    
                            // close upload win
    
                        })
                        .on('fileuploadfail', function (e, data) {
                            $.each(data.files, function (index) {
                                var error = $('<span class="text-danger"/>').text('上传失败。');
                                $(data.context.children()[index])
                                    .append('<br>')
                                    .append(error);
                            });
                            // close upload win
    
                        })
                        .prop('disabled', !$.support.fileInput)
                        .parent().addClass($.support.fileInput ? undefined : 'disabled');
                },
                resetStatus(){
                    const self = this
    
                    self.selectedItem = [];
                },
                orderIt(){
                    const self = this
    
                    $.contextMenu({
                        selector: '.fs-order',
                        trigger: 'left',
                        callback: function (key, options) {
                            if(key == 'byNameAsc'){
                                self.model = _.orderBy(self.model,['name'],['asc']);
                            } else if(key == 'byNameDesc'){
                                self.model = _.orderBy(self.model,['name'],['desc']);
                            } else if(key == 'byTimeAsc'){
                                self.model = _.orderBy(self.model,['vtime'],['asc']);
                            } else if(key == 'byTimeDesc'){
                                self.model = _.orderBy(self.model,['vtime'],['desc']);
                            } else {
                                self.model = _.orderBy(self.model,['ftype'],['asc']);
                            }
                        },
                        items: {
                            "byNameAsc": { name: "按名称升序",icon: "fas fa-sort-alpha-up" },
                            "byNameDesc": { name: "按名称降序",icon: "fas fa-sort-alpha-down" },
                            "byTimeAsc": { name: "按时间升序",icon: "fas fa-sort-alpha-up" },
                            "byTimeDesc": { name: "按时间降序",icon: "fas fa-sort-alpha-down" },
                            "byFtype": { name: "按类型排序",icon: "fas fa-sort-alpha-down" },
                        }
                    });
    
                },
                openIt(item, path){
                    const self = this
    
                    event.preventDefault();
    
                    // 点击【我的文件】返回不同的root
                    if(_.isNull(item)){
                        self.rootPath = self.root;
                        return;
                    }
    
                    if(typeof(item) === 'string' || item.ftype === 'dir'){
                        self.rootPath = path.replace(/\/\//g,'/');
                        return;
                    }
    
                    if(!_.isEmpty(item)){
    
                        if(_.includes(['png','jpg','jpeg','gif'], item.ftype)) {
    
    
                            let contents = `<img src="/fs${path}?type=open&issys=${window.SignedUser_IsAdmin}" class="preview-img-responsive center-block" alt="Image">`;
                            let _wnd = maxWindow.winApp(item.name, contents, null,null);
    
                        } else if(_.includes(['mov','mp4','avi'], item.ftype)) {
    
                            let contents = `<div class="embed-responsive embed-responsive-16by9">
                                                <video src="/fs${path}?type=open&issys=${window.SignedUser_IsAdmin}" controls="controls" autoplay>
                                                    your browser does not support the video tag
                                                </video>
                                            </div>
                                            `;
    
                            let _wnd = maxWindow.winApp(item.name, contents, null,null);
    
                        } else if(_.includes(['pdf'], item.ftype)) {
    
                            let contents = `<div class="embed-responsive embed-responsive-16by9">
                                                <iframe class="embed-responsive-item" src="/fs${path}?type=open&issys=${window.SignedUser_IsAdmin}"></iframe>
                                            </div>`;
    
                            let _wnd = newWindow('fsapp', item.name, contents, null,null);
    
                        } else if(_.includes(['pptx','ppt'], item.ftype)) {
    
                            window.open(`/fs${path}?type=open&issys=${window.SignedUser_IsAdmin}`, "_blank");
    
                        } else if(_.some(_.filter(mx.global.register.file,{type:"public"}), {value:item.ftype})) {
    
                           self.editIt(item);
    
                        } else if(_.includes(['swf'], item.ftype)) {
                            let contents = `<div class="embed-responsive embed-responsive-16by9">
                                                <video src="/fs${path}?type=open&issys=${window.SignedUser_IsAdmin}" width="100%" height="100%" controls="controls" autoplay>
                                                    Your browser does not support the video tag.
                                                </video>
                                            </div>`;
    
                            let _wnd = maxWindow.winApp(item.name, contents, null,null);
                        } else if(_.includes(['imap','iflow', 'ishow'], item.ftype)) {
    
                            _.merge(item,{action:'run'});
    
                            let url = fsHandler.genFsUrl(item,null,null);
    
                            window.open(url,'_blank');
                        } else if(_.includes(['md'], item.ftype)){
                            _.merge(item,{action:'run'});
    
                            let url = fsHandler.genFsUrl(item,{ header:true, sidebar:true, footbar:true },null);
    
                            window.open(url,'_blank');
                        }
                    }
    
                },
                runHtml(item){
                    const self = this
    
                    let file = [item.parent, item.name].join("/");
                    window.open(`/fs${file}?issys=true&type=open&issys=${window.SignedUser_IsAdmin}`,'_blank');
                },
                copyUrl(item){
                    const self = this
    
                    let file = `/fs${[item.parent, item.name].join("/")}?type=open&issys=${window.SignedUser_IsAdmin}`;
    
                    if(_.includes(['md','imap','iflow','ishow'],item.ftype)){
                        _.merge(item,{action:'run'});
                        file = fsHandler.genFsUrl(item,{ header:true, sidebar:false, footbar:true },null);
                    }
    
                    alertify.set({ labels: {
                            ok     : "复制地址",
                            cancel : "取消"
                    }});
    
                    alertify.prompt("运行链接地址", function (e, str) {
                        // str is the input text
                        if (e) {
                            // user clicked "ok"
                            let clipboard = new Clipboard('.alertify-button-ok', {
                                text: function (trigger) {
                                    return str;
                                }
                            });
                        } else {
                            // user clicked "cancel"
                        }
                    }, file);
    
                    $(".alertify-prompt .alertify-message").css('height','5vh');
    
                },
                refreshTree(){
                    // 发送Tree刷新事件
                    eventHub.$emit("FS-TREE-REFRESH-EVENT");
                },
                load() {
                    const self = this
    
                    // 临时解决view刷新问题 & destroy editable
                    //self.currentView = "";
    
                    _.delay(function(){
    
                        // 临时解决view刷新问题
                        //self.currentView = self.defaultView;
    
                        // 重置选择
                        self.selectedItem = [];
    
                        let _rtn = fsHandler.fsList(self.rootPath);
    
                        self.model = _.orderBy(_.map(_rtn,function(v,k){
    
                            return _.merge(v, {"username": `${self.signedUserName}`});
    
                        }),[v => v.name.toLowerCase(),"vtime"],["asc","desc"]);
    
                        _.delay(function(){
                            // 刷新
                            self.refresh();
                        },100);
                    },100)
    
                },
                refresh() {
                    const self = this
    
                    // 重新实例化 editable
                    self.initEditName();
                },
                mouseOver(item){
                    const self = this
    
                    $(self.$el).find('.fs-node-highlight').removeClass('fs-node-highlight');
                    $('#fs_node_'+item.id).find('.widget').addClass('fs-node-highlight');
    
                },
                mouseOut(item){
                    const self = this
    
                    $('#fs_node_'+item.id).find('.fs-node-highlight').removeClass('fs-node-highlight');
                },
                newDir() {
                    const self = this;
    
                    let _name = '新文件夹_' + _.now();
                    let _type = 'dir';
                    let _attr = {remark: '', ctime: _.now(), author: self.signedUserName};
    
                    let _rtn = fsHandler.fsNew(_type, self.rootPath, _name, null, _attr);
    
                    if(_rtn == 1){
                        self.load();
                    }
                },
                newFile() {
                    fileSystem.fileNew(this.rootPath,this.load);
                },
                info(node){
                    const self = this
    
                    let _win = maxWindow.winInfo("属性",'<div id="fs-info"></div>',null,$('#content'));
    
                    let _attr = {"attr": `{"remark": "", "ctime": ${_.now()}, "author": ${window.SignedUser_UserName}, "type": "${node.ftype}", "icon": "${window.ASSETS_ICON}/files/png/${node.ftype}.png?type=download&issys=${window.SignedUser_IsAdmin}"}`};
    
                    if(_.isEmpty(node.attr)){
                        node = _.merge(node, _attr);
                    }
    
                    let _infoVue = new Vue({
                        delimiters: ['#{', '}#'],
                        el: "#fs-info",
                        template: `<div class="tab-content" style="height:100%;">
                                                <div role="tabpanel" class="tab-pane active" id="home"  style="height:100%;">
                                                    <form  style="height:95%;overflow:auto;">
                                                        <div class="form-group">
                                                            <label for="name">名称</label>
                                                            <input type="text" class="form-control" id="name" placeholder="" v-model="model.newName" autofocus @keyup.enter="save">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="remark">备注</label>
                                                            <textarea type="text" class="form-control" rows="2" id="remark" placeholder="" v-model="model.attr.remark"></textarea>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="ctime">更新时间</label>
                                                            <input type="text" class="form-control" id="ctime" placeholder="" :value="model.attr.ctime | toLocalTime" disabled>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="parent">目录</label>
                                                            <input type="text" class="form-control" id="parent" placeholder="" v-model="model.parent" disabled>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="type">类型</label>
                                                            <input type="text" class="form-control" id="type" placeholder="" v-model="model.type" disabled>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="type">大小</label>
                                                            <input type="text" class="form-control" id="size" placeholder="" value="${mx.bytesToSize(node.size)}" disabled>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="author">作者</label>
                                                            <input type="text" class="form-control" id="author" placeholder="" v-model="model.attr.author" disabled>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="icon">图标</label>
                                                            <a href="#icon-list" aria-controls="icon-list" role="tab" data-toggle="tab">
                                                                <img class="media-object" :src="model.icon.value" style="width:15%;">
                                                            </a>
                                                        </div>
    
                                                   </form>
                                                    <div class="form-group" style="text-align: center;padding-top:3px;">
                                                        <a href="javascript:void(0)" class="btn btn-sm btn-warning" @click="apply">应用</a>
                                                        <a href="javascript:void(0)" class="btn btn-sm btn-success" @click="save">确定</a>
                                                        <a href="javascript:void(0)" class="btn btn-sm btn-default" @click="close">取消</a>
                                                    </div>
                                                </div>
                                                <div role="tabpanel" class="tab-pane" id="icon-list" style="height:100%;">
                                                    <div class="row" style="height:95%;">
                                                      <div class="col-md-12" style="display: list-item;height: 95%;overflow: auto;">
                                                        <ul>
                                                            <li v-for="icon in model.icon.list">
                                                                <a href="#" class="thumbnail" style="border:none;" @click="triggerInput(icon.id)">
                                                                  <img class="media-object" :src="icon | pickIcon" style="max-width: 55px;min-width: 55px;;">
                                                                  <input type="radio" :ref="icon.id" :id="icon.id"  :value="'/fs'+icon.parent+'/'+icon.name+'?type=download&issys=${window.SignedUser_IsAdmin}'" v-model="model.icon.value" >
                                                                </a>
                                                            </li>
                                                        </ul>
                                                      </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-12" style="text-align:center;">
                                                            <a class="btn btn-sm btn-default" href="#home" aria-controls="home" role="tab" data-toggle="tab">返回</a></li>
                                                        </div>
                                                    </div>
                                                </div>
    
                                            </div>`,
                        data: {
                            model: {
                                parent: node.parent,
                                oldName: node.name,
                                newName: node.name,
                                type: node.ftype,
                                attr: {remark:''},
                                icon: {
                                    value: null,
                                    list: []
                                }
                            }
                        },
                        mounted: function() {
                            const me = this;
    
                            me.$nextTick(function() {
                                me.model.attr = _.attempt(JSON.parse.bind(null, node.attr));
                                me.model.icon.value = me.model.attr.icon;
                                me.init();
                            })
                        },
                        filters: {
                            pickName: function (value) {
                                const me = this;
    
                                if (!value) return '';
    
                                let _attr = _.attempt(JSON.parse.bind(null, value));
    
                                return _attr.name;
                            },
                            pickIcon: function(item) {
                                return `/fs${item.parent}/${item.name}?type=download&issys=${window.SignedUser_IsAdmin}`;
                            },
                            readMore: function (text, length, suffix) {
                                return text.substring(0, length) + suffix;
                            },
                            toLocalTime: function (value) {
                                return moment(value).format("LLL");
                            }
                        },
                        destroyed: function(){
                            const me = this;
    
                            me.model = null;
                        },
                        methods: {
                            init: function(){
                                const me = this;
    
                                me.model.icon.list = fsHandler.fsList('/assets/images/files/png');
                            },
                            triggerInput: function(id){
                                const self = this
    
                                $(self.$refs[id]).click()
                            },
                            apply: function(){
                                const me = this;
    
                                me.saveAttr();
    
                            },
                            save: function(){
                                const me = this;
    
                                me.saveAttr();
                                _win.close();
                            },
                            close: function(){
                                const me = this;
    
                                _win.close();
                            },
                            saveName: function(){
                                const me = this;
    
                                let _extName = node.ftype=='dir'?'':'.'+node.ftype;
                                let _old = node.parent + "/" + node.name;// + _extName;
                                let _new = node.parent + "/" + me.model.newName;// + _extName;
    
    
                                let _check = fsHandler.fsCheck( node.parent, me.model.newName);
                                if(_check) {
                                    alertify.error("文件已存在，请确认！")
                                    return false;
                                }
    
                                let _rtn = fsHandler.fsRename(_old, _new);
    
                                if(_rtn == 1){
                                    self.load();
                                }
                            },
                            saveAttr: function(){
                                const me = this;
    
                                me.model.attr = me.model.icon.value?_.extend(me.model.attr, {icon: me.model.icon.value}):me.model.attr;
    
                                let _rtn = fsHandler.fsUpdateAttr(node.parent, node.name, me.model.attr);
    
                                if(_rtn == 1){
                                    self.load();
                                    $(".list-context-menu").contextMenu('update');
    
                                    if(me.model.oldName != me.model.newName){
                                        me.saveName();
                                    }
                                }
                            }
                        }
                    })
    
                },
                copyIt(item){
                    const self = this;
    
                    self.selectedItem = [];
                    window.fsSelectedItem = [];
                    self.selectedItem[0] = item;
                    window.fsSelectedItem = _.cloneDeep(self.selectedItem)
                    alertify.log(`已复制 ${window.fsSelectedItem.length} 项`);
                },
                copyThem(){
                    const self = this;
    
                    window.fsSelectedItem = _.cloneDeep(self.selectedItem);
                    alertify.log(`已复制 ${window.fsSelectedItem.length} 项`);
                },
                moveIt(){
                    const self = this;
                    
                    
                    if(_.isEmpty(window.fsSelectedItem)) {
                        alertify.log("请选择移动内容")
                        return false;
                    }
                    
                    alertify.confirm(`确认要将下列所选文件移动到 ${self.rootPath} 目录? <br><br> ${_.map(window.fsSelectedItem,'name').join("<br>")}`, function (e) {
                        if (e) {
                            try {
                                let rtn = true;
                                _.forEach(window.fsSelectedItem,function(v){
                                    let _rtn = fsHandler.fsMove([v.parent,v.name].join("/"), self.rootPath);
                                    if(_rtn===0){
                                        rtn = false;
                                    }
                                })
                                if(rtn){
                                    alertify.success("移动成功 " + self.rootPath);
                                    self.load();
                                }
                            }
                            catch(error){}
                            finally{
                                window.fsSelectedItem = [];
                            }
                        } else {
                            
                        }
                    });
                },
                pasteIt(){
                    const self = this
    
                    if(_.isEmpty(window.fsSelectedItem)) {
                        alertify.log("请选择复制内容")
                        return false;
                    }
                    
                    alertify.confirm(`确认要将下列所选文件复制到 ${self.rootPath} 目录? <br><br> ${_.map(window.fsSelectedItem,'name').join("<br>")}`, function (e) {
                        if (e) {
                            try {
                                let rtn = true;
                                _.forEach(window.fsSelectedItem,function(v){
                                    let _rtn = fsHandler.fsCopy([v.parent,v.name].join("/"), self.rootPath);
                                    if(_rtn===0){
                                        rtn = false;
                                    }
                                })
                                if(rtn){
                                    alertify.success("复制成功 " + self.rootPath);
                                    self.load();
                                }
                            }
                            catch(error){}
                            finally{
                                window.fsSelectedItem = [];
                            }
                        } else {
                            
                        }
                    });
                },
                moveTo(){
                    const self = this;
                    
                    if(_.isEmpty(window.fsSelectedItem)) {
                        alertify.log("请选择移动内容")
                        return false;
                    }
                    const app = self.root;
                    fileSystem.fileMoveTo(app,window.fsSelectedItem,this.load);
    
                },
                copyTo(){
                    const self = this
    
                    if(_.isEmpty(window.fsSelectedItem)) {
                        alertify.log("请选择复制内容")
                        return false;
                    }
                    
                    fileSystem.fileCopyTo(null,window.fsSelectedItem,this.load);
    
                },
                deleteThem() {
                    const self = this
    
                    if(_.includes([['app','extend','assets','opt','script']],self.selectedItem[0].name)){
                        alertify.error("系统目录，不允许删除!");
                        return false;
                    }
    
                    if(_.isEmpty(self.selectedItem)) {
                        alertify.log("选择需要删除的对象！");
                        return false;
                    }
    
                    const h = this.$createElement;
                    this.$msgbox({
                            title: `确定要删除选定文件?`,
                            message: h('span', null, _.concat(h('p', null, `目录：${self.rootPath}`),_.map(self.selectedItem,(v)=>{ return h('p', null, v.name); })) ),
                            showCancelButton: true,
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning',
                    }).then(() => {
                        _.forEach(self.selectedItem, function(v){
                            self.deleteIt(v, false);
                        })
                        
                    }).catch(()=>{

                    });

                },
                deleteIt(event, prompt) {
                    const self = this
    
                    if(_.includes(['admin','app','extend','assets','opt','script'],event.name)){
                        alertify.error("系统目录，不允许删除!");
                        return false;
                    }
    
                    if(_.isEmpty(event)) {
                        alertify.log("选择需要删除的对象！");
                        return false;
                    }
    
                    if(prompt){
                        
                        alertify.confirm(`确定要删除 ${event.name} 文件?`, function (e) {
                            if (e) {
                                let _rtn = fsHandler.fsDelete(event.parent,event.name);
    
                                if (_rtn == 1){
                                    self.load();
                                }
                            } else {
                                
                            }
                        });
                        
                    } else {
    
                        let _rtn = fsHandler.fsDelete(event.parent,event.name);
    
                        if (_rtn == 1){
                            self.load();
                        }
                    }
    
                },
                shareIt(event){
                    const self = this
    
                    alertify.prompt("共享设置", function (e, str) {
                        // str is the input text
                        if (e) {
                            // user clicked "ok"
                        } else {
                            // user clicked "cancel"
                        }
                    }, "admin;");
                    $(".alertify-prompt .alertify-message").css('height','5vh');
                },
                deployIt(item){
                    const self = this
    
                    let wnd = maxWindow.winDeployApp( `<i class="fab fa-codepen"></i> 应用发布`, `<div id="fs-app-deploy"></div>`, null, 'content');
    
                    let form = {
                        delimiters: ['#{', '}#'],
                        template:   `<el-container><el-main><el-tabs v-model="activeName" ref="tabs">
                                        <el-tab-pane label="应用发布" name="app">
                                            <el-container style="height:100%;">
                                                <el-main style="height:100%;overflow:auto;padding:10px 0px;">
                                                    <el-form ref="form" :model="app" label-width="80px">
                                                        <el-form-item label="中文名">
                                                            <el-input v-model="app.cnname"></el-input>
                                                        </el-form-item>
                                                        <el-form-item label="英文名称">
                                                            <el-input v-model="app.enname"></el-input>
                                                        </el-form-item>
                                                        <el-form-item label="图标选择">
                                                            <el-button type="text" @click="activeName='icon'">
                                                                <el-avatar shape="square" fit="fill" size="64" :src="app.icon.value"></el-avatar>
                                                            </el-button>
                                                        </el-form-item>
                                                        <el-form-item label="Target">
                                                            <el-radio-group v-model="app.target">
                                                                <el-radio label="_blank">打开新窗口</el-radio>
                                                                <el-radio label="_parent">当前窗口打开</el-radio>
                                                            </el-radio-group>
                                                        </el-form-item>
                                                        <el-form-item label="分组">
                                                            <el-radio-group v-model="app.groups.group">
                                                                #{app.groups.group}#
                                                                <el-radio :label="item.name" v-for="item in model.groups">#{item.title}#</el-radio>
                                                            </el-radio-group>
                                                        </el-form-item>
                                                    </el-form> 
                                                </el-main>
                                                <el-footer style="height:40px;line-height:40px;text-align:right;">
                                                    <el-button type="primary" @click="deploy">发布</el-button>
                                                    <el-button type="defult" @click="cancel">取消</el-button>
                                                </el-footer>
                                            </el-container>
                                        </el-tab-pane>
                                        <el-tab-pane label="" name="icon">
                                            <el-container style="height:100%;">
                                                <el-main style="height:100%;overflow:auto;padding:10px 0px;">
                                                    <el-radio-group v-model="app.icon.value">
                                                        <el-radio :label="'/fs'+icon.parent+'/'+icon.name+'?type=download&issys=${window.SignedUser_IsAdmin}'" v-model="app.icon.value"  v-for="icon in app.icon.list">
                                                            <el-avatar shape="square" fit="contain" size="64" :src="icon | pickIcon"></el-avatar>    
                                                        </el-radio>
                                                    </el-radio-group>
                                                </el-main>
                                                <el-footer style="height:30px;line-height:30px;text-align:center;">
                                                    <el-button type="text" @click="activeName='app'">返回</el-button>  
                                                </el-footer>
                                            </el-container>
                                        </el-tab-pane>
                                    </el-tabs></el-main></el-container>`,
                        data: {
                            activeName: "app",
                            model: null,
                            app: {
                                cnname: _.head(item.name.split(".")),
								enname: _.head(item.name.split(".")),
                                seat: _.random(100, 10000),
                                url: "",
								icon: "",
								target: "_blank",
								selected: 1,
                                groups: {"group":"application"},
                                url: `/fs${[item.parent, item.name].join("/")}?issys=true&type=open&issys=${window.SignedUser_IsAdmin}`,
                                icon: {
                                    value: '',
                                    list: []
                                }                                
                            }
                        },
                        filters:{
                            pickIcon: function(icon) {
                                return `/fs${icon.parent}/${icon.name}?type=download&issys=${window.SignedUser_IsAdmin}`;
                            }
                        },
                        mounted: function() {
                            const me = this;
    
                            me.$nextTick(function() {
                                me.app.icon.value = `${window.ASSETS_ICON}/apps/png/creative.png?type=download&issys=${window.SignedUser_IsAdmin}`;
    
                                me.init();

                                _.delay(()=>{
                                    me.hideHeader();
                                },500)
                                
                            })
                        },
                        methods: {
                            init: function(){
                                const me = this;
                                me.model = fsHandler.callFsJScript("/matrix/apps/appList.js",null).message;
                                me.app.icon.list = fsHandler.fsList(`${window.ASSETS_ICON}/apps/png`);
    
                            },
                            hideHeader(){
                                const me = this;
                                me.$refs.tabs.$children[0].$el.style.display = 'none';
                            },
                            deploy: function(){
                                const me = this;
    
                                let check = fsHandler.callFsJScript("/matrix/apps/app_exist_check.js",encodeURIComponent(JSON.stringify(me.app.cnname))).message;;
    
                                if(check==1){
                                    me.$message({
                                        message:"应用已经发布，请确认。",
                                        type: "info"
                                    });
                                    return false;
                                }

                                _.extend(me.app,{
                                                    icon: me.app.icon.value.replace(/\/fs\/assets\/images\/apps\/png\//,'').replace(/\?type=download&issys=true/,'')
                                                });

                                let rtn = fsHandler.callFsJScript("/matrix/apps/app.js",encodeURIComponent(JSON.stringify(me.app)));
                                if( _.lowerCase(rtn.status) == "ok"){
                                    self.$message({
                                        type: "info",
                                        message: "应用发布成功"
                                    });
                                    
                                    eventHub.$emit("APP-REFRESH-EVENT");

                                    $("ul.nav").find("li>a[title='应用']").popover({
                                        container: "body",
                                        title: "",
                                        content: `${me.app.cnname} 应用发布成功！`
                                    }).popover('show');

                                    _.delay(function(){
                                        $("ul.nav").find("li>a[data-original-title='应用']").popover('destroy');
                                    },8000)

                                    wnd.close();

                                }
    
                                // let app = {
                                //     cnname: me.app.cnname,
                                //     enname: me.app.enname,
                                //     icon: me.app.icon.value.replace(/\/fs\/assets\/images\/apps\/png\//,'').replace(/\?type=download&issys=true/,''),
                                //     seat: me.app.seat,
                                //     url: me.app.url
                                // };
    
                                // let rtn = fsHandler.callFsJScript("/matrix/apps/app.js",encodeURIComponent(JSON.stringify(app)));
                                // if( _.lowerCase(rtn.status) == "ok"){
                                //     alertify.success("应用发布成功");
                                //     eventHub.$emit("APP-REFRESH-EVENT");
    
                                //     $("ul.nav").find("li>a[title='应用']").popover({
                                //         container: "body",
                                //         title: "",
                                //         content: `${me.app.cnname} 应用发布成功！`
                                //     }).popover('show');
    
                                //     _.delay(function(){
                                //         $("ul.nav").find("li>a[data-original-title='应用']").popover('destroy');
                                //     },8000)
    
    
                                //     wnd.close();
                                // }
                            },
                            cancel:function(){
                                wnd.close();
                            }
                        }
                    };
                    new Vue(form).$mount("#fs-app-deploy");
    
                },
                editIt(node){
                    const self = this
                    
                    // 生成布局、vue组件配置，根据不同的文件类型，需要对应不同的编辑器
                    let editor = {
                            normal: {
                                delimiters: ['#{', '}#'],
                                data: {
                                    tabs: {
                                        list:[],
                                        activeIndex: '',
                                        activeNode: null
                                    },
                                    tree: {
                                        root: "/"
                                    }
                                },
                                template:  `<el-container style="height: 100%;">
                                                <el-header style="height:30px;line-height:30px;background-color:#f6f6f6;border-bottom:1px solid #ddd;">
                                                    <el-dropdown style="padding-right: 10px;" trigger="click">
                                                        <span class="el-dropdown-link">
                                                            文件
                                                        </span>
                                                        <el-dropdown-menu slot="dropdown">
                                                            
                                                            <el-dropdown-item @click.native="onNewProject">新建项目</el-dropdown-item>
                                                            <el-dropdown-item @click.native="onNewFile">新建文件</el-dropdown-item>

                                                            <el-dropdown-item @click.native="onReload" divided>打开</el-dropdown-item>
                                                            <el-dropdown-item @click.native="onReload">重打开</el-dropdown-item>
                                                            
                                                            <el-dropdown-item @click.native="onSave" divided>保存  ctrl+s</el-dropdown-item>
                                                            <el-dropdown-item @click.native="onSaveAs">另存为</el-dropdown-item>

                                                            <el-dropdown-item @click.native="onCloseTab" divided>关闭当前页</el-dropdown-item>
                                                            <el-dropdown-item @click.native="onCloseWin">关闭窗口</el-dropdown-item>
                                                        </el-dropdown-menu>
                                                    </el-dropdown>
                                                    <el-dropdown style="padding-right: 10px;" trigger="click">
                                                        <span class="el-dropdown-link">
                                                            编辑
                                                        </span>
                                                        <el-dropdown-menu slot="dropdown">
                                                            <el-dropdown-item @click.native="onUndo">撤销</el-dropdown-item>
                                                            <el-dropdown-item @click.native="onUndo">重做</el-dropdown-item>
                                                            <el-dropdown-item :class="'copy-'+tabs.activeIndex" @click="onCopy" divided>复制</el-dropdown-item>
                                                            <el-dropdown-item @click.native="onPaste">粘贴</el-dropdown-item>
                                                            <el-dropdown-item @click.native="onSelect">选择</el-dropdown-item>
                                                            <el-dropdown-item @click.native="onRemove" divided>清除</el-dropdown-item>
                                                        </el-dropdown-menu>
                                                    </el-dropdown>
                                                    
                                                    <el-dropdown style="padding-right: 10px;" trigger="click">
                                                        <span class="el-dropdown-link">
                                                            运行
                                                        </span>
                                                        <el-dropdown-menu slot="dropdown">
                                                            <el-dropdown-item @click.native="onSaveAndPlay">运行</el-dropdown-item>
                                                            <el-dropdown-item @click.native="onSaveAndPlay" divided>预览</el-dropdown-item>
                                                            <el-dropdown-item @click.native="onSaveAndPlay" divided>日志</el-dropdown-item>
                                                        </el-dropdown-menu>
                                                    </el-dropdown>   

                                                    <!--el-dropdown style="padding-right: 10px;" trigger="click">
                                                        <span class="el-dropdown-link">
                                                            发布
                                                        </span>
                                                        <el-dropdown-menu slot="dropdown">
                                                            <el-dropdown-item @click.native="onDeploy">发布为应用</el-dropdown-item>
                                                        </el-dropdown-menu>
                                                    </el-dropdown-->    
                                                    
                                                    <el-tooltip content="主题" open-delay="500">
                                                        <el-button type="text" :class="'editor-select-theme-'+tabs.activeIndex" v-show="!_.isEmpty(tabs.list)" style="float:right;"><i class="fas fa-tshirt"></i> 主题</el-button>
                                                    </el-tooltip>
                                                </el-header>
                                                <el-container style="height: 100%;min-height:300px;border-top:1px solid #fff;">
                                                    <el-aside style="background-color:#f6f6f6;width:200px;overflow:hidden;" ref="leftView">
                                                        <devops-tree-component :root="tree.root" :defaultExpandedKeys="[tabs.activeNode.fullname]" v-if="!_.isEmpty(tabs.activeNode)"></devops-tree-component>
                                                    </el-aside>
                                                    <el-main style="padding:0px;overflow:hidden;" ref="mainView">
                                                        <el-tabs v-model="tabs.activeIndex" type="border-card" 
                                                                style="height:100%;" 
                                                                closable 
                                                                @tab-click="onTabClick"
                                                                @tab-remove="tabRemove">
                                                            <el-tab-pane
                                                                :key="item.name"
                                                                v-for="(item, index) in tabs.list"
                                                                :label="item.title"
                                                                :name="item.name"
                                                                style="height:100%;">
                                                                <span slot="label">
                                                                    <i class="fas fa-code" style="color:rgb(64, 158, 255);"></i> #{item.title}#
                                                                    <el-dropdown trigger="click">
                                                                        <span class="el-dropdown-link">
                                                                            <i class="el-icon-arrow-down"></i>
                                                                        </span>
                                                                        <el-dropdown-menu slot="dropdown">
                                                                            <el-dropdown-item @click.native="tabClose(0,item)">关闭</el-dropdown-item>
                                                                            <el-dropdown-item @click.native="tabClose(1,item)">关闭其它标签页</el-dropdown-item>
                                                                            <el-dropdown-item @click.native="tabClose(2,item)">关闭右侧标签页</el-dropdown-item>
                                                                            <el-dropdown-item divided>
                                                                                <p style="margin:0px;">所在目录：#{item.model.parent}#</p>
                                                                                <p style="margin:0px;">文件类型：#{item.model.ftype}#</p>
                                                                                <p style="margin:0px;">文件大小：#{mx.bytesToSize(item.model.size)}#</p>
                                                                                <p style="margin:0px;">创建时间：#{moment(item.model.vtime).format("LLL")}#</p>
                                                                            </el-dropdown-item>
                                                                        </el-dropdown-menu>
                                                                    </el-dropdown>
                                                                </span>
                                                                <fs-editor-view :id="item.name" :item="item.model" ref="editor"></fs-editor-view>
                                                            </el-tab-pane>
                                                        </el-tabs>
                                                    </el-main>
                                                </el-container>
                                            </el-container>`,
                                created() {
                                    this.tree.root = self.root;
                                },
                                watch:{
                                    'tabs.activeIndex':{
                                        handler(val,oldVal){
                                            // 默认展开节点
                                            this.tabs.activeNode = _.find(this.tabs.list,{name:val}).model || null;
                                        },
                                        deep:true
                                    }
                                },
                                mounted() {
                                    const me = this;
    
                                    _.delay(()=>{
                                        
                                        me.tabAdd(node);

                                        _.delay(()=>{
                                            Split([this.$refs.leftView.$el, this.$refs.mainView.$el], {
                                                sizes: [20, 80],
                                                minSize: [0, 0],
                                                gutterSize: 5,
                                                cursor: 'col-resize',
                                                direction: 'horizontal',
                                            });
                                        },500)
                                        
                                    },50)
                                },
                                methods: {
                                    onTabClick(tab){
                                        //this.tabs.activeNode = _.find(this.tabs.list,{name:val});
                                    },
                                    tabClose(key,tab){
                                        const self = this;

                                        if(key === 0){
                                            self.tabRemove(tab.name);
                                        } else if( key === 1 ){
                                            let others = _.xor(self.tabs.list,[tab]);
                                            _.forEach(others,(v)=>{
                                                self.tabRemove(v.name);
                                            })
                                        } else {
                                            let others = self.tabs.list.slice(_.indexOf(self.tabs.list,tab) + 1, self.tabs.list.length);
                                            _.forEach(others,(v)=>{
                                                self.tabRemove(v.name);
                                            })
                                        }
                                    },
                                    tabAdd(item){
                                        
                                        try {
                                            let pID = objectHash.sha1([item.parent,item.name].join("/"));
                                            
                                            // 已经打开
                                            if(_.find(this.tabs.list,{name:pID})){
                                                this.tabs.activeIndex = pID;
                                                return false;
                                            }
                                            
                                            // 添加tab
                                            this.tabs.list.push({name: pID, title: [item.parent,item.name].join("/"), model: _.extend(item,{output:null})})
                                            this.tabs.activeIndex = _.last(this.tabs.list).name;

                                            _.delay(()=>{
                                                this.initTheme();
                                            },500)
                                            

                                        } catch(error){
                                            this.tabs.list = [];
                                        } 
                                        
                                    },
                                    tabRemove(targetName){
                                        try{
                                            let tabs = this.tabs.list;
                                            let activeIndex = this.tabs.activeIndex;
                                            if (activeIndex === targetName) {
                                            tabs.forEach((tab, index) => {
                                                if (tab.name === targetName) {
                                                let nextTab = tabs[index + 1] || tabs[index - 1];
                                                if (nextTab) {
                                                    activeIndex = nextTab.name;
                                                }
                                                }
                                            });
                                            }
                                            
                                            this.tabs.list = tabs.filter(tab => tab.name !== targetName);
                                            this.tabs.activeIndex = activeIndex;
                                            
                                        } catch(err){
                                            
                                        }
                                    },
                                    onNewProject(){
                                        fileSystem.fileNewTo(this.tree.root,window.fsSelectedItem,self.load);
                                    },
                                    onNewFile(){
                                        let node = _.find(this.tabs.list,{name:this.tabs.activeIndex}).model;
                                        fileSystem.fileNew(node.parent,self.load);
                                    },
                                    onCloseTab(){
                                        if(!_.isEmpty(this.tabs.activeIndex)){
                                            this.tabRemove(this.tabs.activeIndex);
                                        }
                                    },
                                    onCloseWin(){
                                        let win = window.jsPanel.activePanels.getPanel(`jsPanel-editor`);
                                        win.close();
                                    },
                                    onReload(){
                                        let node = _.find(this.tabs.list,{name:this.tabs.activeIndex}).model;
                                        let editor = ace.edit('editor-' + this.tabs.activeIndex);
                                        let rtn = fsHandler.fsContent(node.parent,node.name);

                                        if(editor){
                                            editor.setValue(rtn);
                                        }
                                    },
                                    onUndo(){
                                        let editor = ace.edit('editor-'+this.tabs.activeIndex);
                                        editor.undo();
                                    },
                                    onRedo(){
                                        let editor = ace.edit('editor-'+this.tabs.activeIndex);
                                        editor.redo();
                                    },
                                    onCopy(){
                                        const me = this;
                                        let editor = ace.edit('editor-'+this.tabs.activeIndex);
                                        new Clipboard(`.copy-%{this.tabs.activeIndex}`, {
                                            text: function(trigger) {
                                                me.$message("已复制");
                                                return editor.getValue();
                                            }
                                        });
                                    },
                                    onPaste(){
                                        document.execCommand("paste");
                                        this.$message("已粘贴");
                                    },
                                    onSelect(){
                                        let editor = ace.edit('editor-'+this.tabs.activeIndex);
                                        editor.selection.selectAll();
                                    },
                                    onRemove(){
                                        let editor = ace.edit('editor-'+this.tabs.activeIndex);
                                        if(editor){
                                            editor.setValue();
                                            this.$message("已清空");
                                        }
                                    },
                                    onSave(){
                                        let me = this;
                                        let editor = ace.edit('editor-'+this.tabs.activeIndex);
                                        let sc = editor.getValue();

                                        if(_.isEmpty(editor.getValue())){
                                            return false;
                                        }

                                        // save
                                        let sRtn = fsHandler.fsNew(this.tabs.activeNode.ftype, this.tabs.activeNode.parent, this.tabs.activeNode.name, sc, _.attempt(JSON.parse.bind(null, this.tabs.activeNode.attr)));

                                        if(sRtn == 0){
                                            this.$message("请确认脚本！");
                                            return false;
                                        }

                                        editor.session.getUndoManager().markClean();
                                        //self.updateToolbar();
                                    },
                                    onSaveAs(){
                                        let me = this;
                                        let editor = ace.edit('editor-'+this.tabs.activeIndex);
                                        let sc = editor.getValue();

                                        if(_.isEmpty(editor.getValue())){
                                            return false;
                                        }

                                        // save
                                        let sRtn = fsHandler.fsNew(this.tabs.activeNode.ftype, this.tabs.activeNode.parent, this.tabs.activeNode.name, sc, _.attempt(JSON.parse.bind(null, this.tabs.activeNode.attr)));

                                        if(sRtn == 0){
                                            this.$message("请确认脚本！");
                                            return false;
                                        }

                                        editor.session.getUndoManager().markClean();
                                        //self.updateToolbar();
                                    },
                                    onSaveAndPlay(){
                                        
                                        // $(".fas.fa-play").addClass("fa-spin");

                                        // 先保存
                                        this.onSave();

                                        _.delay(()=>{
                                            // 后运行 depend ftype: js/html
                                            if(_.includes(['html','html'],this.tabs.activeNode.ftype)){
                                                eventHub.$emit(`FS-EDITOR-RUN-EVENT-${this.tabs.activeIndex}`, `/fs${[this.tabs.activeNode.parent,this.tabs.activeNode.name].join("/")}?issys=true&type=open`);
                                            } else {

                                                try {
                                                    let rtn = fsHandler.callFsJScript([this.tabs.activeNode.parent, this.tabs.activeNode.name].join("/").replace(/\/script/g, ""), '');
                                                    _.extend(_.find(this.tabs.list,{name:this.tabs.activeIndex}).model, {output:rtn});
                                                    
                                                    //eventHub.$emit(`FS-EDITOR-RUN-EVENT-${this.tabs.activeIndex}`, rtn);
                                                } catch(err) {
                                                    //eventHub.$emit(`FS-EDITOR-RUN-EVENT-${this.tabs.activeIndex}`, err);
                                                    _.extend(_.find(this.tabs.list,{name:this.tabs.activeIndex}).model, {output:err});
                                                    
                                                }
                                            }
                                        },500)
                                        
                                        // $(".fas.fa-play.fa-spin").removeClass("fa-spin");
                                    },
                                    onDeploy(){
                                        
                                    },
                                    initTheme(){
                                        
                                        let id = this.tabs.activeIndex;
                                        
                                        $.contextMenu({
                                            selector: `.editor-select-theme-${id}`,
                                            trigger: 'left',
                                            callback: function (key, options) {
                                                if(key !== 'bright' && key !== 'dark'){
                                                    let editor = ace.edit('editor-'+id);
                                                    editor.setTheme("ace/theme/"+key);
                                                    localStorage.setItem(`editor-select-theme-${id}`,key);
                                                }
                                            },
                                            items: {
                                                "bright": { name: "亮色", items: {
                                                        "chrome": { name: "chrome"},
                                                        "clouds": { name: "clouds"},
                                                        "crimson_editor": { name: "crimson_editor"},
                                                        "dawn": { name: "dawn"},
                                                        "dreamweaver": { name: "dreamweaver"},
                                                        "eclipse": { name: "eclipse"},
                                                        "github": { name: "github"},
                                                        "iplastic": { name: "iplastic"},
                                                        "solarized_light": { name: "solarized_light"},
                                                        "textmate": { name: "textmate"},
                                                        "tomorrow": { name: "tomorrow"},
                                                        "xcode": { name: "xcode"},
                                                        "kuroir": { name: "kuroir"},
                                                        "katzenmilch": { name: "katzenmilch"},
                                                        "sqlserver": { name: "sqlserver"}
                                                    }
                                                },
                                                "dark": { name: "暗色", items: {
                                                        "ambiance": { name: "ambiance"},
                                                        "chaos": { name: "chaos"},
                                                        "clouds_midnight": { name: "clouds_midnight"},
                                                        "dracula": { name: "dracula"},
                                                        "cobalt": { name: "cobalt"},
                                                        "gruvbox": { name: "gruvbox"},
                                                        "gob": { name: "gob"},
                                                        "idle_fingers": { name: "idle_fingers"},
                                                        "kr_theme": { name: "kr_theme"},
                                                        "merbivore": { name: "merbivore"},
                                                        "merbivore_soft": { name: "merbivore_soft"},
                                                        "mono_industrial": { name: "mono_industrial"},
                                                        "monokai": { name: "monokai"},
                                                        "pastel_on_dark": { name: "pastel_on_dark"},
                                                        "solarized_dark": { name: "solarized_dark"},
                                                        "terminal": { name: "terminal"},
                                                        "tomorrow_night": { name: "tomorrow_night"},
                                                        "tomorrow_night_blue": { name: "tomorrow_night_blue"},
                                                        "tomorrow_night_bright": { name: "tomorrow_night_bright"},
                                                        "tomorrow_night_eighties": { name: "tomorrow_night_eighties"},
                                                        "twilight": { name: "twilight"},
                                                        "vibrant_ink": { name: "vibrant_ink"}
                                                    }
                                                }
                                            }
                                        });
                                    }
                                }
                            },
                            /* md: { 
                                data: {
                                    layout: null,
                                    config: {
                                        settings: {
                                            hasHeaders: true,
                                            showPopoutIcon: false,
                                            showCloseIcon: false,
                                            selectionEnabled: false,
                                            constrainDragToContainer: false
                                        },
                                        dimensions: {
                                            borderWidth: 3
                                        },
                                        content: [{
                                            type: 'row',
                                            content: [{
                                                type: 'component',
                                                title: '编辑',
                                                height: 50,
                                                componentName: 'fsEditorComponent',
                                                componentState: {
                                                    id: 'editor-main-top',
                                                    div: `<div id="fs-editor-main-top-${pID}"></div>`
                                                }
                                            }, {
                                                type: 'component',
                                                title: '预览',
                                                height: 50,
                                                componentName: 'fsEditorComponent',
                                                componentState: {
                                                    id: 'editor-main-bottom',
                                                    div: `<div id="fs-editor-main-bottom-${pID}"></div>`
                                                }
                                            }]
                                        }]
                                    },
                                    editor: {
                                        delimiters: ['#{', '}#'],
                                        el: `#fs-editor-main-top-${pID}`,
                                        template: `<fs-md-editor-component :id="id" :bid="bid"
                                                          :model="model"
                                                          showToolsBar="false"
                                                          showStatusBar="false"
                                                          ref="editor"></fs-md-editor-component>`,
                                        data: {
                                            id: `editor-${pID}`,
                                            bid: `${pID}`,
                                            model: {
                                                oldInput: "",
                                                newInput: "",
                                                mode: "",
                                                theme: "tomorrow",
                                                printMargin: false,
                                                readOnly: false,
                                                fs: node
                                            }
                                        },
                                        mounted: function () {
                                            const me = this;
    
                                            me.$nextTick(function () {
                                                me.init();
                                            })
                                        },
                                        methods: {
                                            init: function () {
                                                const me = this;
    
                                                let rtn = fsHandler.fsContent(node.parent, node.name);
    
                                                me.model.newInput = rtn;
    
                                            }
                                        }
    
                                    },
                                    output: {
                                        el: `#fs-editor-main-bottom-${pID}`,
                                        template:
                                            `<div :id="id" v-html="compiledMarkdown" style="display: inline-block; overflow:auto; width: 100%;height: 100%;vertical-align: top;box-sizing: border-box;padding: 0 20px;"></div>`,
                                        data: {
                                            id: `editor-output-${pID}`,
                                            compiledMarkdown: ""
                                        },
                                        created: function () {
                                            eventHub.$on(`OUTPUT-CHANGE-EVENT-${pID}`, this.setContent)
                                        },
                                        methods: {
                                            setContent: function (event) {
                                               this.compiledMarkdown = marked(event, { sanitize: true });
                                            }
                                        }
                                    }
                                },
                                created: function () {
                                    const me = this;
    
                                    eventHub.$on("WINDOW-STATUS-CHANGE-EVENT", me.resizeLayout);
                                },
                                mounted: function () {
                                    const me = this;
    
                                    me.$nextTick(function () {
                                        setTimeout(function () {
                                            me.init();
                                        });
                                    })
                                },
                                methods: {
                                    init: function () {
                                        const me = this;
    
                                        me.layout = new GoldenLayout(me.config, me.$el);
    
                                        me.layout.registerComponent('fsEditorComponent', function (container, state) {
                                            // console.log(state)
                                        });
    
                                        me.layout.on('componentCreated', function (component) {
    
                                            let state = component.config;
                                            let id = state.componentState.id;
                                            let html = state.componentState.div;
    
                                            component.container.getElement().html(html);
                                        });
    
                                        //  Initialize GL
                                        me.layout.init();
    
                                        //  Update GL on window resize
                                        window.addEventListener('resize', function () {
                                            me.layout.updateSize();
                                        });
    
                                        _.delay(function () {
                                            me.fsEditor();
                                            me.fsOutput();
                                        }, 300);
    
                                    },
                                    fsEditor: function () {
                                        const me = this;
    
                                        new Vue(me.editor);
                                    },
                                    fsOutput: function () {
                                        const me = this;
    
                                        new Vue(me.output);
                                    },
                                    resizeLayout: function () {
                                        const me = this;
    
                                        me.layout.updateSize();
                                    }
                                }
                            }*/
                        };
    
                    
                    // 判断是否已有窗体打开
                    try {
                        if( window.jsPanel.activePanels.getPanel(`jsPanel-editor`) ){
                            window.jsPanel.activePanels.getPanel(`jsPanel-editor`).front();
                            window.editorApp.tabAdd(node);
                        } 
                    } catch(err){
                        // 模板，作为vue组件容器
                        let content = `<div id="fs-editor-template" style="width: 100%;height: 100%;"></div>`;
                        
                        // 打开窗体
                        let win = maxWindow.winEditor("M³ Devops", content, null, null);
                        // vue组件实例化
                        let ed = node.ftype==='md' ? editor[node.ftype] : editor['normal'];
                        window.editorApp = new Vue(ed).$mount(`#fs-editor-template`);
                        
                    } 
    
                },
                downloadIt(item, prompt) {
                    const self = this
    
                    if(item.ftype == 'dir'){
                        let rtn = fsHandler.fsList(item.parent);
    
    
                    } else {
    
                        /*if(_.includes(['zip','gz','tar','exe','png','gif','svg','doc','ppt','file'],item.ftype)){
                            let _url = `/fs/${item.parent}/${item.name}?type=download`.replace(/\/\//g,'/');
                            let _target = '_blank';
                            // system || extend || ...
                            if(_.startsWith(item.parent,'/extend') || _.startsWith(item.parent,'/script') || _.startsWith(item.parent,'/app')){
                                _url += '&issys=true';
                            }
                            window.open(_url, _target);
                        } else if(_.includes(['mp3','mp4'],item.ftype)){
                            let _url = `/fs/${item.parent}/${item.name}?type=download`.replace(/\/\//g,'/');
                            let _target = '_blank';
                            // system || extend || ...
                            if(_.startsWith(item.parent,'/extend') || _.startsWith(item.parent,'/script') || _.startsWith(item.parent,'/app')){
                                _url += '&issys=true';
                            }
                            window.location.href=_url;
                        } else {
                            let rtn = fsHandler.fsContent(item.parent, item.name);
                            let blob = new Blob([rtn], {type: "text/plain;charset=utf-8"});
    
                            saveAs(blob, `${item.name}`);
                        }*/
    
                        let _url = `/fs/${item.parent}/${item.name}?type=download&issys=${window.SignedUser_IsAdmin}`.replace(/\/\//g,'/');
                        let _target = '_blank';
                        // system || extend || ...
                        //if(_.startsWith(item.parent,'/extend') || _.startsWith(item.parent,'/script') || _.startsWith(item.parent,'/app')){
                        /*if(item.parent === "/"){
                            _url += '&issys=true';
                        }*/
                        window.open(_url, _target);
                    }
    
    
                },
                downloadThem(){
                    const self = this
    
                    let _them = $(".fs-node-highlight .list-context-menu");
    
                    if(_.isEmpty(_them)) {
                        alertify.log("选择需要下载的对象！");
                        return false;
                    }
    
                    let zip = new JSZip();
                    _.forEach(_them, function(v,k){
                        let item = $(v).data("item");
                        let rtn = fsHandler.fsContent(item.parent, item.name);
                        let blob = new Blob([rtn], {type: "text/plain;charset=utf-8"});
                        zip.file(`${item.name}`,rtn);
                    })
    
                    zip.generateAsync({type:"blob"})
                        .then(function(content) {
                            saveAs(content, `${self.rootPath}.zip`);
                        });
    
    
                },
                exportIt(path){
                    const self = this;
                    
                    alertify.confirm(`确认要导出 ${path} 目录下的所有文件?`, function (e) {
                        if (e) {
                            fsHandler.fsZip(path);
                            self.$message({
                                type: "info",
                                message: "导出操作将提交至后台，请稍后。。。"
                            })
                        } else {
                            
                        }
                    });
    
                },
                importIt(event) {
                    const self = this;
    
                    let file = event.target.files[0];
                    
                    alertify.confirm(`确认要导入 ${file.name} 文件，导入后将覆盖原有文件，请确认！<br><br>
                                        文件名称：${file.name}<br><br>
                                        修改时间：${file.lastModifiedDate}<br><br>
                                        文件大小：${mx.bytesToSize(file.size)}`, function (e) {
                        if (e) {
                            let rtn = fsHandler.fsUnZip(self.rootPath, file);

                            self.$message({
                                type: "info",
                                message: "导入操作将提交至后台，请稍后。。。"
                            })

                            if(rtn == 1){
                                self.load();
                            }
                        } else {
                            
                        }
    
                        event.target.value = null;
    
                    });
                },
                syncIt(){
                    const self = this
    
                    alertify.prompt("同步设置", function (e, str) {
                        // str is the input text
                        if (e) {
                            // user clicked "ok"
                        } else {
                            // user clicked "cancel"
                        }
                    }, "url:http://47.92.151.165/matrix/web.git;username:admin;password:admin;interval=24hour;");
                    $(".alertify-prompt .alertify-message").css('height','5vh');
                },
                selectIt(item){
                    const self = this
                    
                    if(_.find(self.selectedItem,item)) {
                        self.selectedItem = _.filter( self.selectedItem,function(v){ return v.id != item.id} );
                    } else {
                        self.selectedItem.push(item);
                    }
    
                    window.fsSelectedItem = self.selectedItem;//[];
                    
                },
                selectAll(){
                    const self = this
    
                    let items = $("li.fs-node").find('.fs-name');
    
                    self.selectedItem = [];
            
                    _.forEach(items,function(v){
                        let item = $(v).data("info");
    
                        self.selectedItem.push(item);
                    })
    
                    //window.fsSelectedItem = self.selectedItem;//[];
    
                },
                setRootPath(item) {
                    const self = this;
                    
                    let _item = _.attempt(JSON.parse.bind(null, decodeURIComponent(window.atob(item))));
    
                    self.openIt(_item, [_item.parent,_item.name].join("/"));
    
                },
                toggleLeft() {
                    const self = this;
    
                    if(self.toggle.left) {
    
                        $("#nav").hide();
    
                        $("#content").removeClass("col-lg-10");
                        $("#content").addClass("col-lg-12");
    
                        $(".navtoggle").removeClass("fa fa-caret-left");
                        $(".navtoggle").addClass("fa fa-caret-right");
    
                        self.toggle.left = false;
                    } else {
                        $("#nav").slideDown(500);
                        $("#nav").show();
    
                        $("#content").removeClass("col-lg-12");
                        $("#content").addClass("col-lg-10");
                        //$("#content").find(".panel-default").css("border-left","2px #ddd dotted");
    
                        $(".navtoggle").removeClass("fa fa-caret-right");
                        $(".navtoggle").addClass("fa fa-caret-left");
    
                        self.toggle.left = true;
                    }
                }
            }
        
        }
        </script>
    
    
    
    </code>
    