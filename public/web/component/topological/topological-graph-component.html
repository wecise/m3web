<code>

	<style scoped>
		/*----------  style  ----------*/
        .pace{
            display: none!important;
        }
        
        .topological-graph-component{
            height: 100%;
        }

        
		.topological-graph-component .el-input--small .el-input__inner {
            height: 35px!important;
            line-height: 35px!important;
        }

		.topological-graph-component .node-menu{
			width:20vw;
		}

        .topological-graph-component .tools-search {
			width: 100%;
            float: right;
            height: 100%;
            line-height: 30px;
            border: unset;
            background: #ffffff;
        }
        
        .topological-graph-component .tools-search .el-input__inner {
			background: transparent;
            border: unset;
        }
        .topological-graph-component .tools-search .el-input-group__append, 
        .topological-graph-component .tools-search .el-input-group__prepend{
            border:unset;
            padding: 0 5px;
        }

        /* ToolBar */
        .topological-graph-component .tools {
			overflow: hidden;
            width: 45%;
            height: 100%;
            display: flex;
            padding: 0px;
		}

        .topological-graph-component .tools .el-color-picker__trigger{
            width: 18px;
            height: 18px;
            padding: 0px;
            border: unset;
        }
        .topological-graph-component .tools > a + a {
            padding: 0 5px;
        }
        .topological-graph-component .tools > a{
            line-height: 24px;
            height:24px;
        }

        .topological-graph-component .controlBar{
            position:absolute;
            z-index:1000;
			top:5px;
			right:5px;
        }

        .topological-graph-component .outlineContainer {
			position:absolute;
            z-index:1000;
			overflow:hidden;
			top:35px;
			right:5px;
			width: 80px;
			height:80px;
            padding:5px;
			background: #ffffff;
			box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
			border: unset;
            border-radius: 5px;
		}

        .topological-graph-component .search-toolbar{        
            position: absolute;
            width: auto;
            max-width: 30vw;
            height: auto;
            z-index: 1000;
            top:5px;
            left:5px;
            box-shadow: 1px 2px 1px rgba(0,0,0,.15);
            border: 1px solid #ddd;
            background: #ffffff;
        }
        .topological-graph-component .search-toolbar .el-input__inner,
        .topological-graph-component .search-toolbar .el-button{
            border:unset;
        } 

        .topological-graph-component .vertical-toolbar{
            position: absolute;
            width: 29px;
            height: auto;
            background: #ffffff;
            z-index: 1000;
            right: 5px;
            bottom: 65px;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 0px 6px;
        }
        .topological-graph-component .vertical-toolbar > button{
            margin: 0 5px;
        }
        .topological-graph-component .vertical-toolbar > .el-dropdown,
        .topological-graph-component .vertical-toolbar > .el-color-picker{
            margin: 5px;
        }

        .topological-graph-component .horizontal-toolbar{
            position: absolute;
            width: auto;
            height: 30px;
            line-height: 30px;
            background: #ffffff;
            z-index: 1000;
            right: 5px;
            bottom: 60px;
            -webkit-transform: translateZ(0);
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 0px 6px;
        }

        .topological-graph-component .footerbar {
            width: 100%;
            height: auto!important;
            padding: 0px;
            background: #f2f3f5;
        }
        .topological-graph-component .footerbar > a{
            padding: 0px 10px 0px 5px;
            background: #fff;
            height: 30px;
            line-height: 30px;
            overflow-y: auto;
            border-radius: 20px;
        }
        .topological-graph-component .footerbar > a:hover{
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        .topological-graph-component .footerbar > a > span{
            background: #ddd;
            padding: 5px 8px;
            border-radius: 15px;
        }
        .topological-graph-component .footerbar > a + a{
            margin-left: 5px;
        }

        .topological-graph-component svg foreignObject div {
            user-select: none;
        }

        .el-tooltip__popper.is-light {
            background: #FFF;
            /* border: 1px solid #303133; */
            padding: 10px;
            position: absolute;
            background: #fff;
            min-width: 150px;
            border-radius: 4px;
            border: 1px solid #ebeef5;
            padding: 12px;
            z-index: 2000;
            color: #606266;
            line-height: 1.4;
            text-align: justify;
            font-size: 14px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,.1);
            word-break: break-all;
        }

        .el-tooltip__popper is-light .popper__arrow, .el-popper .popper__arrow:after {
            position: absolute;
            display: block;
            width: 0;
            height: 0;
            border-color: transparent!important;
            border-style: solid;
        }

        .el-divider.el-divider--horizontal{
            margin: 0px;
        }

        /* 工具栏拾色器 */
        .topological-graph-component .el-color-picker{
            padding: unset!important;
        }

        .topological-graph-component .el-color-picker--small .el-color-picker__trigger {
            height: 18px;
            width: 18px;
            padding: 2px;
            margin-top: 4px;
            border:none;
        }

        .topological-graph-component .el-input-group__append, 
        .topological-graph-component .el-input-group__prepend,
        .topological-graph-component .el-input__inner{
            border-radius: 0px;
        }
        .topological-graph-component .el-input.is-disabled .el-input__inner {
            background-color: #ffffff;
        }

        .el-color-dropdown.el-color-picker-dropdown.el-color-picker__panel{
            z-index: 30000!important;
        }

        /* jsPanel graphAction */
        .graphAction .input-with-select.el-input.el-input--small{
            border-bottom: 1px solid #ddd!important;
        }
        .graphAction .topological-analysis-input .el-input-group__append, .graphAction .el-input-group__prepend, .graphAction .el-input__inner {
            background-color: transparent!important;
            border: unset!important;
        }
        .graphAction .topological-analysis-form .el-input__inner{
            background-color: #FFF!important;
            border:1px solid #DCDFE6!important;
            height: 32px!important;
            line-height: 32px!important;
        }


        /* graph */
        .topological-search-toolbar-graph .el-input-group__prepend{
            background: transparent;
            border: unset;
            padding: 0 5px;
            
        }
        
        .topological-search-toolbar-graph .el-input__inner{
            padding: 0 5px;   
        }

        /* graphAdv  */
        .topological-search-toolbar-graphAdv .el-textarea__inner,
        .topological-search-toolbar-path .el-radio-button__inner{
            border:unset;
        }
        .topological-search-toolbar-path .el-radio-button__orig-radio:checked+.el-radio-button__inner {
            color: #333333;
            background-color: #ffffff;
            border-color: #ffffff;
            -webkit-box-shadow: unset;
            box-shadow: unset;
        }
        .topological-search-toolbar-path .el-radio-button__orig-radio:checked+.el-radio-button__inner:before {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 29px;
            border-width: 0 6px 6px;
            border-style: solid;
            border-color: #2790e2 transparent;
            display: block;
            width: 0;
            -webkit-transition-duration: 0.3s;
            transition-duration: 0.3s;
            -webkit-transition-property: transform;
            transition-property: transform;
        }
        .topological-search-toolbar-path .el-radio-button__orig-radio:checked+.el-radio-button__inner:after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 30px;
            border-width: 0 5px 5px;
            border-style: solid;
            border-color: #ffffff transparent;
            display: block;
            width: 0;
            /* -webkit-transition-duration: 0.3s;
            transition-duration: 0.3s;
            -webkit-transition-property: transform;
            transition-property: transform; */
        }

        .topological-graph-component .div-hover-effect:hover{
            background: #f2f3f5;
        }
        .topological-graph-component .div-hover-effect:visited,
        .topological-graph-component .div-hover-effect:focus{
            background: #f2f3f5;
        }

        .info-popper{
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            background: #fff;
            padding: 10px;
            outline: unset;
        }

        .info-popper .el-divider__text, 
        .info-popper .el-link {
            font-weight: unset;
            font-size: 12px;
        }

        .el-textarea__inner{
            border: unset; 
            transition: 0.4s;
        }
        .el-textarea__inner:focus{
            border: 1px solid #ddd;
            background: #f2f3f5;
            transition: 0.4s;
        }

        /* diagnosis view style */
        .graph-view-diagnosis .entity-diagnosis-tabs > .el-tabs__header.is-left {
            background: #f2f3f5;
        }
        .graph-view-diagnosis .entity-diagnosis-tabs .el-tabs__nav.is-left .el-tabs__item.is-left.is-active {
            background: #ffffff;
        }
        .graph-view-diagnosis .el-tabs--left .el-tabs__nav-wrap.is-left {
            margin-right: 0px;
        }

        /* mxPopuMenu */
        div.mxPopupMenu{
            -webkit-box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1)!important;
            -moz-box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1)!important;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1)!important;
            border: unset!important;
        }
        
        /* mxToolTip */
        div.mxTooltip {
            background: #fff;
            border: unset!important;
            font-family: inherit;
            font-size: 12px;
            padding: 10px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }

        /* graph background pattern */
        .topological-graph-component #graphContainer > svg.grid-pattern{
            background:
                linear-gradient(-90deg, rgba(0,0,0,.05) 1px, transparent 1px),
                linear-gradient(rgba(0,0,0,.05) 1px, transparent 1px), 
                linear-gradient(-90deg, rgba(0, 0, 0, .04) 1px, transparent 1px),
                linear-gradient(rgba(0,0,0,.04) 1px, transparent 1px),
                linear-gradient(transparent 3px, #f2f2f2 3px, #f2f2f2 78px, transparent 78px),
                linear-gradient(-90deg, #aaa 1px, transparent 1px),
                linear-gradient(-90deg, transparent 3px, #f2f2f2 3px, #f2f2f2 78px, transparent 78px),
                linear-gradient(#aaa 1px, transparent 1px),
                #f2f2f2;
            background-size:
                4px 4px,
                4px 4px,
                80px 80px,
                80px 80px,
                80px 80px,
                80px 80px,
                80px 80px,
                80px 80px;
        }

        /* note background */
        .topological-view-diagnosis .notes-view-content {
            height: calc(100% - 45px)!important;
            background: #f9f9f5;
        }

        /* edge flow Effect */
        .topological-graph-component .flow {
		  stroke-dasharray: 8;
		  animation: dash 0.5s linear;
		  animation-iteration-count: infinite;
		}
		@keyframes dash {
		  to {
		    stroke-dashoffset: -16;
		  }
		}

        /* report */
        .topological-graph-component .topological-report{
            background: #f2f3f5;
            margin: 20px 120px;
            height: 95%!important;
            overflow: auto;
            outline-style: none;
        }

        .topological-graph-component .topological-report .el-drawer__header > span{
            font-size: 18px;
            outline-style: none;
        }
    }

	</style>

	
	/*----------  最外层element会自动增加组件同名 class="topological-graph-component"  ----------*/
	<template>
		<el-main style="overflow:hidden;padding: 0px;width:100%;height:100%;">
            <el-container id="container" style="width:100%;height:100%;position: relative;" ref="container" direction="vertical">
                <el-header style="height:35px;line-height: 35px;padding:0px;position: relative;display:none;">
                    <graph-view-search class="tools-search" ref="graphViewSearch"></graph-view-search>
                </el-header>
                <el-main id="graphContainer" ref="graphContainer" 
                        style="width:100vw;height:100vh;min-width:100vw;position:releative;overflow:hidden;padding:0px;">
                </el-main>
                <el-footer class="footerbar" ref="footer" v-if="model.graph.footbar.show">
                    <topological-timeline :model="model.graph.allNodesIds" ref="timeline"></topological-timeline>
                </el-footer>
                <!--el-footer class="footerbar" ref="footer" v-else>
                    <topological-timeline-mini :model="model.graph.allNodesIds" ref="timeline"></topological-timeline-mini>
                </el-footer-->
                <div id="search-toolbar" class="search-toolbar">
                    <topological-search-toolbar ref="searchToolbar" style="width:100%;"></topological-search-toolbar>
                </div>
                <div id="controlBar" class="controlBar">
                    <el-tooltip content="分析报告" open-delay="500" placement="left" style="display: none;">
                        <el-button type="text" icon="el-icon-notebook-2" @click="report.show=!report.show"></el-button>
                    </el-tooltip>
                    <el-popover
                        placement="left"
                        trigger="click"
                        popper-class="info-popper">
                        <el-container>
                            <el-main style="padding:0px;">
                                <el-tabs value="setup">
                                    <el-tab-pane label="设置" name="setup">
                                        <el-form>
                                            <el-form-item label="工具栏">
                                                <el-switch
                                                    v-model="model.control.toolbar.show"
                                                    active-color="#13ce66"
                                                    inactive-color="#dddddd"
                                                    @change="onToolbarShowChange">
                                                </el-switch>
                                            </el-form-item>
                                            <el-form-item label="自动刷新">
                                                <el-switch
                                                    v-model="model.control.refresh.enable"
                                                    active-color="#13ce66"
                                                    inactive-color="#dddddd"
                                                    @change="onRefreshChange">
                                                </el-switch>
                                            </el-form-item>
                                            <el-form-item label="手动刷新">
                                                <el-button type="text" @click="refreshEntityStatus"><i class="el-icon-refresh"></i></el-button>
                                            </el-form-item>
                                            <el-form-item label="网格背景">
                                                <el-switch
                                                    v-model="model.graph.style.grid.show"
                                                    active-color="#13ce66"
                                                    inactive-color="#dddddd"
                                                    @change="onToggleGridBg">
                                                </el-switch>
                                            </el-form-item>
                                        </el-form>
                                    </el-tab-pane>
                                    <el-tab-pane label="节点" name="vertex">
                                        <el-form>
                                            <el-form-item label="排列">
                                                <el-select v-model="model.graph.style.vertex.align.value" placeholder="请选择" @change="onVertexAlignChange">
                                                    <el-option :key="item.name" :value="item.value" :label="item.name" v-for="item in model.graph.style.vertex.align.list"></el-option>
                                                </el-select>
                                            </el-form-item>
                                        </el-form>
                                    </el-tab-pane>
                                    <el-tab-pane label="边线" name="edge">
                                        <el-form>
                                            <el-form-item label="样式">
                                                <el-select v-model="model.graph.style.edge.value" placeholder="请选择" @change="onEdgeStyleChange">
                                                    <el-option :key="item.name" :value="item" :label="item.name" v-for="item in model.graph.style.edge.list">
                                                        <div style="display: flex;">
                                                            <el-image
                                                                style="width: 32px; height: 32px"
                                                                :src="item | pickLineStyleImage"></el-image>
                                                            <span>${ item.cnTitle }</span>
                                                        </div>
                                                    </el-option>
                                                </el-select>
                                            </el-form-item>
                                            
                                        </el-form>
                                    </el-tab-pane>
                                </el-tabs>
                            </el-main>
                        </el-container>
                        <el-button type="text" slot="reference">
                            <i class="el-icon-setting" style="font-size:15px;margin:0 5px;">
                        </el-button>
                    </el-popover>
                </div>
                <div id="outlineContainer" class="outlineContainer animated fadeIn" v-show="model.control.toolbar.show"></div>
                <div class="vertical-toolbar animated fadeIn" v-show="model.control.toolbar.show">
                    <el-popover
                        placement="left"
                        title="信息"
                        width="300"
                        trigger="click"
                        @show="onGraphSummaryPopoverShow"
                        @hide="onGraphSummaryPopoverHide"
                        popper-class="info-popper">
                        <el-card>
                            <div v-if="!_.isEmpty(fileInfo)">
                                <el-divider content-position="left">文件</el-divider>
                                <div style="display:flex;flex-wrap: wrap; align-items: flex-start;margin:10px 0px;">
                                    <p>目录：${fileInfo.parent}</p>
                                    <p>名称：${fileInfo.name}</p>
                                </div>
                            </div>
                            <el-divider content-position="left">实体类型 (${_.size(model.graph.allNodesClass)})</el-divider>
                            <el-container>
                                <el-main style="padding:20px 0px;">
                                    <el-checkbox-group 
                                        v-model="model.control.checkedNodes" @change="onCellCheckedChange($event,'vertex')">
                                        <el-checkbox :label="v" 
                                            :key="k" 
                                            v-for="(v,k) in model.graph.allNodesClass">${k} [${_.size(v)}]</el-checkbox>
                                    </el-checkbox-group>
                                </el-main>
                            </el-container>
                            <el-divider content-position="left">关系 (${_.size(model.graph.allNodesEdge)})</el-divider>
                            <el-container>
                                <el-main style="padding:20px 0px;">
                                    <el-checkbox-group 
                                        v-model="model.control.checkedEdges" @change="onCellCheckedChange($event,'edge')">
                                        <el-checkbox :label="v" 
                                            :key="k" 
                                            v-for="(v,k) in model.graph.allNodesEdge">${k} [${_.size(v)}]</el-checkbox>
                                    </el-checkbox-group>
                                </el-main>
                            </el-container>
                            
                        </el-card>
                        <el-button type="text" slot="reference">
                            <i class="el-icon-postcard" style="font-size:18px;margin:0 5px;">
                        </el-button>
                    </el-popover>
                    <el-divider></el-divider>
                    <el-tooltip content="放大" open-delay="500" placement="left">
                       <el-button type="text"  @click="onZoomIn">
                            <i class="el-icon-zoom-in" style="font-size:18px;">
                       </el-button>
                   </el-tooltip>
                   <el-divider></el-divider>
                   <el-tooltip content="缩小" open-delay="500" placement="left">
                       <el-button type="text"  @click="onZoomOut">
                            <i class="el-icon-zoom-out" style="font-size:18px;">
                       </el-button>
                   </el-tooltip>
                   <el-divider></el-divider>
                   <el-tooltip content="将图居中显示"" open-delay="500" placement="left">
                       <el-button type="text"  @click="toCenter(true)">
                            <i class="el-icon-rank" style="font-size:18px;">
                       </el-button>
                   </el-tooltip>
                   <el-divider></el-divider>
                   <el-tooltip content="节点渲染模式" open-delay="500" placement="left">
                        <el-button type="text" :icon="model.control.ifIcon | pickIconStyle" @click="onToggleIcon" style="width:18px;height:auto;">
                        </el-button>
                    </el-tooltip>
                   <el-divider></el-divider>
                   <el-tooltip content="全屏显示" open-delay="500" placement="left">
                       <el-button type="text" :icon="model.control.ifFullScreen | pickScreenStyle" 
                                @click="onFullScreen" style="width:18px;height:auto;">
                       </el-button>
                   </el-tooltip>
                   <el-divider></el-divider>
                   <el-tooltip content="调整布局" open-delay="500" placement="left">
                       <el-dropdown @command="onSetLayout">
                           <span class="el-dropdown-link">
                                <i class="el-icon-view" style="font-size:18px;">
                           </span>
                           <el-dropdown-menu slot="dropdown">
                               <el-dropdown-item :command="{name:'hierarchical_vertical',value:4}">分层</el-dropdown-item>
                               <el-dropdown-item :command="{name:'tree_horizontal',value:null}">树形</el-dropdown-item>
                               <el-dropdown-item :command="{name:'organic',value:null}">随机</el-dropdown-item>
                               <el-dropdown-item :command="{name:'circle',value:null}">圆形</el-dropdown-item>
                           </el-dropdown-menu>
                       </el-dropdown>
                   </el-tooltip>
                   <el-divider></el-divider>
                   <el-tooltip content="打印" open-delay="500" placement="left">
                       <el-button type="text"  @click="onPrint">
                           <i class="el-icon-printer" style="font-size:18px;">
                       </el-button>
                   </el-tooltip>
                   <el-divider></el-divider>
                   <el-tooltip content="调整图背景" open-delay="500" placement="left">
                       <el-color-picker
                           v-model="model.graph.theme.color"
                           :predefine="model.graph.theme.predefineColors"
                           @change="setTheme"
                           style="padding:4px 8px;">
                       </el-color-picker>
                   </el-tooltip>
                   <el-divider></el-divider>
                   <el-tooltip content="时间轴" open-delay="500" placement="left">
                        <el-button type="text"  @click="onToggleTimeline">
                            <i :class="['animated fadeIn ', model.graph.footbar.show ? 'el-icon-d-arrow-right' : 'el-icon-d-arrow-left']"></i>
                        </el-button>
                    </el-tooltip>
               </div>
               <!--  -->
               <el-drawer
                    :title="report.title"
                    :visible.sync="report.show"
                    modal="false"
                    modal-append-to-body="false"
                    direction="rtl"
                    size="80%"
                    custom-class="topological-report"
                    @open="onReportOpen">
                    <iframe :src="report.content" style="width: 100%;height: 100%;" frameborder="0"></iframe>
                    <entity-diagnosis-notes :model="null"></entity-diagnosis-notes>
                </el-drawer>
               <el-dialog
                    title="实体/关系编辑"
                    :visible.sync="entity.dialog.show"
                    width="60%"
                    modal="false"
                    @closed="onEntityDialogClosed">
                    <el-row :gutter="24">
                        <el-col :span="8">
                            <h4>起始点</h4>
                            <el-form label-width="80" v-if="entity.source">
                                <el-form-item label="id">
                                    <el-input v-model="entity.source.id" placeholder="ID" disabled></el-input>
                                </el-form-item>
                                <el-form-item label="value">
                                    <el-input v-model="entity.source.value" placeholder="Value"  disabled></el-input>
                                </el-form-item>
                            </el-form>
                        </el-col>
                        <el-col :span="8" style="border-left:1px solid #dddddd;border-right:1px solid #dddddd;">
                            <h4>选择关系</h4>
                            <el-form label-width="80" v-if="entity.source">
                                <el-form-item label="选择关系类型">
                                    <el-select v-model="entity.edges.value" placeholder="选择关系类型">
                                        <el-option v-for="item in entity.edges.list" 
                                            :key="item.name"
                                            :value="item.name"
                                            :label="item.remedy">
                                        </el-option>
                                    </el-select>
                                </el-form-item>
                                <el-form-item label="关系属性" v-if="!_.isEmpty(item)" v-for="item in entity.edges.properties.list">
                                    <el-input :value="item | pickEdgeProperty" 
                                        placeholder="属性=值" >
                                        <el-button slot="append" type="text" icon="el-icon-delete" @click="onDeleteEdgesProperty(item)" style="padding-left: 10px;color:#ff0000;"></el-button>
                                    </el-input>
                                </el-form-item>
                                <el-form-item label="添加关系属性" >
                                    <el-input v-model="entity.edges.properties.value"
                                        placeholder="属性=值">
                                        <el-button slot="append" type="text" icon="el-icon-plus"  @click="onAddEdgesProperty" style="padding-left: 10px;color:rgb(40, 240, 40)"></el-button>
                                    </el-input>
                                </el-form-item>
                            </el-form>
                        </el-col>
                        <el-col :span="8">
                            <h4>目标点</h4>
                            <el-form label-width="80" v-if="entity.target">
                                <el-form-item label="id">
                                    <el-input v-model="entity.target.id" placeholder="ID"></el-input>
                                </el-form-item>
                                <el-form-item label="name" v-if="!entity.target.type">
                                    <el-input v-model="entity.target.value" placeholder="Value"></el-input>
                                </el-form-item>
                            </el-form>
                        </el-col>
                      </el-row>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="entity.dialog.ifClose = true;entity.dialog.show = false;">取消</el-button>
                        <el-button type="primary" @click="addEntityHandler(null)" v-if="entity.target.type=='new'">创建实体和关系</el-button>
                        <el-button type="primary" @click="createEntityEdgeHandler" v-else>创建关系</el-button>
                    </span>
                </el-dialog>

                <el-dialog
                    title="新建实体"
                    :visible.sync="entity.newDialog.show"
                    width="60%"
                    height="50vh"
                    modal="false"
                    @closed="onEntityDialogClosed">
                    <mx-entity-new></mx-entity-new>
                </el-dialog>

                <el-dialog
                    title="新建关系类型"
                    :visible.syc="entity.newEdgeType.show"
                    width="60%"
                    height="50vh"
                    modal="false"
                    @closed="entity.newEdgeType.show=false">
                    <el-form :model="entity.newEdgeType.model">
                        <el-form-item label="类型名称(Name)" label-width="120px">
                          <el-input v-model="entity.newEdgeType.model.name" autocomplete="off"></el-input>
                        </el-form-item>
                        <el-form-item label="类型描述(Remedy)" label-width="120px">
                            <el-input v-model="entity.newEdgeType.model.remedy" autocomplete="off"></el-input>
                        </el-form-item>
                      </el-form>
                      <div slot="footer" class="dialog-footer">
                        <el-button @click="entity.newEdgeType.show = false">取 消</el-button>
                        <el-button type="primary" @click="onSaveEdgeType">确 定</el-button>
                      </div>
                </el-dialog>

                <el-dialog title="实体备注" :visible.sync="entity.dialogNoteForEntity.show">
                    <h5>${entity.dialogNoteForEntity.model.id}</h5>
                    <el-form>
                      <el-form-item >
                        <el-input type="textarea" :rows="10" 
                            v-model="entity.dialogNoteForEntity.model.note.content" 
                            placeholder="请输入备注"
                            autofocus></el-input>
                      </el-form-item>
                    </el-form>
                    <div slot="footer" class="dialog-footer">
                      <el-button @click="entity.dialogNoteForEntity.show = false">取 消</el-button>
                      <el-button type="primary" @click="addEntityNoteHandler">确 定</el-button>
                    </div>
                </el-dialog>
            </el-container>
		</el-main>
	</template>

	/*----------  id是vue组件的name，内容是vue组件的option参数  ----------*/
	<script id="topological-graph-component">
	{
	    delimiters: ['${', '}'],
	    props: {
	        graphData: Object
	    },
	    data() {
            
            return {
                model:{
                    editor: null,
                    graph:{
                        container: null,
                        model: null,
                        graph: null,
                        parent: null,
                        outline: null,
                        layout: {
                            default: "hierarchical",
                            inst: null,
                            edgeStyle: 2
                        },
                        allNodesIds: [],
                        allNodesClass: null,
                        allNodesEdge: null,
                        nodes:null,
                        edges:null,
                        style: {
                            grid: {
                                show: false
                            },
                            vertex:{
                                align: {
                                    value: '',
                                    list: [
                                        {name: '左对齐', icon:'', value:'mxConstants.ALIGN_LEFT'},
                                        {name: '居中', icon:'', value:'mxConstants.ALIGN_CENTER'},
                                        {name: '右对齐', icon:'', value:'mxConstants.ALIGN_RIGHT'},
                                        {name: '上对齐', icon:'', value:'mxConstants.ALIGN_TOP'},
                                        {name: '中间', icon:'', value:'mxConstants.ALIGN_MIDDLE'},
                                        {name: '下对齐', icon:'', value:'mxConstants.ALIGN_BOTTOM'}
                                    ]
                                }
                            },
                            edge: {
                                endArrow: 'classic',
                                strokeWidth: 1,
                                strokeColor: '#333333',
                                value: {
                                        name: 'straight', cnTitle:'直线', title:'isometricEdgeStyle', keys:[mxConstants.STYLE_EDGE, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], values:[null, null, null]
                                },
                                list: [
                                    {
                                        name: 'straight', cnTitle:'直线', title:'isometricEdgeStyle', keys:[mxConstants.STYLE_EDGE, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], values:[null, null, null]
                                    },
                                    {
                                        name: 'orthogonal', cnTitle:'正交', title:'orthogonalEdgeStyle', keys:[mxConstants.STYLE_EDGE, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], values:['orthogonalEdgeStyle', null, null]
                                    },
                                    {
                                        name: 'simple1', cnTitle:'简单1', title:'elbowEdgeStyle', keys:[mxConstants.STYLE_EDGE, mxConstants.STYLE_ELBOW, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], values:['elbowEdgeStyle', null, null, null]
                                    },
                                    {
                                        name: 'simple2', cnTitle:'简单2', title:'elbowEdgeStyle', keys:[mxConstants.STYLE_EDGE, mxConstants.STYLE_ELBOW, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], values:['elbowEdgeStyle', 'vertical', null, null]
                                    },
                                    {
                                        name: 'isometric1', cnTitle:'等距1', title:'isometricEdgeStyle', keys:[mxConstants.STYLE_EDGE, mxConstants.STYLE_ELBOW, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], values:['isometricEdgeStyle', null, null, null]
                                    },
                                    {
                                        name: 'isometric2', cnTitle:'等距2', title:'isometricEdgeStyle', keys:[mxConstants.STYLE_EDGE, mxConstants.STYLE_ELBOW, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], values:['isometricEdgeStyle', 'vertical', null, null]
                                    },
                                    {
                                        name: 'entityRelation', cnTitle:'实体关联', title:'entityRelationEdgeStyle', keys:[mxConstants.STYLE_EDGE, mxConstants.STYLE_CURVED, mxConstants.STYLE_NOEDGESTYLE], values:['entityRelationEdgeStyle', null, null]
                                    }
                                ]
                            }
                        },                 
                        path: {
                            list:[],
                            colors:['#ff0000','#ffd700','#666666','#00ffff','#40e0d0','#ff7373','#d3ffce','#3399ff','#000080','#66cccc','#a0db8e','#794044','#6897bb','#cc0000'],
                        },
                        default: {
                            title: 'name',
                            list: []
                        },
                        theme:{
                            color: "#FFFFFF",
                            predefineColors: [
                                                '#ffffff',
                                                '#f2f3f5',
                                                '#dddddd',
                                                '#e7e7e7',
                                                '#c7c7c7',
                                                '#6b778d',
                                                '#263859',
                                                '#17223b',
                                                '#333333',
                                                '#D3FFF4',
                                                '#EBDCF4',
                                                '#B3C0FD',
                                                '#AE8BB5',
                                                '#736D6D'
                                                ]
                        },
                        history:[],
                        footbar:{
                            show: false
                        },
                        show: {
                            type: "image"
                        }
                    },
                    control: {
                        ifFullScreen: false,
                        ifIcon: true,
                        show: true,
                        checkedNodes:[],
                        checkedEdges:[],
                        toolbar: {
                            show: true,
                        },
                        refresh:{
                            inst: null,
                            enable: false,
                            interval: 15*1000
                        },
                        splitInst: null
                    }
                },
                entity: {
                    dialog: {
                        show: false,
                        ifClose: false,
                        classList: fsHandler.callFsJScript("/matrix/omdb/getClassListForTree.js",encodeURIComponent("/matrix/entity")).message,
                        defaultProps: {
                            children: 'children',
                            label: 'class'
                        }
                    },
                    newDialog:{
                        show: false,
                        tree: {

                        },
                        model:{
                            id:"",
                            name:"",
                            class: ""
                        }
                    },
                    newEdgeType: {
                        show:false,
                        model: {
                            name:"",
                            remedy: ""
                        }
                    },
                    dialogNoteForEntity:{
                        show:false,
                        model: {
                            id: "",
                            note: {   
                                parent: "",
                                name: "",
                                ftype: "md",
                                item: "",
                                content: ""
                            }
                        }
                    },
                    source: {},
                    target: {},
                    edges: {
                        value: "",
                        list: fsHandler.callFsJScript("/matrix/graph/edges.js",null).message,
                        properties: {
                            value: "",
                            list: []
                        }
                    }
                },
                layout: {
                    splitInst: null
                },
                global: {
                    count: 0
                },
                fileInfo: {},
                report:{
                    show: false,
                    content: "",
                    title: "汇总报告"
                }
	        }
        },
        filters: {
            genFileName(event){
                return `${window.ASSETS_ICON}/tools/png/${event}.png?type=open&issys=${window.SignedUser_IsAdmin}`;
            },
            pickScreenStyle(evt){
                if(evt){
                    return `el-icon-full-screen`;
                } else {
                    return `el-icon-copy-document`;
                }
            },
            pickIconStyle(evt){
                if(evt){
                    return `el-icon-picture-outline`;
                } else {
                    return `el-icon-s-help`;
                }
            },
            pickEdgeProperty(item) {
                
                try {
                    return `${ [item.name,item.value].join("=") }`;
                } catch(err){
                    console.log(err);
                }
            },
            pickLineStyleImage(item){
                try{
                    return `${window.ASSETS_ICON}/graph/tools/line/${item.name}.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                } catch(err){
                    return `${window.ASSETS_ICON}/graph/tools/line/straight.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                }
            }
        },
	    watch:{
	        graphData:{
                handler:function(val,oldVal){
                    
                    if(_.isEmpty(val.nodes)){
                        
                        this.$message({
                            type: "info",
                            message: "没有匹配的实体图谱"
                        })

                        //清空画布
                        this.onClear();

                        return false;
                    }

                    if(val === oldVal){
                        return false;
                    } else {
                        this.onReload();
                    }
                },
                deep:true
            },
            'model.graph.allNodesIds': {
                handler:function(val,oldVal) {
                    
                    try{
                        this.fileInfo = this.$refs.searchToolbar.file.doc;
                    } catch(err){

                    }
                },
                deep:true,
                immediate: true
            },
            'model.control.refresh.enable':{
                handler(val,oldVal){
                    if(val) {
                        this.model.control.refresh.inst = setInterval(()=>{
                            this.refreshEntityStatus();
                        },this.model.control.refresh.interval);
                        this.$message({
                            type: "info",
                            message: "自动刷新开启"
                        })
                    } else {
                        clearInterval(this.model.control.refresh.inst);
                        this.$message({
                            type: "info",
                            message: "自动刷新关闭"
                        })
                    }
                },
                deep:true
            },
            'model.graph.footbar.show':function(val,oldVal){
                if(val){
                    this.model.control.toolbar.show = !this.model.control.toolbar.show;

                    _.delay(()=>{
                        this.model.control.splitInst = Split([this.$refs.graphContainer.$el,this.$refs.footer.$el], {
                            sizes: [70, 30],
                            minSize: [0, 0],
                            cursor: 'col-resize',
                            direction: 'vertical',
                            gutterSize: 5
                        });
                    },1000)
                    
                } else {
                    this.model.control.splitInst.destroy();
                }
            },
            'model.graph.style.grid.show':{

                handler:function(val,oldVal){
                    
                    if(val){
                        _.delay(()=>{
                            $("#graphContainer>svg").addClass("grid-pattern");
                        },2000)
                        
                    } else{
                        $("#graphContainer>svg").removeClass("grid-pattern");
                    }
                },
                deep:true,
                immediate:true
            }
        },
        created(){
            
            // 实体新建成功
            eventHub.$on("ENTITY-ADD-EVENT", this.addEntityToGraph);
            // 删除路径
            eventHub.$on("TOPOLOGICAL-ANALYSIS-CALLBACK", this.removePath);
            
            // 节点是否可以移动 
            mxGraphHandler.prototype.setMoveEnabled(true);
            //显示节点位置标尺  
            mxGraphHandler.prototype.guidesEnabled = true;

            // Alt disables guides
            mxGuide.prototype.isEnabledForEvent = function(evt){
                return !mxEvent.isAltDown(evt);
            };

            // Enables snapping waypoints to terminals
            mxEdgeHandler.prototype.snapToTerminals = true;

            // Defines an icon for creating new connections in the connection handler.
            // This will automatically disable the highlighting of the source vertex.
            //mxConnectionHandler.prototype.connectImage = new mxImage('/fs/assets/images/tools/down.gif?type=open&issys=true', 14, 14);

            // Sets the collapse and expand icons. The values below are the default
            // values, but this is how to replace them if you need to.
            mxGraph.prototype.collapsedImage = new mxImage('/fs/assets/images/graph/tools/collapsed.gif?type=open&issys=true', 9, 9);
            mxGraph.prototype.expandedImage = new mxImage('/fs/assets/images/graph/tools/expanded.gif?type=open&issys=true', 9, 9);
            
            // Adds connect icon to selected vertex
			var connectorSrc = '/fs/assets/images/tools/png/handle-connect.png?type=open&issys=true';
            var vertexHandlerInit = mxVertexHandler.prototype.init;
			mxVertexHandler.prototype.init = function(){
				// TODO: Use 4 sizers, move outside of shape
				//this.singleSizer = this.state.width < 30 && this.state.height < 30;
				vertexHandlerInit.apply(this, arguments);
	
				// Only show connector image on one cell and do not show on containers
				if (this.graph.connectionHandler.isEnabled() &&
					this.graph.isCellConnectable(this.state.cell) &&
					this.graph.getSelectionCount() == 1)
				{
					this.connectorImg = mxUtils.createImage(connectorSrc);
					this.connectorImg.style.cursor = 'pointer';
					this.connectorImg.style.width = '29px';
					this.connectorImg.style.height = '29px';
					this.connectorImg.style.position = 'absolute';
					
					if (!mxClient.IS_TOUCH)
					{
						mxEvent.redirectMouseEvents(this.connectorImg, this.graph, this.state);
					}
	
					// Starts connecting on touch/mouse down
					mxEvent.addGestureListeners(this.connectorImg,
						mxUtils.bind(this, function(evt)
						{
							this.graph.popupMenuHandler.hideMenu();
							this.graph.stopEditing(false);
							
							var pt = mxUtils.convertPoint(this.graph.container,
									mxEvent.getClientX(evt), mxEvent.getClientY(evt));
							this.graph.connectionHandler.start(this.state, pt.x, pt.y);
							this.graph.isMouseDown = true;
							this.graph.isMouseTrigger = mxEvent.isMouseEvent(evt);
							mxEvent.consume(evt);
						})
					);
	
					this.graph.container.appendChild(this.connectorImg);
				}
	
				this.redrawHandles();
            };
            var vertexHandlerHideSizers = mxVertexHandler.prototype.hideSizers;
			mxVertexHandler.prototype.hideSizers = function()
			{
				vertexHandlerHideSizers.apply(this, arguments);
				
				if (this.connectorImg != null)
				{
					this.connectorImg.style.visibility = 'hidden';
				}
			};
			
			var vertexHandlerReset = mxVertexHandler.prototype.reset;
			mxVertexHandler.prototype.reset = function()
			{
				vertexHandlerReset.apply(this, arguments);
				
				if (this.connectorImg != null)
				{
					this.connectorImg.style.visibility = '';
				}
			};
			
			var vertexHandlerRedrawHandles = mxVertexHandler.prototype.redrawHandles;
			mxVertexHandler.prototype.redrawHandles = function()
			{
				vertexHandlerRedrawHandles.apply(this);
	
				if (this.state != null && this.connectorImg != null)
				{
					var pt = new mxPoint();
					var s = this.state;
					
					// Top right for single-sizer
					if (mxVertexHandler.prototype.singleSizer)
					{
						pt.x = s.x + s.width - this.connectorImg.offsetWidth / 2;
						pt.y = s.y - this.connectorImg.offsetHeight / 2;
					}
					else
					{
						pt.x = s.x + s.width + mxConstants.HANDLE_SIZE / 2 + 4 + this.connectorImg.offsetWidth / 2;
						pt.y = s.y + s.height / 2;
					}
					
					var alpha = mxUtils.toRadians(mxUtils.getValue(s.style, mxConstants.STYLE_ROTATION, 0));
					
					if (alpha != 0)
					{
						var cos = Math.cos(alpha);
						var sin = Math.sin(alpha);
						
						var ct = new mxPoint(s.getCenterX(), s.getCenterY());
						pt = mxUtils.getRotatedPoint(pt, cos, sin, ct);
					}
					
					this.connectorImg.style.left = (pt.x - this.connectorImg.offsetWidth / 2) + 'px';
					this.connectorImg.style.top = (pt.y - this.connectorImg.offsetHeight / 2) + 'px';
				}
			};
			
			var vertexHandlerDestroy = mxVertexHandler.prototype.destroy;
			mxVertexHandler.prototype.destroy = function(sender, me)
			{
				vertexHandlerDestroy.apply(this, arguments);
	
				if (this.connectorImg != null)
				{
					this.connectorImg.parentNode.removeChild(this.connectorImg);
					this.connectorImg = null;
				}
			};
			
			// Pre-fetches touch connector
            new Image().src = connectorSrc;
            
            /* Group for Graph */
            // Overrides check for valid roots
            mxGraph.prototype.isValidRoot = function()
            {
                return false;
            };
            
            // Don't clear selection if multiple cells selected
            var graphHandlerMouseDown = mxGraphHandler.prototype.mouseDown;
            mxGraphHandler.prototype.mouseDown = function(sender, me)
            {
                graphHandlerMouseDown.apply(this, arguments);
        
                if (this.graph.isCellSelected(me.getCell()) && this.graph.getSelectionCount() > 1)
                {
                    this.delayedSelection = false;
                }
            };
            
            // Selects descendants before children selection mode
            var graphHandlerGetInitialCellForEvent = mxGraphHandler.prototype.getInitialCellForEvent;
            mxGraphHandler.prototype.getInitialCellForEvent = function(me)
            {
                var model = this.graph.getModel();
                var psel = model.getParent(this.graph.getSelectionCell());
                var cell = graphHandlerGetInitialCellForEvent.apply(this, arguments);
                var parent = model.getParent(cell);
                
                if (psel == null || (psel != cell && psel != parent))
                {
                    while (!this.graph.isCellSelected(cell) && !this.graph.isCellSelected(parent) &&
                            model.isVertex(parent) && !this.graph.isValidRoot(parent))
                    {
                        cell = parent;
                        parent = this.graph.getModel().getParent(cell);
                    }
                }
                
                return cell;
            };
            // Selection is delayed to mouseup if child selected
            var graphHandlerIsDelayedSelection = mxGraphHandler.prototype.isDelayedSelection;
            mxGraphHandler.prototype.isDelayedSelection = function(cell)
            {
                var result = graphHandlerIsDelayedSelection.apply(this, arguments);
                var model = this.graph.getModel();
                var psel = model.getParent(this.graph.getSelectionCell());
                var parent = model.getParent(cell);
                
                if (psel == null || (psel != cell && psel != parent))
                {
                    if (!this.graph.isCellSelected(cell) && model.isVertex(parent) && !this.graph.isValidRoot(parent))
                    {
                        result = true;
                    }
                }
                
                return result;
            };
            // Delayed selection of parent group
            mxGraphHandler.prototype.selectDelayed = function(me)
            {
                var cell = me.getCell();
                
                if (cell == null)
                {
                    cell = this.cell;
                }
                
                var model = this.graph.getModel();
                var parent = model.getParent(cell);
                
                while (this.graph.isCellSelected(cell) && model.isVertex(parent) && !this.graph.isValidRoot(parent))
                {
                    cell = parent;
                    parent = model.getParent(cell);
                }
                
                this.graph.selectCellForEvent(cell, me.getEvent());
            };
            // Returns last selected ancestor
            mxPopupMenuHandler.prototype.getCellForPopupEvent = function(me)
            {
                var cell = me.getCell();
                var model = this.graph.getModel();
                var parent = model.getParent(cell);
                
                while (model.isVertex(parent) && !this.graph.isValidRoot(parent))
                {
                    if (this.graph.isCellSelected(parent))
                    {
                        cell = parent;
                    }
                    
                    parent = model.getParent(parent);
                }
                
                return cell;
            };

            // 状态刷新频率
            this.model.control.refresh.interval = mx.global.register.topological.status_interval;
            // 状态刷新标志
            this.model.control.refresh.enable = (localStorage.getItem("GRAPH-STATUS-IFREFRESH") == 'true');
            //初始化theme
            this.model.graph.theme.color = localStorage.getItem(`GRAPH-VIEW-THEME-${window.SignedUser_UserName}`);
            // 画布背景
            this.model.graph.style.grid.show = (localStorage.getItem("GRAPH-GRID-SHOW") == 'true');

            // 节点渲染方式
            this.model.control.ifIcon = (localStorage.getItem("TOPOLOGICAL-RENDER-TYPE"))=='true'?true:false;
            // 布局类型
            this.model.graph.layout.default = localStorage.getItem("GRAPH-LAYOUT");
            // 关系渲染类型
            this.model.graph.layout.edgeStyle = localStorage.getItem("TOPOLOGICAL-RENDER-EDGESTYLE") || 4;

        },
        mounted() {
	        
	        this.$nextTick(()=>{

                _.delay(()=>{
                    
                    // 初始化
                    this.init();
                    
                    _.delay(()=>{
                        // 初始化ToolBar
                        this.nodeTitle();
                    },500)

                },500)
	            
	        })
        },
	    methods: {
            // 初始化图容器
            init() {
                
                if (!mxClient.isBrowserSupported()){
                    mxUtils.error('Browser is not supported!', 200, false);
                } else {
                    
                    this.model.graph.container = document.getElementById(this.$refs.graphContainer.$el.id);
                    
                    // Workaround for Internet Explorer ignoring certain CSS directives
                    if (mxClient.IS_QUIRKS) {
                        document.body.style.overflow = 'hidden';
                        new mxDivResizer(this.model.graph.container);
                    }

                    // 初始化Graph
                    this.model.editor = new mxEditor();
                    //this.model.editor.graph = new mxGraph(this.model.graph.container);

                    // Sets the graph container and configures the editor
                    this.model.editor.setGraphContainer(this.model.graph.container);

                    this.model.graph.parent = this.model.editor.graph.getDefaultParent();

                    this.model.editor.graph.setEnabled(true);
                    // 设定可连接
                    this.model.editor.graph.setConnectable(true);
                    // 容器大小自适应 
                    this.model.editor.graph.setResizeContainer(false);

                    // Clones the source if new connection has no target
                    this.model.editor.graph.connectionHandler.setCreateTarget(true);
                    
                    this.model.editor.graph.setConnectableEdges(false);
                    this.model.editor.graph.setDropEnabled(true);

                    // 是否允许平移。true：表示按住Shift+左键拖动时，整个graph移动；
                    // false：按住Shift+左键拖动时，选中的图形水平方向或者垂直方向平移。
                    this.model.editor.graph.setPanning(true);
                    mxPanningHandler.prototype.isPanningTrigger = function(me) {
                        var evt = me.getEvent();
                        return true;
                    };

                    // 禁止改变节点大小
                    this.model.editor.graph.setCellsResizable(false);
                    // 禁止节点文字编辑功能
                    this.model.editor.graph.setCellsEditable(false);
                    
                    // 禁止连线移动
                    this.model.editor.graph.disconnectOnMove = false;
                    

                    // 允许连线的目标和源是同一元素 
                    this.model.editor.graph.setAllowLoops(true); 
                    // 居中缩放
                    this.model.editor.graph.centerZoom = true;
                    // Tooltips on touch devices
                    this.model.editor.graph.setTooltips(!mxClient.IS_TOUCH);
                    // 支持Html
                    this.model.editor.graph.setHtmlLabels(true);


                    // 去锯齿效果
				    mxRectangleShape.prototype.crisp = true;

                    // 鼠标框选
                    new mxRubberband(this.model.editor.graph);

                    // Sets global styles
                    var style = this.model.editor.graph.getStylesheet().getDefaultEdgeStyle();
                    style[mxConstants.STYLE_EDGE] = mxEdgeStyle.EntityRelation;
                    style[mxConstants.STYLE_ROUNDED] = true;
                    style[mxConstants.EDGE_SELECTION_STROKEWIDTH] = 3;
                    style[mxConstants.STYLE_LABEL_BACKGROUNDCOLOR] = 'transparent';
                    style[mxConstants.STYLE_LABEL_PADDING] = 5;
                    style[mxConstants.STYLE_LABEL_BACKGROUNDCOLOR] = 'backcolor';

                    style = this.model.editor.graph.getStylesheet().getDefaultVertexStyle();
                    style[mxConstants.STYLE_FILLCOLOR] = '#2f8ee7';
                    style[mxConstants.STYLE_FONTCOLOR] = '#333333';
                    style[mxConstants.STYLE_FONTSIZE] = '14';
                    style[mxConstants.STYLE_SHAPE] = 'swimlane';
                    style[mxConstants.STYLE_SPACING] = '10';
                    style[mxConstants.STYLE_STARTSIZE] = 30;
                    style[mxConstants.STYLE_GRADIENTCOLOR] = '#419efe';
                    style[mxConstants.VERTEX_SELECTION_STROKEWIDTH] = 3;
                    style[mxConstants.VERTEX_SELECTION_COLOR] = '#ff0000';

                    // style = [];
                    // style[mxConstants.STYLE_SHAPE] = mxConstants.SHAPE_RECTANGLE;
                    // style[mxConstants.STYLE_STROKECOLOR] = 'none';
                    // style[mxConstants.STYLE_FILLCOLOR] = 'none';
                    // style[mxConstants.STYLE_FOLDABLE] = false;
                    // style = this.model.editor.graph.getStylesheet().putCellStyle('column', style);
 

                    // 预览时鼠标悬浮到节点时，改变鼠标样式
                    this.model.editor.graph.getCursorForCell = function(cell){
                        if (cell != null && cell.value != null && cell.vertex ==1 ){
                            return 'pointer';
                        }
                    }
                    
                    // 预览时鼠标悬浮到节点时，改变节点样式
                    new mxCellTracker(this.model.editor.graph);
                    
                    // 布局定义
                    this.executeLayout();

                    // Animates the changes in the graph model
                    // this.model.editor.graph.getModel().addListener(mxEvent.CHANGE, (sender, evt)=>{
                    //     var changes = evt.getProperty('edit').changes;
                    //     mxEffects.animateChanges(this.model.editor.graph, changes);
                    // });

                    // Installs a popupmenu handler using local function (see below).
                    const self = this;
                    // 首先禁用浏览器右键菜单
                    mxEvent.disableContextMenu(this.$el);
                    // 右键菜单
                    //this.model.editor.graph.popupMenuHandler.autoExpand = true;
                    this.model.editor.graph.popupMenuHandler.factoryMethod = function(menu, cell, evt){
                        self.createPopupMenu(self.model.editor, self.model.editor.graph, menu, cell, evt);
                    };
                    
                    this.initGraph(this.model.editor,this.model.editor.graph);
                    this.initGraphEvent(this.model.editor.graph);
                    // 设置主题
                    this.setTheme(this.model.graph.theme.color);

                }
            },
            // 右键菜单
            createPopupMenu(editor, graph, menu, cell, evt){
                
                // 节点或边菜单
                if (cell != null){
                    // node
                    let id = cell.getId();
                    let value = cell.getValue();
                    let node = {id: id, value: value, type:'event', cell: cell};

                    // 节点菜单
                    if(!cell.edge){

                        menu.addItem('实体分析', null, ()=>{
                            this.$root.$refs.graphDiagnosisRef.diagnosisAdd( node );
                        });

                        if(mx.allow()){

                            menu.addItem('实体删除', null, ()=>{
                                this.removeEntityHandler(cell);
                            });

                        }

                        menu.addSeparator();

                        var vars = {};
                        var submenuBsearch = null;
                        var submenuEsearch = null;
                        let edgeListByClass = fsHandler.callFsJScript("/matrix/graph/getEdgesByClass.js",encodeURIComponent(id)).message;
                        
                        if(_.find(edgeListByClass,{direction:'out'})){
                            submenuBsearch = menu.addItem('起点查询', null, null);
                        }
                        if(_.find(edgeListByClass,{direction:'in'})){
                            submenuEsearch = menu.addItem('终点查询', null, null);
                        }
                        _.forEach(edgeListByClass,(v,index)=>{
                            
                            if(v.direction == 'out'){
                                
                                vars['submenuBStep'+index] = menu.addItem(v.remedy,null,null,submenuBsearch)
                                var stepCount = Array(6);
                                _.forEach(stepCount,(val,idx)=>{
                                    let step = idx + 1;
                                    
                                    menu.addItem(step + '跳', null, ()=>{
                                        this.loadSubGraph({direction:"out",node:node,step:step,edge:v.name});
                                    },vars['submenuBStep'+index]);
                                
                                })
                            } else {
                                vars['submenuEStep'+index] = menu.addItem(v.remedy,null,null,submenuEsearch);
                                var stepCount = Array(6);
                                _.forEach(stepCount,(val,idx)=>{
                                    let step = idx + 1;
                                    
                                    menu.addItem(step + '跳', null, ()=>{
                                        this.loadSubGraph({direction:"in",node:node,step:step,edge:v.name});
                                    },vars['submenuEStep'+index]);
                                    
                                })
                            }
                            
                        })
                        
                        if(mx.allow()){
                            menu.addSeparator();

                            /* 活动查询是基于业务场景可维护的 
                            1、只有实体有活动菜单
                            */
                            var submenuAction= menu.addItem('活动查询', null, null);
                            var vars = {};
                            
                            let actions = fsHandler.callFsJScript("/matrix/graph/getEntityDiagnosisDataType.js",null).message;
                            
                            _.forEach(actions[0].children,(v,index)=>{
                                
                                // step查询 render:mql
                                if(v.render==='mql'){
                                    vars[v.name] = menu.addItem(v.title,null,()=>{
                                        this.loadSubGraphByAction({
                                                direction:"action",
                                                node:node,
                                                step:1,
                                                mql:v.mql,
                                                template:v.template,
                                                model:v});
                                    },submenuAction);
                                    
                                }
                                // render:url
                                else {
                                    if(window.COMPANY_OSPACE == 'hdim'){
                                        vars[v.name] = menu.addItem(v.title,null,()=>{
                                            this.processHandler(node,v);
                                        },submenuAction);
                                    }
                                }
                                
                            })

                            if(window.COMPANY_OSPACE == 'hdim'){
                                menu.addItem('同行同住', null, ()=>{
                                    let rtn = fsHandler.callFsJScript("/bizApi/hdim/getSameRecordGraphByPeople.js", encodeURIComponent(cell.getValue())).message.data;
                                    this.loadSubGraphBySameRecord({
                                                    direction:"same",
                                                    node:node,
                                                    step:1,
                                                    model:rtn.tx});
                                    this.loadSubGraphBySameRecord({
                                                    direction:"same",
                                                    node:node,
                                                    step:1,
                                                    model:rtn.tz});
                                },submenuAction);
                            }

                            menu.addSeparator();

                            menu.addItem('关系维护', null, ()=>{
                                this.$root.$refs.graphEdgesRef.edgesTabAdd( node );
                            });

                        }

                        menu.addSeparator();
                        
                        // 收起
                        let sourceCells = _.map(cell.edges,(v)=>{
                            return v.source;
                        })
                        let targetCells = _.map(cell.edges,(v)=>{
                            return v.target;
                        })
                        
                        if(sourceCells.length > 0){
                            menu.addItem('向里收起',null,(evt)=>{
                                graph.setSelectionCells(sourceCells);

                                if (graph.getSelectionCount() == 1) {
                                        graph.setCellStyles('container', objectHash.sha1(sourceCells));
                                } else {
                                    graph.setSelectionCell(graph.groupCells(null, 10));
                                }

                                graph.foldCells(true);
                            })  
                        }

                        if(targetCells.length > 0){
                            menu.addItem('向外收起',null,(evt)=>{
                                graph.setSelectionCells(targetCells);

                                if (graph.getSelectionCount() == 1) {
                                        graph.setCellStyles('container', objectHash.sha1(targetCells));
                                } else {
                                    graph.setSelectionCell(graph.groupCells(null, 10));
                                }

                                graph.foldCells(true);
                            })  

                            menu.addSeparator();
                        }


                        if (graph.getSelectionCount() > 1) {
                            
                            menu.addItem('组合',null,(evt)=>{
                                if (graph.getSelectionCount() == 1) {
                                        graph.setCellStyles('container', objectHash.sha1(graph.getSelectionCells()));
                                } else {
                                    graph.setSelectionCell(graph.groupCells(null, 10));
                                }
                            })  
                            
                            
                            menu.addSeparator();
                            
                        } else if (graph.getSelectionCount() == 1 && !graph.getModel().isEdge(cell) && 
                                graph.getModel().getChildCount(cell) > 0) {
                            
                            menu.addItem('解除组合',null,(evt)=>{
                                if (graph.getSelectionCount() == 1 && graph.getModel().getChildCount(graph.getSelectionCell()) == 0){
                                    graph.setCellStyles('container', '0');
                                } else {
                                    graph.setSelectionCells(graph.ungroupCells());
                                }
                            })

                            // menu.addItem('进入组',null,(evt)=>{
                            //     graph.enterGroup(cell)
                            // })

                            // menu.addItem('退出组',null,(evt)=>{
                            //     graph.exitGroup(cell);
                            // })

                            menu.addSeparator();
                            
                        }
                        
                        menu.addItem('节点删除', null, (evt)=>{
                            this.deleteSelectedCells(graph,evt != null && mxEvent.isShiftDown(evt));
                        });


                    } 
                    // 边菜单
                    else {
                        node = {id: id, value: value, type:'edge', cell: cell};

                        menu.addItem('实体关系分析', null, ()=>{
                            this.$root.$refs.graphDiagnosisRef.diagnosisAdd( node );
                        });
                        menu.addItem('实体关系删除', null, ()=>{
                            this.$root.$refs.graphViewRef.$refs.graphViewContainerInst.removeEntityHandler(cell);
                        });
                        menu.addSeparator();

                        menu.addItem('新建关系类型', null, ()=>{
                            this.entity.newEdgeType.show = true;
                        });
                        menu.addItem('更新关系类型', null, ()=>{
                            this.$root.$refs.graphDiagnosisRef.diagnosisAdd( node );
                        });
                        
                        menu.addSeparator();

                        menu.addItem('删除边', null, (evt)=>{
                            this.deleteSelectedCells(graph,evt != null && mxEvent.isShiftDown(evt));
                        });
                    }
                } 
                // 画布菜单
                else {
                    
                    menu.addItem('居中', null, ()=>{
                        this.toCenter(true);
                    });
                    menu.addItem('另存为PDF', null, ()=>{
                        mxUtils.printScreen(graph);
                    });
                    menu.addSeparator();

                    var submenuSelect = menu.addItem('选择', null, null);
                    menu.addItem('选择实体', null, ()=>{
                        this.selectHandler('selectAllVertices');
                    }, submenuSelect);
                    menu.addItem('选择关系', null, ()=>{
                        this.selectHandler('selectAllEdges');
                    }, submenuSelect);
                    menu.addItem('选择所有', null, ()=>{
                        this.selectHandler('selectAll');
                    }, submenuSelect);
                    menu.addItem('清除选择', null, ()=>{
                        this.selectHandler('selectNone');
                    }, submenuSelect);
                    
                    menu.addSeparator();

                    if(mx.allow()){
                        
                        var submenuEntity = menu.addItem('实体', null, null);
                    
                        menu.addItem('新建实体', null, ()=>{
                            this.entity.newDialog.show = true;
                        }, submenuEntity);
                        menu.addItem('新建关系类型', null, ()=>{
                            this.entity.newEdgeType.show = true;
                        }, submenuEntity);

                        menu.addSeparator();
                    }

                    if(!_.isEmpty(this.graphData.nodes)){
                        menu.addItem('刷新', null, ()=>{
                            this.onReload();
                        });
                    }
                    
                    let cells = this.model.editor.graph.getChildVertices(this.model.editor.graph.getDefaultParent())
                    if(!_.isEmpty(cells)){
                        menu.addItem('清空', null, ()=>{
                            this.onClear();
                        });
                    }
                    menu.addSeparator();

                    menu.addItem('撤销', null, ()=>{
                        this.model.editor.execute("undo");
                    });
                    menu.addItem('重做', null, ()=>{
                        this.model.editor.execute("redo");
                    });
                    
                    menu.addSeparator();

                    var submenuIcon = menu.addItem('显示', null, null);
                    
                    menu.addItem('图标', null, ()=>{
                        this.model.control.ifIcon = false;
                        localStorage.setItem("TOPOLOGICAL-RENDER-TYPE",this.model.control.ifIcon);
                        this.onToggleIcon();
                    }, submenuIcon);
                    menu.addItem('图形', null, ()=>{
                        this.model.control.ifIcon = true;
                        localStorage.setItem("TOPOLOGICAL-RENDER-TYPE",this.model.control.ifIcon);
                        this.onToggleIcon();
                    }, submenuIcon);

                    menu.addSeparator();

                    var submenuLabel = menu.addItem("标签",null,null);
                    _.forEach(this.model.graph.default.list,(v)=>{
                        menu.addItem(v.label, null, ()=>{
                            this.model.graph.default.title = v.label;
                            this.onToggleLabel();
                        }, submenuLabel);
                    })

                    menu.addSeparator();
                    
                    var submenuLayout = menu.addItem('布局', null, null);

                    var submenuLayoutHierarchical = menu.addItem('分层布局', null, null,submenuLayout);
                    menu.addItem('上下', null, ()=>{
                        this.model.graph.layout.default = 'hierarchical_vertical';
                        this.executeLayout();
                    }, submenuLayoutHierarchical);
                    menu.addItem('左右', null, ()=>{
                        this.model.graph.layout.default = 'hierarchical_horizontal';
                        this.executeLayout();
                    }, submenuLayoutHierarchical);
    
                    
                    var submenuLayoutTree = menu.addItem('树形布局', null, null,submenuLayout);

                    menu.addItem('上下', null, ()=>{
                        this.model.graph.layout.default = 'tree_vertical';
                        this.executeLayout();
                    }, submenuLayoutTree);
                    menu.addItem('左右', null, ()=>{
                        this.model.graph.layout.default = 'tree_horizontal';
                        this.executeLayout();
                    }, submenuLayoutTree);

                    menu.addItem('随机布局', null, ()=>{
                        this.model.graph.layout.default = 'organic';
                        this.executeLayout();
                    }, submenuLayout);
                    menu.addItem('圆形布局', null, ()=>{
                        this.model.graph.layout.default = 'circle';
                        this.executeLayout();
                    }, submenuLayout);
                }
                
            },
            // 选择实体或关系
            selectHandler(type){
                if(type=='selectAllVertices'){
                    this.model.editor.graph.selectVertices();
                } else if(type=='selectAllEdges'){
                    this.model.editor.graph.selectEdges();
                } else if(type=='selectAll'){
                    this.model.editor.graph.selectAll(null, true);
                }  else if(type=='selectNone'){
                    this.model.editor.graph.clearSelection();
                }
            },
            checkImgExists(name){
                let term = {parent:"/assets/images/entity/png", name:name};
                return true;//fsHandler.callFsJScript("/matrix/graph/checkHaveFile.js", encodeURIComponent(JSON.stringify(term))).message;
            },            
            // 初始化画布
            initGraph(editor,graph){
                
                graph.getModel().beginUpdate();
                
                try{

                    if(!_.isEmpty(window.URL_PARAMS_ITEM)) {
                        let doc = mxUtils.parseXml(this.graphData);
                        let svgBgColor = doc.getElementsByTagName("mxGraphModel")[0].getAttribute("background") || "#ffffff";
                        $("svg", this.$el).css("background-color",svgBgColor);
                        let codec = new mxCodec(doc);

                        codec.decode(doc.documentElement, graph.getModel());

                        $("foreignObject div").css("color","#849EB6");
                    } else {
                        
                        graph.getModel();

                        let parent = graph.getDefaultParent();
                        let allNodes = _.concat([],this.graphData.nodes);
                        let allEdges = _.concat([],this.graphData.edges);

                        if( this.graphData['diff'] && 'add' in this.graphData['diff'] ){
                            allNodes = _.concat(allNodes, this.graphData.diff.add.nodes);
                            allEdges = _.concat(allEdges, this.graphData.diff.add.edges);
                        }

                        if( this.graphData['diff'] && 'del' in this.graphData['diff'] ){
                            allNodes = _.concat(allNodes, this.graphData.diff.del.nodes);
                            allEdges = _.concat(allEdges, this.graphData.diff.del.edges);
                        }

                        allNodes = _.uniqBy(allNodes,'id');
                        allEdges = _.uniqBy(allEdges,'id'); 
                        
                        // 绘制节点
                        _.forEach(allNodes,(v)=>{

                            let _type = v._icon || 'matrix';

                            // 可设置默认显示属性
                            let _name =  '';

                            try{
                                if(window.URL_PARAMS_GRAPH){
                                    _name = v[window.URL_PARAMS_GRAPH.title];
                                } else {
                                    _name = v[this.model.graph.default.title];
                                }
                            } catch(err){
                                _name = v["id"];
                            }

                            // 选择节点渲染模式：icon/shape
                            let node = null;
                            let imageUrl = `${window.ASSETS_ICON}/entity/png/${_type}.png?type=open&issys=${window.SignedUser_IsAdmin}`;

                            // icon渲染
                            if(this.model.control.ifIcon){
                                if(this.checkImgExists(`${_type}.png`)){
                                    node = graph.insertVertex(parent, v.id, _name, 50, 50, 60, 60,`shape=image;html=1;image=${imageUrl};verticalLabelPosition=bottom;verticalAlign=top;`);
                                } else {
                                    node = graph.insertVertex(parent, v.id, _name, 50, 50, 50, 50,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;`);
                                }    
                            } 
                            // shape渲染
                            else {
                                node = graph.insertVertex(parent, v.id, _name, 50, 50, 50, 50,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;`);
                            }
                        })
                        
                        // 绘制边
                        _.forEach(allEdges,(k,index)=>{
                            
                            let source = graph.getModel().getCell(k.source);
                            let target = graph.getModel().getCell(k.target);

                            let baseEdgeStyle = `edgeStyle=${this.model.graph.style.edge.value.title};html=1;rounded=1;jettySize=auto;orthogonalLoop=1;endArrow=block;endFill=1;`;
                            let direction = '';

                            if(k.twoway){
                                direction = 'startArrow=block;endArrow=block;endFill=1;';
                            }

                            // edge为path的样式
                            if(k.class === "path"){
                                baseEdgeStyle = `edgeStyle=${this.model.graph.style.edge.value.title};orthogonalLoop=1;strokeWidth=1;dashed=1;startFill=0;endArrow=none;endFill=0;startArrow=none;orthogonal=1;elbow=vertical;`;
                                let strokeColor = this.model.graph.path.colors[index] || _.sample(this.model.graph.path.colors);
                                let edge = graph.insertEdge(parent, k.id, k.class, source, target, baseEdgeStyle+direction+`strokeColor=${strokeColor}`);
                                return;
                            }

                            let edge = null;
                            try {
                                let edgeName = _.find(this.entity.edges.list,{name:k.class}).remedy;
                                edge = graph.insertEdge(parent, k.id, edgeName, source, target, baseEdgeStyle+direction);
                            } catch(err){
                                edge = graph.insertEdge(parent, k.id, k.class, source, target, baseEdgeStyle+direction);
                            } 
                        })

                        this.setDiffCellsStyle();
                        
                    }
                    
                }
                finally {
                    
                    graph.getModel().endUpdate();    

                    // 图布局
                    _.delay(()=>{
                        this.executeLayout();
                    },800)

                    // 图居中
                    _.delay(()=>{
                        this.toCenter(true);
                    },1000)

                    // 鹰眼
                    this.outline();

                    // 统计
                    this.graphSummary();

                    // 刷新状态
                    if(this.model.control.refresh.enable){
                        this.refreshEntityStatus();
                    }

                }
            },
            // 图分析 - 子图
            loadSubGraph(node){
                
                let parentCell = node.node.cell;

                let term = "";
                let edgeStr = _.isEmpty(node.edge) ? node.edge : `:${node.edge}`;

                if(node.direction=="out"){
                    term = `match ('${node.node.id}') - [${edgeStr}*${node.step}] -> ()`;
                } else{
                    term = `match ('${node.node.id}') <- [${edgeStr}*${node.step}] - ()`;
                }

                let rtn = fsHandler.callFsJScript("/matrix/graph/graph_service.js", encodeURIComponent(term)).message[0].graph;
                
                let allNodes = _.concat([],rtn.nodes);
                let allEdges = _.concat([],rtn.edges);

                if( rtn['diff'] && 'add' in rtn['diff'] ){
                    allNodes = _.concat(allNodes, rtn.diff.add.nodes);
                    allEdges = _.concat(allEdges, rtn.diff.add.edges);
                }

                if( rtn['diff'] && 'del' in rtn['diff'] ){
                    allNodes = _.concat(allNodes, rtn.diff.del.nodes);
                    allEdges = _.concat(allEdges, rtn.diff.del.edges);
                }

                allNodes = _.uniqBy(allNodes,'id');
                allEdges = _.uniqBy(allEdges,'id'); 

                let graph = new mxGraph();
                let parent = graph.getDefaultParent();
                
                graph.getModel().beginUpdate();
                
                try{

                    graph.getModel();

                    // 绘制节点
                    _.forEach(allNodes,(v)=>{

                        let _type = v._icon || 'matrix';

                        // 可设置默认显示属性
                        let _name =  '';

                        try{
                            if(window.URL_PARAMS_GRAPH){
                                _name = v[window.URL_PARAMS_GRAPH.title];
                            } else {
                                _name = v[this.model.graph.default.title];
                            }
                        } catch(err){
                            _name = v["id"];
                        }

                        // 选择节点渲染模式：icon/shape
                        let node = null;
                        let imageUrl = `${window.ASSETS_ICON}/entity/png/${_type}.png?type=open&issys=${window.SignedUser_IsAdmin}`;

                        // icon渲染
                        if(this.model.control.ifIcon){
                            if(this.checkImgExists(`${_type}.png`)){
                                node = graph.insertVertex(parent, v.id, _name, 50, 50, 60, 60,`shape=image;html=1;image=${imageUrl};verticalLabelPosition=bottom;verticalAlign=top;`);
                            } else {
                                node = graph.insertVertex(parent, v.id, _name, 50, 50, 50, 50,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;`);
                            }    
                        } 
                        // shape渲染
                        else {
                            node = graph.insertVertex(parent, v.id, _name, 50, 50, 50, 50,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;`);
                        }
                        })

                        // 绘制边
                        _.forEach(allEdges,(k,index)=>{

                            let source = graph.getModel().getCell(k.source);
                            let target = graph.getModel().getCell(k.target);

                            let baseEdgeStyle = `edgeStyle=${this.model.graph.style.edge.value.title};html=1;dashed=1;rounded=1;jettySize=auto;orthogonalLoop=1;endArrow=block;endFill=1;`;
                            let direction = '';

                            if(k.twoway){
                                direction = 'startArrow=block;endArrow=block;endFill=1;';
                            }

                            // edge为path的样式
                            if(k.class === "path"){
                                baseEdgeStyle = `edgeStyle=${this.model.graph.style.edge.value.title};orthogonalLoop=1;strokeWidth=1;dashed=1;startFill=0;endArrow=none;endFill=0;startArrow=none;orthogonal=1;elbow=vertical;`;
                                let strokeColor = this.model.graph.path.colors[index] || _.sample(this.model.graph.path.colors);
                                let edge = graph.insertEdge(parent, k.id, k.class, source, target, baseEdgeStyle+direction+`strokeColor=${strokeColor}`);
                                return;
                            }

                            // 检查是否已经存在edge
                            let ifHaveEdge = this.model.editor.graph.getModel().getCell(k.id);
                            if(ifHaveEdge) return ;
                            
                            let edge = null;
                            try {
                                let edgeName = _.find(this.entity.edges.list,{name:k.class}).remedy;
                                edge = graph.insertEdge(parent, k.id, edgeName, source, target, baseEdgeStyle+direction);
                            } catch(err){
                                edge = graph.insertEdge(parent, k.id, k.class, source, target, baseEdgeStyle+direction);
                            } 

                        })
                    
                        //this.model.editor.graph.groupCells(parentCell,1,graph.selectAll(parent, true));
                        this.setDiffCellsStyle();
                    
                }
                finally {
                    
                    graph.getModel().endUpdate();

                    // 合并图
                    this.model.editor.graph.getModel().mergeChildren(graph.getModel().getRoot(), this.model.editor.graph.getDefaultParent(),true);

                    // 图布局
                    _.delay(()=>{
                        this.executeLayout();
                    },800)

                    // 图居中
                    _.delay(()=>{
                        this.toCenter(true);
                    },1000)

                    
                    // 图布局
                    _.delay(()=>{
                        this.executeLayout();
                    },1500)

                    
                    // 加入高级搜索定义
                    this.$refs.searchToolbar.term = term;

                    // 设置主题
                    this.setTheme(this.model.graph.theme.color);

                    // 统计
                    this.graphSummary();
                    
                }
            },
            // 图分析 - 子图 By 活动
            loadSubGraphByAction(node){
                
                let term = "";
                if(node.mql){
                    term = _.template(node.template)({
                        action: node.model.name,
                        actionWhere: "",
                        step: 1,
                        endEntity: node.node.id
                    });
                   
                    //term = node.mql.replace(/people:\*/,node.node.id);
                } else {
                    this.$message({
                        type: "info",
                        message: "请确认查询"
                    })
                    return false;
                }

                let rtn = fsHandler.callFsJScript("/matrix/graph/graph_service.js", encodeURIComponent(term)).message[0].graph;
                
                let allNodes = [];
                let allEdges = [];

                var graph = new mxGraph();
                var parent = graph.getDefaultParent();

                // Sets global styles
                var style = graph.getStylesheet().getDefaultEdgeStyle();
                style[mxConstants.STYLE_GRADIENTCOLOR] = _.sample(this.model.graph.path.color);

                this.model.editor.graph.getStylesheet().putCellStyle('column', style);
                
                graph.getModel().beginUpdate();
                
                try{

                    graph.getModel();
                    let nodes = {};
                    
                    // 添加节点类型，是否是新增、删除或者正常
                    allNodes =  _.map(rtn.nodes,(v)=>{
                                        return _.extend(v,{type:'normal'});
                                });
                    
                    //合并新增节点
                    try{
                        allNodes = _.extend(allNodes,_.map(rtn.diff.add.nodes,(v)=>{
                            return _.extend(v,{type:'add'});
                        }))
                    }catch(err){
                        
                    }
                    
                    //合并删除的节点
                    try{
                        allNodes =  _.concat(allNodes,_.map(rtn.diff.del.nodes,(v)=>{
                                        return _.extend(v,{type:'del'});
                                    }))
                    } catch(err){
                        
                    }

                    // 添加edge类型，包括正常的、新增的、删除的
                    allEdges = _.map(rtn.edges,(v)=>{
                        return _.extend(v,{type:"normal"});
                    });

                    //合并新增edge
                    try{
                        allEdges = _.map(allEdges,(v)=> {
                            if(_.find(rtn.diff.add.edges,{id:v.id})){
                                return _.extend(v,{type:'add'});
                            } else {
                                return v;
                            }
                        });
                    }catch(err){

                    }
                    
                    // 合并删除edge
                    try {
                        allEdges =  _.concat(allEdges,_.map(rtn.diff.del.edges,(v)=> {
                                        return _.extend(v,{type:'del'});
                                    }));
                    } catch(err){
                        
                    }

                    // 绘制节点
                    let fillColor = "";//`fillColor=${_.sample(this.model.graph.theme.predefineColors)}`;
                    let size = 50;
                    _.forEach(allNodes,(v)=>{

                        let _type = v._icon || 'matrix';
                        
                        // 可设置默认显示属性
                        let _name =  '';
                        
                        try{
                            if(window.URL_PARAMS_GRAPH){
                                _name = v[window.URL_PARAMS_GRAPH.title];
                            } else {
                                _name = v[this.model.graph.default.title];
                            }
                        } catch(err){
                            _name = v["id"];
                        }

                        // normal
                        // 选择节点渲染模式：icon/shape
                        let node = null;
                        let imageUrl = `${window.ASSETS_ICON}/entity/png/${_type}.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                        
                        // icon渲染
                        if(this.model.control.ifIcon){
                            if(this.checkImgExists(`${_type}.png`)){
                                node = graph.insertVertex(parent, v.id, _name, 50, 50, 50, 50,`shape=image;html=1;image=${imageUrl};verticalLabelPosition=bottom;verticalAlign=top;`);
                            } else {
                                node = graph.insertVertex(parent, v.id, _name, 50, 50, size, size,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;${fillColor}`);
                            }    
                        } 
                        // shape渲染
                        else {
                            node = graph.insertVertex(parent, v.id, _name, 50, 50, size, size,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;${fillColor}`);
                        }

                        this.model.graph.allNodesIds.push(node.getId());

                        // node directory
                        _.extend(nodes,{[v.id]:node});


                        //add
                        if(v.type && v.type === 'add'){
                            let overlay = new mxCellOverlay(new mxImage(`/fs/assets/images/apps/png/flag/add.png?issys=true&type=open`,24,24), "新增", mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_TOP, new mxPoint(-10,15));
                            graph.addCellOverlay(node, overlay);
                        }

                        //delete
                        if(v.type && v.type === 'del'){
                            let overlay = new mxCellOverlay(new mxImage(`/fs/assets/images/apps/png/flag/delete.png?issys=true&type=open`,24,24), "删除", mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_TOP, new mxPoint(-10,15));
                            graph.addCellOverlay(node, overlay);
                        }

                    })

                    // 边界
                    let edges = {};
                    _.forEach(allEdges,(k,index)=>{
                        
                        let source = nodes[k.source];
                        let target = nodes[k.target];

                        let baseEdgeStyle = `edgeStyle=${this.model.graph.style.edge.value.title};html=1;dashed=1;rounded=1;jettySize=auto;orthogonalLoop=1;endArrow=block;endFill=1;`;
                        let direction = '';

                        if(k.twoway){
                            direction = 'startArrow=block;endArrow=block;endFill=1;';
                        }

                        if(k.type=='add'){
                            direction += 'strokeColor=#47fa28;strokeWidth=2;';
                        } else if(k.type=='del'){
                            direction += 'dashed=1;strokeColor=#ff0000;strokeWidth=2;';
                        } else {
                            direction += ''; 
                        }

                        // edge为path的样式
                        if(k.class === "path"){
                            baseEdgeStyle = `edgeStyle=${this.model.graph.style.edge.value.title};orthogonalLoop=1;strokeWidth=1;dashed=1;startFill=0;endArrow=none;endFill=0;startArrow=none;orthogonal=1;elbow=vertical;`;
                            let strokeColor = this.model.graph.path.colors[index] || _.sample(this.model.graph.path.colors);
                            let edge = graph.insertEdge(parent, k.id, k.class, source, target, baseEdgeStyle+direction+`strokeColor=${strokeColor}`);
                            return;
                        }

                        // 检查是否已经存在edge
                        let ifHaveEdge = this.model.editor.graph.getModel().getCell(k.id);
                        if(ifHaveEdge) return ;

                        let edge = null;
                        try {
                            let edgeName = _.find(this.entity.edges.list,{name:k.class}).remedy;
                            edge = graph.insertEdge(parent, k.id, edgeName, source, target, baseEdgeStyle+direction);
                        } catch(err){
                            edge = graph.insertEdge(parent, k.id, k.class, source, target, baseEdgeStyle+direction);
                        }
                        
                        // edge directory
                        try{
                            let id = source.getId() + ':' + target.getId();
                            _.extend(edges, { [id]: edge });
                        } catch(err){
                            console.log(err)
                        }
                        
                    })
                    
                }
                finally {
                    
                    graph.getModel().endUpdate();

                    // 合并图
                    this.model.editor.graph.getModel().mergeChildren(graph.getModel().getRoot(), this.model.editor.graph.getDefaultParent());

                    // Executes the layout handler
                    _.delay(()=>{
                        this.executeLayout();
                    },500)

                    // Search journal
                    let cell = node.node.cell;
                    if (cell != null) {
                            
                        this.model.editor.graph.removeCellOverlays(cell);
                        let overlay = new mxCellOverlay(new mxImage(`/fs/assets/images/others/png/${this.global.count}.png?issys=true&type=open`,20,20), '', mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_TOP, new mxPoint(10,10));
                        this.model.editor.graph.addCellOverlay(cell, overlay);

                        // 定位cell
                        this.onPosition(cell.getId(), true, true);
                    
                    }
                    // Search Step
                    this.global.count = this.global.count + 1;

                    // 加入高级搜索定义
                    this.$refs.searchToolbar.term = term;
                    //this.$refs.searchToolbar.search();

                    // 统计
                    this.graphSummary();
                    
                }
            },
            // 图分析 - 子图 By 活动同行同住
            loadSubGraphBySameRecord(node){
                
                let rtn = node.model.data[0].graph;
                
                let allNodes = [];
                let allEdges = [];

                var graph = new mxGraph();
                var parent = graph.getDefaultParent();

                // Sets global styles
                var style = graph.getStylesheet().getDefaultEdgeStyle();
                style[mxConstants.STYLE_GRADIENTCOLOR] = _.sample(this.model.graph.path.color);

                this.model.editor.graph.getStylesheet().putCellStyle('column', style);
                
                graph.getModel().beginUpdate();
                
                try{

                    graph.getModel();
                    let nodes = {};
                    
                    // 添加节点类型，是否是新增、删除或者正常
                    allNodes =  _.map(rtn.nodes,(v)=>{
                                        return _.extend(v,{type:'normal'});
                                });
                    
                    //合并新增节点
                    try{
                        allNodes = _.extend(allNodes,_.map(rtn.diff.add.nodes,(v)=>{
                            return _.extend(v,{type:'add'});
                        }))
                    }catch(err){
                        
                    }
                    
                    //合并删除的节点
                    try{
                        allNodes =  _.concat(allNodes,_.map(rtn.diff.del.nodes,(v)=>{
                                        return _.extend(v,{type:'del'});
                                    }))
                    } catch(err){
                        
                    }

                    // 添加edge类型，包括正常的、新增的、删除的
                    allEdges = _.map(rtn.edges,(v)=>{
                        return _.extend(v,{type:"normal"});
                    });

                    //合并新增edge
                    try{
                        allEdges = _.map(allEdges,(v)=> {
                            if(_.find(rtn.diff.add.edges,{id:v.id})){
                                return _.extend(v,{type:'add'});
                            } else {
                                return v;
                            }
                        });
                    }catch(err){

                    }
                    
                    // 合并删除edge
                    try {
                        allEdges =  _.concat(allEdges,_.map(rtn.diff.del.edges,(v)=> {
                                        return _.extend(v,{type:'del'});
                                    }));
                    } catch(err){
                        
                    }

                    // 绘制节点
                    let fillColor = "";//`fillColor=${_.sample(this.model.graph.theme.predefineColors)}`;
                    let size = 50;
                    _.forEach(allNodes,(v)=>{

                        let _type = v._icon || 'matrix';
                        
                        // 可设置默认显示属性
                        let _name =  '';
                        
                        try{
                            if(window.URL_PARAMS_GRAPH){
                                _name = v[window.URL_PARAMS_GRAPH.title];
                            } else {
                                _name = v[this.model.graph.default.title];
                            }
                        } catch(err){
                            _name = v["id"];
                        }

                        // normal
                        // 选择节点渲染模式：icon/shape
                        let node = null;
                        let imageUrl = `${window.ASSETS_ICON}/entity/png/${_type}.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                        
                        // icon渲染
                        if(this.model.control.ifIcon){
                            if(this.checkImgExists(`${_type}.png`)){
                                node = graph.insertVertex(parent, v.id, _name, 50, 50, 50, 50,`shape=image;html=1;image=${imageUrl};verticalLabelPosition=bottom;verticalAlign=top;`);
                            } else {
                                node = graph.insertVertex(parent, v.id, _name, 50, 50, size, size,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;${fillColor}`);
                            }    
                        } 
                        // shape渲染
                        else {
                            node = graph.insertVertex(parent, v.id, _name, 50, 50, size, size,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;${fillColor}`);
                        }

                        this.model.graph.allNodesIds.push(node.getId());

                        // node directory
                        _.extend(nodes,{[v.id]:node});


                        //add
                        if(v.type && v.type === 'add'){
                            let overlay = new mxCellOverlay(new mxImage(`/fs/assets/images/apps/png/flag/add.png?issys=true&type=open`,24,24), "新增", mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_TOP, new mxPoint(-10,15));
                            graph.addCellOverlay(node, overlay);
                        }

                        //delete
                        if(v.type && v.type === 'del'){
                            let overlay = new mxCellOverlay(new mxImage(`/fs/assets/images/apps/png/flag/delete.png?issys=true&type=open`,24,24), "删除", mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_TOP, new mxPoint(-10,15));
                            graph.addCellOverlay(node, overlay);
                        }

                    })

                    // 边界
                    let edges = {};
                    _.forEach(allEdges,(k,index)=>{
                        
                        let source = nodes[k.source];
                        let target = nodes[k.target];

                        let baseEdgeStyle = `edgeStyle=${this.model.graph.style.edge.value.title};html=1;dashed=1;rounded=1;jettySize=auto;orthogonalLoop=1;endArrow=block;endFill=1;`;
                        let direction = '';

                        if(k.twoway){
                            direction = 'startArrow=block;endArrow=block;endFill=1;';
                        }

                        if(k.type=='add'){
                            direction += 'strokeColor=#47fa28;strokeWidth=2;';
                        } else if(k.type=='del'){
                            direction += 'dashed=1;strokeColor=#ff0000;strokeWidth=2;';
                        } else {
                            direction += ''; 
                        }

                        // edge为path的样式
                        if(k.class === "path"){
                            baseEdgeStyle = `edgeStyle=${this.model.graph.style.edge.value.title};orthogonalLoop=1;strokeWidth=1;dashed=1;startFill=0;endArrow=none;endFill=0;startArrow=none;orthogonal=1;elbow=vertical;`;
                            let strokeColor = this.model.graph.path.colors[index] || _.sample(this.model.graph.path.colors);
                            let edge = graph.insertEdge(parent, k.id, k.class, source, target, baseEdgeStyle+direction+`strokeColor=${strokeColor}`);
                            return;
                        }

                        // 检查是否已经存在edge
                        let ifHaveEdge = this.model.editor.graph.getModel().getCell(k.id);
                        if(ifHaveEdge) return ;

                        let edge = null;
                        try {
                            let edgeName = _.find(this.entity.edges.list,{name:k.class}).remedy;
                            edge = graph.insertEdge(parent, k.id, edgeName, source, target, baseEdgeStyle+direction);
                        } catch(err){
                            edge = graph.insertEdge(parent, k.id, k.class, source, target, baseEdgeStyle+direction);
                        }
                        
                        // edge directory
                        try{
                            let id = source.getId() + ':' + target.getId();
                            _.extend(edges, { [id]: edge });
                        } catch(err){
                            console.log(err)
                        }
                        
                    })
                    
                }
                finally {
                    
                    graph.getModel().endUpdate();

                    // 合并图
                    this.model.editor.graph.getModel().mergeChildren(graph.getModel().getRoot(), this.model.editor.graph.getDefaultParent());

                    // Executes the layout handler
                    _.delay(()=>{
                        this.executeLayout();
                    },500)

                    // Search journal
                    let cell = node.node.cell;
                    if (cell != null) {
                            
                        this.model.editor.graph.removeCellOverlays(cell);
                        let overlay = new mxCellOverlay(new mxImage(`/fs/assets/images/others/png/${this.global.count}.png?issys=true&type=open`,20,20), '', mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_TOP, new mxPoint(10,10));
                        this.model.editor.graph.addCellOverlay(cell, overlay);

                        // 定位cell
                        this.onPosition(cell.getId(), true, true);
                    
                    }
                    // Search Step
                    this.global.count = this.global.count + 1;

                    // 加入高级搜索定义
                    //this.$refs.searchToolbar.term = term;
                    //this.$refs.searchToolbar.search();

                    // 统计
                    this.graphSummary();

                    this.toCenter(false);
                    
                }
            },
            // 图分析 - By 活动
            processHandler(node,item){
                const self = this;
                let wnd = null;
                try{
                    if(jsPanel.activePanels.getPanel('jsPanel-entity-info')){
                        jsPanel.activePanels.getPanel('jsPanel-entity-info').close();
                    }
                } catch(error){

                }
                finally{
                    wnd = maxWindow.winEntityInfo(`${item.title} ${node.id.split(":")[1]}`, `<div id="entity-process-wnd"></div>`, null, null, null);
                }

                new Vue({
                    delimiters: ['#{', '}#'],
                    data:{
                        
                    },
                    template:   `<el-container style="width:100%;height:100%;">
                                    <el-main ref="map"></el-main>
                                </el-container>`,
                    mounted(){
                        this.init();
                    },
                    methods: {
                        init(){
                            // 百度地图API功能
                            var map = new BMapGL.Map(this.$refs.map.$el);
                            map.centerAndZoom(new BMapGL.Point(120.17430114746094, 33.324501037597656), 17); 
                            // 编写自定义函数,创建标注
                            function addMarker(point){
                            var marker = new BMapGL.Marker(point);
                            map.addOverlay(marker);
                            }
                            // 随机向地图添加25个标注
                            var bounds = map.getBounds();
                            var sw = bounds.getSouthWest();
                            var ne = bounds.getNorthEast();
                            var lngSpan = Math.abs(sw.lng - ne.lng);
                            var latSpan = Math.abs(ne.lat - sw.lat);
                            for (var i = 0; i < 25; i ++) {
                                var point = new BMapGL.Point(sw.lng + lngSpan * (Math.random() * 0.7), ne.lat - latSpan * (Math.random() * 0.7));
                                addMarker(point);
                            }

                            
                        }
                    }
                }).$mount("#entity-process-wnd");
            },
            // 设置布局
            onSetLayout(cmd){
                this.model.graph.layout.default = cmd.name;
                if(cmd.value){
                    this.model.graph.layout.edgeStyle = cmd.value;
                }
                this.executeLayout();
            },
            // 清空当前画布
            onClear(){
                this.model.editor.execute("selectAll");
                this.model.editor.execute("delete");
            },
            // 关系属性添加
            onAddEdgesProperty(){
                try{
                    let tmp = this.entity.edges.properties.value.split("=");
                    
                    let ifHave = _.find(this.entity.edges.properties.list,{name:tmp[0]});

                    if(!ifHave){
                        this.entity.edges.properties.list.push({name:tmp[0],value:tmp[1]});
                    } else {
                        this.$message({
                            type: "info",
                            message: "属性已经存在"
                        })
                        return false;
                    }
                    
                } catch(err){

                } finally{
                    this.entity.edges.properties.value = "";
                }
            },
            // 关系属性删除
            onDeleteEdgesProperty(item){
                try{
                    
                    this.entity.edges.properties.list.splice(this.entity.edges.properties.list.indexOf(item), 1);
                    
                } catch(err){

                }
                
            },
            // 删除节点极其子节点
            deleteSubCellTree(cell){
                // 删除节点树
                var cells = [];
                this.model.editor.graph.traverse(cell, true, function(vertex){
                    cells.push(vertex);
                    return true;
                });
                this.model.editor.graph.removeCells(cells);
            },
            // 删除选择的节点
            deleteSelectedCells(graph,includeEdges){
                // Cancels interactive operations
                graph.escape();
                var cells = graph.getDeletableCells(graph.getSelectionCells());
                
                if (cells != null && cells.length > 0){
                    var parents = graph.model.getParents(cells);
                    graph.removeCells(cells, includeEdges);
                    
                    // Selects parents for easier editing of groups
                    if (parents != null){
                        var select = [];
                        
                        for (var i = 0; i < parents.length; i++){
                            if (graph.model.contains(parents[i]) &&
                                (graph.model.isVertex(parents[i]) ||
                                graph.model.isEdge(parents[i]))){
                                select.push(parents[i]);
                            }
                        }
                        graph.setSelectionCells(select);
                    }
                }
            },
            // 设置布局
            executeLayout(){
                let graph = this.model.editor.graph;
                let parent = this.model.editor.graph.getDefaultParent();
                let layout = this.model.graph.layout;
                
                // 布局定义
                if(layout.default === 'hierarchical_vertical'){
                    // Layout hierarchical
                    graph.getModel().beginUpdate();
                    try {
                        layout.inst = new mxHierarchicalLayout(graph, mxConstants.DIRECTION_NORTH);
                        layout.inst.edgeStyle = layout.edgeStyle;
                        layout.inst.intraCellSpacing = 80;
                        layout.inst.interRankCellSpacing = 80;
                        
                        var selectionCells = graph.getSelectionCells();
                        layout.inst.execute(parent, null);//selectionCells.length == 0 ? null : selectionCells);

                    } catch (e) {
                        throw e;
                    } finally {
                        var morph = new mxMorphing(graph);  
                        morph.addListener(mxEvent.DONE, function(){  
                            graph.getModel().endUpdate();  
                        });  
                            
                        morph.startAnimation();  
                    }
                    
                } else if(layout.default === 'hierarchical_horizontal'){
                    // Layout hierarchical
                    graph.getModel().beginUpdate();
                    try {
                        layout.inst = new mxHierarchicalLayout(graph, mxConstants.DIRECTION_WEST);
                        layout.inst.edgeStyle = layout.edgeStyle;
                        layout.inst.intraCellSpacing = 80;
                        layout.inst.interRankCellSpacing = 80;
                        
                        var selectionCells = graph.getSelectionCells();
                        layout.inst.execute(parent, null);// selectionCells.length == 0 ? null : selectionCells);
                    } catch (e) {
                        throw e;
                    } finally {
                        var morph = new mxMorphing(graph);  
                        morph.addListener(mxEvent.DONE, function(){  
                            graph.getModel().endUpdate();  
                        });  
                            
                        morph.startAnimation();  
                    }
                    
                } else if(layout.default === 'organic'){
                    // Layout Organic
                    graph.getModel().beginUpdate();
                    try {
                        layout.inst = new mxFastOrganicLayout(graph);
                        layout.inst.forceConstant = 140;
                        //layout.inst.execute(parent);

                        var selectionCells = graph.getSelectionCells();
                        layout.inst.execute(parent,null);// selectionCells.length == 0 ? null : selectionCells);
                    } catch (e) {
                        throw e;
                    } finally {
                        graph.getModel().endUpdate();
                    }
                    
                } else if(layout.default === 'tree_vertical'){
                    /* Layout tree vertical */
                    graph.getModel().beginUpdate();
                    try {
                        var tmp = graph.getSelectionCell();
                        var roots = null;
                        var cells = [tmp];
                        
                        if ( tmp == null || graph.getModel().getChildCount(tmp) == 0 ) {
                            if (graph.getModel().getEdgeCount(tmp) == 0){
                                roots = graph.findTreeRoots(parent);
                            }
                        } else {
                            roots = graph.findTreeRoots(tmp);
                        }

                        if ( roots != null && roots.length > 0 ) {
                            cells = roots;
                        }
                        
                        if( cells.length > 0 ) {
                            _.forEach(cells,(v)=>{
                                layout.inst = new mxCompactTreeLayout(graph, false);
                                layout.inst.edgeRouting = false;
                                layout.inst.levelDistance = 30;
                                layout.inst.execute(parent, v);
                            })
                        }

                    } catch (e) {
                        throw e;
                    } finally {
                        var morph = new mxMorphing(graph);  
                        morph.addListener(mxEvent.DONE, function(){  
                            graph.getModel().endUpdate();  
                        });  
                            
                        morph.startAnimation();  
                    }
                } else if(layout.default === 'tree_horizontal'){
                    /* Layout tree horizontal */
                    graph.getModel().beginUpdate();
                    try {
                        var tmp = graph.getSelectionCell();
                        var roots = null;
                        var cells = [tmp];
                        
                        if (tmp == null || graph.getModel().getChildCount(tmp) == 0){
                            if (graph.getModel().getEdgeCount(tmp) == 0){
                                roots = graph.findTreeRoots(parent);
                            }
                        } else {
                            roots = graph.findTreeRoots(tmp);
                        }

                        if (roots != null && roots.length > 0){
                            cells = roots;
                        }
                        
                        if( cells.length > 0 ) {
                            _.forEach(cells,(v)=>{
                                layout.inst = new mxCompactTreeLayout(graph, true);
                                layout.inst.edgeRouting = false;
                                layout.inst.levelDistance = 30;
                                layout.inst.execute(parent, v);
                            })
                        }
                        
                    } catch (e) {
                        throw e;
                    } finally {
                        var morph = new mxMorphing(graph);  
                        morph.addListener(mxEvent.DONE, function(){  
                            graph.getModel().endUpdate();  
                        });  
                            
                        morph.startAnimation();  
                    }
                } else {
                    /* Layout Circle */
                    graph.getModel().beginUpdate();
                    try {
                        layout.inst = new mxCircleLayout(graph);
                        //layout.inst.execute(parent);
                        var selectionCells = graph.getSelectionCells();
                        layout.inst.execute(parent, null);//selectionCells.length == 0 ? null : selectionCells);
                    } catch (e) {
                        throw e;
                    } finally {
                        graph.getModel().endUpdate();
                    }
                }
                
                // 缓存最后一次布局
                localStorage.setItem("GRAPH-LAYOUT",layout.default);

                
            },
            addChild(graph, cell){
                var model = this.model.editor.graph.getModel();
                var parent = this.model.editor.graph.getDefaultParent();
                var vertex;

                model.beginUpdate();
                try{
                    vertex = graph.insertVertex(parent, null, 'Double click to set name');
                    var geometry = model.getGeometry(vertex);

                    // Updates the geometry of the vertex with the
                    // preferred size computed in the graph
                    var size = graph.getPreferredSizeForCell(vertex);
                    geometry.width = size.width;
                    geometry.height = size.height;

                    // Adds the edge between the existing cell
                    // and the new vertex and executes the
                    // automatic layout on the parent
                    var edge = graph.insertEdge(parent, null, '', cell, vertex);

                    // Configures the edge label "in-place" to reside
                    // at the end of the edge (x = 1) and with an offset
                    // of 20 pixels in negative, vertical direction.
                    edge.geometry.x = 1;
                    edge.geometry.y = 0;
                    edge.geometry.offset = new mxPoint(0, -20);

                    addOverlays(graph, vertex, true);
                }
                finally
                {
                    model.endUpdate();
                }
                
                return vertex;
            },
            createOverlayByTip(image, tooltip) {
                            
                let overlay = new mxCellOverlay(new mxImage(`/fs/assets/images/apps/png/severity/${image}.png?issys=true&type=open`,24,24), tooltip, mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_TOP, new mxPoint(-10,15));
                
                return overlay;
            },
            refreshEntityStatus(){
                
                // 图所有节点
                let cells = _.map(this.model.editor.graph.getChildVertices(this.model.editor.graph.getDefaultParent()),(v,k)=>{
                                return {gid: v.id, name: v.value};
                            });
    
                let input = "('" + `${cells.join("','")}` + "')";

                let status = fsHandler.callFsJScript("/matrix/graph/graph_imap_data.js", encodeURIComponent(JSON.stringify(cells))).message;

                this.model.editor.graph.getModel().beginUpdate();

                try {
                    
                    _.forEach(status,(v)=>{
                        let id = v.gid;
                        let status = v.status;
                        let cell = this.model.editor.graph.getModel().getCell(id);
                        let state = this.model.editor.graph.view.getState(cell);
                        
                        if (cell != null) {
                            
                            // Resets
                            this.model.editor.graph.removeCellOverlays(cell);
    
                            if (status >= 5) {
                                this.model.editor.graph.addCellOverlay(cell, this.createOverlayByTip(status, `${id}: 重大告警`));
                            } else if (status >3 && status < 5) {
                                this.model.editor.graph.addCellOverlay(cell, this.createOverlayByTip(status, `${id}: 严重告警`));
                            } else {
                                this.model.editor.graph.removeCellOverlays(cell);
                            } 
                        
                        }

                    })

                } catch(err){

                }
                finally {
                    this.model.editor.graph.getModel().endUpdate();
                }
            },
            onReload(){
                
                if(this.model.editor.graph){
                    
                    $(this.$refs.graphContainer.$el).empty();
                    $("#outlineContainer",this.$el).empty();

                    // 清空
                    this.model.editor.execute("selectAll");
                    this.model.editor.execute("delete");

                    // 重新初始化
                    this.init();
                    
                    this.outline();

                    this.setTheme(this.model.graph.theme.color);

                    // 更新toobar属性选择列表
                    this.model.graph.default.list = _.sortBy(_.map(_.keys(this.graphData.nodes[0]),function(v){
                        let k = v;
                        return {value: k, label: k};
                    }),['value'])
                }

                this.global.count = 0;

            },
            // 图事件
            initGraphEvent(graph){
                const self = this;
                try{

                    // 自定义ToolTip
                    graph.getTooltipForCell = function(cell){
                        
                        if(!cell.edge){
                            //return `<h5>ID：${cell.getId()}</h5>`;
                        } else {
                            return `ID：${cell.getId()}<br>
                                    起点：${cell.source.getId()}<br>
                                    终点：${cell.target.getId()}`;
                        }
                        
                    }

                    // Removes the source vertex 
                    graph.addListener(mxEvent.REMOVE_CELLS, (sender, evt)=> {
                        this.graphSummary();
                    });

                    // Add the source vertex
                    graph.addListener(mxEvent.ADD_CELLS, (sender, evt)=> {
                        this.graphSummary();
                    });

                    // Move the source vertex
                    graph.addListener(mxEvent.MOVE_CELLS, (sender, evt)=> {
                        // Executes the layout handler
                        _.delay(()=>{
                            //this.executeLayout();
                        },500)
                    });

                    // 找一个图的触发机制，触发统计
                    graph.addListener(mxEvent.MOUSE_MOVE, (sender, evt)=> {
                        this.graphSummary();
                    });

                    // 关系编辑
                    graph.addListener(mxEvent.CELL_CONNECTED, (sender, evt)=>{
                        
                        let edge = evt.getProperty('edge');
                        let sCell = edge.source;
                        let tCell = edge.target;

                        if(sCell && tCell){
                            _.extend(this.entity, {source: {id: sCell.getId(), value: sCell.getValue()}});

                            // 如果tCell为空，则为复制源实体
                            let id = tCell.getId();
                            let value = tCell.getValue();
                            let type = "";

                            if(_.indexOf(id,":") == -1){
                                tId = sCell.getId() + `_copy_${moment().format("SSS")}`;
                                tValue = sCell.getValue() + `_copy_${moment().format("SSS")}`;
                                tCell.setValue(tValue);
                                type = "new";
                            } else {
                                tId = tCell.getId();
                                tValue = tCell.getValue();
                            }
                            _.extend(this.entity, {target: {id: tId, value: tValue, type: type}});
                            this.entity.dialog.show = true;
                        }

                        // 统计
                        this.graphSummary();
                    })

                    // 监听双击事件
                    graph.addListener(mxEvent.DOUBLE_CLICK, (sender, evt)=> {
                        let cell = evt.getProperty('cell');

                        if(!cell) return;

                        let id = cell.getId();
                        let value = cell.getValue();

                        // 点击获取关联信息
                        this.$root.$refs.graphDiagnosisRef.diagnosisAdd( {id:id, value:value, type:'event', cell: cell} );
                    })

                    var highlightList = [];
                    var highlighEdgetList = [];
                    // 监听单击事件
                    graph.addListener(mxEvent.CLICK, (sender, evt)=> {
                        
                        let cell = evt.getProperty('cell');

                        if(!cell){
                            // 点击画板切换到图查询搜索栏
                            //this.$refs.searchToolbar.currentView = "topological-search-toolbar-graph";
                            return;
                        }
                        
                        let id = cell.getId();
                        let value = cell.getValue();
                        let node = {id: id, value: value, type:'event', cell: cell};

                        if(!cell.edge){
                            if(this.$refs.searchToolbar.currentView==='topological-search-toolbar-graphAdv'){
                                //this.$refs.searchToolbar.currentView = "topological-search-toolbar-graph";
                            }
                            _.delay(()=>{
                                eventHub.$emit("TOPOLOGICAL-ANALYISS-TRACE", node);
                            },500)  
                            
                        }

                        /********************* 上线节点、边高亮 *********************/
                        
                        // 高亮节点集合
                        if(highlightList){
                            for(var k=0;k<highlightList.length;k++){
                                highlightList[k].light.destroy();
                            }
                        }

                        // 高亮线集合
                        if(highlighEdgetList){
                            for(var k=0;k<highlighEdgetList.length;k++){
                                highlighEdgetList[k].light.destroy();
                            }
                        }
                        
                        if( cell && cell.isVertex ){
                            var edges = cell.edges;
                            var edge;
                            for(var i=0;i<edges.length;i++){
                                edge = edges[i];
                                // 添加上级节点相关高亮配置
                                if(cell.id != edge.source.id){
                                    var cellSource = graph.getModel().getCell(edge.source.id);
                                    // 上级节点高亮配置
                                    var highlight = new mxCellHighlight(graph, '#00FF00', 2);
                                    highlight.highlight(graph.view.getState(cellSource));
                                    var highlightMap = {};

                                    highlightMap.cell = cellSource;
                                    highlightMap.light = highlight;
                                    highlightList.push(highlightMap);

                                    // 上级连线高亮配置
                                    var highlightEdge = new mxCellHighlight(graph, '#00FF00', 2);
                                    highlightEdge.highlight(graph.view.getState(edge));
                                    var highlightEdgeMap = {};
                                    highlightEdgeMap.light = highlightEdge;
                                    highlighEdgetList.push(highlightEdgeMap);
                                }
                                // 添加下级节点相关高亮配置
                                if(cell.id!=edge.target.id){
                                    var cellTarget = graph.getModel().getCell(edge.target.id);
                                    // 下级节点高亮配置
                                    var highlight = new mxCellHighlight(graph, '#00FF00', 2);
                                    highlight.highlight(graph.view.getState(cellTarget));

                                    var highlightMap = {};
                                    highlightMap.cell = cellTarget;
                                    highlightMap.light = highlight;
                                    highlightList.push(highlightMap);
                                    // 下级连线高亮配置
                                    var highlightEdge = new mxCellHighlight(graph, '#00FF00', 2);
                                    highlightEdge.highlight(graph.view.getState(edge));
                                    var highlightEdgeMap = {};
                                    highlightEdgeMap.light = highlightEdge;
                                    highlighEdgetList.push(highlightEdgeMap);
                                }
                            }
                        }

                    });

                    // 鼠标停留到元素上边缘高亮显示
                    /* let track = new mxCellTracker(graph);
                    track.mouseMove = _.debounce((sender, me)=> {
                        
                        try{
                            // 刷新状态
                            this.refreshEntityStatus();
                        } catch(err){

                        } 
                        
                    },2000); */

                    // 初始化滚轮图缩放事件监听
                    this.addScrollListener(this.model.graph.container, this.wheelHandle);
                    
                    // 监听拖拽事件
                    mxEvent.addListener(container, 'dragover', function(evt){
                        if (graph.isEnabled()){
                            evt.stopPropagation();
                            evt.preventDefault();
                        }
                    });
                    // 监听拖入事件
                    const self = this;
                    mxEvent.addListener(container, 'drop', function(evt){
                        if (graph.isEnabled()){
                            evt.stopPropagation();
                            evt.preventDefault();

                            // Gets drop location point for vertex
                            var pt = mxUtils.convertPoint(graph.container, mxEvent.getClientX(evt), mxEvent.getClientY(evt));
                            var tr = graph.view.translate;
                            var scale = graph.view.scale;
                            var x = pt.x / scale - tr.x;
                            var y = pt.y / scale - tr.y;
                            
                            // Converts local entity to graph cell
                            let addCellToGraph = function(items){
                                
                                graph.getModel().beginUpdate();

                                try{

                                    graph.getModel();
                                    let parent = graph.getDefaultParent();

                                    _.forEach(items,(v)=>{

                                        let cell = graph.getModel().getCell(v.id);

                                        if(cell){
                                            self.$message({
                                                type: "info",
                                                message: "已有该实体"
                                            })
                                            return;
                                        }

                                        let type = _.head(v.id.split(":")) || 'matrix';

                                        // 可设置默认显示属性
                                        let name =  '';
                                        
                                        try{
                                            if(window.URL_PARAMS_GRAPH){
                                                name = v[window.URL_PARAMS_GRAPH.title];
                                            } else {
                                                name = v[self.model.graph.default.title];
                                            }
                                        } catch(err){
                                            name = v["id"];
                                        }

                                        // normal
                                        // 选择节点渲染模式：icon/shape
                                        let node = null;
                                        let imageUrl = `${window.ASSETS_ICON}/entity/png/${type}.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                                        
                                        // icon渲染
                                        if(self.model.control.ifIcon){
                                            if(self.checkImgExists(`${type}.png`)){
                                                node = graph.insertVertex(parent, v.id, name, x, y, 60, 60,`shape=image;html=1;image=${imageUrl};verticalLabelPosition=bottom;verticalAlign=top;`);
                                            } else {
                                                node = graph.insertVertex(parent, v.id, name, x, y, 50, 50,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;`);
                                            }    
                                        } 
                                        // shape渲染
                                        else {
                                            node = graph.insertVertex(parent, v.id, name, x, y, 50, 50,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;`);
                                        }

                                        node.vertex = true;

                                        // node directory
                                        _.extend(self.model.graph.nodes,{[v.id]:node});

                                        // 定位到cell
                                        _.delay(()=>{
                                            graph.scrollCellToVisible(cell);
                                            graph.setSelectionCell(cell);
                                        },3500)

                                    })
                                
                                    
                                } catch(err){

                                } finally {
                                    graph.getModel().endUpdate();
                                }
                            };

                            var items = [JSON.parse(event.dataTransfer.getData("Text"))];

                            addCellToGraph(items);
                        }
                    });


                    // 节点Hover菜单
                    // Defines a new class for all icons
                    function mxIconSet(state){
                        this.images = [];
                        var graph = state.view.graph;
                        
                        // Tip img
                        let size = 24;
                        var imgTip = mxUtils.createImage('/fs/assets/images/tools/png/tip.png?type=open&issys=true');
                        imgTip.setAttribute('title', '备注');
                        imgTip.style.position = 'absolute';
                        imgTip.style.cursor = 'pointer';
                        imgTip.style.width = size+'px';
                        imgTip.style.height = size+'px';
                        imgTip.style.left = (state.x + state.width) + 'px';
			            imgTip.style.top = (state.y - size) + 'px';
                        
                        mxEvent.addGestureListeners(imgTip,
                            mxUtils.bind(this, function(evt){
                                // Disables dragging the image
					            mxEvent.consume(evt);
                            })
                        );
                        // bind事件到备注按钮    
                        mxEvent.addListener(imgTip, 'click',
                            mxUtils.bind(this, function(evt){
                                self.entity.dialogNoteForEntity.model.id = state.cell.getId();
                                self.entity.dialogNoteForEntity.model.note.content = "";
                                self.entity.dialogNoteForEntity.show = true;
                                mxEvent.consume(evt);
                                this.destroy();
                            })
                        );
                        
                        state.view.graph.container.appendChild(imgTip);
                        this.images.push(imgTip);

                        // Info img
                        var imgInfo = mxUtils.createImage('/fs/assets/images/tools/png/info.png?type=open&issys=true');
                        imgInfo.setAttribute('title', '信息');
                        imgInfo.style.position = 'absolute';
                        imgInfo.style.cursor = 'pointer';
                        imgInfo.style.width = size+'px';
                        imgInfo.style.height = size+'px';
                        imgInfo.style.left = (state.x - size) + 'px';
                        imgInfo.style.top = (state.y - size) + 'px';
                        
                        mxEvent.addGestureListeners(imgInfo,
                            mxUtils.bind(this, function(evt){
                                mxEvent.consume(evt);
                            })
                        );
                        // bind事件到备注按钮    
                        mxEvent.addListener(imgInfo, 'click',
                            mxUtils.bind(this, function(evt){
                                // 点击查看实体信息
                                self.onTipWnd(state.cell);
                                mxEvent.consume(evt);
                                this.destroy();
                            })
                        );
                        
                        state.view.graph.container.appendChild(imgInfo);
                        this.images.push(imgInfo);
                        
                    }

                    mxIconSet.prototype.destroy = function(){
                        if (this.images != null) {
                            for (var i = 0; i < this.images.length; i++) {
                                var img = this.images[i];
                                img.parentNode.removeChild(img);
                            }
                        }
                        
                        this.images = null;
                    }
                    // Defines the tolerance before removing the icons
                    var iconTolerance = 20;

                    // Shows icons if the mouse is over a cell
                    graph.addMouseListener({
                        currentState: null,
                        currentIconSet: null,
                        mouseDown: function(sender, me){
                            // Hides icons on mouse down
                            if (this.currentState != null){
                                this.dragLeave(me.getEvent(), this.currentState);
                                this.currentState = null;
                            }
                        },
                        mouseMove: function(sender, me){
                            if (this.currentState != null && (me.getState() == this.currentState ||
                                me.getState() == null)){
                                var tol = iconTolerance;
                                var tmp = new mxRectangle(me.getGraphX() - tol,
                                    me.getGraphY() - tol, 2 * tol, 2 * tol);

                                if (mxUtils.intersects(tmp, this.currentState)){
                                    return;
                                }
                            }
                            
                            var tmp = graph.view.getState(me.getCell());
                            
                            // Ignores everything but vertices
                            if (graph.isMouseDown || (tmp != null && !graph.getModel().isVertex(tmp.cell))){
                                tmp = null;
                            }

                            if (tmp != this.currentState){
                                if (this.currentState != null){
                                    this.dragLeave(me.getEvent(), this.currentState);
                                }
                            
                                this.currentState = tmp;
                            
                                if (this.currentState != null){
                                    this.dragEnter(me.getEvent(), this.currentState);
                                }
                            }
                        },
                        mouseUp: function(sender, me) { },
                        dragEnter: function(evt, state){
                            if (this.currentIconSet == null){
                                this.currentIconSet = new mxIconSet(state);
                            }
                        },
                        dragLeave: function(evt, state){
                            if (this.currentIconSet != null){
                                this.currentIconSet.destroy();
                                this.currentIconSet = null;
                            }
                        }
                    })

                } catch(err){}
            },
            // 统计
            graphSummary(){
                try{
                    let parent = this.model.editor.graph.getDefaultParent();
                    let vertices = this.model.editor.graph.getChildVertices(parent);
                    
                    // Summary All IDs
                    this.model.graph.allNodesIds = _.uniq(_.map(vertices,(v,k)=>{
                                        return v.getId();
                                    })).sort();
                    
                    // Summary All Edges
                    let edges = this.model.editor.graph.getChildEdges(parent);
                    this.model.graph.allNodesEdge = _.groupBy(edges,(v)=>{
                        return v.getValue();
                    });
                    
                    this.model.graph.allNodesClass = _.groupBy(vertices,(v)=>{
                        return v.getId().split(":")[0];
                    });
                    
                } catch(err){
                    this.model.graph.allNodesIds = [];
                    this.model.graph.allNodesEdge = null;
                    this.model.graph.allNodesClass = null;
                } finally{
                    this.model.control.checkedNodes = [];
                    this.model.control.checkedEdges = [];
                }
            },
            onPosition(id,hFlag,vFlag){
                
                let editor = this.model.editor; 
                let graph = editor.graph;
                let cell = graph.getModel().getCell(id);

                try{
                    // 恢复图实际大小
                    editor.execute("actualSize");    
                    
                    let containerW = graph.container.clientWidth;
                    let containerH = graph.container.clientHeight;
                    let x =-cell.geometry.x + ( containerW - cell.geometry.width) / 2;
                    let y =-cell.geometry.y + ( containerH - cell.geometry.height) / 2;
                    
                    if( hFlag ){
                        x = x / 2;
                    }

                    if( vFlag ){
                        y = y / 2;
                    }
                    
                    graph.getView().setTranslate(x,y);
                    graph.scrollCellToVisible(cell);
                    graph.setSelectionCells([cell]);

                    _.delay(()=>{
                        let state = graph.view.getState(cell);
                        
                        if(this.model.control.ifIcon){
                            state.shape.node.getElementsByTagName("image")[0].setAttribute('class', 'animated flash');
                        } else {
                            state.shape.node.getElementsByTagName("ellipse")[0].setAttribute('class', 'animated flash');
                        }
                    },500)

                    // 选择节点突出显示
                    graph.setCellStyles(mxConstants.STYLE_PERIMETER_SPACING, 8, [cell]);
                    
                } catch(err){
                    
                    // 当前画布中不包含该实体
                    this.$message({
                        type: "info",
                        message: "画布没有该实体 "
                    })
                }
                
            },
            onTipWnd(cell){
                const self = this;
                let wnd = null;
                try{
                    if(jsPanel.activePanels.getPanel('jsPanel-entity-info')){
                        jsPanel.activePanels.getPanel('jsPanel-entity-info').close();
                    }
                } catch(error){

                }
                finally{
                    wnd = maxWindow.winEntityInfo('信息' + cell.getId().split(":")[1], `<div id="entity-info-wnd"></div>`, null, null, null);
                }

                new Vue({
                    delimiters: ['#{', '}#'],
                    data:{
                        src: "/matrix/form?id=" + cell.getId()
                    },
                    template:   `<div style="width:100%;height:100%;">
                                    <iframe style="border:unset;width:100%;height:100%;" :src="src"></iframe>
                                </div>`
                }).$mount("#entity-info-wnd");
            },
            onToggleTimeline(){
                this.model.graph.footbar.show = !this.model.graph.footbar.show;
            },
            forward(item){
                if(this.model.graph.history.length > 1){
                    this.model.graph.history = _.slice(this.model.graph.history,0,_.findIndex(this.model.graph.history,{id:item.id})+1);
                }
                this.$root.$refs.graphViewRef.search( encodeURIComponent(item.term));
            },
            outline(){
                
                if(this.model.graph.outline){
                    this.model.graph.outline.destroy();
                }
                
                this.model.graph.outline = new mxOutline(this.model.editor.graph, $("#outlineContainer",this.$el)[0]);
            },
		    saveas(){
				const self = this;

                let encoder = new mxCodec();
                let node = encoder.encode(self.model.editor.graph.getModel());
                let xml = mxUtils.getPrettyXml(node);

                alertify.prompt("另存为", function (e, str) {
                    // str is the input text
                    if (e) {
                        // user clicked "ok"
	                    let parent = '/opt/creative/admin';
	                    let ftype = 'imap';
	                    let name = `${str}.${ftype}`;
	                    let attr = {remark: null, ctime: _.now(), author: window.SignedUser_UserName, type: 'imap', icon: `${window.ASSETS_ICON}/files/png/imap.png?type=open&issys=${window.SignedUser_IsAdmin}`};
                        let rtn = fsHandler.fsNew('file', parent, name, xml, attr);
	                    if(rtn == 1){

	                        let item = _.merge({parent:parent,name:name,attr:attr,ftype:ftype},{lang: 'zh', action:'run'});

                            let url = fsHandler.genFsUrl(item,null,null);

                            alertify.success(`已保存到/fs${[parent,name].join("/")}，<a class="btn btn-success" href="${url}" target="_blank">点击前往编辑或查看</a>`);
	                    }
                    } else {
                        // user clicked "cancel"
                    }
                }, "");

                $(".alertify-prompt .alertify-message").css('height','5vh');

		    },
            nodeTitle() {

                // 文件图模式
                if(window.URL_PARAMS_ITEM){
                    this.model.graph.default.list = [{value: "id", label: "ID"},{value: "value", label: "Value"}];    
                } else {
                    this.model.graph.default.list = _.sortBy(_.map(_.keys(this.graphData.nodes[0]),function(v){
                        let k = v;
                        return {value: k, label: k};
                    }),['value'])
                }

            },
            // 图自适应并居中显示
            toCenter(immediate){
                const self = this;

                let editor = this.model.editor;
                let graph = editor.graph;
                let parent = graph.getDefaultParent();
                let limit = 30;  // 当前画布节点数量阈值
                let topCell = graph.findTreeRoots(parent)[0];
                
                // 获取当前选择节点 
                // 针对加载子图的场景
                // 最顶层节点  graph.center(true,true,0,0.5);
                // 子节点  graph.center(true,true,0.5,0.5);
                let toCenter = function(){
                    let selectionCell = graph.getSelectionCell();
                    let allCells = graph.getChildVertices(parent);
                    
                    if( allCells.length > limit){
                        // 图自适应
                        editor.execute("fit");
                        editor.execute("actualSize"); 
                    } else {
                        // 图实际大小
                        editor.execute("actualSize"); 
                    }

                    // 没有选择节点
                    if( selectionCell == null ){
                        
                        graph.center(true,true,0.5,0.5);  // middle-center

                    } else {
                        
                        // 选择了最顶层节点
                        if( selectionCell == topCell ){
                            graph.center(true,true,0,0.5); // top-center
                            // 定位选择节点
                            self.onPosition(selectionCell.getId(), true, true);
                        } 
                        // 选择了子节点
                        else {
                            graph.center(true,true,0.5,0.5);  // middle-center
                            // 定位选择节点
                            self.onPosition(selectionCell.getId(), true, true);
                        }
                    }

                    //graph.clearSelection();
                    
                }

                if(immediate){
                    editor.execute("fit");
                    toCenter();
                } else {
                    let loadSvg = function(){
                        try{
                            let rtn = graph.getChildEdges(parent);
                            
                            if(_.size(rtn) > 0){
                                return true;
                            } else {
                                return false;
                            }
                            
                        } catch(err){
                            return false
                        }
                    };
                    
                    if(loadSvg()) {
                        _.delay(()=>{
                            editor.execute("fit");
                            toCenter();
                        },500)
                    } else {
                        setTimeout(loadSvg, 50);
                    }   
                }
            },
            // 绘制路径
            addPath(paths){
                
                
                let pathsByOmitProp = _.map(paths,(v)=>{
                                return _.omit(v,['num','class']);
                            });
                

                this.model.editor.graph.getModel().beginUpdate();
                
                try{
                    this.model.editor.graph.getModel()

                    this.removePath();
                    
                    _.forEach(pathsByOmitProp,(v,index)=>{
                        // keys
                        var keys = _.keys(v);
                        // values
                        var values = _.values(v);

                        for(var i=0;i<keys.length;i++){
                            let source = this.model.editor.graph.getModel().getCell(v[keys[i]]);//this.model.graph.nodes[v[keys[i]]];
                            let target = this.model.editor.graph.getModel().getCell(v[keys[i+1]]);//this.model.graph.nodes[v[keys[i+1]]];
                            if(_.isUndefined(target)){
                                return;
                            }
                            let baseEdgeStyle = `edgeStyle=${this.model.graph.style.edge.value.title};orthogonalLoop=1;strokeWidth=3;dashed=1;startFill=0;endArrow=none;endFill=0;startArrow=none;orthogonal=1;elbow=vertical;`;
                            let strokeColor = this.model.graph.path.colors[index] || _.sample(this.model.graph.path.colors);
                            
                            let hasPath = this.model.editor.graph.getModel().getCell(`path${index+1}${i}`);
                            if(!hasPath){
                                let path = this.model.editor.graph.insertEdge(this.model.graph.parent, `path${index+1}${i}`, `${index+1}`, source, target, baseEdgeStyle+`strokeColor=${strokeColor};`);
                                this.model.graph.path.list.push(path);
                            }
                        }
                    })

                    
                    this.entity.dialog.show = false;


                } catch(err){
                    console.log('addPath ', err)
                }
                finally{
                    this.model.editor.graph.getModel().endUpdate();
                }
            },
            // 删除路径
            removePath(){
                
                if(this.model.graph.path.list.length == 0){
                    return false;
                }

                // Cancels interactive operations
                this.model.editor.graph.escape();

                let cells = this.model.graph.path.list;
                
                if (cells != null && cells.length > 0){
                    this.model.editor.graph.removeCells(cells, true);
                }
            },
            // 图打印
            onPrint(){
                let scale = mxUtils.getScaleForPageCount(1, this.model.editor.graph);
                let preview = new mxPrintPreview(this.model.editor.graph, scale);
                preview.open();
            },
            // 设置主题色
            setTheme(bgColor){

                $("body").css({
                    "background": bgColor
                });

                $(this.$refs.graphContainer.$el).css({
                    "backgroundColor":"transparent"
                });

                let vertices = this.model.editor.graph.getChildVertices(this.model.editor.graph.getDefaultParent());
                let edges = this.model.editor.graph.getChildEdges(this.model.editor.graph.getDefaultParent());
                let bgColorReverse = this.setThemeFont(bgColor);
                
                this.model.editor.graph.setCellStyles(mxConstants.STYLE_FONTCOLOR, bgColorReverse, vertices);
                this.model.editor.graph.setCellStyles(mxConstants.STYLE_STROKECOLOR, bgColorReverse, vertices);

                this.model.editor.graph.setCellStyles(mxConstants.STYLE_FONTCOLOR, bgColorReverse, edges);
                this.model.editor.graph.setCellStyles(mxConstants.STYLE_STROKECOLOR, bgColorReverse, edges);
                
                this.setDiffCellsStyle();

                localStorage.setItem(`GRAPH-VIEW-THEME-${window.SignedUser_UserName}`,bgColor);
            },
            // 设置剔除add/del的节点和边样式
            setDiffCellsStyle(){
                
                try{

                    if( this.graphData['diff'] && 'add' in this.graphData['diff'] ){
                        _.forEach(this.graphData['diff']['add']['nodes'], (v)=>{
                            let overlay = new mxCellOverlay(new mxImage(`/fs/assets/images/apps/png/flag/add.png?issys=true&type=open`,24,24), "新增", mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_TOP, new mxPoint(-10,15));
                            let cell = this.model.editor.graph.getModel().getCell(v.id);
                            this.model.editor.graph.addCellOverlay(cell, overlay);
                        })

                        _.forEach(this.graphData['diff']['add']['edges'], (v)=>{
                            let cell = this.model.editor.graph.getModel().getCell(v.id);
                            this.model.editor.graph.setCellStyles(mxConstants.STYLE_STROKECOLOR, "#47fa28", [cell]);
                            this.model.editor.graph.setCellStyles(mxConstants.STYLE_STROKEWIDTH, "2", [cell]);
                        })
                    }

                    if( this.graphData['diff'] && 'del' in this.graphData['diff'] ){

                        _.forEach(this.graphData['diff']['del']['nodes'], (v)=>{
                            let overlay = new mxCellOverlay(new mxImage(`/fs/assets/images/apps/png/flag/delete.png?issys=true&type=open`,24,24), "删除", mxConstants.ALIGN_RIGHT, mxConstants.ALIGN_TOP, new mxPoint(-10,15));
                            let cell = this.model.editor.graph.getModel().getCell(v.id);
                            this.model.editor.graph.addCellOverlay(cell, overlay);
                        })

                        _.forEach(this.graphData['diff']['del']['edges'], (v)=>{
                            let cell = this.model.editor.graph.getModel().getCell(v.id);
                            this.model.editor.graph.setCellStyles(mxConstants.STYLE_STROKECOLOR, "#ff0000", [cell]);
                            this.model.editor.graph.setCellStyles(mxConstants.STYLE_STROKEWIDTH, "2", [cell]);
                        })
                    }
                    
                } catch(err){
                    console.log(err)
                }

            },
            // 根据主题获取前景色
            setThemeFont(hexcolor){
                try{

                    // If a leading # is provided, remove it
                    if (hexcolor.slice(0, 1) === '#') {
                        hexcolor = hexcolor.slice(1);
                    }

                    // If a three-character hexcode, make six-character
                    if (hexcolor.length === 3) {
                        hexcolor = hexcolor.split('').map(function (hex) {
                            return hex + hex;
                        }).join('');
                    }

                    // Convert to RGB value
                    var r = parseInt(hexcolor.substr(0,2),16);
                    var g = parseInt(hexcolor.substr(2,2),16);
                    var b = parseInt(hexcolor.substr(4,2),16);

                    // Get YIQ ratio
                    var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;

                    // Check contrast
                    return (yiq >= 128) ? 'inherit' : '#efefef';

                } catch(err){
                    return 'inherit';
                }

            },
            // 节点排列
            onVertexAlignChange(evt){
                this.model.editor.graph.alignCells(evt);
            },
            // 边样式调整
            onEdgeStyleChange(evt){
                
                let keys = evt.keys;
                let values = evt.values;
                let graph = this.model.editor.graph;
                
                graph.stopEditing(false);
                
                graph.getModel().beginUpdate();
                try{
                    
                    graph.selectEdges();

                    let cells = graph.getSelectionCells();

                    let edges = [];

                    for (var i = 0; i < cells.length; i++){
                        var cell = cells[i];
                        
                        if (graph.getModel().isEdge(cell)){
                            
                            var geo = graph.getCellGeometry(cell);
                
                            // Resets all edge points
                            if (geo != null){
                                geo = geo.clone();
                                geo.points = null;
                                graph.getModel().setGeometry(cell, geo);
                            }
                            
                            for (var j = 0; j < keys.length; j++){
                                graph.setCellStyles(keys[j], values[j], [cell]);
                            }
                            
                            edges.push(cell);
                        }
                    }

                    graph.clearSelection();
                    
                }
                finally{
                    graph.getModel().endUpdate();
                }
            
            },
            // 图放大
            onZoomIn(){
                this.model.editor.graph.zoomIn();
            },
            // 图缩小
            onZoomOut(){
                this.model.editor.graph.zoomOut();
            },
            // 图自适应大小
            onFit(){
                this.model.editor.execute("fit");
            },
            // 进入创作中心二次编辑 【暂时舍弃】
            editIt(){
                let item = { 
                                parent:window.URL_PARAMS_ITEM.parent, 
                                name:window.URL_PARAMS_ITEM.name, 
                                ftype:window.URL_PARAMS_ITEM.ftype, 
                                lang: window.MATRIX_LANG, 
                                attr:window.URL_PARAMS_ITEM.attr, 
                                action:'edit'
                            };

                let url = fsHandler.genFsUrl(item,null,null);

                window.open(url, "_parent");
            },
            addCell(tNode){
                
                try{
                    // normal
                    let type = tNode.key.split(":")[0];
                    let node = this.model.editor.graph.insertVertex(this.model.graph.parent, tNode.key, tNode.label, 50, 50, 120, 50,
                                `shape=image;html=1;image=${window.ASSETS_ICON}/entity/png/${type}.png?type=open&issys=${window.SignedUser_IsAdmin};verticalLabelPosition=bottom;verticalAlign=top;`);
                    
                    // node directory
                    _.extend(this.model.graph.nodes,{[tNode.key]:node});

                } catch(err){
                    
                }
            },
            addEdge(sNode,tNode){
                
                this.model.editor.graph.getModel().beginUpdate();

                let source = this.model.graph.nodes[sNode];
                
                try{

                    this.model.editor.graph.getModel();

                    _.forEach(tNode, (v)=>{
                        
                        let target = null;

                        // 如果没有Cell，先新建Cell
                        if(!this.model.graph.nodes[v.key]){
                            target = this.addCell(v)
                        }

                        target = this.model.graph.nodes[v.key];
                        
                        let id = sNode + '-' + target.getId();
                        let edgeNode = {id:id, class:''};

                        let baseEdgeStyle = `edgeStyle=${this.model.graph.style.edge.value.title};html=1;rounded=1;jettySize=auto;orthogonalLoop=1;endArrow=block;endFill=1;`;
                        let direction = 'startArrow=block;endArrow=block;endFill=1;';

                        // add
                        direction += 'strokeColor=#47fa28;strokeWidth=2;';

                        let edge = null;
                        try {
                            edge = this.model.editor.graph.insertEdge(this.model.graph.parent, edgeNode.id, '', source, target, baseEdgeStyle+direction);
                        } catch(err){
                            edge = this.model.editor.graph.insertEdge(this.model.graph.parent, edgeNode.id, edgeNode.class, source, target, baseEdgeStyle+direction);
                        }

                        // edges directory
                        _.extend(this.model.graph.edges, {[id]:edge});
                    })
                    
                    // Executes the layout handler
                    _.delay(()=>{
                        this.executeLayout();
                    },500)
                    
                } finally {
                    this.model.editor.graph.getModel().endUpdate();
                }
            },
            removeEdge(sNode,tNode){
                
                this.model.editor.graph.getModel().beginUpdate();
                
                try{

                    let cells = _.map(tNode, (v)=>{
                                    let id = sNode + '-' + v.key;
                                    return this.model.editor.graph.getModel().getCell(id);
                                });

                    this.model.editor.graph.getModel();

                    this.model.editor.graph.escape();
                    
                    if (cells != null && cells.length > 0){
                        this.model.editor.graph.removeCells(cells, true);
                    }
                    
                    // Executes the layout handler
                    _.delay(()=>{
                        this.executeLayout();
                    },500)
                    
                } finally {
                    this.model.editor.graph.getModel().endUpdate();
                }
            },
            onFullScreen(){
                if (screenfull.isEnabled) {
                    if(this.model.control.ifFullScreen){
                        screenfull.exit(this.$el);
                        this.model.control.ifFullScreen = false;   
                    
                        $("#header").show();
                        $("#aside").show();
                        $("#footer").show();
                        $("#content").css("margin-left","60px");
                        $(this.$root.$refs.main.$el).css("height","calc(100vh - 85px)");
                    } else {
                        screenfull.request();
                        this.model.control.ifFullScreen = true;

                        $("#header").hide();
                        $("#aside").hide();
                        $("#footer").hide();
                        $("#content").css("margin-left","0px");
                        $(this.$root.$refs.main.$el).css("height","calc(100vh - 50px)");
                    }   
                }
                //this.model.control.ifFullScreen = mx.fullScreenByEl(this.$el);
            },
            // 滚轮缩放事件监听
            addScrollListener(element, wheelHandle) {
                if (typeof element != 'object') return;
                if (typeof wheelHandle != 'function') return;

                // 监测浏览器
                if (typeof arguments.callee.browser == 'undefined') {
                    var user = navigator.userAgent;
                    var b = {};
                    b.opera = user.indexOf("Opera") > -1 && typeof window.opera == "object";
                    b.khtml = (user.indexOf("KHTML") > -1 || user.indexOf("AppleWebKit") > -1 || user.indexOf("Konqueror") > -1) && !b.opera;
                    b.ie = user.indexOf("MSIE") > -1 && !b.opera;
                    b.gecko = user.indexOf("Gecko") > -1 && !b.khtml;
                    arguments.callee.browser = b;
                }
                if (element == window)
                    element = document;
                if (arguments.callee.browser.ie)
                    element.attachEvent('onmousewheel', wheelHandle);
                else
                    element.addEventListener(arguments.callee.browser.gecko ? 'DOMMouseScroll' : 'mousewheel', wheelHandle, false);
            },
            // 滚轮缩放图
            wheelHandle(e) {
                var upcheck;

                if (e.wheelDelta) {
                    upcheck = e.wheelDelta > 0 ? 1 : 0;
                } else {
                    upcheck = e.detail < 0 ? 1 : 0;
                }
                if (upcheck) {
                    this.model.editor.graph.zoomIn();
                }
                else {
                    this.model.editor.graph.zoomOut();
                }

                if (window.event) {
                    e.returnValue = false;
                    window.event.cancelBubble = true;
                } else {
                    e.preventDefault();
                    e.stopPropagation();
                }
            },
            // 节点选中进行样式切换
            onCellCheckedChange(val,type){
                // 拍扁了合并
                this.onToggleCellStyle(_.concat(_.flatten(val)),type);
            },
            // 工具栏显示控制
            onToolbarShowChange(val){
                this.model.control.toolbar.show = val;
            },
            // 自动刷新控制
            onRefreshChange(val){
                this.model.control.refresh.enable = val;
                localStorage.setItem("GRAPH-STATUS-IFREFRESH", this.model.control.refresh.enable);
            },
            // 显示格子背景
            onToggleGridBg(val){
                this.model.graph.style.grid.show = val;
                localStorage.setItem("GRAPH-GRID-SHOW", this.model.graph.style.grid.show);
            },
            // 切换节点渲染类型 图标 or 图形
            onToggleIcon(){
                
                this.model.control.ifIcon = !this.model.control.ifIcon;

                try{
                    let parent = this.model.editor.graph.getDefaultParent();
                    let vertices = this.model.editor.graph.getChildVertices(parent);
                    
                    _.forEach(vertices, (v)=>{
                        let style = this.model.editor.graph.getModel().getStyle(v);
                        let type = _.head(v.id.split(":")) || 'matrix';
                        let imageUrl = `${window.ASSETS_ICON}/entity/png/${type}.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                        
                        // 图标
                        if(this.model.control.ifIcon){
                            if(this.checkImgExists(`${type}.png`)){
                                this.model.editor.graph.getModel().setStyle(v,`shape=image;html=1;image=${imageUrl};verticalLabelPosition=bottom;verticalAlign=top;`)
                            } else {
                                this.model.editor.graph.getModel().setStyle(v,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;`);
                            }    
                        } 
                        // 图形
                        else {
                            this.model.editor.graph.getModel().setStyle(v,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;`);
                        }
                        
                    })
                    
                } catch(err){
                    console.log(err)
                } finally{
                    localStorage.setItem("TOPOLOGICAL-RENDER-TYPE",this.model.control.ifIcon);
                }

            },
            // 切换节点显示名称
            onToggleLabel(){
                    
                try{
                    let parent = this.model.editor.graph.getDefaultParent();
                    let vertices = this.model.editor.graph.getChildVertices(parent);
                    
                    _.forEach(vertices, (v)=>{
                        let cell = this.model.editor.graph.getModel().getCell(v.getId());
                        if(cell){
                            // 可设置默认显示属性
                            let node = _.find(this.graphData.nodes,{id: cell.getId()});
                            let name = node[this.model.graph.default.title]?node[this.model.graph.default.title]:node["name"];

                            this.model.editor.graph.getModel().setValue(cell, name);
                        }
                        
                    })
                    
                } catch(err){
                    console.log(err)
                } finally {
                    
                }
            },
            onEntityDialogClosed(){
                this.entity.soure = {};
                this.entity.target = {};
                if(this.entity.dialog.ifClose == true){
                    this.model.editor.execute('undo');
                }
            },
            // 保存关系类型
            onSaveEdgeType(){
                
                let term = encodeURIComponent( JSON.stringify(_.extend(this.entity.newEdgeType.model, {action: "create"})) );

                let rtn = fsHandler.callFsJScript("/matrix/edge/edgeAction.js",term);
                
                if(rtn.status == 'ok'){
                    this.$message({
                        type: "success",
                        message: "新建关系类型成功！"
                    })
                    this.entity.newEdgeType.show = false;
                }
                
            },  
            // 添加实体到画布
            addEntityToGraph(event){
                
                this.model.editor.graph.getModel().beginUpdate();
                
                try {

                    let _type = event.id.split(":")[0] || 'matrix';
                            
                    // 可设置默认显示属性
                    let _name =  '';
                    
                    try{
                        _name = event[this.model.graph.default.title];
                    } catch(err){
                        _name = event["id"];
                    }

                    // normal
                    // 选择节点渲染模式：icon/shape
                    let node = null;
                    let imageUrl = `${window.ASSETS_ICON}/entity/png/${_type}.png?type=open&issys=${window.SignedUser_IsAdmin}`;
                    
                    // icon渲染
                    if(this.model.control.ifIcon){
                        if(this.checkImgExists(`${_type}.png`)){
                            node = this.model.editor.graph.insertVertex(this.model.graph.parent, event.id, _name, 350, 50, 60, 60,`shape=image;html=1;image=${imageUrl};verticalLabelPosition=bottom;verticalAlign=top;`);
                        } else {
                            node = this.model.editor.graph.insertVertex(this.model.graph.parent, event.id, _name, 350, 50, 50, 50,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;`);
                        }    
                    } 
                    // shape渲染
                    else {
                        node = this.model.editor.graph.insertVertex(this.model.graph.parent, event.id, _name, 350, 50, 50, 50,`shape=ellipse;perimeter=ellipsePerimeter;html=1;labelPosition=center;verticalLabelPosition=bottom;align=center;verticalAlign=middle;`);
                    }

                    // node directory
                    _.extend(this.model.graph.nodes,{[v.id]:node});

                    
                }
                finally {
                    
                    this.model.editor.graph.getModel().endUpdate();

                    // 统计
                    this.graphSummary();

                }
            },
            // 删除实体
            removeEntityHandler(cell){
                
                if(!cell){
                    this.$message({
                        type: "info",
                        message: "请确认所选实体！"
                    })
                    return false;
                }

                // 删除节点
                if(!cell.edge){
                    this.$confirm(`确定删除该实体？`, '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }).then(() => {
                            // entity action
                            let entity = {id:cell.getId(),type:'delete'};
                            fsHandler.callFsJScript("/matrix/graph/entity-action.js",encodeURIComponent(JSON.stringify(entity)));

                            // graph action
                            cell.removeFromParent();
                            this.model.editor.graph.refresh(cell);
                            
                            this.$message({
                                message: '删除实体成功',
                                type: 'success'
                            }); 
                        }).catch(() => {
                            
                        });
                }
                // 删除关系
                else{
                    this.$confirm(`确定删除该实体关系？`, '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }).then(() => {
                            
                            // entity action
                            let sourceId = cell.getId().split("-")[0];
                            let targetId = cell.getId().split("-")[1];
                            let type = cell.getId().split("-")[2];//cell.getValue();
                            let edges = {
                                id: sourceId, 
                                type: type, 
                                action:"-", 
                                value: _.map([targetId],(v)=>{
                                    return {key: v, label: v};
                                })
                            };
                    
                            // 更新关系
                            let rtn = fsHandler.callFsJScript("/matrix/graph/edges-action.js",encodeURIComponent(JSON.stringify(edges)));
                            
                            if(rtn.status == 'ok'){
                                this.$message({
                                    type: "success",
                                    message: "删除关系成功！"
                                })
                                // graph action
                                cell.removeFromParent();
                                this.model.editor.graph.refresh(cell);

                            } else {
                                this.$message({
                                    type: "error",
                                    message: "删除关系失败！"
                                })
                            }

                        }).catch(() => {
                            
                        });
                }
            },
            addEntityHandler(entity){
                let rtn = null;

                if(!this.entity.edges.value){
                    this.$message({
                        type: "info",
                        message: "请选择关系类型！"
                    });
                    return false;
                }

                if(!entity){
                    
                    rtn = fsHandler.callFsJScript("/matrix/graph/entity-action.js",encodeURIComponent(JSON.stringify(this.entity.target))).message;
                }

                this.$message({
                    type: "success",
                    message: "实体插入成功！"
                })

                this.createEntityEdgeHandler();
            },
            // 创建实体关系
            createEntityEdgeHandler(){
                
                if(!this.entity.edges.value){
                    this.$message({
                        type: "info",
                        message: "请选择关系类型！"
                    });
                    return false;
                }

                if(!this.entity.source.id){
                    this.$message({
                        type: "info",
                        message: "请确定起始节点！"
                    });
                    return false;
                }

                if(!this.entity.target.id){
                    this.$message({
                        type: "info",
                        message: "请确定目标节点！"
                    });
                    return false;
                }


                /* value = [
                    {
                    "key": "linux:wecise",
                    "label": "linux:wecise",
                    "class": "/matrix/entity/linux",
                    "disabled": 0
                    }
                ] */
                
                let edges = {
                                id:this.entity.source.id, 
                                type:this.entity.edges.value, 
                                action:"+", 
                                value: _.map([this.entity.target],(v)=>{
                                    return {key: v.id, label: v.value};
                                })
                            };
                    
                // 更新关系
                let rtn = fsHandler.callFsJScript("/matrix/graph/edges-action.js",encodeURIComponent(JSON.stringify(edges)));
                            
                if(rtn.status == 'ok'){
                    this.$message({
                        type: "success",
                        message: "创建关系成功！"
                    })
                    
                    this.entity.dialog.ifClose = false;
                    this.entity.dialog.show = false;

                } else {
                    this.$message({
                        type: "error",
                        message: "创建关系失败！"
                    })
                }

            },
            // 更新实体关系类型
            updateEntityEdgeTypeHandler(id,type,oldType){

                let cell = this.model.editor.graph.getModel().getCell(id);
                
                if(!cell) {
                    this.$message({
                        type: "info",
                        message: "请选择节点！"
                    });
                    return false;
                }

                let sId = cell.source.getId();
                let tId = cell.target.getId();

                if(!type){
                    this.$message({
                        type: "info",
                        message: "请选择关系类型！"
                    });
                    return false;
                }

                if(!sId){
                    this.$message({
                        type: "info",
                        message: "请确定起始节点！"
                    });
                    return false;
                }

                if(!tId){
                    this.$message({
                        type: "info",
                        message: "请确定目标节点！"
                    });
                    return false;
                }
                
                let rtn = null;

                // 先减关系
                let oldEdges = {
                                id: sId, 
                                type: oldType, 
                                action: "-", 
                                value: _.map([cell.target],(v)=>{
                                    return {key: v.getId(), label: v.getValue()};
                                })
                            };
                rtn = fsHandler.callFsJScript("/matrix/graph/edges-action.js",encodeURIComponent(JSON.stringify(oldEdges)));

                // 后加关系
                let edges = {
                    id: sId, 
                    type: type, 
                    oldType: oldType,
                    action: "+", 
                    value: _.map([cell.target],(v)=>{
                        return {key: v.getId(), label: v.getValue()};
                    })
                };                            
                rtn = fsHandler.callFsJScript("/matrix/graph/edges-action.js",encodeURIComponent(JSON.stringify(edges)));
                            
                if(rtn.status == 'ok'){
                    this.$message({
                        type: "success",
                        message: "更新关系成功！"
                    })

                    this.model.editor.graph.getModel().setValue(cell, type);
                    this.model.editor.graph.refresh();

                } else {
                    this.$message({
                        type: "error",
                        message: "更新关系失败！"
                    })
                }
            },
            // 添加实体备注
            addEntityNoteHandler(){
                // 根据实体ID定义该实体note存储位置
                this.entity.dialogNoteForEntity.model.note.parent = "/storage/entity/notes/" + this.entity.dialogNoteForEntity.model.id;
                this.entity.dialogNoteForEntity.model.note.name = "note_" + moment().format("YYYY-MM-DD HH:MM:SS")+".md";
                // 文件存在
                try{
                    let rtn = fsHandler.fsCheck(this.entity.dialogNoteForEntity.model.note.parent,this.entity.dialogNoteForEntity.model.note.name); 
                    if(!rtn){
                        let attr = {remark: '', ctime: _.now(), author: window.SignedUser_UserName};
                        let rtn = fsHandler.fsNew(this.entity.dialogNoteForEntity.model.note.ftype, this.entity.dialogNoteForEntity.model.note.parent, this.entity.dialogNoteForEntity.model.note.name, this.entity.dialogNoteForEntity.model.note.content, attr);
                    }
                } 
                // 文件不存在则新建一个
                catch(err){
                    console.log(err)
                } finally{
                    this.entity.dialogNoteForEntity.show = false;
                }
            },
            // 生成报告
            onReportOpen(){
                const self = this;

                html2canvas(this.$refs.graphContainer.$el,{
					allowTaint: true,
					useCORS: true,
					letterRendering: 1
				}).then(
                    function (canvas) {

                        var image = canvas.toDataURL();
                        var byteString = atob(image.substring(22));
                        var buffer = new ArrayBuffer(byteString.length);
                        var intArray = new Uint8Array(buffer);

                        for ( var i = 0; i < byteString.length; i++ ){
                            intArray[i] = byteString.charCodeAt(i);
                        }


                        let ftype = "html";
                        let attr = {remark: "", ctime: _.now(), author: window.SignedUser_UserName, type: ftype};
                        let name = '报告_' + moment().format("YYYY-MM-DD HH:MM:SS");
                        let html = `<!DOCTYPE html>
                                    <html>
                                        <head>
                                            <meta charset="UTF-8">
                                        </head>
                                        <style>
                                            body{
                                                padding:10px 30px;
                                            }
                                        </style>
                                        <body>
                                            <section>
                                                <h3 style="background:#f2f3f5;">图</h3>
                                                <p>
                                                    <img src="${canvas.toDataURL()}" style="width:100%;height:100%;"/>
                                                </p>
                                                <p>
                                                    <h3 style="background:#f2f3f5;">事件</h3>
                                                </p>
                                                <p>
                                                    <h3 style="background:#f2f3f5;">性能</h3>
                                                </p>
                                            </section>
                                            
                                        </body>
                                    </html>`;

                        let url = fsHandler.fsReport(ftype, name + "." + ftype, html, attr);
                        
                        // 保存失败
                        if(!url){
                            self.$message({
                                type: "error",
                                message: "保存失败，请确认！",
                                showClose: true
                            });
                            return false;
                        }
                        
                        self.report.content = `/fs${url}?type=open&issys=${window.SignedUser_IsAdmin}`;
                        // self.$notify({
                        //     title: '报告已生成',
                        //     dangerouslyUseHTMLString: true,
                        //     duration: 10*1000,
                        //     message: `<p>目录：${url} </p>
                        //                 <p>点击 <a href="/fs${url}?type=open&issys=${window.SignedUser_IsAdmin}" class="el-button el-button--success el-button--mini" style="text-decoration: none;" target="_blank">确认</a> 查看详细</p>`,
                        //     position: 'bottom-right'
                        // });
                });
            },
            // 图统计面板打开
            onGraphSummaryPopoverShow(){
                // 统计
                this.graphSummary();
            },
            // 图统计面板关闭
            onGraphSummaryPopoverHide(){
                // 重置图样式
                this.onResetStatus(null);
            },
            // 重置节点样式
            onResetStatus(cells){

                const self = this;
                
                this.model.editor.graph.getModel().beginUpdate();
                
                try {

                    let vertices = this.model.editor.graph.getChildVertices(this.model.editor.graph.getDefaultParent());
                    let edges = this.model.editor.graph.getChildEdges(this.model.editor.graph.getDefaultParent());

                    // 重置所有Cells
                    if(_.isEmpty(cells)){
                        
                        // vertices
                        this.model.editor.graph.setCellStyles(mxConstants.STYLE_FILLCOLOR, "#419efe", vertices);
                        this.model.editor.graph.setCellStyles(mxConstants.STYLE_FONTCOLOR, "#333333", vertices);
                        this.model.editor.graph.setCellStyles(mxConstants.STYLE_GRADIENTCOLOR, "#419efe", vertices);
                        this.model.editor.graph.setCellStyles(mxConstants.STYLE_FILL_OPACITY, "100", vertices);
                        
                        // edge
                        this.model.editor.graph.setCellStyles(mxConstants.STYLE_STROKECOLOR, "#888", edges);
                        this.model.editor.graph.setCellStyles(mxConstants.STYLE_STROKEWIDTH, "1", edges);
                        _.forEach(edges,(v)=>{
                            var state = self.model.editor.graph.view.getState(v);
                            state.shape.node.getElementsByTagName('path')[1].removeAttribute('class');
                        })
                    } 
                    // 重置指定Cells
                    else {
                        // vertices
                        this.model.editor.graph.setCellStyles(mxConstants.STYLE_FILLCOLOR, "#419efe", cells);
                        this.model.editor.graph.setCellStyles(mxConstants.STYLE_FONTCOLOR, "#333333", cells);
                        this.model.editor.graph.setCellStyles(mxConstants.STYLE_GRADIENTCOLOR, "#419efe", cells);
                        this.model.editor.graph.setCellStyles(mxConstants.STYLE_FILL_OPACITY, "100", cells);
                        

                        // edges
                        this.model.editor.graph.setCellStyles(mxConstants.STYLE_STROKECOLOR, "#888", cells);
                        this.model.editor.graph.setCellStyles(mxConstants.STYLE_STROKEWIDTH, "1", cells);
                        _.forEach(cells,(v)=>{
                            if(v.edge){
                                var state = self.model.editor.graph.view.getState(v);
                                state.shape.node.getElementsByTagName('path')[1].removeAttribute('class');
                            }
                        })
                    }
                   
                    
                } finally {
                    this.model.editor.graph.getModel().endUpdate();
                }
            },
            // 当前选择实体效果
            onToggleCellStyle(cells,type){
                const self = this;
                
                this.model.editor.graph.getModel().beginUpdate();
                
                try {
                    //this.model.control.ifIcon = false;
                    let vertices = this.model.editor.graph.getChildVertices(this.model.editor.graph.getDefaultParent());
                    let edges = this.model.editor.graph.getChildEdges(this.model.editor.graph.getDefaultParent());
                    
                    let toggleStyle = function(){
                        
                        try{
                            // 节点
                            if(type == 'vertex'){
                                
                                // 图片模式
                                if(self.model.control.ifIcon){
                                    
                                    // 重置图片样式
                                    self.onResetStatus(vertices);
                                    
                                    // 置为透明
                                    if(!_.isEmpty(cells)){
                                        self.model.editor.graph.setCellStyles(mxConstants.STYLE_FILL_OPACITY, "30", _.difference(vertices,cells));
                                    }
                                    

                                }
                                // 图形模式
                                else {
                                    
                                    // 重置图形样式
                                    self.onResetStatus(_.difference(vertices,cells));

                                    // 前景置色
                                    self.model.editor.graph.setCellStyles(mxConstants.STYLE_FILLCOLOR, "#88d62d", cells);
                                    self.model.editor.graph.setCellStyles(mxConstants.STYLE_FONTCOLOR, "#333333", cells);
                                    self.model.editor.graph.setCellStyles(mxConstants.STYLE_GRADIENTCOLOR, "#88d62d", cells);
                                }

                            } 
                            // 边
                            else {

                                // 重置边样式
                                self.onResetStatus(_.difference(edges,cells));

                                // 边动态效果
                                _.forEach(cells,(v)=>{
                                    var state = self.model.editor.graph.view.getState(v);
                                    state.shape.node.getElementsByTagName('path')[0].removeAttribute('visibility');
                                    state.shape.node.getElementsByTagName('path')[0].setAttribute('stroke-width', '4');
                                    state.shape.node.getElementsByTagName('path')[0].setAttribute('stroke', '#88d62d');
                                    state.shape.node.getElementsByTagName('path')[1].setAttribute('class', 'flow');
                                })
                            }
                        } catch(err){
                            console.log(err)
                        } finally {
                            //self.model.editor.graph.orderCells(false,[cells]);
                        }
                    }

                    // 设置样式
                    toggleStyle();
                } finally {
                    this.model.editor.graph.getModel().endUpdate();
                }
                
            }
	    }
	
	}
	</script>

</code>
