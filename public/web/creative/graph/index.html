<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=5,IE=9" ><![endif]-->
<!DOCTYPE html>
<html>
<head>
	<title>M³ Platform 创作中心</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<script type="text/javascript">
        mxBasePath = '/web/creative/src';
        let signeduser = JSON.parse(localStorage.getItem("SIGNEDUSER")) || {};
        window.MATRIX_LANG = signeduser.lang;
        window.SignedUser_UserName = signeduser.username;
        window.SignedUser_FullName = signeduser.fullname;
        window.SignedUser_IsAdmin = signeduser.isadmin;
        window.COMPANY_LOGO = signeduser.companyLogo;
        window.ASSETS_ICON = '/fs/assets/images';
        window.mxLanguage = window.MATRIX_LANG;
	</script>

    <link rel="stylesheet" type="text/css" href="styles/grapheditor.css">
    <link rel="shortcut icon" href="" id="favicon"/>

	<script src="/web/vendor/jquery/jquery-3.3.1.min.js"></script>

	<!-- Bootstrap core CSS -->
	<link href="/web/css/dist/css/bootstrap_wecise.css" rel="stylesheet">
	<link href="/web/css/dist/css/theme_wecise.css" rel="stylesheet">
	<script src="/web/css/dist/js/bootstrap.min.js"></script>


	<!-- Color Theme core CSS -->
	<!--<link href="/web/css/color/color_style.min.css" rel="stylesheet">
	<link href="/web/css/color/color_style_responsive.min.css" rel="stylesheet">-->
	<link href="/web/css/color/style.min.css" rel="stylesheet">

	<!-- Bootstrap ICON  CSS -->
	<link href="/web/vendor/font-awesome/5.4.1/css/all.min.css" rel="stylesheet" >

	<!-- animate core CSS -->
	<link href="/web/vendor/animate/animate.css" rel="stylesheet" >
	<!--Alertify CSS-->
	<link href="/web/vendor/alertifyjs/themes/alertify.core.css" type="text/css" rel="stylesheet" />
	<link href="/web/vendor/alertifyjs/themes/alertify.default.css" type="text/css" rel="stylesheet" />

	<style>

		/* For global font-size */
		span {
			font-size: 12px;
		}

		* {
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: initial;
		}

        /*----------  mxWindow ----------*/
		div.mxWindowPane {
			overflow: auto!important;
            background-color: #ffffff;
            border-top: 1px solid rgb(221, 221, 221);
		}

		/* For mxPoputMenu */
		html div.mxPopupMenu {
			-webkit-box-shadow: 0 2px 8px 0 rgba(0,0,0,0.15);
			-moz-box-shadow: 0 2px 8px 0 rgba(0,0,0,0.15);
			box-shadow: 0 2px 8px 0 rgba(0,0,0,0.15);
			background-color: rgb(255, 255, 255);
			border: none!important;
			padding: 3px;
		}

		.mxPopupMenu hr {
			margin-top: 0px;
			margin-bottom: 0px;
		}

		/* For Sidebar */
		.geSidebar {
			padding-bottom: 10px 8px 0px!important;
		}

		.geSidebar > center {
			padding-bottom: 0px!important;
		}

	</style>


	<script type="text/javascript">
        // Parses URL parameters. Supported parameters are:
        // - lang=xy: Specifies the language of the user interface.
        // - touch=1: Enables a touch-style user interface.
        // - storage=local: Enables HTML5 local storage.
        // - chrome=0: Chromeless mode.
        
        // Default resources are included in grapheditor resources
        mxLoadResources = false;
	</script>

	<script type="text/javascript" src="/web/vendor/lodash/dist/lodash.min.js"></script>

	<!--Panel JS & CSS -->
	<script src="/web/vendor/jsPanel/jquery.jspanel.min.js" type="text/javascript"></script>
	<link href="/web/vendor/jsPanel/jquery.jspanel.min.css" type="text/css" rel="stylesheet" />

	<!--Moment JS-->
	<script src="/web/vendor/moment/min/moment.min.js"></script>
	<script src="/web/vendor/moment/min/moment-with-locales.min.js"></script>

	<!--VUE Core JS-->
	<script src="/web/vendor/vue/2.5.17/dist/vue.min.js"></script>
    <script src="/web/vendor/vueloader/vue.loader.min.js"></script>

    <!--Pace Progress JS & CSS-->
	<script src="/web/vendor/pace/pace.min.js" type="text/javascript"></script>
    
    <!-- Element -->
	<script src="/web/vendor/element/2.6.1/dist/index.js"></script>
	<link href="/web/vendor/element/2.6.1/dist/theme-dark/index.css" type="text/css" rel="stylesheet" />

	<!--localforage Core JS -->
	<script src="/web/vendor/localForage/dist/localforage.min.js"></script>

	<!--Alertify JS -->
	<script src="/web/vendor/alertifyjs/lib/alertify.min.js" type="text/javascript"></script>

	<!-- Your project file goes here -->
	<link href="/web/vendor/jquery-contextmenu/dist/jquery.contextMenu.css" type="text/css" rel="stylesheet">
	<script src="/web/vendor/jquery-contextmenu/dist/jquery.ui.position.js"></script>
	<script src="/web/vendor/jquery-contextmenu/dist/jquery.contextMenu.js"></script>

    <!-- App JS-->
    <script src="/web/js/model/ContextMenu.js" type="text/javascript"></script>
    <script src="/web/js/model/Matrix.js" type="text/javascript"></script>
	<script src="/web/js/model/Window.js" type="text/javascript"></script>
	<script src="/web/js/model/VueHub.js" type="text/javascript"></script>
	
	<script src="/web/js/handler/FsHandler.js" type="text/javascript"></script>
	<script src="/web/js/handler/OmdbHandler.js" type="text/javascript"></script>
	<script src="/web/js/handler/UserHandler.js" type="text/javascript"></script>
	
	<script type="text/javascript" src="js/Init.js"></script>
	<script type="text/javascript" src="deflate/pako.min.js"></script>
	<script type="text/javascript" src="deflate/base64.js"></script>
	<script type="text/javascript" src="jscolor/jscolor.js"></script>
	<script type="text/javascript" src="sanitizer/sanitizer.min.js"></script>
	<script type="text/javascript" src="../src/js/mxClient.js"></script>
	<script type="text/javascript" src="js/EditorUi.js"></script>
	<script type="text/javascript" src="js/Editor.js"></script>
	<script type="text/javascript" src="js/Sidebar.js"></script>
	<script type="text/javascript" src="js/Graph.js"></script>
	<script type="text/javascript" src="js/Format.js"></script>
	<script type="text/javascript" src="js/Shapes.js"></script>
	<script type="text/javascript" src="js/Actions.js"></script>
	<script type="text/javascript" src="js/Menus.js"></script>
	<script type="text/javascript" src="js/Toolbar.js"></script>
	<script type="text/javascript" src="js/Dialogs.js"></script>
</head>

<body class="geEditor">

<script type="text/javascript">
    
    (function(){
        window.URL_PARAMS_ITEM = _.attempt(JSON.parse.bind(null, decodeURIComponent(window.atob(mx.urlParams['item']))));
        window.URL_PARAMS_CFG = _.attempt(JSON.parse.bind(null, decodeURIComponent(window.atob(mx.urlParams['cfg']))));

        var editorUiInit = EditorUi.prototype.init;

        EditorUi.prototype.init = function(){
            editorUiInit.apply(this, arguments);
            this.actions.get('export').setEnabled(false);

            // Updates action states which require a backend
            if (!Editor.useLocalStorage)
            {
                mxUtils.post(OPEN_URL, '', mxUtils.bind(this, function(req)
                {
                    var enabled = req.getStatus() != 404;
                    this.actions.get('open').setEnabled(enabled || Graph.fileSupport);
                    this.actions.get('import').setEnabled(enabled || Graph.fileSupport);
                    this.actions.get('save').setEnabled(enabled);
                    this.actions.get('saveAs').setEnabled(enabled);
                    this.actions.get('export').setEnabled(enabled);
                }));

            }
        };

        // Adds required resources (disables loading of fallback properties, this can only
        // be used if we know that all keys are defined in the language specific file)
        mxResources.loadDefaultBundle = false;
        var bundle = mxResources.getDefaultBundle(RESOURCE_BASE, mxLanguage) ||
            mxResources.getSpecialBundle(RESOURCE_BASE, mxLanguage);

        // Fixes possible asynchronous requests
        mxUtils.getAll([bundle, STYLE_PATH + '/default.xml'], function(xhr){
            // Adds bundle text to resources
            mxResources.parse(xhr[0].getText());

            // Configures the default graph theme
            var themes = new Object();
            themes[Graph.prototype.defaultThemeName] = xhr[1].getDocumentElement();

            // Main
            var editorUi = new EditorUi(new Editor(mx.urlParams['chrome'] == '0', themes));

            editorUi.toggleFormatPanel();

            var mgr = new mxAutoSaveManager(editorUi.editor.graph);
            mgr.autoSaveDelay = 2;
            mgr.save = function()
            {
                let _xml = mxUtils.getXml(editorUi.editor.getGraphXml());
                let _attr = _.attempt(JSON.parse.bind(null, window.URL_PARAMS_ITEM.attr));

                let _rtn = fsHandler.fsNew('file',window.URL_PARAMS_ITEM.parent, window.URL_PARAMS_ITEM.name, _xml, _attr);

            };

            let _list = fsHandler.fsContent(window.URL_PARAMS_ITEM.parent, window.URL_PARAMS_ITEM.name);

            editorUi.editor.graph.model.beginUpdate();
            try {
                editorUi.editor.setGraphXml(mxUtils.parseXml(_list).documentElement);

            } catch (e) {
                error = e;
            } finally {
                editorUi.editor.graph.model.endUpdate();
            }

            // Auto Toggle Properties Panel
            editorUi.editor.graph.getSelectionModel().addListener(mxEvent.CHANGE, function(sender, evt) {
                if(!_.isEmpty(window.jsPanel.activePanels.list)){
                    let action = editorUi.actions.get('mxProperties');
                    action.funct(null);
                }
            });

            // 工具栏扩展
            $(".geToolbarContainer").append(`<div id="geToolbarContainer"></div>`).ready(function(){
                new Vue({
                    delimiters: ['#{', '}#'],
                    template: `<div id="geToolbarContainer-right" style="float:right;">
                                    <el-tooltip content="全屏" placement="top">
                                        <a href="javascript:void(0);" @click="fullscreen" title="全屏" class="geButton" style="background-position: 50% 50%; background-repeat: no-repeat; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABS0lEQVQ4T62TwVECQRBFf0MAYgRiBoSAGWgELrPcJQMxA7wz7RCBZqBGIBlICHBn61uf2qEGpLzgXHZrpvtN9+8/hjOXKb+u6zWAi5LVNM11Smmlvaqq+p1O58vMejmG5NrdLzOAOtAmgGf9u/u0BIYQJgB6Zqbv7rIYo5WAjQ5IJncfneqsrusE4B7ALvYAQPIJwMrMXk5BiuQFScU9loA1yZnKDiFUggC4izG+qZLxeDwk+Q5gEWOsQgjTA4BEyoK1og1UTUpJmkhEiaeYZW4t5+w0OGf9D+C4BfW83W6Xf7WQq96PUVOQiFltM7uZz+cfrdFuAbySHLl7kogAHg6MJICZ9ds579QutclgQSTo8RgpF7ZW/ZWcQYUXNI3BsROzlWetlWWs/WrLluUn+U2UAD2aqyJ+0zTNoHxM3W73uwSS/HT34dlj/AH7KNIRGLhsnwAAAABJRU5ErkJggg==');"></a>&nbsp;&nbsp;
                                    </el-tooltip>
                                    <el-tooltip content="预览" placement="top">
                                        <a href="javascript:void(0);" @click="preview" title="预览" class="geButton" style="background-position: 50% 50%; background-repeat: no-repeat; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAo0lEQVQ4T+2SsQ0CMQxF/aX0MAJlpLhgBBiBDW4jGIER2AAxQxwp5Y3AAJGMfLqLRAEEhZJfJbL/K/w/qFPo9NMECCFcAKy+hN1F5DABmFmJaN8KUNUtgKOIoALs0wpg5h0RXf+AX98AgF22SRYjEZ1qCnOR1k3ueUlVx5TS8JS95QvASvVWMcbbslAB3vuNc+78yWzzUsqQcx7t3dy+V+BuwANX7VoRrx4R3gAAAABJRU5ErkJggg==');"></a>&nbsp;&nbsp;
                                    </el-tooltip>
                                    <el-tooltip content="格式面板(Ctrl+Shift+P)" placement="top">
                                        <a href="javascript:void(0);" @click="formatPanelToggle" title="格式面板(Ctrl+Shift+P)" class="geButton" style="background-position: 50% 50%; background-repeat: no-repeat; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAfklEQVQ4T+3TwQ2CQBCF4Y8O7EBKsAOxA0ugBEqwJSsQKoBS6AAzYTWaeGDOMpedw3t/Npt/K+vUOJY9cwxVSfc4Z5ole/kEBOSWgCxIAU4YcccVaUCDBwbEvgP+8w0OCJlmTL88CDFC560T2r9V7oqeW8uRi5u0r8+UKX5ln0MMP2FDItXQAAAAAElFTkSuQmCC');"></a>&nbsp;&nbsp;
                                    </el-tooltip>
                                    <el-tooltip content="属性面板" placement="top">
                                        <a href="javascript:void(0);" @click="propertyPanelToggle" title="属性面板" class="geButton" style="background-position: 50% 50%; background-repeat: no-repeat; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgElEQVQ4T2NkgAAFBgYGeSibFOogI1T1AQYGBntSdELVOiIbADKkgQRD/jMwMGAYsIGBgeE8AwPDRgYGhgAChmE1AOSK/QwMDAcZGBgcRg0YsWEwgYGBwYCBgeEDAwPDBVLTAShlgRISsQCU7OFJuYCIpItuMMiVCbDMRKytGOoAcyo/YeP/2LEAAAAASUVORK5CYII=');"></a>
                                    </el-tooltip>
                                </div>`,
                    created(){

                        // 设置Document Title
                        mx.companyTitle = window.URL_PARAMS_ITEM.name;
                        mx.setTitle();

                        // 设置Code Button Style
                        $(".geMenubarContainer").remove();
                        $(".geSprite-editdiagram").removeClass('geSprite');
                        $(".geSprite-editdiagram").addClass('fa fa-code');
                        $(".geSprite-editdiagram").css("border","none").css("padding","3px").css("font-size","16px");
                    },
                    methods: {
                        fullscreen(){
                            mx.fullScreen();
                        },
                        preview(){
                            let item = _.merge(_.cloneDeep(window.URL_PARAMS_ITEM),{action: 'run'});
                            let url = fsHandler.genFsUrl(item,null,null);

                            window.open(url, "_parent");
                        },
                        formatPanelToggle(){
                            editorUi.toggleFormatPanel();
                        },
                        propertyPanelToggle(){
                            if(editorUi.hsplitPosition === 0){
                                editorUi.hsplitPosition = 208;
                            } else{
                                editorUi.hsplitPosition = 0;
                            }
                            editorUi.refresh();
                        }

                    },
                }).$mount("#geToolbarContainer");
            })

            
            // 底边栏扩展
            $(".geFooterContainer > .geFooter").append(`<div id="geFooter"></div>`).ready(function(){
                new Vue({
                    delimiters: ['#{', '}#'],
                    template: `<ul class="nav navbar-nav" style="padding:5px 0;width:100%;">
                                    <li>
                                        <a href="javascript:void(0);" style="padding-top: 0px;padding-bottom: 0px;font-size: 12px;">
                                            文件：#{file}#
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:void(0);" style="padding-top: 0px;padding-bottom: 0px;font-size: 12px;">
                                            作者：#{author}#
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:void(0);" style="padding-top: 0px;padding-bottom: 0px;font-size: 12px;">
                                            时间：#{time}#
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:void(0);" style="padding-top: 0px;padding-bottom: 0px;font-size: 12px;">
                                            大小：#{size}#
                                        </a>
                                    </li>
                                    <li style="float:right;"><a target="_blank" href="http://www.wecise.com" style="padding-top: 0px;padding-bottom: 0px;font-size:12px;"><i class="fas fa-globe"></i> 唯简科技（北京）有限公司</a></li>
                                </ul>`,
                    data:{
                        author: JSON.parse(window.URL_PARAMS_ITEM.attr).auth,
                        file: window.URL_PARAMS_ITEM.name,
                        time: moment(window.URL_PARAMS_ITEM.vtime).format("LLL"),
                        size: mx.bytesToSize(window.URL_PARAMS_ITEM.size)
                    }
                }).$mount("#geFooter");
            });
        

        }, function(){
            document.body.innerHTML = '<center style="margin-top:10%;">Error loading resource files. Please check browser console.</center>';
        });
    })();
</script>
</body>
</html>

