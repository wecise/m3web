<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=5,IE=9" ><![endif]-->
<!DOCTYPE html>
<html>
<head>
	<title>M³ Platform 创作中心</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<script type="text/javascript">
        mxBasePath = '/web/creative/src';
        let signeduser = JSON.parse(localStorage.getItem("SIGNEDUSER")) || {};
        window.MATRIX_LANG = signeduser.lang;
        window.SignedUser_UserName = signeduser.username;
        window.SignedUser_FullName = signeduser.fullname;
        window.SignedUser_IsAdmin = signeduser.isadmin;
        window.ASSETS_ICON = '/fs/assets/images';
        window.mxLanguage = window.MATRIX_LANG;
	</script>

	<link rel="stylesheet" type="text/css" href="styles/grapheditor.css">

	<script src="/web/vendor/jquery/jquery-3.3.1.min.js"></script>

	<!-- Bootstrap core CSS -->
	<link href="/web/css/dist/css/bootstrap_wecise.css" rel="stylesheet">
	<link href="/web/css/dist/css/theme_wecise.css" rel="stylesheet">
	<script src="/web/css/dist/js/bootstrap.min.js"></script>


	<!-- Color Theme core CSS -->
	<!--<link href="/web/css/color/color_style.min.css" rel="stylesheet">
	<link href="/web/css/color/color_style_responsive.min.css" rel="stylesheet">-->
	<link href="/web/css/color/style.min.css" rel="stylesheet">

	<!-- Bootstrap ICON  CSS -->
	<link href="/web/vendor/font-awesome/5.4.1/css/all.min.css" rel="stylesheet" >

	<!-- animate core CSS -->
	<link href="/web/vendor/animate/animate.css" rel="stylesheet" >
	<!--Alertify CSS-->
	<link href="/web/vendor/alertifyjs/themes/alertify.core.css" type="text/css" rel="stylesheet" />
	<link href="/web/vendor/alertifyjs/themes/alertify.default.css" type="text/css" rel="stylesheet" />

	<style>

		/* For global font-size */
		span {
			font-size: 12px;
		}

		* {
			-webkit-box-sizing: border-box;
			-moz-box-sizing: border-box;
			box-sizing: initial;
		}

		div.mxWindowPane {
			overflow: auto!important;
			background-color: #ffffff;
		}

		/* For mxPoputMenu */
		html div.mxPopupMenu {
			-webkit-box-shadow: 0 2px 8px 0 rgba(0,0,0,0.15);
			-moz-box-shadow: 0 2px 8px 0 rgba(0,0,0,0.15);
			box-shadow: 0 2px 8px 0 rgba(0,0,0,0.15);
			background-color: rgb(255, 255, 255);
			border: none!important;
			padding: 3px;
		}

		.mxPopupMenu hr {
			margin-top: 0px;
			margin-bottom: 0px;
		}

		html td.mxPopupMenuItem {
			padding: 5px 10px 5px 10px!important;
			font-size: 8pt!important;
			font-family: system;
		}

		html tr.mxPopupMenuItemHover {
			background-color: rgb(246,246,246);
		}

		/* For Sidebar */
		.geSidebar {
			background: #fff!important;
			border-bottom: none!important;
			padding-bottom: 10px 8px 0px!important;
		}

		.geSidebar > center {
			padding-bottom: 0px!important;
		}


		/*----------  mxWindow ----------*/
		html td.mxWindowTitle {
			background-color: rgb(238, 238, 238);
			background-image: linear-gradient(180deg,rgb(247, 247, 247),rgb(224, 224, 224));
			background-repeat: repeat-x;
		}

		div.mxWindowPane {
			border-top: 1px solid rgb(221, 221, 221);
		}
	</style>


	<script type="text/javascript">
        // Parses URL parameters. Supported parameters are:
        // - lang=xy: Specifies the language of the user interface.
        // - touch=1: Enables a touch-style user interface.
        // - storage=local: Enables HTML5 local storage.
        // - chrome=0: Chromeless mode.
        var urlParams = (function(url)
        {
            var result = new Object();
            var idx = url.lastIndexOf('?');

            if (idx > 0)
            {
                var params = url.substring(idx + 1).split('&');

                for (var i = 0; i < params.length; i++)
                {
                    idx = params[i].indexOf('=');

                    if (idx > 0)
                    {
                        result[params[i].substring(0, idx)] = params[i].substring(idx + 1);
                    }
                }
            }

            return result;
        })(window.location.href);

        // Default resources are included in grapheditor resources
        mxLoadResources = false;
	</script>

	<script type="text/javascript" src="/web/vendor/lodash/dist/lodash.min.js"></script>

	<!--Panel JS & CSS -->
	<script src="/web/vendor/jsPanel/jquery.jspanel.min.js" type="text/javascript"></script>
	<link href="/web/vendor/jsPanel/jquery.jspanel.min.css" type="text/css" rel="stylesheet" />

	<!--Moment JS-->
	<script src="/web/vendor/moment/min/moment.min.js"></script>
	<script src="/web/vendor/moment/min/moment-with-locales.min.js"></script>

	<!--VUE Core JS-->
	<script src="/web/vendor/vue/2.5.17/dist/vue.min.js"></script>
	<script src="/web/vendor/vueloader/vue.loader.min.js"></script>

	<!--localforage Core JS -->
	<script src="/web/vendor/localForage/dist/localforage.min.js"></script>

	<!-- sweetalert core CSS -->
	<link href="/web/vendor/sweetalert2/dist/sweetalert2.min.css" rel="stylesheet">
	<!-- sweetalert core JS -->
	<script src="/web/vendor/sweetalert2/dist/sweetalert2.min.js"></script>

	<!--Alertify JS -->
	<script src="/web/vendor/alertifyjs/lib/alertify.min.js" type="text/javascript"></script>

	<!-- Your project file goes here -->
	<link href="/web/vendor/jquery-contextmenu/dist/jquery.contextMenu.css" type="text/css" rel="stylesheet">
	<script src="/web/vendor/jquery-contextmenu/dist/jquery.ui.position.js"></script>
	<script src="/web/vendor/jquery-contextmenu/dist/jquery.contextMenu.js"></script>

	<!-- App JS-->
	<script src="/web/js/app.js" type="text/javascript"></script>
	<script src="/web/js/cfg.js" type="text/javascript"></script>
	<script src="/web/js/init.js" type="text/javascript"></script>
	<script src="/web/js/model/Window.js" type="text/javascript"></script>
	<script src="/web/js/model/VueHub.js" type="text/javascript"></script>
	
	<script src="/web/js/handler/FsHandler.js" type="text/javascript"></script>
	<script src="/web/js/handler/OmdbHandler.js" type="text/javascript"></script>
	<script src="/web/js/handler/UserHandler.js" type="text/javascript"></script>
	
	<script type="text/javascript" src="js/Init.js"></script>
	<script type="text/javascript" src="deflate/pako.min.js"></script>
	<script type="text/javascript" src="deflate/base64.js"></script>
	<script type="text/javascript" src="jscolor/jscolor.js"></script>
	<script type="text/javascript" src="sanitizer/sanitizer.min.js"></script>
	<script type="text/javascript" src="../src/js/mxClient.js"></script>
	<script type="text/javascript" src="js/EditorUi.js"></script>
	<script type="text/javascript" src="js/Editor.js"></script>
	<script type="text/javascript" src="js/model/Sidebar.js"></script>
	<script type="text/javascript" src="js/Graph.js"></script>
	<script type="text/javascript" src="js/Format.js"></script>
	<script type="text/javascript" src="js/Shapes.js"></script>
	<script type="text/javascript" src="js/Actions.js"></script>
	<script type="text/javascript" src="js/Menus.js"></script>
	<script type="text/javascript" src="js/Toolbar.js"></script>
	<script type="text/javascript" src="js/Dialogs.js"></script>
</head>
<body class="geEditor">
<script type="text/javascript">
    // Extends EditorUi to update I/O action states based on availability of backend
    (function()
    {
        const URL_PARAMS_ITEM = _.attempt(JSON.parse.bind(null, decodeURIComponent(window.atob(urlParams['item']))));
        const URL_PARAMS_CFG = _.attempt(JSON.parse.bind(null, decodeURIComponent(window.atob(urlParams['cfg']))));

        var editorUiInit = EditorUi.prototype.init;

        EditorUi.prototype.init = function()
        {
            editorUiInit.apply(this, arguments);
            this.actions.get('export').setEnabled(false);

            // Updates action states which require a backend
            if (!Editor.useLocalStorage)
            {
                mxUtils.post(OPEN_URL, '', mxUtils.bind(this, function(req)
                {
                    var enabled = req.getStatus() != 404;
                    this.actions.get('open').setEnabled(enabled || Graph.fileSupport);
                    this.actions.get('import').setEnabled(enabled || Graph.fileSupport);
                    this.actions.get('save').setEnabled(enabled);
                    this.actions.get('saveAs').setEnabled(enabled);
                    this.actions.get('export').setEnabled(enabled);
                }));

            }
        };

        // Adds required resources (disables loading of fallback properties, this can only
        // be used if we know that all keys are defined in the language specific file)
        mxResources.loadDefaultBundle = false;
        var bundle = mxResources.getDefaultBundle(RESOURCE_BASE, mxLanguage) ||
            mxResources.getSpecialBundle(RESOURCE_BASE, mxLanguage);

        // Fixes possible asynchronous requests
        mxUtils.getAll([bundle, STYLE_PATH + '/default.xml'], function(xhr)
        {
            // Adds bundle text to resources
            mxResources.parse(xhr[0].getText());

            // Configures the default graph theme
            var themes = new Object();
            themes[Graph.prototype.defaultThemeName] = xhr[1].getDocumentElement();

            // Main
            var editorUi = new EditorUi(new Editor(urlParams['chrome'] == '0', themes));

            editorUi.toggleFormatPanel();

            var mgr = new mxAutoSaveManager(editorUi.editor.graph);
            mgr.autoSaveDelay = 2;
            mgr.save = function()
            {
                let _xml = mxUtils.getXml(editorUi.editor.getGraphXml());
                let _attr = _.attempt(JSON.parse.bind(null, URL_PARAMS_ITEM.attr));

                let _rtn = fsHandler.fsNew('file',URL_PARAMS_ITEM.parent, URL_PARAMS_ITEM.name, _xml, _attr);

            };

            let _list = fsHandler.fsContent(URL_PARAMS_ITEM.parent, URL_PARAMS_ITEM.name);

            editorUi.editor.graph.model.beginUpdate();
            try
            {
                editorUi.editor.setGraphXml(mxUtils.parseXml(_list).documentElement);

            }
            catch (e)
            {
                error = e;
            }
            finally
            {
                editorUi.editor.graph.model.endUpdate();
            }

            // Auto Toggle Properties Panel
            editorUi.editor.graph.getSelectionModel().addListener(mxEvent.CHANGE, function(sender, evt)
            {
                if(!_.isEmpty(window.jsPanel.activePanels.list)){
                    let action = editorUi.actions.get('mxProperties');
                    action.funct(null);
                }
            });

            $(".geMenubarContainer").remove();
            $(".geSprite-editdiagram").removeClass('geSprite');
            $(".geSprite-editdiagram").addClass('fa fa-code');
            $(".geSprite-editdiagram").css("border","none").css("padding","3px").css("font-size","16px");

            $(".geSprite-mx-save").removeClass('geSprite');
            $(".geSprite-mx-save").addClass('fa fa-save');
            $(".geSprite-mx-save").css("border","none").css("padding","3px").css("font-size","16px");
            $(".geSprite-mx-save").attr("alt",mxResources.get("fa-save"));

            $(".geSprite-mx-close").removeClass('geSprite');
            $(".geSprite-mx-close").addClass('fa fa-sign-out');
            $(".geSprite-mx-close").css("border","none").css("padding","3px").css("font-size","16px");
            $(".geSprite-mx-close").attr("alt",mxResources.get("fa-sign-out"));


            $(".geToolbarContainer").append(`<a href="javascript:void(0);" title="Fullscreen" class="geButton" style="position: absolute; display: inline-block; top: 5px; right: 73px; padding: 2px; font-size: 14px; width: 16px; height: 16px; background-position: 50% 50%; background-repeat: no-repeat; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABS0lEQVQ4T62TwVECQRBFf0MAYgRiBoSAGWgELrPcJQMxA7wz7RCBZqBGIBlICHBn61uf2qEGpLzgXHZrpvtN9+8/hjOXKb+u6zWAi5LVNM11Smmlvaqq+p1O58vMejmG5NrdLzOAOtAmgGf9u/u0BIYQJgB6Zqbv7rIYo5WAjQ5IJncfneqsrusE4B7ALvYAQPIJwMrMXk5BiuQFScU9loA1yZnKDiFUggC4izG+qZLxeDwk+Q5gEWOsQgjTA4BEyoK1og1UTUpJmkhEiaeYZW4t5+w0OGf9D+C4BfW83W6Xf7WQq96PUVOQiFltM7uZz+cfrdFuAbySHLl7kogAHg6MJICZ9ds579QutclgQSTo8RgpF7ZW/ZWcQYUXNI3BsROzlWetlWWs/WrLluUn+U2UAD2aqyJ+0zTNoHxM3W73uwSS/HT34dlj/AH7KNIRGLhsnwAAAABJRU5ErkJggg==');"></a>&nbsp;&nbsp;
												 <a href="javascript:void(0);" title="Preview Panel" class="geButton" style="position: absolute; display: inline-block; top: 5px; right: 50px; padding: 2px; font-size: 14px; width: 16px; height: 16px; background-position: 50% 50%; background-repeat: no-repeat; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAo0lEQVQ4T+2SsQ0CMQxF/aX0MAJlpLhgBBiBDW4jGIER2AAxQxwp5Y3AAJGMfLqLRAEEhZJfJbL/K/w/qFPo9NMECCFcAKy+hN1F5DABmFmJaN8KUNUtgKOIoALs0wpg5h0RXf+AX98AgF22SRYjEZ1qCnOR1k3ueUlVx5TS8JS95QvASvVWMcbbslAB3vuNc+78yWzzUsqQcx7t3dy+V+BuwANX7VoRrx4R3gAAAABJRU5ErkJggg==');"></a>&nbsp;&nbsp;
												 <a href="javascript:void(0);" title="Format Panel (Ctrl+Shift+P)" class="geButton" style="position: absolute; display: inline-block; top: 5px; right: 6px; padding: 2px; font-size: 14px; width: 16px; height: 16px; background-position: 50% 50%; background-repeat: no-repeat; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAfklEQVQ4T+3TwQ2CQBCF4Y8O7EBKsAOxA0ugBEqwJSsQKoBS6AAzYTWaeGDOMpedw3t/Npt/K+vUOJY9cwxVSfc4Z5ole/kEBOSWgCxIAU4YcccVaUCDBwbEvgP+8w0OCJlmTL88CDFC560T2r9V7oqeW8uRi5u0r8+UKX5ln0MMP2FDItXQAAAAAElFTkSuQmCC');"></a>&nbsp;&nbsp;
												 <a href="javascript:void(0);" title="Property Panel" class="geButton" style="position: absolute; display: inline-block; top: 5px; right: 28px; padding: 2px; font-size: 14px; width: 16px; height: 16px; background-position: 50% 50%; background-repeat: no-repeat; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgElEQVQ4T2NkgAAFBgYGeSibFOogI1T1AQYGBntSdELVOiIbADKkgQRD/jMwMGAYsIGBgeE8AwPDRgYGhgAChmE1AOSK/QwMDAcZGBgcRg0YsWEwgYGBwYCBgeEDAwPDBVLTAShlgRISsQCU7OFJuYCIpItuMMiVCbDMRKytGOoAcyo/YeP/2LEAAAAASUVORK5CYII=');"></a>`);

            $("a[title='Fullscreen']").click(function(event){
                mx.fullScreen();
            });

            $("a[title='Preview Panel']").click(function(event){
	            let item = _.merge(_.cloneDeep(URL_PARAMS_ITEM),{action: 'run'});
                let url = fsHandler.genFsUrl(item,null,null);

                window.open(url, "_blank");
            });

            $("a[title='Format Panel (Ctrl+Shift+P)']").click(function(event){
                editorUi.toggleFormatPanel();
            });

            $("a[title='Property Panel']").click(function(event){
                if(editorUi.hsplitPosition === 0){
                    editorUi.hsplitPosition = 208;
                } else{
                    editorUi.hsplitPosition = 0;
                }
                editorUi.refresh();
            });

        }, function()
        {
            document.body.innerHTML = '<center style="margin-top:10%;">Error loading resource files. Please check browser console.</center>';
        });
    })();
</script>
</body>
</html>

